<article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>æœ€è¿‘åˆšå¥½å­¦py,åˆšå¥½å°ç»„çš„ç¾¤åšå¥½ä¹…æ²¡æ›´æ–°äº†<br/> ä¾¿æƒ³æ‹¿pyæ¥è¯•è¯•æ°´</p>
<p>é€šè¿‡å³ä¸Šè§’æ‰“å¼€rssè®¢é˜…ã€€<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2020101221364549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> å…¶ä¸­æœ‰å¾ˆå¤šæ˜¯ä½ ä¹‹å‰çš„åšå®¢ï¼Œä½†ä¸æ˜¯å…¨éƒ¨ï¼Œè¿™é‡Œæˆ‘å¤§æ¦‚40ç¯‡åšå®¢å®ƒä»…ä»…æ›´æ–°äº†<br/> 10å¤šç¯‡<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2020101221364546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"/></img></p>
<p>æ¥ä¸‹æ¥å°†è¿™ä¸ªrssçš„url é€šè¿‡pyè„šæœ¬è·å–å…¶ä¸­å¸¦<br/> <code>&lt;a&gt;&lt;href="https://blog.csdn.net/adlatereturn/article/details/108889759"&gt;&lt;/a&gt;</code><br/> çš„æ ‡ç­¾ï¼Œè¿™å¹¶ä¸éš¾,éœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦ BeautifulSoup(html, â€˜lxmlâ€™),å®ƒè¿™ä¼ ä¸‹æ¥çš„æ˜¯xmlï¼Œä½†ç½‘é¡µä¸Šçœ‹å…¶æºä»£ç å…¶å®æ˜¯htmlï¼Œè¿™çš„ç¡®å¾ˆå‘ã€‚</p>
<pre><code class="prism language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> urlopen
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> re
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> HTTPError
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> URLError
<span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">getAritcles</span><span class="token punctuation">(</span>articleUrl<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        html <span class="token operator">=</span> urlopen<span class="token punctuation">(</span>articleUrl<span class="token punctuation">)</span>
    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">except</span> URLError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        bs <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
        <span class="token comment"># with open('rss.xml', 'w+')as fd:</span>
        <span class="token comment">#     fd.write(str(bs))</span>
        <span class="token comment"># print(bs.title)</span>
        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token string">'åŸæ–‡é“¾æ¥'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'href'</span> <span class="token keyword">in</span> article<span class="token punctuation">.</span>attrs<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

getAritcles<span class="token punctuation">(</span><span class="token string">'https://blog.csdn.net/adlatereturn/rss/list'</span><span class="token punctuation">)</span>

</code></pre>
<p>æ¥ç€å¦‚æœç”¨å¦‚ä¸‹æ–¹å¼</p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> i <span class="token keyword">in</span> bs<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> i
</code></pre>
<p>å¯è§find_allå¯ä»¥ç›´æ¥å®šä½åˆ°æ ‡ç­¾</p>
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108889759<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108732422<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108502385<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108356380<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108046579<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107753159<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107335130<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107335130#comments<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>æŸ¥çœ‹è¯„è®º<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107286812<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107585630<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107586703<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107445014<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107281562<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106845518<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106293203<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106167280<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105897403<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105780480<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105691795<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105586921<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105452737<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>åŸæ–‡é“¾æ¥<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>è€Œé€šè¿‡ã€€ã€€<code>article['href']</code>å¯è·å¾—æ­£ç¡®çš„url<br/> æ³¨æ„ã€€ä½¿ç”¨<code>article.get_text()åªèƒ½å¾—åˆ°åé¢çš„â€œåŸæ–‡é“¾æ¥â€</code></p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
           <span class="token keyword">if</span> <span class="token string">'href'</span> <span class="token keyword">in</span> article<span class="token punctuation">.</span>attrs<span class="token punctuation">:</span>
              <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-bash">https://blog.csdn.net/adlatereturn/article/details/108889759
https://blog.csdn.net/adlatereturn/article/details/108732422
https://blog.csdn.net/adlatereturn/article/details/108502385
https://blog.csdn.net/adlatereturn/article/details/108356380
https://blog.csdn.net/adlatereturn/article/details/108046579
https://blog.csdn.net/adlatereturn/article/details/107753159
https://blog.csdn.net/adlatereturn/article/details/107335130
https://blog.csdn.net/adlatereturn/article/details/107335130<span class="token comment">#comments</span>
https://blog.csdn.net/adlatereturn/article/details/107286812
https://blog.csdn.net/adlatereturn/article/details/107585630
https://blog.csdn.net/adlatereturn/article/details/107586703
https://blog.csdn.net/adlatereturn/article/details/107445014
https://blog.csdn.net/adlatereturn/article/details/107281562
https://blog.csdn.net/adlatereturn/article/details/106845518
https://blog.csdn.net/adlatereturn/article/details/106293203
https://blog.csdn.net/adlatereturn/article/details/106167280
https://blog.csdn.net/adlatereturn/article/details/105897403
https://blog.csdn.net/adlatereturn/article/details/105780480
https://blog.csdn.net/adlatereturn/article/details/105691795
https://blog.csdn.net/adlatereturn/article/details/105586921
https://blog.csdn.net/adlatereturn/article/details/105452737
</code></pre>
<p>ä¸­é—´æœ‰ä¸ªå¾ˆå”çªçš„æŸ¥çœ‹è¯„è®º</p>
<p>å› æ­¤æˆ‘ä»¬ä½¿ç”¨</p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token string">'åŸæ–‡é“¾æ¥'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre>
<p>æ’é™¤æ‰æŸ¥çœ‹è¯„è®º</p>
<p>è·å¾—æ­£ç¡®çš„url</p>
<pre><code class="prism language-bash">https://blog.csdn.net/adlatereturn/article/details/108889759
https://blog.csdn.net/adlatereturn/article/details/108732422
https://blog.csdn.net/adlatereturn/article/details/108502385
https://blog.csdn.net/adlatereturn/article/details/108356380
https://blog.csdn.net/adlatereturn/article/details/108046579
https://blog.csdn.net/adlatereturn/article/details/107753159
https://blog.csdn.net/adlatereturn/article/details/107335130
https://blog.csdn.net/adlatereturn/article/details/107286812
https://blog.csdn.net/adlatereturn/article/details/107585630
https://blog.csdn.net/adlatereturn/article/details/107586703
https://blog.csdn.net/adlatereturn/article/details/107445014
https://blog.csdn.net/adlatereturn/article/details/107281562
https://blog.csdn.net/adlatereturn/article/details/106845518
https://blog.csdn.net/adlatereturn/article/details/106293203
https://blog.csdn.net/adlatereturn/article/details/106167280
https://blog.csdn.net/adlatereturn/article/details/105897403
https://blog.csdn.net/adlatereturn/article/details/105780480
https://blog.csdn.net/adlatereturn/article/details/105691795
https://blog.csdn.net/adlatereturn/article/details/105586921
https://blog.csdn.net/adlatereturn/article/details/105452737
</code></pre>
<p>è¿™æ ·æˆ‘ä»¬å°±æ˜ç¡®äº†æˆ‘ä»¬éœ€è¦çˆ¬å»çš„ç›®æ ‡äº†</p>
<p>ä¹‹ååªéœ€è¦å¯¹æ¯ä¸ªurlè¿›è¡Œå•ç‹¬çˆ¬å»å³å¯</p>
<p>csdnçˆ¸çˆ¸æ±‚è¿‡å®¡</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä¹‹å‰ä¸€ç›´ç”¨å…å¯†ç ç™»å½• ğŸ˜¢ğŸ˜¢ ğŸ˜¢ï¼Œä»Šå¤©å†æ¬¡æ‰¾æ–¹æ³•å»ä¿®æ”¹å¯†ç ï¼Œä½†ç½‘ä¸Šæ–¹æ³•ä¸€ç›´å¤±æ•ˆï¼Œç›´åˆ°æ‰¾åˆ°è¿™ç¯‡ï¼Œ<br/> <a href="https://www.cnblogs.com/cpl9412290130/p/9583868.html">blog</a></p>
<pre><code class="prism language-bash">mysql<span class="token operator">&gt;</span> update mysql.user <span class="token keyword">set</span> authentication_string<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span>,plugin<span class="token operator">=</span><span class="token string">'mysql_native_password'</span> where user<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span>
</code></pre>
<p>å…¶å®å°±æ¯”ç½‘ä¸Šå¤šä¸€æ­¥æ“ä½œ,update mysql.userä¸­ ä¿®æ”¹<code>plugin='mysql_native_password'</code>å°±å®Œäº‹äº†ï¼Œå¦åˆ™å°†ä»ç„¶ç™»å½•å¤±è´¥ï¼</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>å°ä¼™ä¼´ä»¬,åœ¨åˆæ­¥å­¦ä¹ äº†c++çš„ç§»åŠ¨æ“ä½œåä½ è‚¯å®šä¼šæ¥è§¦åˆ°std::move,std::forwardäº†å§ï¼Œä½†ä½ çœŸçš„æ‡‚äº†std::moveå’Œstd::forwardçš„å…·ä½“æ„ä¹‰å—ï¼Ÿ</p>
<p>æœ¬æ–‡ä»…æ¶‰åŠstd::forwardçš„éƒ¨åˆ†çŸ¥è¯†è®²è§£</p>
<p>std::forwardçš„ä½¿ç”¨éœ€æ±‚ï¼šæ¨¡æ¿è½¬å‘å‚æ•°ï¼ˆå®Œç¾è½¬å‘ï¼‰</p>
<p>æ‰€è°“è½¬å‘ï¼Œå³åœ¨æ¨¡æ¿å‡½æ•°ä¸­è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°,å¤–éƒ¨å‡½æ•°ä¼ é€’çš„å‚æ•°å¹¶å¯ä»¥ä¿æŒå…¶å·¦å³å€¼å±æ€§ä¼ é€’ç»™å†…éƒ¨çš„å‡½æ•°<br/> å¤§è‡´æ˜¯ä¸‹é¢è¿™æ ·çš„å½¢å¼ï¼š</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä»¥ä¸‹æ˜¯å‡ ç§ä¸å¥½æˆ–è€…ä¸æ­£ç¡®çš„è½¬å‘æ–¹å¼ï¼š<br/> ##åŸå§‹æ‹·è´è½¬å‘</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸‹å›¾1çš„execæ¨¡æ¿å‡½æ•°ä¼ å…¥a,bç±»å‹å¯¹è±¡çš„æ‹·è´ï¼ˆæ¯”å¦‚ä¼ å…¥ä¸€ä¸ªstring,è™½è¯´æ­¤å¤„ä¼ å…¥intï¼‰,æ•ˆç‡ä½ï¼</p>
<p><strong>å›¾1</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##å¤–éƒ¨å‡½æ•°å·¦å€¼è½¬å‘</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸‹å›¾2çš„execæ¨¡æ¿å‡½æ•°ä¼ å…¥a,bç±»å‹å¯¹è±¡çš„å·¦å€¼å¼•ç”¨,mainå‡½æ•°ä¸­execä¸å¯ä»¥ç›´æ¥ä¼ å…¥æ•°å­—6è¿™ç§å³å€¼.</p>
<p><strong>å›¾2</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b<span class="token operator">&amp;</span> tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##å¤–éƒ¨å‡½æ•°å·¦å€¼è½¬å‘ï¼Œå†…éƒ¨å‡½æ•°å«æœ‰å³å€¼å‚æ•°</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸‹å›¾3å½“ tmpçš„å‚æ•°æ˜¯å³å€¼å¼•ç”¨æ—¶ï¼Œç”±äºexecä¸­çš„tmpbæ˜¯å·¦å€¼ï¼Œä¸èƒ½ç»™tmpä½œä¸ºå‚æ•°</p>
<p><strong>å›¾3</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b<span class="token operator">&amp;</span> tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##å¤–éƒ¨å‡½æ•°å³å€¼å¼•ç”¨è½¬å‘</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>ä¸‹å›¾4å·²ç»è§£å†³äº†execä¼ å³å€¼é—®é¢˜ï¼Œä½†ä¼ ç»™tmp çš„tmpbä¾æ—§æ˜¯ä¸ªå·¦å€¼ï¼ˆå³å€¼å¼•ç”¨ä¸ºå·¦å€¼ï¼‰,æˆ‘ä»¬è‹¥ç›´æ¥ä½¿ç”¨<br/> std::move(tmpb)æ¥ç»™tmpå‡½æ•°ä¼ å³å€¼,æ­¤æ—¶çš„ç¡®æ˜¯å¯è¡Œçš„,ä½†æˆ‘ä»¬å¹¶ä¸ç¡®å®šå¤–ç•Œç»™execä¼ å…¥çš„tmpa,tmpbæ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼,è€Œæˆ‘ä»¬éœ€è¦çš„è½¬å‘éœ€è¦ä¿æŒå‚æ•°çš„å·¦å³å€¼å±æ€§ï¼Œæ­¤æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•å»å¤„ç†æ¨¡æ¿å‡½æ•°è°ƒç”¨å†…éƒ¨å‡½æ•°çš„æ–¹å¼.</p>
<p><strong>å›¾4</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> ï¼†a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ä½œä¸ºä¸€ç§ç»Ÿä¸€çš„åšæ³•ï¼Œæˆ‘ä»¬éœ€è¦è®©ä¼ ç»™execçš„å·¦å€¼ä¿æŒå·¦å€¼å‘ç»™tmpï¼Œè®©ä¿å­˜execçš„å³å€¼çš„å·¦å€¼å½¢å‚å¦‚tmpbè½¬æ¢æˆå³å€¼å‘ç»™tmp,ä½†è¿™ä¸ªè‡ªå·±å¹¶ä¸å¥½å®ç°ï¼Œä½†æ ‡å‡†åº“èªæ˜åœ°å®ç°äº†è¿™ä¸ªè¿‡ç¨‹<code>std::forward&lt;T&gt;()</code>,ä¸‹å›¾5æ¨¡æ¿å‡½æ•°å†…éƒ¨ä»…éœ€ç»Ÿä¸€çš„è°ƒç”¨å‡½æ•°<code>f(std::forward&lt;a&gt;(tmpa), std::forward&lt;b&gt;(tmpb));</code></p>
<p><strong>å›¾5</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>a<span class="token operator">&gt;</span><span class="token punctuation">(</span>tmpa<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">(</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>å¤§å®¶è‚¯å®šä¼šå¾ˆå¥½å¥‡forwardçš„å®ç°åŸç†ï¼<br/> å¦‚ä¸‹å›¾6<br/> std::forwardæºç </p>
<pre><code class="prism language-cpp">  <span class="token comment">/**
   *  @brief  Forward an lvalue.
   *  @return The parameter cast to the specified type.
   *
   *  This function is used to implement "perfect forwarding".
   */</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token operator">&gt;</span>
    <span class="token keyword">constexpr</span> _Tp<span class="token operator">&amp;&amp;</span>
    <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">typename</span> std<span class="token operator">::</span>remove_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type<span class="token operator">&amp;</span> __t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Tp<span class="token operator">&amp;&amp;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>__t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">/**
   *  @brief  Forward an rvalue.
   *  @return The parameter cast to the specified type.
   *
   *  This function is used to implement "perfect forwarding".
   */</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token operator">&gt;</span>
    <span class="token keyword">constexpr</span> _Tp<span class="token operator">&amp;&amp;</span>
    <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">typename</span> std<span class="token operator">::</span>remove_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type<span class="token operator">&amp;&amp;</span> __t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token operator">!</span>std<span class="token operator">::</span>is_lvalue_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>value<span class="token punctuation">,</span> <span class="token string">"template argument"</span>
		    <span class="token string">" substituting _Tp is an lvalue reference type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Tp<span class="token operator">&amp;&amp;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>__t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<p>æ— è®ºä¼ å…¥çš„_Tpæ˜¯intè¿˜æ˜¯int&amp;è¿˜æ˜¯int&amp;&amp;<br/> <code>std::remove_reference&lt;_Tp&gt;::type</code>ä¼šæ˜¯int<br/> <code>std::remove_reference&lt;_Tp&gt;::type&amp;</code>ä¼šæ˜¯int&amp;,<br/> <code>std::remove_reference&lt;_Tp&gt;::type&amp;&amp;</code>ä¼šæ˜¯int&amp;&amp;</p>
<p>è€Œexec çš„å‚æ•°tmpa,tmpbéƒ½æ˜¯å·¦å€¼ï¼ˆå³å€¼å¼•ç”¨æ˜¯å·¦å€¼ï¼‰ï¼Œæ­¤æ—¶ä½¿ç”¨forwardå…¶å®éƒ½åªä¼šè°ƒç”¨å·¦å€¼ç‰ˆæœ¬çš„forwardå‡½æ•°ï¼Œtempaä¼ å…¥int&amp;,tempbä¼ å…¥int&amp;&amp;,é€šè¿‡å¼•ç”¨æŠ˜å ,aç±»å‹æ¨å¯¼ä¸ºint&amp;,bæ¨å¯¼ä¸ºintï¼Œ<br/> æ‰€ä»¥<br/> forward(tmpa)å³forward&lt;int&amp;&gt;(int&amp;)<br/> forwardå‡½æ•°å†…_Tp=int&amp;,_Tp&amp;&amp;=int&amp;,<br/> å› æ­¤<code>return static_cast&lt;_Tp&amp;&amp;&gt;(__t)</code>è¿”å› int&amp;,ä¹Ÿå°±æ˜¯å·¦å€¼</p>
<p><code>forward&lt;b&gt;(tmpb)</code>å³<code>forward&lt;int&gt;(int&amp;) forwardå‡½æ•°å†…_Tp=int&amp;,_Tp&amp;&amp;=int&amp;, å› æ­¤</code>return static_cast&lt;_Tp&amp;&amp;&gt;(__t)`è¿”å› int&amp;&amp;,ä¹Ÿå°±æ˜¯å³å€¼</p>
<p>å½“ç„¶å½“forwardä¼ å®å‚æ˜¯å³å€¼æ—¶ä¼šè°ƒç”¨å¦ä¸€ä¸ªé‡è½½å‡½æ•°ï¼Œæœ€åä¼šè¿”å›å³å€¼ï¼</p>
<p>æ‰€ä»¥å¯ä»¥è¯´forwardè¿™é‡Œæ˜¯å¿…é¡»é…åˆæ¨¡æ¿ï¼‹&amp;&amp;å‚æ•°æ¥å®ç°å®Œç¾è½¬å‘</p>
<p>å¦‚ç”Ÿæˆæ™ºèƒ½æŒ‡é’ˆå‡½æ•°std::make_sharedå°±è¿ç”¨äº†å®Œç¾è½¬å‘çš„æ¨¡å‹ï¼Œc++ä¸­æºç çš„å¥¥å¦™çœŸæ˜¯æ— ç©·æ— å°½ï¼</p>
<pre><code class="prism language-cpp">  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> _Args<span class="token operator">&gt;</span>
    <span class="token keyword">inline</span> shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span>
    <span class="token function">make_shared</span><span class="token punctuation">(</span>_Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> __args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">typedef</span> <span class="token keyword">typename</span> std<span class="token operator">::</span>remove_const<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type _Tp_nc<span class="token punctuation">;</span>
      <span class="token keyword">return</span> std<span class="token operator">::</span>allocate_shared<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>allocator<span class="token operator">&lt;</span>_Tp_nc<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				       std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>_Args<span class="token operator">&gt;</span><span class="token punctuation">(</span>__args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p><a href="https://github.com/linyacool/WebServer">linyacool/WebServer</a></p>
<p>æ€ä¹ˆè¯´å‘¢,åˆçœ‹äº†ä¸€ä¸ªæ¨¡ä»¿moduoçš„server,ä¸è¿‡ä¹‹å‰é‚£ä¸ªmini-muduoæ˜¯echoæœåŠ¡å™¨,è¿™ä¸ªæ˜¯httpæœåŠ¡å™¨,æ€æƒ³éƒ½å·®ä¸å¤š,åœ¨å¹¶å‘æ¨¡å‹ä¸Šè¿™ä¸ªæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯Reactor +çº¿ç¨‹æ±  ,æ¯ä¸ªè¿æ¥å­çº¿ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªReactor,è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ç§æ¨¡å‹çš„å®ç°,å®ƒç›¸å¯¹mini-muduoçš„ä¼˜ç‚¹è¿˜æœ‰å®ƒä½¿ç”¨äº†æ™ºèƒ½æŒ‡é’ˆæ¥é¿å…å†…å­˜æ³„æ¼,è¿™çš„ç¡®å¢å¤§äº†ç¼–ç¨‹çš„éš¾åº¦,ä½†å…¶ä¿è¯å†…å­˜ä¸æ³„æ¼çš„ç¡®æ˜¯ç¨‹åºå‘˜æ ¼å¤–éœ€è¦å»æ³¨æ„çš„åœ°æ–¹.</p>
<p>å¤§è‡´æœ‰è¿™äº›ç±»<br/> Server(å…¥å£ç±»,å…¶ä¸­åŒ…å«äº†Accptor ç”¨æ¥å¤„ç†è¿æ¥äº‹ä»¶)</p>
<p>Channel (å¯¹äºæ–‡ä»¶æè¿°ç¬¦çš„å°è£…)</p>
<p>Epoll (å¯¹äºepollçš„å°è£…,åœ¨å…¶ä¸­æ·»åˆ Channel)</p>
<p>EventLoop(whileå¾ªç¯çš„å°è£…,å…¶ä¸­æœ‰ä¸ªEpollåœ¨é‚£æ”¶é›†äº‹ä»¶)</p>
<p>EventLoopThread(EventLoopçº¿ç¨‹ç±»,æ˜¯å­çº¿ç¨‹æ¥ä½¿ç”¨EventLoopæ¥ç›‘æ§è¿æ¥å¥—æ¥å­—çš„)</p>
<p>EventLoopThreadPool(åŒ…å«æŒ‡å®šæ•°é‡çš„EventLoopThreadæ¥åˆ†æ‹…æ‰€æœ‰è¿æ¥å¥—æ¥å­—)</p>
<p>HTTPData(è¿æ¥ç±»,åœ¨å…¶ä¸­è¯»å–æ•°æ®,å¤„ç†æ•°æ®,åˆ†å‘æ•°æ®)</p>
<p>Logging(å¼‚æ­¥æ—¥å¿—)</p>
<p>æµç¨‹:(ç¬¦å·ä¸å®Œå…¨ä¸€æ ·)</p>
<p>mainLoop()<br/> myHttpServer()-&gt;eventLoopThreadPool_(),accpetChannel()-&gt;myHttpServer.start()-&gt;eventLoopThreadPool_.start()-&gt; eventLoopThread(),eventLoopThread.startLoop()-&gt;thread.start()-&gt; subEventLoop()-&gt;subEventLoop.loop()-&gt;mainloop.addToPoller(acceptChannel)<br/> mainLoop.loop()</p>
<p>å¯¹åº”çš„è¯´æ˜:</p>
<ul><li>åˆå§‹åŒ–åŒ–ä¸»å¾ªç¯mainloop</li><li>åˆå§‹åŒ–Server</li><li>å…¶ä¸­å…ˆåˆå§‹åŒ–eventLoopThreadPool,å†åˆå§‹åŒ–ç›‘å¬å¥—æ¥å­—å¹¶æ”¾å…¥accpetChannel</li><li>æ¥ç€å¯åŠ¨Server.start</li><li>å…¶ä¸­eventLoopThreadPoolä¸­åˆå§‹åŒ–4ä¸ªeventLoopThread</li><li>å¹¶å¼€å¯çº¿ç¨‹è°ƒç”¨å®ƒä»¬æ³¨å†Œçš„çº¿ç¨‹å‡½æ•°,ä¹Ÿå°±æ˜¯å¯åŠ¨ ä¸€ä¸ªçº¿ç¨‹ç‹¬æœ‰çš„EventLoop subReactor</li><li>æ¯ä¸ªsubEventLoop è°ƒç”¨loopä¹Ÿå°±æ˜¯Epollç±»è°ƒç”¨çš„poll(epoll_wait)æ­¤æ—¶è¿™äº›epollä¸Šéƒ½æ²¡æœ‰å®¢æˆ·å¥—æ¥å­—</li><li>æ­¤æ—¶å­çº¿ç¨‹çš„å·¥ä½œå®Œæˆ,å›åˆ°çˆ¶çº¿ç¨‹ä¸­çš„Server::start,è®©mainLoopç›‘å¬acceptChannel</li><li>å†è°ƒç”¨mainloop.loopæ¥ç­‰å¾…å®¢æˆ·è¿æ¥,æ­¤æ—¶ä¸‡äº‹å…·å¤‡,åªæ¬ ä¸œé£.</li></ul>
<p>æµç¨‹:<br/> mainLoop.loopè¿”å›-&gt;accpetChannel.handleEvents-&gt;myHttpServer.handNewConn-&gt;acceptå¾—åˆ°conn_fd-&gt;HttpData req_info(conn_fd)-&gt;Channel connChannel(conn_fd)-&gt;subloop.queueInLoopå¼‚æ­¥æ‰§è¡Œreq_info.newEvent,subloop.addToPoller(connChannel,2000)</p>
<p>å¯¹åº”çš„è¯´æ˜:</p>
<ul><li>æ­¤æ—¶æ¥äº†å®¢æˆ·è¿æ¥,ä¼šåœ¨mainLoop.loopä¸­è¿”å›,</li><li>é€šè¿‡å›è°ƒhandNewConnæ¥accept,å°†å¾—åˆ°çš„conn_fdç»‘å®šåˆ°HttpDataå’ŒChannelä¸Š</li><li>é€šè¿‡EventLoopThreadPoolæ¥è½®è½¬è·å–subEventLoop,åœ¨subEventLoopä¸­ç”¨queueInLoopæ¥å°†ä»»åŠ¡å‡½æ•°HttpData::newEventæ·»åŠ åˆ°åˆ°subEventLoopä¸­</li><li>å…¶ä¸­ä¼šå°†conn_ChannelåŠ å…¥åˆ°subLoopç›‘å¬çš„çº¢é»‘æ ‘ä¸­</li><li>è¿˜ä¼šåœ¨conn_Channelç»‘å®šä¸€ä¸ª2ç§’çš„è®¡æ—¶å™¨,è¿™ä¸ªè®¡æ—¶å™¨ç”±å…¨å±€çš„timerManageç®¡ç†,2så†…å®¢æˆ·æ²¡å‘é€æ¶ˆæ¯,è¿‡æ—¶ä¼šåˆ å»è®¡æ—¶å™¨(ä¸è¿‡ä¼šåœ¨EventLoopä¸­å»¶è¿Ÿæ‰§è¡Œ),åœ¨è®¡æ—¶å™¨ç±»çš„ææ„å‡½æ•°ä¸­è®©conn_Channelçš„æ™ºèƒ½æŒ‡é’ˆçš„è®¡æ•°-1,èµ·åˆ°"æ¸…é™¤"è¶…æ—¶å®¢æˆ·çš„ä½œç”¨.</li></ul>
<p>å½“å®¢æˆ·æ¶ˆæ¯æ¥äº†<br/> æµç¨‹:<br/> subLoop.loopè¿”å›-&gt; EPOLLIN?-&gt;req_info.handleRead() EPOLLOUT?-&gt;req_info.handleWrite()<br/> req_info.handleRead()-&gt;read,parseURI,parseHeaders,analysisRequest ,req_info.handleWrite()-&gt;write</p>
<p>req_info.handleConn -&gt;æŸ¥çœ‹å¹¶ä¿®æ”¹è¿æ¥ç±»çš„EpollçŠ¶æ€-&gt;subEventloop.updatePoller(connChennel)/subEventloop.runInLoop(HttpData::handleClose)å¼‚æ­¥æ‰§è¡Œreq_info.handleClose-&gt;subLoop.removeFromPoller(connChennel)</p>
<p>å¯¹åº”çš„è¯´æ˜:</p>
<ul><li>å½“å®¢æˆ·æ¶ˆæ¯æ¥äº†,subLoop.loopè¿”å›,Channelä¼šæ ¹æ®è¿”å›çš„äº‹ä»¶æ¥æ‰§è¡Œè¯»å†™,handleReadä¸­è¯»å–è¾“å…¥,å¹¶å¤„ç†httpè¯·æ±‚, handleWriteä¸­å°†éœ€è¦å›å‘çš„æ•°æ®å‘å‡ºå»,æ¥ç€åœ¨handleConnä¸­ä¼šæŸ¥çœ‹å¹¶ä¿®æ”¹è¿æ¥ç±»çš„EpollçŠ¶æ€,æ ¹æ®ç°åœ¨çš„çŠ¶æ€é€‰æ‹©æ›´æ–°connChennel çš„Epolläº‹ä»¶æˆ–è€…å¼‚æ­¥å…³é—­è¿æ¥.</li></ul>
<p>ä¸€æ¬¡çš„è¯·æ±‚å®Œæ¯•</p>
<p>Logç±»çš„è®¾è®¡ä¹Ÿæ¯”è¾ƒå·§å¦™,ä¸“é—¨ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å‘é€éœ€è¦å†™å…¥æ—¥å¿—çš„ä¿¡æ¯,ç”¨æˆ·æ¥å£éå¸¸å®¹æ˜“<code>Log&lt;&lt;"xxx"</code>,è¯¦è§æºç </p>
<p>ç»éªŒ:</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Functor<span class="token operator">&amp;&amp;</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>
    MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingFunctors_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> callingPendingFunctors_<span class="token punctuation">)</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ol><li>(çº æ­£ä¸‹æˆ‘ä¸Šä¸€ç¯‡åšå®¢è®²mini-muduoé‡Œé¢ queueInLoopçš„é”™è¯¯)``queueInLoop å¼‚æ­¥æ‰§è¡Œä»»åŠ¡,queueInLoopä¸­çš„åˆ¤æ–­callingPendingFunctors_çš„ä½œç”¨:åœ¨EventLoop::loopä¸­callingPendingFunctors_=trueçš„åŒºé—´å–å‡ºæ‰€æœ‰ä»»åŠ¡å¹¶æ‰§è¡Œ,åœ¨queueInLoopä¸­å…ˆåˆ¤æ–­å¦‚æœå‘é€çš„ä»»åŠ¡æ‰€åœ¨çº¿ç¨‹ä¸æ˜¯EventLoopæ‰€åˆ›å»ºçš„çº¿ç¨‹é‚£ä¹ˆå¦‚æœEventLoopçš„æ‰€åœ¨çº¿ç¨‹å·²ç»ä»pendingFunctors_ä»¥vector.swapçš„æ–¹å¼ä¸­å–å‡ºä»»åŠ¡ï¼ˆé¿å…è¿­ä»£å™¨å¤±æ•ˆï¼‰ï¼Œè¿™ä¸ªæ—¶å€™ callingPendingFunctors_ä¸ºçœŸ,åˆ™EventLoop.weakupå¯ä»¥è®©epollçš„ä¸‹ä¸€è½®æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæ­¤æ—¶queueInLoopè°ƒç”¨çš„çº¿ç¨‹æ˜¯EventLoopæ‰€åˆ›å»ºçš„çº¿ç¨‹çš„è¯ï¼Œé‚£åŒæ ·!isInLoopThread()ä¸ºå‡,callingPendingFunctors_ä¹Ÿä¸ºå‡,ä¸è°ƒç”¨wakeupå¼‚æ­¥å”¤é†’ï¼Œä¹‹åç­‰åˆ°eventloopä¸‹ä¸€è½®è‹é†’äº†æˆ–è€…è¯´æ‰§è¡Œåˆ°doPendingFunctorsäº†ï¼Œå°±èƒ½ä¿è¯æ­¤æ¬¡æ·»åŠ çš„ä»»åŠ¡åœ¨ä»»åŠ¡vectorä¸­.</li><li>runInLoopä¹Ÿæ˜¯å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼ŒqueueInLoopåŠŸèƒ½æ›´åƒæ˜¯å¼‚æ­¥å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡Vector</li><li>çº¿ç¨‹å±€éƒ¨å­˜å‚¨_threadçš„ç”¨æ³•</li><li>é€šè¿‡linuxæ–°api eventfdå®ç°å”¤é†’epollçš„åŠŸèƒ½</li><li>å°†é¢å‘è¿‡ç¨‹ä»£ç é€šè¿‡åŒ…è£…æˆç±»æ”¹é€ æˆé¢å‘å¯¹è±¡ä»£ç </li><li>httpä¸­headä¸­çš„æ¯ä¸ª<code>åŸŸå:åŸŸå€¼</code>é€‰é¡¹ä»¥mapçš„key,valueå­˜å‚¨ï¼Œæ–¹ä¾¿è§£æ</li><li>ä½¿ç”¨åº”ç”¨å±‚çš„ç¼“å†²åŒºï¼Œè¯»å–åˆ°çš„æ•°æ®appendåˆ°bufferçš„æœ«å°¾ï¼Œä»¥stringåŠ¨æ€æ‰©å®¹çš„æ–¹å¼ï¼Œè§£å†³äº†åŸæœ¬ä¸€ä¸ªå®šé•¿æ•°ç»„çš„ä¸è¶³ä¹‹å¤„ï¼</li><li>,äº†è§£äº†mainReactor+subReactor+threadpoolçš„æ¨¡å¼çš„åŠŸèƒ½ï¼Œï¼ˆè¿™ä¸ªthreadpoolä¸æ˜¯ç”¨æ¥è®¡ç®—ï¼Œè€Œæ˜¯ç»™subReactoræ¥loopï¼‰</li><li>åˆ©ç”¨å‡½æ•°getoptæ¥æ–¹ä¾¿è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™ç®€ç›´æ˜¯å†™lsï¼Œcpç­‰å„ç§å‘½ä»¤çš„ç¦éŸ³</li><li>é€šè¿‡setReadHandler(bind(&amp;Server::handNewConn, this))çš„æ–¹å¼è®¾ç½®å›è°ƒå‡½æ•°ï¼Œå¯ä»¥æ‰§è¡Œå¯¹è±¡çš„å‡½æ•°ï¼Œè¿˜å¯ä»¥ä¿è¯setReadHandlerçš„æ¥å£ç»Ÿä¸€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¼ å…¥å¯¹è±¡çš„thisæŒ‡é’ˆä¼šè®©ç»‘å®šè¿™ä¸ªå‡½æ•°ä¸å®‰å…¨ï¼ˆè¿™åœ¨muduoå‰å‡ ç« æœ‰æ‰€æåŠï¼‰</li><li>ETæ¨¡å¼ä¸‹æ¯æ¬¡è¯»å–æˆ–è€…è¾“å‡ºéœ€è¦ä¸€ç›´readæˆ–writeç›´åˆ°EAGAIN</li><li></li></ol>
<p>bug:æœåŠ¡å™¨bindçš„80ç«¯å£å·²è¢«å ç”¨,éœ€è¦ç»‘å®šåˆ«çš„.åœ¨ç½‘é¡µä¸Šæœ‰å›è½¦æ˜¾ç¤ºä¸å‡ºæ¥çš„é—®é¢˜</p>
<p>ç¼ºç‚¹:æœªæ”¯æŒutf-8,POSTçš„çœç•¥,è®¡æ—¶å™¨çš„è®¾è®¡ä¸ä½³</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä¹‹å‰æƒ³å­¦muduo ä½†å› ä¸ºä¸€äº›åŸå› ï¼Œæš‚æ—¶ç¼–è¯‘ä¸è¿‡ï¼Œç¢°å·§çœ‹åˆ°ä¸€ä¸ªåšä¸»æ˜¯æ¨¡ä»¿ç€muduoå†™çš„mini-muduoï¼Œçœ‹äº†çœ‹è§‰å¾—æŒºå¥½ï¼Œä»…ä»…å®ç°EchoæœåŠ¡å™¨ï¼Œä»æœ€ç®€å•çš„epollæ¨¡å‹å¼€å§‹åˆ°ååº”å †+å¤šçº¿ç¨‹,ä¸ºäº†ç®€æ´æ²¡æœ‰ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ˆå®ƒä¹Ÿæç¤ºäº†ä¼šå†…å­˜æ³„æ¼ï¼‰ï¼Œéƒ¨åˆ†æœ‰bug,ä½†ä¾æ—§æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å­¦ä¹ å¯¹è±¡ã€‚æœ¬æ–‡å°±æœ€åçš„ã€€ååº”å †+å¤šçº¿ç¨‹æ¨¡å‹ä½œä¸€ä¸‹åˆ†æã€‚(åŸæ–‡åˆ†æˆäº†13å°èŠ‚)</p>
<h2><a id="maincpp_2"></a>main.cpp</h2>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EchoServer.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> args<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    EventLoop loop<span class="token punctuation">;</span>
    EchoServer <span class="token function">echoserver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    echoserver<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ¥å£éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¸€ä¸ªloop,åˆ†åˆ«ä½¿ç”¨start loopæ–¹æ³•å°±å¯ä»¥è®©ç¨‹åºè·‘èµ·æ¥ï¼Œ</p>
<h2><a id="EchoServerh_20"></a>EchoServer.h</h2>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> ECHOSERVER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ECHOSERVER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IMuduoUser.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ThreadPool.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token operator">:</span> <span class="token keyword">public</span> IMuduoUser
                   <span class="token punctuation">,</span> <span class="token keyword">public</span> IRun2
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">EchoServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">EchoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onConnection</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onWriteComplate</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
    TcpServer _pServer<span class="token punctuation">;</span>
    ThreadPool _threadpool<span class="token punctuation">;</span>
    <span class="token keyword">long</span> _timer<span class="token punctuation">;</span>
    <span class="token keyword">int</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>è¿™ä¸ªEchoServer æ˜¯åº”ç”¨å±‚é¢çš„æœåŠ¡å™¨ï¼Œç»§æ‰¿äºIMuduoUserå’ŒIRun2ã€‚IMuduoUserç±»åŒ…å«onConnectionï¼ŒonMessageï¼ŒonWriteComplateä¸‰ä¸ªè™šå‡½æ•°ï¼Œè¦æ±‚å­ç±»EchoServerå®ç°ï¼Œåˆ†åˆ«å¯¹åº”ç€è¿æ¥æ—¶ï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå‘é€æ¶ˆæ¯å®Œæˆæ—¶éœ€è¦çš„éƒ¨åˆ†å¤„ç†ï¼Œ<br/> IRun2ç±»è™šå‡½æ•°æ˜¯run2ï¼Œè¿™ä¸ªå‡½æ•°è¿ç”¨äºå›è°ƒã€‚<br/> EventLoop* _pLoopæ˜¯äº‹ä»¶è½®è®¯å¯¹è±¡æŒ‡é’ˆï¼ŒTcpServer _pServeræ˜¯æœåŠ¡å™¨å¯¹è±¡,ThreadPool _threadpoolæ˜¯çº¿ç¨‹æ± ï¼Œ_timeræ˜¯è®¡æ—¶å™¨çš„åœ°å€(åŸåšä¸»çš„æ„æ€æ˜¯ç”¨è®¡æ—¶å™¨çš„id,ä½†ä»–ç›´æ¥ä½¿ç”¨äº†è®¡æ—¶å™¨çš„æŒ‡é’ˆå­˜æ”¾åœ¨longç±»å‹çš„_timeré‡Œ,å¯ä»¥è¯´æ˜¯æœ‰ç‚¹å¤æ€ªï¼Œåé¢éœ€è¦å¤šæ¬¡çš„è½¬å‹)<br/> _indexæš‚æ— ä½¿ç”¨</p>
<h2><a id="EchoServercc_59"></a>EchoServer.cc</h2>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EchoServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpConnection.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"CurrentThread.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MESSAGE_LENGTH 8</span>

EchoServer<span class="token operator">::</span><span class="token function">EchoServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pServer</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_timer</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_index</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

EchoServer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">EchoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _threadpool<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onConnection</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"onConnection"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MESSAGE_LENGTH<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAsString</span><span class="token punctuation">(</span>MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAllAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onWriteComplate</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"onWriteComplate"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//run in different therad</span>
<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//IO blocking task or CPU busy task</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fib(30) = "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" tid = "</span> <span class="token operator">&lt;&lt;</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span><span class="token punctuation">)</span>tcp<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fib is short for Fibonacci, fib is a CPU busy method</span>
<span class="token keyword">int</span> EchoServer<span class="token operator">::</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>å¯ä»¥çœ‹åˆ°ã€€onConnectionï¼ŒonWriteComplateç±»ä»…ä»…æ˜¯æ‰“å°ä¸€ä¸‹å‡½æ•°åç§°ï¼Œ <code>printf("%s\n",__func__);</code>æ˜¯æˆ‘ä¸ºäº†æ‰“å°å‡½æ•°æ‰§è¡Œæµç¨‹è€Œæ‰“å°çš„ï¼Œä½¿ç”¨æ—¶å¯å»é™¤ã€‚<br/> å…ˆä¸çœ‹run2 ,fib,onMessage,è€Œæ˜¯çœ‹mainé‡Œé¢çš„echoserver.start</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _threadpool<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è½¬åˆ°TcpServer</p>
<h2><a id="TcpServerh_147"></a>TcpServer.h</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> TCPSERVER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCPSERVER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IAcceptorCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IMuduoUser.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TcpServer</span> <span class="token operator">:</span> <span class="token keyword">public</span> IAcceptorCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">TcpServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IMuduoUser<span class="token operator">*</span> pUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">struct</span> epoll_event _events<span class="token punctuation">[</span>MAX_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
        map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> TcpConnection<span class="token operator">*</span><span class="token operator">&gt;</span> _connections<span class="token punctuation">;</span>
        Acceptor<span class="token operator">*</span> _pAcceptor<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
        IMuduoUser<span class="token operator">*</span> _pUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<h2><a id="TcpServercc_181"></a>TcpServer.cc</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Acceptor.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpConnection.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

TcpServer<span class="token operator">::</span><span class="token function">TcpServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_pAcceptor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pUser</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

TcpServer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Acceptor</span><span class="token punctuation">(</span>_pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pAcceptor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pAcceptor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TcpConnection<span class="token operator">*</span> tcp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TcpConnection</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> _pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _connections<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span> <span class="token operator">=</span> tcp<span class="token punctuation">;</span>
    tcp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setUser</span><span class="token punctuation">(</span>_pUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tcp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectEstablished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IMuduoUser<span class="token operator">*</span> user<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pUser <span class="token operator">=</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ç›´æ¥çœ‹TcpServer.starté‡Œé¢newäº†ä¸€ä¸ªAccpetor</p>
<h2><a id="Accpetorh_228"></a>Accpetor.h</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> ACCEPTOR_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ACCEPTOR_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Acceptor</span> <span class="token operator">:</span> <span class="token keyword">public</span> IChannelCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Acceptor</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">Acceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IAcceptorCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> <span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> _listenfd<span class="token punctuation">;</span>
        Channel<span class="token operator">*</span> _pSocketAChannel<span class="token punctuation">;</span>
        IAcceptorCallback<span class="token operator">*</span> _pCallback<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>è·³åˆ°Acceptor.ccå†…<br/> ç›´æ¥çœ‹start,</p>
<h2><a id="Acceptorcc_263"></a>Acceptor.cc</h2>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Acceptor.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IAcceptorCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

Acceptor<span class="token operator">::</span><span class="token function">Acceptor</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_listenfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pSocketAChannel</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pCallback</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

Acceptor<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Acceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _listenfd <span class="token operator">=</span> <span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pSocketAChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span>_pLoop<span class="token punctuation">,</span> _listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pSocketAChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pSocketAChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Acceptor<span class="token operator">::</span><span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    _listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in servaddr<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no-block io</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">11111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"bind error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">listen</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> MAX_LISTENFD<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"listen error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> connfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in cliaddr<span class="token punctuation">;</span>
    socklen_t clilen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cliaddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clilen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>connfd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"new connection from "</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>cliaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> 
            <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>cliaddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">" new socket fd:"</span> <span class="token operator">&lt;&lt;</span> connfd
            <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"accept error, connfd:"</span> <span class="token operator">&lt;&lt;</span> connfd
            <span class="token operator">&lt;&lt;</span> <span class="token string">" errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no-block io</span>

    _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">newConnection</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IAcceptorCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pCallback <span class="token operator">=</span> pCallback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>å¯ä»¥çŸ¥é“è¿™ä¸ªAcceptorç±»æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªç›‘å¬å¥—æ¥å­—ï¼Œå†new äº†ä¸€ä¸ªChannelï¼Œåœ¨å…¶æ„é€ å‡½æ•°ä¼ å…¥listenfd,é‚£è¿™ä¸ªChannelæ˜¯ä»€ä¹ˆç±»å‘¢ï¼Ÿ<br/> Channelçš„åŸæ„æ˜¯é¢‘é“ï¼Œæ³¢æ®µï¼Œæˆ‘è§‰å¾—è¿™ä¸ªChannelæ›´åƒæ˜¯æ–‡ä»¶æè¿°ç¬¦å¯¹äºepollçš„ä¸€å±‚å°è£…ã€‚</p>
<h2><a id="Channelh_356"></a>Channel.h</h2>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CHANNEL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CHANNEL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Channel</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Channel</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IChannelCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setRevents</span><span class="token punctuation">(</span><span class="token keyword">int</span> revent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">disableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> <span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> _sockfd<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _events<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _revents<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _index<span class="token punctuation">;</span>
        IChannelCallback<span class="token operator">*</span> _pCallback<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<h2><a id="Channelcpp_393"></a>Channel.cpp</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

Channel<span class="token operator">::</span><span class="token function">Channel</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_sockfd</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_events</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_revents</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_index</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pCallback</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IChannelCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pCallback <span class="token operator">=</span> pCallback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setRevents</span><span class="token punctuation">(</span><span class="token keyword">int</span> revents<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _revents <span class="token operator">=</span> revents<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _index <span class="token operator">=</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_revents <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_revents <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">|</span><span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">|</span><span class="token operator">=</span> EPOLLOUT<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">disableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>EPOLLOUT<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> Channel<span class="token operator">::</span><span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pLoop<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _sockfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>å¯ä»¥çœ‹å‡ºå¯¹è¿™ä¸ªç±»çš„æ“ä½œä»…ä»…æ˜¯å¯¹æ–‡ä»¶æè¿°ç¬¦çš„eventså±æ€§åšäº†ä¿®æ”¹ï¼Œå†åœ¨_pLoopä¸­updateäº†è¿™ä¸ªå¯¹è±¡ï¼Œåœ¨Acceptor::startçš„enableReadingä¹Ÿå°±æ˜¯å°†è¿™ä¸ªä¿®æ”¹äº†çš„æ–‡ä»¶æè¿°ç¬¦è®©å…¶epollçš„å±æ€§è®¾ç½®ä¸ºEPOLLINï¼ŒenableWritingè°ƒç”¨çš„EventLoop::update</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel <span class="token operator">*</span>pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¼šåœ¨å…¶Epoll *_pPollerå†…updateè¿™ä¸ªChannel,ä¹Ÿå°±æ˜¯è°ƒç”¨äº† ::epoll_ctlã€€EPOLL_CTL_ADDæˆ–è€…EPOLL_CTL_MOD</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kNew<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setIndex</span><span class="token punctuation">(</span>kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯è§åœ¨è¿™ä¸ªTcpServerä¸­çš„Acceptoræˆå‘˜ä¼šé€šè¿‡Channelåœ¨EventLoopçš„Epollå¯¹è±¡ä¸­å°†listenfdç›‘å¬å¥—æ¥å­—è®©epollå»ç›‘å¬ã€‚<br/> ä¸€æ­¥æ­¥å›åˆ°EchoServer.start å®ƒæ¥ç€è°ƒç”¨äº†threadpoll.start(3)ä¹Ÿå°±æ˜¯è®©çº¿ç¨‹æ± å¼€å¯äº†ï¼“ä¸ªçº¿ç¨‹</p>
<p>å®ƒçš„çº¿ç¨‹æ± å®ç°ï¼š<br/> ThreadPool.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> THREADPOOL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> THREADPOOL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"BlockingQueue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token operator">:</span> <span class="token keyword">public</span> IRun0
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BlockingQueue<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> _tasks<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Thread<span class="token operator">*</span><span class="token operator">&gt;</span> _threads<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>ThreadPool.cc</p>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ThreadPool.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Thread.h"</span></span>

ThreadPool<span class="token operator">::</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _threads<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//runInThread  while 1</span>
        Thread<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//virtual for Thread</span>
<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">addTask</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//virtual for Thread class</span>
<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä»è·¨çº¿ç¨‹çš„é˜»å¡é˜Ÿåˆ—å–å‡ºä»»åŠ¡æ‰§è¡Œ</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>åˆ©ç”¨çš„é˜»å¡é˜Ÿåˆ—<br/> BlockingQueue.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> BLOCKINGQUEUE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BLOCKINGQUEUE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;deque&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Condition.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">BlockingQueue</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">BlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_cond</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> one<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _cond<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        T <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token punctuation">}</span>
            T <span class="token function">front</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> front<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _queue<span class="token punctuation">;</span>
        MutexLock _mutex<span class="token punctuation">;</span>
        Condition _cond<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>å…¶ä¸­çš„é”å’Œæ¡ä»¶å˜é‡</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MUTEX_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">MutexLock</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pthread_mutex_t<span class="token operator">*</span> <span class="token function">getPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>_mutexid<span class="token punctuation">;</span>       
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        pthread_mutex_t _mutexid<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MutexLockGuard</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">MutexLockGuard</span><span class="token punctuation">(</span>MutexLock<span class="token operator">&amp;</span> mutex<span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">MutexLockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        MutexLock<span class="token operator">&amp;</span> _mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>Conition.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CONDITION_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CONDITION_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Condition</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Condition</span><span class="token punctuation">(</span>MutexLock<span class="token operator">&amp;</span> mutex<span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">,</span> _mutex<span class="token punctuation">.</span><span class="token function">getPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        MutexLock<span class="token operator">&amp;</span> _mutex<span class="token punctuation">;</span>
        pthread_cond_t _condid<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>è¿™é‡Œä¸è¯´ä»€ä¹ˆï¼Œç›´æ¥çœ‹ThreadPool::start</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _threads<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//runInThread  while 1</span>
        Thread<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>åœ¨ä¸€ä¸ªçº¿ç¨‹çš„æŒ‡é’ˆvectorä¸­é€æ¸åŠ å…¥newçš„ThreadæŒ‡é’ˆã€‚è‚¯å®šç–‘æƒ‘çš„æ˜¯è¿™ä¸ªtaskä»»åŠ¡æ˜¯ä»€ä¹ˆ</p>
<p>task.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> TASK_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TASK_H </span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Task</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Task</span><span class="token punctuation">(</span>IRun0<span class="token operator">*</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Task</span><span class="token punctuation">(</span>IRun2<span class="token operator">*</span> func<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        IRun0<span class="token operator">*</span> _func0<span class="token punctuation">;</span>
        IRun2<span class="token operator">*</span> _func2<span class="token punctuation">;</span>
        std<span class="token operator">::</span>string _str<span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token operator">*</span> _param<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>task.cc</p>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>

Task<span class="token operator">::</span><span class="token function">Task</span><span class="token punctuation">(</span>IRun0<span class="token operator">*</span> func<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_func0</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_func2</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_param</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

Task<span class="token operator">::</span><span class="token function">Task</span><span class="token punctuation">(</span>IRun2<span class="token operator">*</span> func<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_func0</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_func2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_str</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_param</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> Task<span class="token operator">::</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>_func0<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _func0<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        _func2<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run2</span><span class="token punctuation">(</span>_str<span class="token punctuation">,</span> _param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>çœ‹å‡ºæ¥taskåªæ˜¯æ ¹æ®å®ƒä¼ å…¥çš„å‚æ•°ä¸ªæ•°åˆ†åˆ«è°ƒç”¨ç›¸åº”çš„run0æˆ–è€…run2ã€‚<br/> è€ŒThreadPoolå®ç°çš„run0ç”±ç»•åœˆå­çš„è°ƒç”¨äº†runInThreadä¹Ÿå°±æ˜¯</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ä»è·¨çº¿ç¨‹çš„é˜»å¡é˜Ÿåˆ—å–å‡ºä»»åŠ¡æ‰§è¡Œ</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°æ˜¯ä»_tasksé˜»å¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚<br/> æ‰€ä»¥æ¯ä¸ªçº¿ç¨‹çš„ä»»åŠ¡ä¹Ÿå°±æ˜¯å¾ªç¯ç€å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚å½“ç„¶æ­¤æ—¶ä»»åŠ¡é˜Ÿåˆ—æ˜¯ç©ºçš„ã€‚</p>
<p>æ­¤æ—¶echoserver.startå·²ç»å¥½äº†<br/> æ¥ç€çœ‹loop.loop();</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> EVENTLOOP_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EVENTLOOP_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventLoop</span> <span class="token operator">:</span> <span class="token keyword">public</span> IChannelCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">runInLoop</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp when<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">cancelTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timerfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> <span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> _quit<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> _callingPendingFunctors<span class="token punctuation">;</span>
        Epoll<span class="token operator">*</span> _pPoller<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _eventfd<span class="token punctuation">;</span>
        <span class="token keyword">const</span> pid_t _threadId<span class="token punctuation">;</span>
        Channel<span class="token operator">*</span> _pEventfdChannel<span class="token punctuation">;</span>
        MutexLock _mutex<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> _pendingFunctors<span class="token punctuation">;</span>
        TimerQueue<span class="token operator">*</span> _pTimerQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/eventfd.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Epoll.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TimerQueue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Timestamp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"CurrentThread.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

EventLoop<span class="token operator">::</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">_quit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_callingPendingFunctors</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_pPoller</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Memory Leak !!!</span>
      <span class="token punctuation">,</span>
      <span class="token function">_threadId</span><span class="token punctuation">(</span>CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_pTimerQueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TimerQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Memory Leak!!!</span>
<span class="token punctuation">{<!-- --></span>
    _eventfd <span class="token operator">=</span> <span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pEventfdChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pEventfdChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pEventfdChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

EventLoop<span class="token operator">::</span><span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_quit<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"loop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid : %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Channel <span class="token operator">*</span><span class="token operator">&gt;</span> channels<span class="token punctuation">;</span>
        _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vector<span class="token operator">&lt;</span>Channel <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> channels<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> channels<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"for"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel <span class="token operator">*</span>pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pendingFunctors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _callingPendingFunctors<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">runInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        task<span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::wakeup() writes "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> EventLoop<span class="token operator">::</span><span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> evtfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK <span class="token operator">|</span> EFD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evtfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed in eventfd"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> evtfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">read</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventEventLoop::handleRead() reads "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid -  %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tempRuns<span class="token punctuation">;</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tempRuns<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pendingFunctors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> tempRuns<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> tempRuns<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        it<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp when<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> when<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> Timestamp<span class="token operator">::</span><span class="token function">nowAfter</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> Timestamp<span class="token operator">::</span><span class="token function">nowAfter</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">cancelTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timerId<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">cancelTimer</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> EventLoop<span class="token operator">::</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _threadId <span class="token operator">==</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>åœ¨loopä¸­è°ƒç”¨<code>_pPoller-&gt;poll</code> ä¹Ÿå°±æ˜¯ä½¿ç”¨epoll_waitç›‘å¬äº‹ä»¶ã€‚</p>
<p>Epoll.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> EPOLL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EPOLL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Epoll</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span> pChannels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _epollfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> epoll_event _events<span class="token punctuation">[</span>MAX_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>Epoll.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Epoll.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> kNew <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> kAdded <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

Epoll<span class="token operator">::</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _epollfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_epollfd <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_create error, errno:"</span> <span class="token operator">&lt;&lt;</span> _epollfd <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Epoll<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">poll</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span> pChannels<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fds <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> _events<span class="token punctuation">,</span> MAX_EVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fds <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_wait error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Channel<span class="token operator">*</span> pChannel <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setRevents</span><span class="token punctuation">(</span>_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannels<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kNew<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setIndex</span><span class="token punctuation">(</span>kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ä»pollå¯è§é€šè¿‡<code>_events[i].data.ptr</code>å–å‡ºChannelæŒ‡é’ˆï¼Œå¹¶è¿”å›ä¸€ä¸ªChannelæŒ‡é’ˆvectorï¼Œç´§æ¥ç€EventLoop::loopéå†vector,å¦‚æœäº‹ä»¶æ˜¯EPOLLINè°ƒç”¨è¯»æ“ä½œ ,æˆ–è€…æ˜¯EPOLLOUTè°ƒç”¨å†™æ“ä½œ</p>
<p>å¦‚æœæœ‰å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶æ¥ä¸´ï¼Œä¼šè°ƒç”¨Acceptor::handleReadæ¥å—è¿æ¥å¹¶å›è°ƒTcpServer::newConnectionå…¶ä¸­ä¼šnewä¸€ä¸ª TcpConnectionå¹¶åœ¨æ„é€ å‡½æ•°ä¸­newå‡ºä¸€ä¸ªæœ‰è¿æ¥å¥—æ¥å­—çš„ Channelï¼Œå¹¶è°ƒç”¨ã€€enableReadingå°†å…¶è®©epollç›‘å¬ã€‚æ¥ç€åœ¨TcpConnection::connectEstablishedä¸­å›è°ƒEchoServer::onConnectionæ‰“å°äº†ä¸‹å‡½æ•°åï¼Œå½“ç„¶å¯ä»¥ç”¨æ¥ã€€æ‰“å°æ—¥å¿—</p>
<p>æ­¤åˆ»è¿æ¥çš„å…¨éƒ¨å·¥ä½œç»“æŸã€‚</p>
<p>å½“å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€€epoll_waitè¿”å›ï¼Œloopä¸­è°ƒç”¨TcpConnection::handleRead è¯»å–è¾“å…¥ï¼Œ</p>
<pre><code class="prism language-cpp">        string <span class="token function">linestr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> readlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _inBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>linestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pUser<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>_inBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>åœ¨åº”ç”¨å±‚è¾“å…¥ç¼“å†²åŒº_inbufä¸­å†™å…¥è¯»å–çš„å†…å®¹ã€‚<br/> è°ƒç”¨EchoServer::onMessage</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MESSAGE_LENGTH<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAsString</span><span class="token punctuation">(</span>MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAllAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>(åŸåšä¸»çš„è¿™ä¸ªå‡½æ•°å†™çš„æœ‰é—®é¢˜ï¼Œæˆ‘ä¿®æ”¹äº†ä¸‹)<br/> å¤§è‡´æ„æ€æ˜¯ä»ç¼“å†²åŒºä¸­æ¯æ¬¡å–å‡ºå®šé•¿å‘é€ã€€è¿™é‡Œå®šé•¿æ˜¯MESSAGE_LENGTHï¼Œå½“ç„¶æœ€åå°äºMESSAGE_LENGTHçš„ä¹Ÿå‘ï¼Œè¿™é‡Œçš„Bufferç±»ä¸éš¾ï¼Œå¯ä»¥ç›´æ¥çœ‹æºç ã€‚æ¥ç€å®ƒè¿™é‡Œæ˜¯å®šä¹‰ä¸€ä¸ªå«æœ‰messageçš„Task,å¹¶æ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼Œthreadpoolçš„ä¸‰ä¸ªçº¿ç¨‹ä¼šæœ‰çº¿ç¨‹æ¥æ‰§è¡Œï¼Œç”±äºæ˜¯ä¸‰å‚æ•°çš„ä»»åŠ¡ä¼šè°ƒç”¨EchoServer::run2ï¼Œä¸ºæ¨¡æ‹Ÿè®¡ç®—å¯†é›†å‹çš„çº¿ç¨‹ï¼Œå®ƒåœ¨run2ä¸­è°ƒç”¨äº†é€’å½’çš„Fibonacciå‡½æ•°ï¼Œæ¥ç€å†è°ƒç”¨TcpConnection::sendã€‚</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//IO blocking task or CPU busy task</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fib(30) = "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" tid = "</span> <span class="token operator">&lt;&lt;</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span><span class="token punctuation">)</span>tcp<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fib is short for Fibonacci, fib is a CPU busy method</span>
<span class="token keyword">int</span> EchoServer<span class="token operator">::</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ¥ç€sendå‡½æ•°ä¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯Eventloop(ç”¨æ¥io)çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ç›´æ¥è°ƒç”¨sendInLoopï¼Œå¦åˆ™å°†è°ƒç”¨runInLoopã€‚å› ä¸ºsendæ˜¯çº¿ç¨‹æ± ä¸­å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ï¼Œè€Œioæ˜¯ä¸»çº¿ç¨‹åšçš„ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨_pLoop-&gt;runInLoop</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">runInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        task<span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å…¶ä¸­è¿˜ä¼šæ£€éªŒä¸€æ¬¡æ˜¯ä¸æ˜¯ioçº¿ç¨‹,æ˜¯åˆ™æ‰§è¡Œä»»åŠ¡ï¼Œæ­¤æ—¶ä¸æ˜¯ï¼Œåˆ™å°†æ‰§è¡ŒqueueInLoop</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pendingFunctors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _callingPendingFunctors<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å…¶ä¸­ä¼šå°†ä»»åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªvectorä¸­ï¼Œå†ä¸€æ¬¡åˆ¤æ–­æ˜¯ä¸æ˜¯ioçº¿ç¨‹ï¼Œæ­¤æ—¶ä¸æ˜¯ï¼Œæ‰§è¡Œwakeup();å§‘ä¸”å…ˆä¸ç®¡_callingPendingFunctorsã€‚</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::wakeup() writes "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯è§wakeupæ˜¯å†™å‘ä¸€ä¸ª_eventfd,è€Œè¿™ä¸ª_eventfdæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> EventLoop<span class="token operator">::</span><span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> evtfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK <span class="token operator">|</span> EFD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evtfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed in eventfd"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> evtfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°linuxçš„æ–°api eventfdç”Ÿæˆä¸€ä¸ªäº‹ä»¶æ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬å§‘ä¸”ä¸ç®¡è¿™ä¸ªæè¿°ç¬¦åœ¨å…¶ä»–é¢†åŸŸçš„ä½œç”¨ï¼Œæ­¤æ—¶å®ƒä¹Ÿæ˜¯epollå¯ä»¥é€‰æ‹©å»ç›‘å¬çš„(åœ¨EventLoopçš„æ„é€ å‡½æ•°ä¸­å°±è°ƒç”¨äº†new Channel +enableReading )</p>
<p>è€Œå½“æˆ‘ä»¬æ‰§è¡Œwrite(_eventfd)çš„æ—¶å€™ï¼Œå¦‚æœepoll_waitæ²¡æœ‰è¿”å›ï¼Œã€€epoll_waitä¼šå”¤é†’å¹¶é€šçŸ¥ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œè¿™é‡Œæ˜¯EventLoop::handleRead,å…¶ä¸­ä»…ä»…æ˜¯è¯»å–äº†åˆšåˆšwakeupå‘é€çš„å†…å®¹ï¼Œå…¶ä½œç”¨ä¹Ÿå°±æ˜¯è®©æ²‰ç¡çš„loopå”¤é†’è€Œå·²ã€‚</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">read</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventEventLoop::handleRead() reads "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>åœ¨loopå†…çš„forè½®è®¯ç»“æŸåï¼Œä¼šè°ƒç”¨ä¸€ä¸ªå‡½æ•°doPendingFunctorsã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šå»æ‰§è¡Œåˆšåˆšæˆ‘ä»¬æ”¾å…¥ä»»åŠ¡vectorå†…çš„ä»»åŠ¡ï¼Œæ‰§è¡ŒTcpConnection::run2å…¶ä¸­è°ƒç”¨sendInLoopï¼Œå°†æ¶ˆæ¯å‘é€ç»™ç›¸åº”çš„å®¢æˆ·ç«¯ã€‚åœ¨å…¶ä¸­çœ‹åˆ°äº†åˆšæ‰æ‰€è§çš„_callingPendingFunctorsï¼Œå®ƒçš„ç”¨æ„å¯èƒ½æ˜¯å¸Œæœ›åœ¨loopæ‰§è¡ŒdoPendingFunctorsçš„æ—¶å€™è°ƒç”¨weakupè®©ä¸‹ä¸€è½®çš„epoll_waitç›‘å¬.</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid -  %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tempRuns<span class="token punctuation">;</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tempRuns<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pendingFunctors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> tempRuns<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> tempRuns<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        it<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ¥ç€æˆ‘ä»¬çœ‹sendInLoopè¿™ä¸ªå‘é€ç»™å®¢æˆ·æ¶ˆæ¯çš„å‡½æ•°</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> TcpConnection<span class="token operator">::</span><span class="token function">sendInLoop</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> message<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_outBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"write error"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _pLoop<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//invoke onWriteComplate</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> n <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _outBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_pSocketChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _pSocketChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//add EPOLLOUT</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>è¿™é‡Œæ˜¯éœ€è¦å‘é€_outBufï¼‹message</p>
<p>å¦‚æœæ²¡å‘å®Œå°†messageæ”¾å…¥_outBufä¸­ï¼Œå¦‚æœå‘å®Œäº†å†å»Eventloopæ”¾ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡æœ€ç»ˆä¼šæ‰§è¡ŒTcpConnection::run0ï¼Œå†æ‰§è¡ŒEchoServer::onWriteComplateï¼Œè¿™é‡Œä»…ä»…æ‰“å°äº†å‡½æ•°åç§°ã€‚</p>
<p>å†ç»åƒè¾›ä¸‡è‹¦ï¼Œæ•´æ¬¡Echoå®Œæ¯•ã€‚</p>
<p>æˆ‘ç§¯ç´¯åˆ°çš„ç»éªŒï¼š<br/> ï¼‘. å¤šçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•ã€‚<br/> ï¼’.ç½‘ç»œæ¨¡å‹çš„è§£è€¦<br/> ï¼“.é˜»å¡é˜Ÿåˆ—BlockingQueueçš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>è®¡æ—¶å™¨è¿™é‡Œæ²¡è®²ï¼Œå®ƒè¿™ä¸ªç‰ˆæœ¬çš„ç¨‹åºå¿½ç•¥äº†è®¡æ—¶å™¨ã€‚åœ¨å‰å‡ ä¸ªç‰ˆæœ¬ä¸­æœ‰å†™ï¼Œä½†æˆ‘è§‰å¾—å®ƒç”¨çš„ä¹Ÿä¸å¥½ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹åŸåšä¸»çš„æºç ã€‚<br/> <a href="https://github.com/voidccc/mini-muduo">voidccc/mini-muduo<br/> </a></p>
<p>æˆ‘ç¨å¾®ä¿®æ”¹è¿‡ä¸€ç‚¹ç‚¹çš„<br/> <a href="https://github.com/adlternative/LinuxLearn/tree/master/mini-muduo-learn">adlternative/mini-muduo-learn</a></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>è¿™æ¬¡å†™çš„æ˜¯ä¸€ä¸ªç½‘ç»œç‰ˆäº”å­æ£‹</p>
<p>æ€ä¹ˆè¯´çš„ï¼Œè¿™æ¬¡çš„cppæ–‡ä»¶æ–‡ä»¶æ¯”è¾ƒå¤šï¼Œæˆ‘å°±è´´ä¸ªgithubä»£ç å§</p>
<p><a href="https://github.com/adlternative/c-2/tree/master/games">github</a><br/> ç¼–è¯‘ä¸»è¦çœ‹ makefileé‡Œé‚£å‡ ä¸ªæ–‡ä»¶<br/> å®ç°äº†ã€€ç™»å½•ã€€åŒ¹é…ä¸‹æ£‹ã€‚</p>
<p>æœåŠ¡å™¨ç”¨äº†ã€€epoll+çº¿ç¨‹æ± ï¼ˆæ¨¡ä»¿ã€Šlinuxé«˜æ€§èƒ½ç¼–ç¨‹å†™çš„ã€‹ï¼‰ä½†è¿™æ¬¡çš„æ•™è®­å°±æ˜¯è¿™ä¸ªæ£‹å±€çš„ä¸»ä½“ä¸šåŠ¡é€»è¾‘åº”è¯¥æ”¾åœ¨æœåŠ¡å™¨ï¼ˆæˆ‘å†™åœ¨å®¢æˆ·ç«¯ç”±å®¢æˆ·ç«¯åˆ¤æ–­æ£‹å±€æ˜¯å¦ç»“æŸï¼‰ï¼Œè€Œä¸”çº¿ç¨‹æ± å¤„ç†ä¹Ÿæ˜¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œåœ¨è¿™ç§ä¿©ä¸ªç”¨æˆ·å¹¶éåŒæ—¶ä¸‹æ£‹çš„ç¨‹åºä¸­å¯ä»¥ä¸ç”¨ã€‚æ›´ä½•å†µæ”¾åœ¨å®¢æˆ·ç«¯çš„ä¸šåŠ¡é€»è¾‘å¯ä»¥ä¼ªé€ çš„ï¼Œè¿™æ ·æœåŠ¡å™¨å°±å¯èƒ½æ”¶åˆ°ä¼ªé€ çš„æ•°æ®ã€‚</p>
<p>ç»™å¤§å®¶çœ‹ä¸‹æ•ˆæœï¼š<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200817004521356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>ç»éªŒï¼š</p>
<ol><li>ç”±äºç”¨çš„æ˜¯PACKçš„bufferç¼“å­˜ç»™çº¿ç¨‹æ± çš„processå‡½æ•°æ‰§è¡Œï¼ˆåŒæ ·è¿˜æœ‰å†™ç¼“å†²ï¼‰, æ¯æ¬¡EPOLLIN è¯»å…¥åéœ€è¦åˆ‡æ¢ EPOLLOUT,å†™å‡ºåå†åˆ‡æ¢EPOLLIN,è¿™æ ·å°±ä¸ä¼šå¤šæ¬¡è¯»å…¥åˆ°åŒä¸€ç¼“å†²åŒºäº†ã€‚</li><li>c++çº¿ç¨‹ä¸­æƒ³è¦ä½¿ç”¨ç±»çš„å‡½æ•°ï¼Œå¾—éœ€è¦ <code>thread(clientUser::UI, this).detach();</code>åœ¨å‚æ•°ä¸­ä¼ å…¥å¯¹è±¡çš„æŒ‡é’ˆï¼ŒåŒæ—¶è¿™ä¸ªè°ƒç”¨çš„å‡½æ•°å¿…é¡»å¾—æ˜¯ç±»å†…çš„é™æ€å‡½æ•°ï¼Œä¸”è¿™ä¸ªé™æ€å‡½æ•°ä¹Ÿåªèƒ½è°ƒç”¨ç±»çš„é™æ€æˆå‘˜ï¼Œæƒ³è¦ä½¿ç”¨å¯¹è±¡åªèƒ½ä½¿ç”¨ä¼ è¿›æ¥çš„arg é€šè¿‡<code>clientUser *cu = (clientUser *) arg;</code>å†ä½¿ç”¨<code>cu-&gt;xxx</code>æ¥ä½¿ç”¨cuå†…çš„æˆå‘˜<br/> 3.è¾“å…¥å‡ºé”™é‡æ–°è¾“å…¥çš„c++æ–¹å¼</li></ol>
<pre><code class="prism language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cin <span class="token operator">&gt;&gt;</span> ch<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cin<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"è¾“å…¥æœ‰è¯¯"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
                cin<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cin<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>4.condition_variableä¸­è¦ä¼ é”å¾—æ˜¯unique_lock ï¼Œè€Œä¸æ˜¯mutexã€‚<br/> åŒæ—¶ä»æºç å¯çŸ¥è°ƒç”¨æ¡ä»¶å˜é‡çš„waitä¸­å¯ä»¥ä¼ å…¥çš„æ¡ä»¶æ˜¯while(!p)è€Œä¸æ˜¯if,ä¹Ÿå°±æ˜¯æ¡ä»¶ä¸æ»¡è¶³ä¼šé‡æ–°waitä¼‘çœ ã€‚</p>
<pre><code class="prism language-cpp">
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Predicate<span class="token operator">&gt;</span>
      <span class="token keyword">void</span>
      <span class="token function">wait</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __lock<span class="token punctuation">,</span> _Predicate __p<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__p</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token function">wait</span><span class="token punctuation">(</span>__lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre>
<p>5.ç±»çš„é™æ€æˆå‘˜çš„åˆå§‹åŒ–åœ¨ç±»å¤–ä¸èƒ½åœ¨.h,æ”¾å…¶ä¸­ä¸€ä¸ª.cppå³å¯ï¼ˆæœ€å¥½æ”¾åœ¨ç±»çš„.cppå†…ï¼‰<br/> 6.ç½‘ç»œå‘åŒ…çš„packä¸­ä¸èƒ½å‡ºç°å®¹å™¨,æœ¬æ¥å¾ˆæƒ³ç”¨string!<br/> 7.make_shared_ptr çš„å‚æ•°æ˜¯å¯¹è±¡è€Œä¸æ˜¯å¯¹è±¡æŒ‡é’ˆï¼Œå¦‚æœåœ¨ç±»ä¸­æœ‰shared_ptrå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥çš„newæŒ‡é’ˆåˆå§‹åŒ–ï¼Œ<br/> 8.ETæ¨¡å¼ä¸‹ readæ˜¯ä¸€æ¬¡è¯»å®Œåå‡ºç°EAGAIN ï¼ŒEWOULDBLOCKè¯´æ˜å®¢æˆ·å‘çš„å…¨éƒ¨è¯»äº†ï¼ˆæ˜¯å¯¹çš„ï¼‰ï¼Œè€Œæˆ‘ä½¿ç”¨åŒ…è£…æˆReadnæ°å¥½è¯»PACKçš„å¤§å°å¯èƒ½ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ã€‚<br/> 9.åŒ¹é…å¯ä»¥ä½¿ç”¨å¯¹è±¡æŒ‡é’ˆé˜Ÿåˆ—ï¼ŒåŒ¹é…æˆåŠŸæ”¾åœ¨ä¸€ä¸ªpairé›†åˆ,æ¯”èµ›ç»“æŸæˆ–è€…ç”¨æˆ·é€€å‡ºåˆ™éœ€è¦åœ¨é˜Ÿåˆ—å’Œé›†åˆç­‰å®¹å™¨ä¸­æ¸…é™¤å¯¹è±¡æŒ‡é’ˆ</p>
<ol start="10"><li><code>str = "SELECT * FROM information_schema.SCHEMATA where SCHEMA_NAME='chess'";</code>åˆ¤æ–­æ˜¯æœ‰chessè¿™ä¸ªæ•°æ®åº“ï¼Œ<code>str = "select TABLE_NAME from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA='chess' and TABLE_NAME='account'";</code>åˆ¤æ–­chessåº“æ˜¯å¦æœ‰accountè¡¨ã€‚</li><li>åˆšçœ‹äº†ç‚¹è®¾è®¡æ¨¡å¼ï¼Œè§‰å¾—è¿™ä¸ªæ˜¯å®¢æˆ·ç«¯çš„å®¢æˆ·ç±»æ˜¯éœ€è¦è®¾ç½®ä¸ºå•ä¾‹æ¨¡å¼çš„ã€‚å¹¶ä¸”è¿™æ¬¡çš„ç¨‹åºä»£ç å¤ç”¨æ€§ä¸å¼ºï¼Œæœ¬æƒ³åŒæ—¶ç»™äº”å­æ£‹ç±»è®¾è®¡çš„åˆ¤æ–­èƒœå‡ºè§„åˆ™æ”¾åœ¨äº†Tableç±»ï¼Œè€Œäº”å­æ£‹ç±»çš„çˆ¶ç±»ChessBaseå°±æ˜¾çš„å¾ˆç´¯èµ˜rule()æ²¡ç”¨ä¸Šï¼Œä¹‹åå†æƒ³æ–¹æ³•å®Œå–„ï¼Œå¯èƒ½æ˜¯å› ä¸ºä¸çŸ¥é“å›´æ£‹çš„è§„åˆ™ï¼Œæ²¡æ³•å®è·µc++ç»§æ‰¿ä½“ç³»ã€‚</li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<ul><li>ç¼–è¯‘å™¨ä¸æ£€æŸ¥è™šå‡½æ•°çš„å„ç±»å±æ€§:pub,pro,priã€‚ç»Ÿä¸€æ”¾äºè™šå‡½æ•°è¡¨</li><li>ç»§æ‰¿å±æ€§åªèƒ½æ”¹å˜å­ç±»ç»§æ‰¿ä¸‹æ¥çš„å…ƒç´ åœ¨å­ç±»ä¸­çš„å±æ€§ï¼Œè€Œå³ä½¿æ˜¯priç»§æ‰¿å­ç±»åŒæ ·å¯ä»¥è®¿é—®åŸºç±»ç»§æ‰¿ä¸‹æ¥çš„prompubå±æ€§æˆå‘˜</li><li>ææ„çš„å¼‚å¸¸å¤„ç†1ï¼štry catch record abort ,2ï¼šclose +flag + try catch</li><li>åŸºç±»ææ„,æ„é€ åˆ«ç”¨å­ç±»çš„è™šå‡½æ•°ï¼ˆä¼šè¢«è§£é‡Šä¸ºåŸºç±»çš„è™šå‡½æ•°ï¼‰ï¼Œå¯ä»¥é€šè¿‡å­ç±»é™æ€éè™šç±»å‡½æ•°æ„é€ åŸºç±»</li><li>operator= è‡ªèµ‹å€¼ return *this,new temp/copy-and-swap</li><li>copy copy-assign å¯ç”¨ç¬¬ä¸‰ä¸ªinit(pri)æ¥ä»£æ›¿</li><li>ç”¨non_memberå‡½æ•°è°ƒç”¨pubæˆå‘˜å‡½æ•°ä»¥æä¾›è¾ƒå¤§å°è£…æ€§ï¼Œè‹¥ä½¿ç”¨memberå‡½æ•°åˆ™å¯è®¿é—®ç§æœ‰ï¼Œç ´ååˆ†è£…ï¼ŒåŠ å¤§åæœŸç»´æŠ¤ï¼ˆè¶Šå°‘è®¿é—®priè¶Šå¥½å°è£…æ€§ï¼‰</li><li>class +swap(member)(using std::swap)+swap(non_member)+std::swap, template +swap(member)(using std::swap)+swap(non_member)</li><li>ä¸´æ—¶å¯¹è±¡çš„æˆå‘˜æŒ‡é’ˆä¼ å‡ºå¯é€ æˆç©ºæ‚¬</li><li>copy+swap æ¥å®ç°å¼ºçƒˆä¿è¯ï¼ˆå¼‚å¸¸å®‰å…¨ï¼‰ï¼ˆå¯èƒ½æ— æ³•å…¨ç¾ï¼‰ã€‚</li><li>Handle classes(impl with obj,handle with shared_ptr impl and å¯èƒ½ä¼šåœ¨æ„é€ å‡½æ•°ä½¿ç”¨çš„classçš„å£°æ˜) ,Interface classes(static create derive class with shared_ptr)</li><li>ä½¿ç”¨çº¯è™šå‡½æ•°ï¼Œè¿™æ ·å­ç±»å¿…é¡»é‡å†™æ¥å£ï¼ˆé¿å…é—å¿˜è€Œå¯¼è‡´ä½¿ç”¨é»˜è®¤çš„çˆ¶ç±»è™šå‡½æ•°ï¼‰ï¼Œçˆ¶ç±»çº¯è™šå‡½æ•°å¯ä»¥æœ‰å®ç°ä½“ï¼ˆå¯ç”¨äºé»˜è®¤ï¼Œå­ç±»å¿…é¡»ï¼šï¼šä½¿ç”¨ï¼‰</li><li>NVI çˆ¶ç±»æ¥å£pubè°ƒè™šå‡½æ•°pri,å­ç±»å¯ä¿®æ”¹è™šå‡½æ•°å®šä¹‰ã€‚priè™šå‡½æ•°å­ç±»åªèƒ½é‡å†™ï¼Œä¸èƒ½ä½¿ç”¨ã€‚è‹¥è¦ä½¿ç”¨ pro,pub</li><li>å¸¦æœ‰é»˜è®¤å‚æ•°çš„è™šå‡½æ•°ä¼šä½¿ç”¨é™æ€çš„é»˜è®¤å‚æ•°ï¼Œè§£å†³æ–¹æ¡ˆNVIï¼Œé»˜è®¤å®å‚ç»™</li><li>ç”¨listå®ç°set (implé€šè¿‡pri list+pub æ¥å£)è€Œépublicç»§æ‰¿ï¼Œå’Œstack dequeç±»ä¼¼ï¼Œå°†deque ä½œä¸º æ¨¡æ¿+pro</li><li>å°†ä¸å¸Œæœ›è®©å­ç±»ä¿®æ”¹çˆ¶ç±»ç»§æ‰¿çˆ¶ç±»çš„çˆ¶ç±»çš„vitualå‡½æ•°å¯ä»¥ä¿®æ”¹ç»“æ„è®©çˆ¶ç±»çš„ç§æœ‰æˆå‘˜(å†…éƒ¨ç±»)pubç»§æ‰¿çˆ¶ç±»çš„çˆ¶ç±»ã€‚å¦‚æœä»…ä»…è®©çˆ¶ç±»priç»§æ‰¿çˆ¶ç±»çš„çˆ¶ç±»æ˜¯ä¸è¡Œçš„ï¼Œå­ç±»è¿˜æ˜¯å¯ä»¥ä¿®æ”¹è™šå‡½æ•°ï¼Œå°½ç®¡ä»–ä¸èƒ½ä½¿ç”¨</li><li>éœ€è¦ç±»å‹è½¬æ¢æ—¶è¯·ä¸ºæ¨¡æ¿å®šä¹‰éæˆå‘˜å‡½æ•°+å‹å…ƒï¼ˆä¸ºäº†ç”Ÿæˆå‡½æ•°ï¼Œä¹‹åæ‰èƒ½æ¨å¯¼ç±»å‹è½¬æ¢ï¼‰</li><li>é€šè¿‡æ¨¡æ¿çš„å‹å…ƒç±»å†…å®šä¹‰å¯ä»¥è®©è¯¥å‡½æ•°è‡ªåŠ¨å…·ç°åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨å‚æ•°çš„ç±»å‹è½¬æ¢ï¼ˆæ¨¡æ¿æ–¹å¯æ¨å¯¼ï¼‰<br/> <code>friend ostream &amp;operator&lt;&lt;&lt;&gt;(ostream &amp;os, A&lt;T&gt; a)</code>;éœ€è¦å‰ç½®å£°æ˜ï¼Œ<br/> æˆ–è€…è¿™æ ·</li></ul>
<pre><code class="prism language-c">  template<span class="token operator">&lt;</span>typename U<span class="token operator">&gt;</span>
  friend
  ostream <span class="token operator">&amp;</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">,</span> A<span class="token operator">&lt;</span>U<span class="token operator">&gt;</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//ç±»å†…å£°æ˜ï¼Œä¹‹åç±»å¤–å®šä¹‰</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä»¥åçŸ¥é“ä¸€ä¸ªå†™ä¸€ä¸ª</p>
<p><strong>valgrind</strong><br/> å¯ç”¨æ¥æ£€éªŒå†…å­˜æ³„æ¼å‡ºå¤„<br/> valgrind --tool=memcheck --leak-check=full ./test</p>
<pre><code class="prism language-shell">adl@adl:~/æ¡Œé¢/json-tutorial/tutorial03/images$ valgrind  ./leptjson_test --leak-check<span class="token operator">=</span>full
<span class="token operator">==</span>7458<span class="token operator">==</span> Memcheck, a memory error detector
<span class="token operator">==</span>7458<span class="token operator">==</span> Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2002-2017, and GNU GPL<span class="token string">'d, by Julian Seward et al.
==7458== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==7458== Command: ./leptjson_test --leak-check=full
==7458== 
160/160 (100.00%) passed
==7458== 
==7458== HEAP SUMMARY:
==7458==     in use at exit: 6 bytes in 1 blocks
==7458==   total heap usage: 12 allocs, 11 frees, 2,092 bytes allocated
==7458== 
==7458== LEAK SUMMARY:
==7458==    definitely lost: 6 bytes in 1 blocks
==7458==    indirectly lost: 0 bytes in 0 blocks
==7458==      possibly lost: 0 bytes in 0 blocks
==7458==    still reachable: 0 bytes in 0 blocks
==7458==         suppressed: 0 bytes in 0 blocks
==7458== Rerun with --leak-check=full to see details of leaked memory
==7458== 
==7458== For counts of detected and suppressed errors, rerun with: -v
==7458== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
adl@adl:~/æ¡Œé¢/json-tutorial/tutorial03/images$ valgrind --tool=memcheck --leak-check=full ./
CMakeFiles/    leptjson_test  
adl@adl:~/æ¡Œé¢/json-tutorial/tutorial03/images$ valgrind --tool=memcheck --leak-check=full ./leptjson_test 
==7516== Memcheck, a memory error detector
==7516== Copyright (C) 2002-2017, and GNU GPL'</span>d, by Julian Seward et al.
<span class="token operator">==</span>7516<span class="token operator">==</span> Using Valgrind-3.13.0 and LibVEX<span class="token punctuation">;</span> rerun with -h <span class="token keyword">for</span> copyright info
<span class="token operator">==</span>7516<span class="token operator">==</span> Command: ./leptjson_test
<span class="token operator">==</span>7516<span class="token operator">==</span> 
160/160 <span class="token punctuation">(</span>100.00%<span class="token punctuation">)</span> passed
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span>7516<span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: 6 bytes <span class="token keyword">in</span> 1 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>   total heap usage: 12 allocs, 11 frees, 2,092 bytes allocated
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> 6 bytes <span class="token keyword">in</span> 1 blocks are definitely lost <span class="token keyword">in</span> loss record 1 of 1
<span class="token operator">==</span>7516<span class="token operator">==</span>    at 0x4C2FB0F: malloc <span class="token punctuation">(</span>in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10F532: lept_set_string <span class="token punctuation">(</span>in /home/adl/æ¡Œé¢/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E83F: test_access_string <span class="token punctuation">(</span>in /home/adl/æ¡Œé¢/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E9AC: test_parse <span class="token punctuation">(</span>in /home/adl/æ¡Œé¢/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E9BD: main <span class="token punctuation">(</span>in /home/adl/æ¡Œé¢/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> LEAK SUMMARY:
<span class="token operator">==</span>7516<span class="token operator">==</span>    definitely lost: 6 bytes <span class="token keyword">in</span> 1 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>    indirectly lost: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>      possibly lost: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>    still reachable: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>         suppressed: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> For counts of detected and suppressed errors, rerun with: -v
<span class="token operator">==</span>7516<span class="token operator">==</span> ERROR SUMMARY: 1 errors from 1 contexts <span class="token punctuation">(</span>suppressed: 0 from 0<span class="token punctuation">)</span>
</code></pre>
<p><strong>telnet</strong></p>
<p>å¯å½“å®¢æˆ·ç«¯<br/> telnet 127.0.0.1 12345<br/> ï¼ˆä¼šæœ‰\r\nï¼‰<br/> <strong>nc</strong><br/> ncå¯ä»¥å½“æˆå®¢æˆ·æˆ–è€…æœåŠ¡å™¨</p>
<p><strong>tcpdump</strong><br/> æŠ“åŒ…<br/> sudo tcpdump -i lo tcp port 12345 and host 127.0.0.1<br/> [.]ACK, [R]RST,[F]FIN,[S]SYN [S.]SYN+ACK</p>
<p><strong>top -d</strong> æŸ¥çœ‹cpuå ç”¨æƒ…å†µï¼</p>
<p><strong>find</strong>ï¼ˆè¿™ä¸ªè®°ä¸‹æ˜¯å› ä¸ºè€æ˜¯å¿˜ï¼‰<br/> find . -maxdepth 5 -name â€œcJSON.*â€ æŒ‡å®šæŸ¥æ‰¾çš„æ·±åº¦ä¸º5</p>
<p><strong>ranger</strong><br/> ä¸€ä¸ªå¯ä»¥é€šè¿‡ä¸Šä¸‹å·¦å³å°±å¯ä»¥å¿«é€Ÿè®¿é—®å„çº§ç›®å½•çš„å‘½ä»¤<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200802224008409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> awk é…åˆ ps grep æ€æ­»ä½ æƒ³ç»“æŸçš„è¿›ç¨‹<br/> ps -ef | grep vim | awk â€˜{print $2}â€™| xargs kill -9</img></p>
<p>rm æƒ³å«æœ‰â€™-'æ–‡ä»¶åçš„æ–‡ä»¶<br/> è§£å†³æ–¹æ³•ï¼šåœ¨æ–‡ä»¶åä¹‹å‰åŠ â€â€“â€œæ¥åˆ é™¤æ–‡ä»¶</p>
<p>g++ æŒ‡å®šç¼–è¯‘ç‰ˆæœ¬<br/> <code>g++ -std=c++17 stdAnyTest.cpp</code></p>
<p>å°†ä¸€ä¸ªæ–‡ä»¶ä¸‹æ‰€æœ‰çš„åç¼€ä¸º<code>.cgi ---&gt;.py</code><br/> <code>rename 's/.py/.cgi/' *</code></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä¹‹å‰å†™èŠå¤©å®¤çš„æ—¶å€™ï¼Œå› ä¸ºæ„æ€ä¸å¤Ÿä¸¥è°¨ï¼Œè¿ç»­é‡æ„äº†å¥½å‡ æ¬¡ï¼Œä¹Ÿç®—æ˜¯è¸©äº†å¥½å¤šæ¬¡çš„å‘ã€‚è¿™æ¬¡å°±ç»™å¤§å®¶è®²ä¸‹æˆ‘å†™èŠå¤©å®¤çš„ä¸€ç‚¹ç‚¹ç»éªŒå’Œå»ºè®®ã€‚</p>
<ol><li>é‡‡ç”¨çš„ç­–ç•¥ï¼šè¿­ä»£æœåŠ¡å™¨è¿˜æ˜¯å¹¶å‘æœåŠ¡å™¨<br/> <em>è¿­ä»£æœåŠ¡å™¨</em><br/> æœåŠ¡å™¨è¿›ç¨‹æ˜¯ä¸€ä¸ªä¸€ä¸ªå¤„ç†å„ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„è¿æ¥çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªå®¢æˆ·ç«¯å‘æ¥ä¸€ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆåªè¦å®ƒè¿˜æ²¡æœ‰å®Œæˆè‡ªå·±çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆå®ƒå°±ä¸€ç›´ä¼šå ç”¨æœåŠ¡å™¨çš„è¿›ç¨‹ç›´åˆ°å¤„ç†å®Œæ¯•åæœåŠ¡å™¨å…³é—­æ‰è¿™ä¸ªsocketã€‚<br/> <em>å¹¶å‘æœåŠ¡å™¨</em><br/> æœ‰å¾ˆå¤šç§æ¨¡å‹ã€‚æœåŠ¡å™¨å¯¹äºå®¢æˆ·ç«¯åˆ°æ¥çš„è¯·æ±‚åœ¨çº¿ç¨‹ä¸­å¹¶å‘å¤„ç†ã€‚è¿™æ ·å¯ä»¥â€œåŒæ—¶â€å¤„ç†è€—æ—¶æ“ä½œã€‚<br/> æˆ‘å½“æ—¶å› ä¸ºçº¿ç¨‹æ± ä¸çŸ¥é“å¦‚ä½•éƒ¨ç½²ï¼ŒåŒ…æ‹¬æˆ‘çš„ä¸šåŠ¡é€»è¾‘å‡½æ•°çš„æ¥å£ä¸ä¸€è‡´ï¼Œå°±é‡‡ç”¨äº†è¿­ä»£æœåŠ¡å™¨</li></ol>
<p>æˆ‘çš„æœåŠ¡å™¨å¤§è‡´æ€è·¯ï¼š</p>
<div class="mermaid">
<svg height="187.1875" id="mermaid-svg-4RkGOVkWob97JqEZ" viewbox="0 0 1062.8125 207.1875" width="1042.8125" xmlns="http://www.w3.org/2000/svg">
<g>
<g class="output">
<g class="clusters"></g>
<g class="edgePaths">
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M81.359375,83.34553252382213L198.2578125,44.296875L315.15625,44.296875" marker-end="url(#arrowhead98)" style="fill:none"></path>
<defs>
<marker id="arrowhead98" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M81.359375,103.84196747617787L198.2578125,142.890625L359.7734375,142.890625" marker-end="url(#arrowhead99)" style="fill:none"></path>
<defs>
<marker id="arrowhead99" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M485.3828125,142.890625L713.6015625,142.890625L897.203125,142.890625" marker-end="url(#arrowhead100)" style="fill:none"></path>
<defs>
<marker id="arrowhead100" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
</g>
<g class="edgeLabels">
<g class="edgeLabel" style="opacity: 1;" transform="translate(198.2578125,44.296875)">
<g class="label" transform="translate(-72.328125,-14.296875)">
<foreignobject height="28.600000381469727" width="144.66717529296875">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">ç›‘å¬åˆ°lfdè¿æ¥äº‹ä»¶</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(198.2578125,142.890625)">
<g class="label" transform="translate(-91.8984375,-14.296875)">
<foreignobject height="28.600000381469727" width="183.8031005859375">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">ç›‘å¬åˆ°cfdå‘é€æ¶ˆæ¯äº‹ä»¶</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(713.6015625,142.890625)">
<g class="label" transform="translate(-158.6015625,-14.296875)">
<foreignobject height="28.600000381469727" width="317.2125244140625">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">æ ¹æ®å‘é€çš„ç»“æ„ä½“ä¸­ç›¸åº”çš„å­—æ®µæ¥switch</span>
</div>
</foreignobject>
</g>
</g>
</g>
<g class="nodes">
<g class="node" id="A" style="opacity: 1;" transform="translate(50.6796875,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="61.359375" x="-30.6796875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-20.6796875,-14.296875)">
<foreignobject height="28.600000381469727" width="41.370361328125">
<div style="display: inline-block; white-space: nowrap;">
          epoll
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="B" style="opacity: 1;" transform="translate(422.578125,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="214.84375" x="-107.421875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-97.421875,-14.296875)">
<foreignobject height="28.600000381469727" width="194.85467529296875">
<div style="display: inline-block; white-space: nowrap;">
          å»ºç«‹è¿æ¥,epollç›‘å¬æ–°cfd
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="C" style="opacity: 1;" transform="translate(422.578125,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          ä¸¢ç»™å¤„ç†å‡½æ•°
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="D" style="opacity: 1;" transform="translate(960.0078125,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          ä¸šåŠ¡å¤„ç†å‡½æ•°
         </div>
</foreignobject>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>æˆ‘çš„å®¢æˆ·ç«¯å¤§è‡´æ€è·¯ï¼š</p>
<div class="mermaid">
<svg height="187.1875" id="mermaid-svg-8wC1qD0R8dglmnAn" viewbox="0 0 1240.84375 207.1875" width="1220.84375" xmlns="http://www.w3.org/2000/svg">
<g>
<g class="output">
<g class="clusters"></g>
<g class="edgePaths">
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M110.40625,93.59375L135.40625,93.59375L160.40625,93.59375" marker-end="url(#arrowhead120)" style="fill:none"></path>
<defs>
<marker id="arrowhead120" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M283.83760895404123,69.296875L346.21875,44.296875L406.421875,44.296875" marker-end="url(#arrowhead121)" style="fill:none"></path>
<defs>
<marker id="arrowhead121" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M708.03125,44.296875L891.6328125,44.296875L1075.234375,44.296875" marker-end="url(#arrowhead122)" style="fill:none"></path>
<defs>
<marker id="arrowhead122" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M283.83760895404123,117.890625L346.21875,142.890625L468.0234375,142.890625" marker-end="url(#arrowhead123)" style="fill:none"></path>
<defs>
<marker id="arrowhead123" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
</g>
<g class="edgeLabels">
<g class="edgeLabel" style="opacity: 1;" transform="">
<g class="label" transform="translate(0,0)">
<foreignobject height="0" width="0">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel"></span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(346.21875,44.296875)">
<g class="label" transform="translate(-35.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="70.417236328125">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">ç™»å½•æˆåŠŸ</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(891.6328125,44.296875)">
<g class="label" transform="translate(-158.6015625,-14.296875)">
<foreignobject height="28.600000381469727" width="317.2125244140625">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">æ ¹æ®å‘é€çš„ç»“æ„ä½“ä¸­ç›¸åº”çš„å­—æ®µæ¥switch</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="">
<g class="label" transform="translate(0,0)">
<foreignobject height="0" width="0">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel"></span>
</div>
</foreignobject>
</g>
</g>
</g>
<g class="nodes">
<g class="node" id="I" style="opacity: 1;" transform="translate(65.203125,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="90.40625" x="-45.203125" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-35.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="70.417236328125">
<div style="display: inline-block; white-space: nowrap;">
          å»ºç«‹è¿æ¥
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="J" style="opacity: 1;" transform="translate(223.2109375,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          ç™»å½•ç•Œé¢ç›®å½•
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="K" style="opacity: 1;" transform="translate(557.2265625,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="301.609375" x="-150.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-140.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="281.6171875">
<div style="display: inline-block; white-space: nowrap;">
          å¼€å¯çº¿ç¨‹ç›‘å¬è¿æ¥æœåŠ¡å™¨å‘æ¥çš„æ¶ˆæ¯
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="Q" style="opacity: 1;" transform="translate(1138.0390625,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          å¤„ç†ä¸šåŠ¡é€»è¾‘
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="L" style="opacity: 1;" transform="translate(557.2265625,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="178.40625" x="-89.203125" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-79.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="158.41717529296875">
<div style="display: inline-block; white-space: nowrap;">
          ä¸»çº¿ç¨‹è¯»å–é”®ç›˜è¾“å…¥
         </div>
</foreignobject>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>æ³¨æ„ï¼šå…¶å®å®¢æˆ·ç«¯åŒæ ·æ˜¯å¯ä»¥ç”¨epollç›‘å¬stdinå’ŒæœåŠ¡å™¨å¥—æ¥å­—ã€‚<br/> (å¦å¤–éœ€è¦æåˆ°çš„ä¸€ç‚¹å°±æ˜¯åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¯»åŒä¸€ä¸ªå¥—æ¥å­—ï¼Œä½ å‘é€ç»™æœåŠ¡å™¨æ–‡ä»¶ï¼Œå¦‚æœè®©æœåŠ¡å™¨å¼€æ¥å—æ–‡ä»¶çš„çº¿ç¨‹ï¼Œè¿™ä¸ªæƒ³æ³•å¾ˆè‡ªç„¶ï¼Œä½†æ˜¯äº‹å®ä¸Šä¼šæœ‰ç‚¹é—®é¢˜ï¼šæˆ‘ä»¬åœ¨å‘é€ç»™æœåŠ¡å™¨æ–‡ä»¶çš„åŒæ—¶ï¼Œå‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨çš„è¿™ä¸ªçº¿ç¨‹éš¾é“ä¸ä¼šæ¥å—ä½ å‘é€çš„æ¶ˆæ¯å—ï¼Ÿå¦‚æœæƒ³è¦é€šè¿‡recv çš„MSG_PEEKä»¥è·å–æ–‡ä»¶çš„flagä½æ¥è¡¨ç¤ºæ¶ˆæ¯ç±»å‹è€Œä¸å»æ¥æ”¶ï¼Œè¿™åŒæ ·ä¼šå‡ºç°é—®é¢˜ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¸€ç›´æ‹¿åˆ°è¿™ä¸ªåŒ…ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´æ‹¿ä¸åˆ°ï¼Œè€Œæˆ‘å½“æ—¶çš„è®¾è®¡é‡ŒæœåŠ¡å™¨æ˜¯æ²¡ç”¨epoll+çº¿ç¨‹æ± çš„ï¼Œè¿™ä¼šå¯¼è‡´æˆ‘æ•´ä¸ªæœåŠ¡å™¨é˜»å¡åœ¨è¿™ï¼å› æ­¤recvè®©ä¸€ä¸ªçº¿ç¨‹æ¥åšï¼Œè€ŒsendåŒ…çš„æ—¶å€™å…¶å®å¯ä»¥å¼€å¤šçº¿ç¨‹å› ä¸ºä¸å­˜åœ¨è¿™ç§å†²çª)</p>
<ol start="2"><li> <p>ä¿¡å·æ€ä¹ˆå¤„ç†<br/> SIGPIPE<br/> <em>æœåŠ¡å™¨</em> Server å‘å·²ç»å…³é—­çš„ Client ç»§ç»­å‘é€æ•°æ®ï¼ˆå…¶å®æ˜¯å‘é€ä¸¤æ¬¡æ‰ä¼šè§¦å‘ï¼‰ï¼Œå¤§éƒ¨åˆ†ä¿¡å·éƒ½æ˜¯é»˜è®¤ç»“æŸæ•´ä¸ªç¨‹åºã€‚è€ŒæœåŠ¡å™¨æ˜¯éœ€è¦æ°¸ä¹…æŒ‚ç€çš„ï¼Œå¦‚æœè§¦å‘äº†SIGPIPEï¼Œç¨‹åºæ˜¯ä¼šåœæ­¢çš„ï¼Œæˆ‘ä»¬å¾—ä½¿ç”¨SIG_IGNã€‚<br/> <em>å®¢æˆ·ç«¯</em> ä½¿ç”¨ä¿¡å·å¤„ç†å‡½æ•°é€šçŸ¥æœåŠ¡å™¨æå‰é€€å‡ºï¼Œç´§æ¥ç€å®¢æˆ·ç«¯å°±å¯ä»¥é€€å‡ºäº†ã€‚<br/> SIGINTï¼ŒSIGTERM éƒ½å¯ä»¥é€‰æ‹©æ€§SIG_IGN</p> </li><li> <p>EPOLLRDHUPæ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯EPOLLä¸­å¯ä»¥ç›‘å¬åˆ°çš„äº‹ä»¶ç§ç±»ä¹‹ä¸€ï¼Œä»£è¡¨å¯¹ç«¯çš„å…³é—­ã€‚epoll_waitå¾—åˆ°çš„ç»“æœé›†ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡å¿—ä½æ¥ç›‘æµ‹å®¢æˆ·ç«¯é€€å‡ºï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚</p> </li><li> <p>åº”è¯¥è®¾è®¡å“ªäº›ç±»ï¼Ÿmysqlè®¾è®¡å“ªäº›è¡¨ï¼Ÿ<br/> å¥½å‹è¡¨ï¼Œæ¶ˆæ¯è¡¨ï¼Œè´¦å·è¡¨â€¦å¹¶æ²¡æœ‰ä»€ä¹ˆæ ‡å‡†ç­”æ¡ˆï¼Œæœ€å¥½æƒ³å¥½å…ˆé€»è¾‘äº†å†å»å†™ï¼Œä¸ç„¶å¾ˆå®¹æ˜“é‡æ„çš„ã€‚</p> </li></ol>
<p>ä¼ çš„PACKåŒ…æœ€å¥½å¸¦æœ‰ä¸ªmysqlä¸­idå­—æ®µï¼ˆä¸è¿‡ä½ å‘é€ç»™æœåŠ¡å™¨ä¸ä¸€å®šè¦å¡«å†™è¿™ä¸ªå­—æ®µï¼‰ï¼Œå› ä¸ºæˆ‘å½“åˆæ²¡æœ‰åŠ idå­—æ®µï¼ˆå› ä¸ºæ€»æ„Ÿè§‰è¿™å¯¹å®¢æˆ·æ²¡æœ‰ç”¨ï¼‰ç»“æœåœ¨æœåŠ¡å™¨ä¸Šå¤„ç†ä¸šåŠ¡é€»è¾‘æ¯æ¬¡éƒ½å¾—æ ¹æ®è´¦å·å»æŸ¥è¯¢mysqlä¸‹çš„idï¼Œå†æ ¹æ®idå»åšæ›´å¤šæ“ä½œï¼Œæ¯”å¦‚æŸ¥è¯¢å¦ä¸€å¼ å«æœ‰è¿™ä¸ªidçš„è¡¨ã€‚ç›´æ¥ä»£ç é‡å¤§äº†å¾ˆå¤šå¾ˆå¤šï¼Œä¹Ÿè®©ç¨‹åºçš„ç»“æ„æ˜¾å¾—ååˆ†ä¸‘é™‹ï¼Œå¯è¯»æ€§ä¹Ÿä¼šå¾ˆå·®ã€‚</p>
<ol start="5"><li> <p>cjson / è‡ªå·±å†™çš„ç»“æ„ä½“ /è¿˜æ˜¯åœ¨msgä¸­ç”¨åˆ†å‰²ç¬¦å·å¾—åˆ°æ›´å¤šçš„å­—æ®µï¼Ÿ<br/> æˆ‘è§‰å¾—jsonå¯èƒ½ä¼šæ›´å¥½ï¼Œå› ä¸ºæˆ‘å½“åˆç”¨çš„æ˜¯åˆ†å‰²ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯åœ¨myshellä¸­ç”¨æ¥åˆ†å‰²æ¯ä¸€ä¸ªå°æ®µï¼Œæ¯”å¦‚<code>id:1\nname:adl\nclass:è®¡ç§‘1904\n</code>é€šè¿‡ä¸€ä¸ªè‡ªå·±å†™çš„å‡½æ•°å»å°†è¿™ä¸ªç‰‡æ®µæ ¹æ®åˆ†éš”ç¬¦â€™\nâ€™åˆ†æˆä¸‰ä»½ï¼Œä»è€Œè§£æå‡ºæˆ‘ä»¬éœ€è¦çš„å­—æ®µå†…å®¹ï¼Œç„¶è€Œæˆ‘å†™çš„å‡½æ•°éœ€è¦åœ¨å‡½æ•°å¤–å¼€è¾Ÿå¤§é‡çš„æ•°ç»„ç©ºé—´é¿å…å†…å®¹è¿‡é•¿è€Œå¯¼è‡´çš„æº¢å‡ºï¼Œè€Œä¸”ä½¿ç”¨èµ·æ¥éš¾ä»¥ç²¾ç¡®freeã€‚è‡³äºçœŸè¦ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œåˆ†éš”ç¬¦è¯·ä¸è¦ä½¿ç”¨\n,å› ä¸ºè¿™ä¸ªè¿‡äºå¸¸è§ï¼Œæ¨èä½¿ç”¨"\r\n"ã€‚è€Œå¦‚æœä½¿ç”¨ç»“æ„ä½“æ·»åŠ å­—æ®µï¼Œä½ è¦çŸ¥é“ï¼Œä½ å‘é€çš„åŒ…ä¸€èˆ¬æ˜¯å›ºå®šçš„ï¼Œä½†ä½ å¦‚æœéœ€è¦å‘é€ä¸€äº›æ–‡ä»¶çš„å¤§å°ï¼Œåç§°ï¼Œä½ å¿½ç„¶å‘ç°ä½ çš„ç»“æ„ä½“çš„å­—æ®µä¸å¤Ÿç”¨ï¼Œæ·»åŠ ç»“æ„ä½“å­—æ®µå…¶å®æ˜¯ä¸€ç§ä¸‹ç­–ï¼ˆæˆ‘å°±åŠ äº†æ–‡ä»¶çš„å­—æ®µï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½ä¼šéœ€è¦å› æ­¤å¤šç»´æŠ¤å¾ˆå¤šç›¸åº”çš„ä¿¡æ¯ã€‚cjsonå‘¢ä½ å°±å¯ä»¥æ¯”å¦‚æƒ³å°†ä¸€ä¸ª</p> </li><li> <p>å‘æ–‡ä»¶å¦‚ä½•è®©å¯¹æ–¹çŸ¥é“æˆ‘å‘å®Œäº†å‘¢ï¼Ÿ<br/> å‘é€å«ENDæ ‡å¿—ä½çš„åŒ…ï¼ŒENDåŒ…çš„å¤„ç†åœ¨èŠå¤©å®¤ä¸­ç”¨åˆ°æŒºå¤šçš„ï¼Œæ˜¾ç¤ºä¸€ä¸ªå¥½å‹åˆ—è¡¨ï¼Œç¾¤åˆ—è¡¨ã€‚ã€‚ã€‚</p> </li><li> <p>é‡å¤åŠ å¥½å‹ï¼ŒåŠ ç¾¤è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿï¼Ÿï¼Ÿç¾¤ä¸»å’Œç®¡ç†å‘˜è¯¥æ€ä¹ˆåŒæ—¶å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Ÿï¼Ÿï¼Ÿ<br/> è¿™äº›é‡å¤éœ€æ±‚å¤§éœ€è¦éªŒè¯è¯¥æ¶ˆæ¯å·²å­˜åœ¨çš„æ“ä½œã€‚è€Œç¾¤ä¸»å’Œç®¡ç†å‘˜åªèƒ½è®©ä¸€ä¸ªç”Ÿæ•ˆã€‚</p> </li><li> <p>åŒæ—¶å¡«å†™ä¸€ä¸ªç»“æ„ä½“çš„å­—æ®µæœ€å¥½å†™æˆå‡½æ•°</p> </li><li> <p>èŠå¤©è®°å½•å’Œå…¶ä»–ç±»å‹çš„æ¶ˆæ¯éœ€è¦åœ¨mysqlä¸­å­˜æ”¾å¤šä¹…ï¼Ÿï¼ˆæ¶ˆæ¯çš„çŠ¶æ€flagï¼‰</p> </li><li> <p>æ–­ç‚¹ä¼ è¾“åº”è¯¥æ³¨æ„å“ªäº›äº‹é¡¹ï¼Ÿ<br/> æœåŠ¡å™¨å­˜å®¢æˆ·ç«¯çš„æ–‡ä»¶çš„æ€»å¤§å°å’Œå·²å‘é€å¤§å°ï¼Œæ–­å¼€è¿æ¥åï¼Œä¸‹ä¸€æ¬¡å®¢æˆ·è¿æ¥ï¼ŒæœåŠ¡å™¨å¯é€šçŸ¥è¯¥å®¢æˆ·ï¼Œå†å¯ä»¥é€‰æ‹©æ€§é‡å‘<br/> ï¼ˆsys/sendfile.h sendfileå‡½æ•°å¤§å®¶å¯ä»¥è¯•è¯•ï¼‰<br/> ä¸Šä¼ ç»™æœåŠ¡å™¨çš„æ–‡ä»¶åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Œæ˜¯ç›´æ¥å‘ç»™å¯¹æ–¹å—ï¼Ÿ<br/> ç›®å½• ç­‰åˆ°å¯¹ç«¯åœ¨çº¿PUSH</p> </li><li> <p>æ—¶é—´æˆ³<br/> è¿™ä¸ªå…¶å®æŒºé‡è¦çš„ï¼Œè¿™æ ·æ¯æ¬¡ä½ å‘é€çš„æ¶ˆæ¯éƒ½å¯æ˜¾ç¤ºæ—¶é—´ï¼Œçœ‹ä¸Šå»ç‚«é…·å¤šäº†ï¼</p> </li><li> <p>è¶…æ—¶å¤„ç†<br/> ä»…ä»…æä¾›æˆ‘çš„æƒ³æ³•ï¼šä¹‹å‰è¯´æœåŠ¡å™¨å¯ä»¥ç”¨ä¸€ä¸ªå…¨å±€é“¾è¡¨æ¥è®°å½•å®¢æˆ·çš„åœ¨çº¿çŠ¶æ€ï¼Œé‚£ä¹ˆå¯ä»¥æ·»åŠ ä¸€ä¸ªå­—æ®µç™»å½•æ—¶é—´ï¼ˆæˆ–è€…è¶…æ—¶æ—¶é—´ï¼‰ï¼ŒæœåŠ¡å™¨å½“å®¢æˆ·è¿æ¥æ—¶è®°å½•ä¸‹å®¢æˆ·çš„ç™»å½•æ—¶é—´ï¼Œæ¯å¾ªç¯ä¸€è½®ï¼ˆæˆ–è€…æ›´é•¿ä¸€æ®µå°±å°†è¶…æ—¶çš„å®¢æˆ·åˆ å»ï¼‰<br/> äº‹å®ä¸Šå¯ä»¥é‡‡ç”¨æ—¶é—´å‡åºé“¾è¡¨çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æ’å…¥çš„æ—¶å€™å°†è¿™ä¸ªèŠ‚ç‚¹æ”¾åœ¨é‚£äº›è¶…æ—¶æ—¶é—´åœ¨å®ƒä¹‹å‰çš„èŠ‚ç‚¹çš„åé¢ã€‚é‚£ä¹ˆä½ åœ¨é“¾è¡¨èŠ‚ç‚¹çš„æ’å…¥å°±æœ‰Oï¼ˆnï¼‰çš„å¤æ‚åº¦ï¼Œä¹Ÿæ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ¯”è¾ƒé“¾è¡¨ä¸ŠèŠ‚ç‚¹è¶…æ—¶æ—¶é—´å’Œå½“å‰æ—¶é—´ï¼Œè¶…æ—¶åˆ™åˆ é™¤å®¢æˆ·ã€‚å¦‚æœå®¢æˆ·å‘é€äº†è¯·æ±‚ï¼Œè¯´æ˜å®¢æˆ·åœ¨çº¿ï¼Œé‚£ä¹ˆå°±å»æ›´æ–°è¶…æ—¶æ—¶é—´ã€‚<br/> å¤§è‡´å°±è¿™ä¸ªæ€è·¯ï¼Œå½“åˆæ²¡æœ‰å®ç°ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è¯•è¯•ã€‚</p> </li></ol>
<p>å†™èŠå¤©å®¤çš„æ€è·¯ å…ˆæ„æ€æ•´ä½“é€»è¾‘ å†ç™»å½•æ³¨å†Œå…¥æ‰‹ å†å®ç°ç§èŠ å†ç¾¤èŠï¼ˆå…¶å®å¾ˆå¤šåœ°æ–¹å’Œç§èŠæœ¬è´¨ç›¸åŒï¼‰<br/> å¿ƒæ€å¾ˆå®¹æ˜“çˆ†ç‚¸çš„ï¼Œä¸€æ¬¡æ¬¡ç—›è‹¦çš„é‡æ„ ï¼Œå”‰ï¼Œæ‰“ä¸æ­»ä½ çš„åªä¼šè®©ä½ æ›´å¼ºå¤§ï¼</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>èŠ‚ç‚¹ç±»<br/> ç›¸æ¯”è¾ƒæ—¶é—´å‡åºé“¾è¡¨ä¸­çš„ç»å¯¹æ—¶é—´expire</p>
<p>tw_timeré‡‡ç”¨çš„æ˜¯ç›¸å¯¹æ—¶é—´çš„æ¦‚å¿µä¹Ÿå°±å¤šå‡º<br/> rotation ï¼Œtime_slotä¿©å±æ€§ï¼Œrotationæ˜¯è½¬çš„â€œåœˆæ•°â€ï¼Œtime_slotæ˜¯è½¬åˆ°æ—¶é—´è½®çš„å“ªä¸€å—åŒºåŸŸã€‚å¥½æ¯”ç°åœ¨åœ¨1ï¼š05ï¼Œè¿‡äº†65åˆ†é’Ÿæ—¶é’ˆèµ°äº†é—¹é’Ÿçš„1rotationå¹¶èµ°åˆ°10 time_slot;</p>
<p>tw_timer.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_TW_TIMER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_TW_TIMER_H</span>

<span class="token keyword">class</span> <span class="token class-name">client_data</span> <span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">tw_timer</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">tw_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> rot<span class="token punctuation">,</span><span class="token keyword">int</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> rotation<span class="token punctuation">;</span>
    <span class="token keyword">int</span> time_slot<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span>user_data<span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span>next<span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_TW_TIMER_H</span>

</code></pre>
<p>tw_timer.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>

tw_timer<span class="token operator">::</span><span class="token function">tw_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> rot<span class="token punctuation">,</span> <span class="token keyword">int</span> ts<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">rotation</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">time_slot</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

</code></pre>
<p>client_data.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_CLIENT_DATA_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_CLIENT_DATA_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE 64</span>

<span class="token comment">//class util_timer;</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>
<span class="token comment">//class heap_timer;</span>
<span class="token keyword">struct</span> client_data <span class="token punctuation">{<!-- --></span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        tw_timer <span class="token operator">*</span>timer<span class="token punctuation">;</span>
<span class="token comment">//        util_timer *timer;</span>
<span class="token comment">//        heap_timer*timer3;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_CLIENT_DATA_H</span>

</code></pre>
<p>time_wheel.cpp<br/> å¯ä»¥æ³¨æ„åˆ°è¿™ä¸ªæ—¶é—´è½®ç±»çš„æ¥å£å’Œæ—¶é—´å‡åºé“¾è¡¨çš„æ¥å£åŸºæœ¬ä¸€è‡´</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_TIME_WHEEL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_TIME_WHEEL_H</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">time_wheel</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tw_timer <span class="token operator">*</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tw_timer <span class="token operator">*</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N<span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span><span class="token comment">//ä¸€åœˆ60å—åŒºåŸŸ</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> SI <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//SIå¯ä»¥æƒ³è±¡æˆæ—¶é’ˆæˆ–è€…åˆ†é’Ÿæ¯æ¬¡è½¬åŠ¨çš„å¹…åº¦</span>
    tw_timer<span class="token operator">*</span>slots<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cur_slot<span class="token punctuation">;</span><span class="token comment">//å½“å‰æ‰€åœ¨åŒºåŸŸ</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_TIME_WHEEL_H</span>
</code></pre>
<p>time_wheel.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"time_wheel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>

time_wheel<span class="token operator">::</span><span class="token operator">~</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tw_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
            <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

time_wheel<span class="token operator">::</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">cur_slot</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

tw_timer <span class="token operator">*</span>time_wheel<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> SI<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//è¿™ä¸ªæ°´è¡¨ä¸€æ¬¡åªèƒ½è·³5å°æ ¼ï¼Œé‚£å½“ç„¶å®šæ—¶3å°æ ¼è‡³å°‘è¦æ—¶é’ˆè·³ä¸€æ¬¡</span>
        ticks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> timeout <span class="token operator">/</span> SI<span class="token punctuation">;</span><span class="token comment">//è·³çš„æ¬¡æ•°</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> rotation <span class="token operator">=</span> ticks <span class="token operator">/</span> N<span class="token punctuation">;</span><span class="token comment">//è·³çš„åœˆæ•°</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>cur_slot <span class="token operator">+</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span><span class="token comment">//è·³çš„æœ€ç»ˆä½ç½®ï¼ˆæ—¶é—´ï¼‰</span>
	<span class="token comment">//è¿™é‡Œå®ƒå°†timeråœ¨timer_wheelå†…éƒ¨åŠ¨æ€åˆ†é…äº†ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†ä½¿ç”¨æ¥å£å’Œæ—¶é—´å‡åºé“¾è¡¨æœ‰æ‰€åŒºåˆ«ï¼Œè§åæ–‡</span>
    tw_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">tw_timer</span><span class="token punctuation">(</span>rotation<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ticks =%d ,timeout=%d\n"</span><span class="token punctuation">,</span>ticks<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add timer,rotation is %d,ts is %d,cur_slot is %d\n"</span><span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//è¿™ä¸ªadjust_timerå‡½æ•°å…¶å®ä¹¦ä¸Šæ²¡æœ‰ï¼Œå› ä¸ºå’Œæ—¶é—´å‡åºé“¾è¡¨çš„æ¥å£æ¯”è¾ƒç›¸ä¼¼ï¼Œæˆ‘å°±æŠŠèŠ‚ç‚¹æ‘˜ä¸‹æ¥ï¼Œå†é‡æ–°æ”¾åˆ°æ—¶é—´è½®ä¸Š=del_timer+add_timerï¼Œä¹Ÿå°±æ˜¯ç”¨äºå®¢æˆ·åœ¨å‘é€æ¶ˆæ¯ä¹‹åæˆ‘ä»¬é‡æ–°è®¾ç½®è¶…æ—¶çš„éœ€æ±‚</span>
tw_timer <span class="token operator">*</span>time_wheel<span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ots <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> SI<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> timeout <span class="token operator">/</span> SI<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> rotation <span class="token operator">=</span> ticks <span class="token operator">/</span> N<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>cur_slot <span class="token operator">+</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span>
    timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot <span class="token operator">=</span> ts<span class="token punctuation">;</span>
    timer<span class="token operator">-</span><span class="token operator">&gt;</span>rotation <span class="token operator">=</span> rotation<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add timer,rotation is %d,ts is %d,cur_slot is %d\n"</span><span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> time_wheel<span class="token operator">::</span><span class="token function">del_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> time_wheel<span class="token operator">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    tw_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current slot is %d\n"</span><span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tick the timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å› ä¸ºæ—¶é’ˆè½¬è¿‡ä¸€åœˆæ‰ä¼šå›åˆ°ç›¸åŒçš„cur_slot,æ‰€ä»¥æ¯è°ƒç”¨tickä¸”è½®åˆ°ç›¸åŒçš„cur_slotæ—¶ï¼Œå°†rotation--ç›´åˆ°0ä¸ºæ­¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>rotation <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tmp<span class="token operator">-</span><span class="token operator">&gt;</span>rotation<span class="token operator">--</span><span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span><span class="token comment">//æ¢åˆ°è¿™ä¸ªåŒºåŸŸå†…é“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŸ¥çœ‹ä»–å®ƒæ˜¯å¦è¶…æ—¶</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//è¶…æ—¶åˆ™è°ƒç”¨å‡½æ•°ï¼Œåˆ é™¤èŠ‚ç‚¹</span>
            tmp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete header in cur_slot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                tmp<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tw_timer <span class="token operator">*</span>tmp2 <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                tmp <span class="token operator">=</span> tmp2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//æ—¶é’ˆè½¬1æ ¼</span>
    cur_slot <span class="token operator">=</span> <span class="token operator">++</span>cur_slot <span class="token operator">%</span> N<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Handleinactiveconnections.cpp<br/> ä¹¦ä¸Šè¯´è®©æˆ‘ä»¬è‡ªå·±å®ç°ä¸€ä¸‹è¿™ä¸ªï¼Œä½†æ˜¯æ—¶é—´å‡åºé“¾è¡¨ä¸­æ“ä½œç•¥æœ‰ä¸åŒï¼ˆæ²¡åœ¨ç”¨æˆ·ç©ºé—´åŠ¨æ€åˆ†é…èŠ‚ç‚¹ç±»ï¼Œå¹¶ä¸”ç›´æ¥ä½¿ç”¨ç›¸å¯¹æ—¶é—´åœ¨æ—¶é—´è½®ä¸Šæ·»åŠ æ–°å®šæ—¶å™¨ï¼Œæ›´ä¸ºæ¸…æ™°æ–¹ä¾¿ï¼‰</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token comment">//#include "sort_timer_lst.h"</span>
<span class="token comment">//#include "util_timer.h"</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"client_data.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"time_wheel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> FD_LIMIT 65535</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENT_NUMBER 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TIMESLOT 1</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> time_wheel timeWheel<span class="token punctuation">;</span>
<span class="token comment">//static sort_timer_lst timerLst;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|</span><span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span>user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    timeWheel<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    timerLst.tick();</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage: %s ip_address port_number \n"</span><span class="token punctuation">,</span> <span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>listenfd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> op<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>op<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    client_data <span class="token operator">*</span>users <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//        std::cout&lt;&lt;number&lt;&lt;std::endl;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">struct</span> sockaddr_in client_address<span class="token punctuation">;</span>
                    socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
<span class="token comment">//                    util_timer *timer = new util_timer;</span>
<span class="token comment">//                    tw_timer*timer =new tw_timer;</span>
<span class="token comment">//æˆ‘ä»¬æ— éœ€åœ¨æ¥å£å¤–åˆ†é…èŠ‚ç‚¹ç±»</span>
            <span class="token comment">//        time_t cur = time(nullptr);</span>
    <span class="token comment">//æ­¤æ—¶è¶…æ—¶æ—¶é—´ä¹Ÿå˜æˆäº†ç›¸å¯¹æ—¶é—´</span>
                    <span class="token keyword">auto</span> timer <span class="token operator">=</span> timeWheel<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token comment">/*cur+*/</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    timer<span class="token operator">-</span><span class="token operator">&gt;</span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    timer<span class="token operator">-</span><span class="token operator">&gt;</span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
<span class="token comment">//                      timer-&gt;expire = cur + 3 * TIMESLOT;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
<span class="token comment">//                    timerLst.add_timer(timer);</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tw_timer<span class="token comment">/*util_timer*/</span> <span class="token operator">*</span>timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                                timerLst.del_timer(timer);</span>
                                timeWheel<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            timeWheel<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timerLst.del_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                            time_t cur = time(nullptr);</span>
<span class="token comment">//                            timer-&gt;expire = cur + 3 * TIMESLOT;</span>
                            timeWheel<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span><span class="token comment">/*cur +*/</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"adjust timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timer-&gt;time_slot;</span>
<span class="token comment">//                            timerLst.adjust_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å®ç°æ•ˆæœå’Œæ—¶é—´å‡åºé“¾è¡¨ç±»ä¼¼</p>
<p>æ€è€ƒï¼šä¸ºä»€ä¹ˆç”¨äº†æ—¶é—´è½®å°±å¯ä»¥ä½¿ç”¨ç›¸å¯¹æ—¶é—´äº†è€Œå‡åºé“¾è¡¨ä¸è¡Œå‘¢ï¼Ÿ<br/> å› ä¸ºæ—¶é—´è½®ä¸­å°†æ—¶é—´èŠ‚ç‚¹â€œå“ˆå¸Œâ€åˆ°æ¯ä¸€å—æ—¶é—´åŒºåŸŸï¼Œå¹¶å°†ç›¸å¯¹æ—¶é—´100è½¬æ¢æˆäº†rotationï¼ˆ1ï¼‰+slotï¼ˆ40ï¼‰ä¹Ÿå°±æ˜¯æ—¶é’Ÿä¸Šçš„å°æ—¶å’Œåˆ†é’Ÿï¼Œä»è€Œä½¿ç”¨è€…å¯ä»¥æ ¹æ®æ—¶é’Ÿä¸Šä½ç½®çš„rotation,slotçš„å˜åŒ–æ¥åˆ¤æ–­çœŸå®æ—¶é—´çš„å˜åŒ–ï¼Œè€Œå‡åºé“¾è¡¨æ— æ³•å¾—çŸ¥è¿‡å»çš„ç›¸å¯¹æ—¶é—´ï¼Œä¾¿åªèƒ½ä½¿ç”¨ç»å¯¹æ—¶é—´æ¯”è¾ƒäº†ã€‚å½“ç„¶æ—¶é—´å‡åºé“¾è¡¨ä¹Ÿå¯ä»¥å­˜å‚¨ç»å¯¹æ—¶é—´ï¼Œä½†å¹¶æ²¡è¿™ä¸ªå¿…è¦ã€‚</p>
<p>æ³¨æ„çš„æ˜¯æ— è®ºæ—¶é—´å‡åºé“¾è¡¨è¿˜æ˜¯æ—¶é—´è½®ï¼Œä»–ä»¬å¦‚æœè°ƒç”¨çš„è¶…æ—¶å›è°ƒå‡½æ•°ä¼šå ç”¨ä¸€æ®µæ—¶é—´ï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤šä¸ªèŠ‚ç‚¹è¶…æ—¶å¹¶éœ€è¦åˆ é™¤ï¼Œä»–ä»¬çš„çœŸå®åˆ é™¤æ—¶é—´å…¶å®ä¸æ˜¯å®šæ—¶å™¨æ‰€å®šçš„æ—¶é—´ï¼Œè€Œæ˜¯ç¨å¾®æ™šä¸€äº›ã€‚</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>åˆšå¥½å‰ä¸¤å¤©å­¦é•¿ç»™æˆ‘ä»¬è®²åº§ä¸­æåˆ°æœåŠ¡å™¨å®¢æˆ·çš„è¶…æ—¶å¤„ç†ï¼Œåˆšå¥½åˆåœ¨çœ‹ã€Šé«˜æ€§èƒ½linuxæœåŠ¡å™¨ç¼–ç¨‹ã€‹æœ‰å‘ç°è¿™æ–¹é¢çš„çŸ¥è¯†ï¼Œå°±æ‹¿å‡ºæ¥æ€»ç»“ä¸€ä¸‹ã€‚</p>
<p>ç¬¬ä¸€,æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è‡ªåˆ¶è®¡æ—¶å™¨ï¼Œc++ /c çš„alarmä¸æ˜¯å¯ä»¥å®ç°å®šæ—¶æ“ä½œå—ï¼Œè¿˜æœ‰sleepâ€¦???</p>
<p>linuxä¸‹ä¸€ä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ªalarmé—¹é’Ÿå®šæ—¶å™¨ï¼Œç„¶è€ŒæœåŠ¡å™¨è‚¯å®šæ˜¯å¤šç”¨æˆ·çš„ï¼Œæˆ‘ä»¬è‚¯å®šå¾—æƒ³æ–¹æ³•ç»™æ¯ä¸ªå®¢æˆ·æ•´ä¸€ä¸ªå®šæ—¶å™¨</p>
<p>ä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥è¦ä»‹ç»çš„å‡åºæ—¶é—´é“¾è¡¨ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰æ—¶é—´è½®ï¼Œæ—¶é—´æœ€å°å †ç­‰æ›´å¥½çš„æ–¹æ³•ã€‚</p>
<p>util_timerç±»ä»£è¡¨ç€æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ©ç”¨time()å­˜å‚¨ç»å¯¹æ—¶é—´,client_dataæ˜¯ç”¨æˆ·çš„æ•°æ®<br/> util_timer.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_UTIL_TIMER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_UTIL_TIMER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">client_data</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    time_t expire<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span>user_data<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>prev<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_UTIL_TIMER_H</span>

</code></pre>
<p>util_timer.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

```cpp
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>

util_timer<span class="token operator">::</span><span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre>
<p>è¿™ä¸ªå®¢æˆ·ç±»ä¸­ä¹Ÿä¼šæœ‰ä¸€ä¸ªutil_timeræŒ‡é’ˆå¯ä»¥è¯´æ˜¯å®¢æˆ·ä¿¡æ¯ç±»å’Œæ—¶é—´èŠ‚ç‚¹ç±»ç›¸äº’æ†ç»‘äº†<br/> client_data.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_CLIENT_DATA_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_CLIENT_DATA_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE 64</span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">heap_timer</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> client_data <span class="token punctuation">{<!-- --></span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        tw_timer *timer;</span>
        util_timer <span class="token operator">*</span>timer<span class="token punctuation">;</span>
<span class="token comment">//        heap_timer*timer3;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_CLIENT_DATA_H</span>
</code></pre>
<p>é“¾è¡¨ç±»<br/> sort_timer_lst.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_SORT_TIMER_LST_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_SORT_TIMER_LST_H</span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">sort_timer_lst</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">,</span>util_timer<span class="token operator">*</span>lst_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>head<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_SORT_TIMER_LST_H</span>

</code></pre>
<p>sort_timer_lst.cpp</p>
<pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sort_timer_lst.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>

sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">head</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tail</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        delete tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * å¦‚æœæ²¡å¤´èŠ‚ç‚¹ï¼Œåˆ™å°†è¿™ä¸ªèŠ‚ç‚¹ä½œä¸ºå¤´èŠ‚ç‚¹*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> tail <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * å¦‚æœè¯¥èŠ‚ç‚¹çš„æ—¶é—´å¤§å°æ¯”å¤´èŠ‚ç‚¹æ—¶é—´å°é‚£ä¹ˆä¿®æ”¹è¿™ä¸ªèŠ‚ç‚¹ä¸ºæ–°çš„å¤´èŠ‚ç‚¹*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * å¦åˆ™ç”¨é‡è½½å‡½æ•°æ·»åŠ åˆ°é“¾è¡¨ä¸­åœ°ä¸€ä¸ªæ¯”å®ƒå¤§çš„èŠ‚ç‚¹çš„å‰é¢æŸ¥æ‰¾çš„èŒƒå›´
     * ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯ä»¥ç¼©å°
     * */</span>

    <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * ä¿®æ”¹æŸä¸ªèŠ‚ç‚¹æ—¶é—´
 * éœ€è¦è°ƒæ•´è¿™ä¸ªèŠ‚ç‚¹åˆ°ç›¸åº”çš„ä½ç½®*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token comment">//å¦‚æœæ—¶é—´å°äºä¸‹ä¸€ä¸ªèŠ‚ç‚¹é‚£æ²¡äº‹æ­¤èŠ‚ç‚¹ä¸ç”¨æ¢ä½ç½®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp <span class="token operator">||</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//å¦åˆ™å¦‚æœè‹¥è¿™ä¸ªèŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹åˆ™æ›´æ”¹å¤´èŠ‚ç‚¹ä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¹¶æ’å…¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//åˆ å¹¶æ’å…¥</span>
        timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token comment">//æ’</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        delete timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> tail <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        delete timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tail <span class="token operator">=</span> tail<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        delete timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
    delete timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * è¿™ä¸ªå‡åºæ—¶é—´é“¾è¡¨çš„å…³é”®å°±æ˜¯è¿™ä¸ªtick æ¯”è¾ƒæ˜¯æ¯”å½“å‰æ—¶é—´(ä½¿ç”¨ç»å¯¹æ—¶é—´æ¯”è¾ƒ)æ—©çš„æ‰€æœ‰èŠ‚ç‚¹å¹¶æ‰§è¡Œä»–ä»¬çš„å›è°ƒå‡½æ•°cb_func
 * æ¯”å¦‚å¯ä»¥è®©å®¢æˆ·è¶…æ—¶é€€å‡º*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timer tick\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    time_t cur <span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tmp <span class="token operator">=</span>head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token operator">&lt;</span>tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tmp<span class="token operator">-&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        delete tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span>head <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * è°ƒæ•´æ–°ä½ç½®
*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> util_timer <span class="token operator">*</span>lst_head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    util_timer<span class="token operator">*</span>prev<span class="token operator">=</span>lst_head<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tmp<span class="token operator">=</span>prev<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            prev<span class="token operator">-&gt;</span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>next<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
            tmp<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prev<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
        tmp<span class="token operator">=</span>tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        prev<span class="token operator">-&gt;</span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next<span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ç”¨å‡åºé“¾è¡¨å®ç°çš„å…³é—­éæ´»è·ƒå®¢æˆ·è¿æ¥</p>
<p>Handleinactiveconnections.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/25.</span>
<span class="token comment">//</span>

<span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token comment">//#include "MyHeadFile.h"</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sort_timer_lst.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"client_data.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> FD_LIMIT 65535</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENT_NUMBER 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TIMESLOT 5</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> sort_timer_lst timerLst<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/*
*è®¾ç½®æ–‡ä»¶æè¿°ç¬¦éé˜»å¡
*/</span>
<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
epoll ETç›‘å¬
*/</span>
<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
ä¿¡å·å¤„ç†å‡½æ•°ï¼Œé€šè¿‡ç®¡é“å‘ç”Ÿç»™ä¸»å‡½æ•°å¤„ç†ï¼ˆepoll_waitï¼‰ï¼Œç»Ÿä¸€äº‹ä»¶æºï¼Œä¹Ÿå°±æ˜¯å°†ä¿¡å·çš„å¤„ç†å’Œæ™®é€šå¥—æ¥å­—æˆ–è€…åˆ«çš„æ–‡ä»¶æè¿°ç¬¦ç»Ÿä¸€ç”¨epoll_waitæ¥åŒæ­¥ï¼Œ
*/</span>
<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
æ·»åŠ ä¿¡å·
*/</span>
<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|</span><span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
å›è°ƒå‡½æ•°ï¼šå…³é—­è¿æ¥
*/</span>
<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span>user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*è¿™ä¸ªå‡½æ•°æ¯æ¬¡epoll_waitè½®å®Œä¸€è½®å°±ç”¨ä¸€æ¬¡ï¼Œè°ƒç”¨tickå°†è¶…æ—¶çš„ç”¨æˆ·æ¸…ç†ï¼Œå¹¶é‡æ–°å®šæ—¶*/</span>
<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    timerLst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    timerLst.tick();</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage: %s ip_address port_number \n"</span><span class="token punctuation">,</span> <span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>listenfd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>op<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
å‰é¢çš„éƒ½ä¸è¯´ï¼Œå°±æ˜¯åŸºæœ¬çš„å»ºç«‹è¿æ¥ï¼Œä»è¿™é‡Œå¼€å§‹æ·»åŠ SIGALRMä¿¡å·
*/</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*åŠ¨æ€åˆ†é…ç”¨æˆ·æ•°ç»„*/</span>
    client_data <span class="token operator">*</span>users <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*å¯åŠ¨é—¹é’Ÿ ï¼Œ5ç§’åä¼šå“
	å¦‚æœepoll_waitä¸Šæ²¡æœ‰å®¢æˆ·å‘æ¥æ¶ˆæ¯æˆ–è€…å…¶ä»–äº‹ä»¶ä»¥ç»“æŸepoll_waitçš„é˜»å¡ï¼Œè¿™ä¸ªalarmä¼šå”¤é†’epoll_wait
	å¯ä»¥è¯•ç€æ‰“å°ä¸‹é¢epoll_waitçš„è¿”å›å€¼ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸å‘æ•°æ®ï¼Œä½ å¯ä»¥çœ‹åˆ°-1ï¼Œ1äº¤æ›¿å‡ºç°çš„ç°è±¡ï¼Œè€Œè¿™ä¸ªç°è±¡å‡ºç°çš„åŸå› æ˜¯
	ç¬¬ä¸€æ¬¡alarmå°†epoll_waitæ‰“æ–­ï¼Œå¹¶è§¦å‘ä¿¡å·å‡½æ•°ï¼Œepollä¼šæ¥å—åˆ°ç®¡é“æ¥çš„æ•°æ®ï¼Œåœ¨ä¸‹ä¸€è½®epoll_waitåæ˜ å‡ºæ¥ã€‚
*/</span>
    
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">struct</span> sockaddr_in client_address<span class="token punctuation">;</span>
                socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
            
              	<span class="token comment">/*
              	è¿æ¥ä¸Šæ¥çš„å¥—æ¥å­—ç»‘å®šä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶é—´æŒ‰èŠ‚ç‚¹çš„è¶…æ—¶æ—¶é—´åœ¨å½“å‰æ—¶é—´æŒ‰+3*TIMEOUTä¹‹å*/</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
                time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                timerLst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">/*
        	è‹¥æ¥å—åˆ°æ˜¯ä¿¡å·å‡½æ•°è§¦å‘è€Œä»ç®¡é“å‘é€è¿‡æ¥çš„ä¿¡æ¯*/</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                           	<span class="token comment">/*å°†timeoutè®¾ç½®æˆtrue,ä¹‹åä¼štickæ£€æŸ¥é“¾è¡¨ä¸Šå…¨éƒ¨çš„è¶…æ—¶äº‹ä»¶
                           	*/</span>
                                timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                timerLst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timeWheel.del_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                        timeWheel.del_timer(timer);</span>
                            timerLst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*å¦‚æœå®¢æˆ·å‘æ¥ä¿¡æ¯äº†ï¼Œé‚£ä¹ˆä¿®æ”¹è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¿®æ”¹é“¾è¡¨ä¸Šæ—¶é—´èŠ‚ç‚¹çš„ä½ç½®*/</span>
                        time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            timer<span class="token operator">-</span><span class="token operator">&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
<span class="token comment">//                        timeWheel.adjust_timer(timer,/*cur +*/ 3 * TIMESLOT);</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"adjust timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            timerLst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*è°ƒç”¨tickï¼Œé‡æ–°è®¾ç½®é—¹é’Ÿæ—¶é—´*/</span>
        
            <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>users<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>g++å’Œç”¨telnetæ¨¡æ‹Ÿå®¢æˆ·ç«¯ä¸€ä¸‹å¯ä»¥çœ‹åˆ°ï¼šæ¯5ç§’ä¸€æ¬¡çš„tickåœ¨å‘é€4æ¬¡ä»¥åæœåŠ¡å™¨å…³é—­äº†è¿æ¥ï¼ˆè™½ç„¶è®¾ç½®äº†è¶…æ—¶æ—¶é—´æ˜¯3Ã—5ç§’ï¼Œä½†æ˜¯ä¸å®¢æˆ·å»ºç«‹è¿æ¥çš„æ—¶å€™éƒ½ä¼šæ˜¯è°ƒç”¨alarmä¸­å‰æˆ–ä¹‹åä¸€æ®µæ—¶é—´ï¼Œå› æ­¤ä¼šå¤šè§¦å‘ä¸€æ¬¡ï¼‰<br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200725220641909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> è€Œå®¢æˆ·ç«¯å‘é€äº†ä¸€æ¡sadæ¶ˆæ¯ä¹‹åsocketçš„å…³é—­æ—¶é—´é‡ç½®ï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¸å‘æ¶ˆæ¯ä¹Ÿè¢«å…³äº†</img></p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200725220609511.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> æ—¶é—´å‡åºé“¾è¡¨ç¼ºç‚¹ï¼šæ·»åŠ æ—¶é—´èŠ‚ç‚¹çš„æ•ˆç‡ä½ï¼Œéå†æŸ¥æ‰¾å¤æ‚åº¦ Oï¼ˆnï¼‰<br/> ä½†è¯´å®è¯ï¼Œä¹¦ä¸Šçš„è¿™ä¸ªc++ä»£ç å¤ªcäº†ä¸€ç‚¹ï¼Œä¹‹åç”¨åˆ°äº†å†æ”¹è¿›å§ï¼</img></p>
<p>å®šæ—¶å™¨ä¹‹æ—¶é—´è½®ï¼Œä¸‹å›åˆ†è§£â€¦</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä¸»ç¨‹åº<br/> RussiaBlock.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/18.</span>
<span class="token comment">//</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Table.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hierarchical_mutex.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"fstream"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">thread_local</span> <span class="token keyword">uint64_t</span>
        hierarchical_mutex<span class="token operator">::</span>this_thread_hierarchical_value <span class="token operator">=</span> ULONG_MAX<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"./a.out number "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//å…¨å±€å˜é‡</span>
    <span class="token keyword">static</span> Table <span class="token function">tab</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ„é€ ä¸€ä¸ª15,20çš„æ£‹ç›˜</span>
    <span class="token keyword">static</span> Block bl<span class="token punctuation">;</span>      <span class="token comment">//æ„é€ ä¸€ä¸ªè½ä¸‹æ–¹å—</span>
    hierarchical_mutex <span class="token function">table_mtx</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hierarchical_mutex <span class="token function">mtx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    thread <span class="token function">getkey</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> termios saveterm<span class="token punctuation">,</span> nt<span class="token punctuation">;</span>
        fd_set rfds<span class="token punctuation">,</span> rs<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q<span class="token punctuation">,</span> r<span class="token punctuation">,</span> fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//æ ‡å‡†è¾“å…¥</span>
        <span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nt <span class="token operator">=</span> saveterm<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ECHO<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ISIG<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ICANON<span class="token punctuation">;</span>
        <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rfds<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">write</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"select error.\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"select error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rfds <span class="token operator">=</span> rs<span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ä¸Šä¸‹å·¦å³</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token string">'A'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//æ—‹è½¬</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bl<span class="token punctuation">.</span><span class="token function">get_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">rotate_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'B'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//å‘ä¸‹ï¼ˆåŠ é€Ÿï¼‰</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'C'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*å‘å³*/</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//å·¦</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">113</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"game over"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">tcsetattr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread <span class="token function">printloop</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"clear"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this_thread<span class="token operator">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">::</span>chrono<span class="token operator">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">/</span> tab<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"ä»»æ„é”®é€€å‡º"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    getkey<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    printloop<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dir<span class="token punctuation">,</span> i<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//ç”Ÿæˆæ–¹å—</span>
        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        std::unique_lock&lt;std::mutex&gt;table_lock(table_mtx);</span>

        bl<span class="token punctuation">.</span><span class="token function">create_block</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tab<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ</span>
        table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">///è¡ŒåŠ¨æŒ‰é”®åˆ¤å®š</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            this_thread<span class="token operator">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">::</span>chrono<span class="token operator">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">400</span> <span class="token operator">/</span> tab<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/å‘ä¸‹ç§»åŠ¨ä¸€æ ¼</span>
            table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//æ¸…ç©ºä¸Šä¸€æ¬¡æ–¹å—ä½ç½®</span>
            bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å‘ä¸‹ç§»åŠ¨ä¸€æ­¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//æ˜¯å¦è§¦åº•</span>
                bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å¦‚æœè§¦åº•ï¼Œè¿˜åŸè§¦åº•å‰ä½ç½®</span>
                tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//å¦‚æœæ»¡è¡Œåˆ™æ¶ˆè¡Œ</span>
        table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tab<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">if_full</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//æ˜¯å¦æ»¡è¡Œ</span>
                tab<span class="token punctuation">.</span><span class="token function">clr_line</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å¦‚æœæ˜¯ï¼Œæ¶ˆè¡Œ</span>
                tab<span class="token punctuation">.</span><span class="token function">move_line</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å°†æ‰€æ¶ˆè¡Œçš„ä¸Šé¢çš„æ£‹ç›˜ä¿¡æ¯ä¸‹ç§»</span>
                i<span class="token operator">--</span><span class="token punctuation">;</span>      <span class="token comment">//ä¸‹ç§»åï¼Œé‡æ–°æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æ»¡ï¼ˆå¯èƒ½å‡ºç°å‡ è¡ŒåŒæ—¶æ¶ˆå»ï¼‰</span>
                tab<span class="token punctuation">.</span><span class="token function">set_count</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è®°å½•å¾—åˆ†</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>grid.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_GRID_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_GRID_H</span>

<span class="token keyword">struct</span> grid <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span>

    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span>grid<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token keyword">noexcept</span> <span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    grid<span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    grid<span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span> grid<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//åæ ‡</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_GRID_H</span>

</code></pre>
<p>grid.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"grid.h"</span></span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span>grid <span class="token operator">&amp;&amp;</span>rhs<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token operator">~</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

grid <span class="token operator">&amp;</span>grid<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> rhs<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> rhs<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

grid <span class="token operator">&amp;</span>grid<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>grid <span class="token operator">&amp;&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> rhs<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> rhs<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Block.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_BLOCK_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_BLOCK_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;termios.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;zconf.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"grid.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BLOCK_SIZE 4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SLEEP_TIME 500</span>

<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;random&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Block</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">using</span> Action <span class="token operator">=</span>Block<span class="token operator">&amp;</span><span class="token punctuation">(</span>Block<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> direct <span class="token punctuation">{<!-- --></span>
        UP<span class="token punctuation">,</span> DOWN<span class="token punctuation">,</span> LEFT<span class="token punctuation">,</span> RIGHT
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    grid g<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">center</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">def_block</span><span class="token punctuation">(</span>grid g1<span class="token punctuation">,</span> grid g2<span class="token punctuation">,</span> grid g3<span class="token punctuation">,</span> grid g4<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> g1<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> g2<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> g3<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> g4<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//é¡ºæ—¶é’ˆæ—‹</span>
        <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> center<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            y <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> center<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> center<span class="token punctuation">.</span>x <span class="token operator">+</span> y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> center<span class="token punctuation">.</span>y <span class="token operator">-</span> x<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>y<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>y<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">left</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>x<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>x<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span>direct dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">*</span>Menu<span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">void</span> <span class="token function">set_cen</span><span class="token punctuation">(</span>grid g<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        center <span class="token operator">=</span> g<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    grid <span class="token function">get_cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token keyword">int</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        type <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">get_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">rotate_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//rotateçš„é€†å‘</span>
        <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> center<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            y <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> center<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> center<span class="token punctuation">.</span>x <span class="token operator">+</span> y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> center<span class="token punctuation">.</span>y <span class="token operator">-</span> x<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">create_block</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ran<span class="token punctuation">;</span>
        grid g<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> std<span class="token operator">::</span>uniform_int_distribution<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">&gt;</span> <span class="token function">u</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> std<span class="token operator">::</span>default_random_engine <span class="token function">e</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ran <span class="token operator">=</span> <span class="token function">u</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ran<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//åL</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//Z</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//åZ</span>
            <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//ç”°</span>
            <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//1</span>
            <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//å±±</span>
            <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"someThing err!"</span> <span class="token operator">&lt;&lt;</span> ran <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">def_block</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> Action Menu<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    grid center<span class="token punctuation">;</span>
    <span class="token keyword">int</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_BLOCK_H</span>

</code></pre>
<p>Block.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>
Block<span class="token operator">::</span>Action Block<span class="token operator">::</span>Menu<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>up<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>down<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>left<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>right
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Table.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Table.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">set_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token comment">//æ¯”å¦‚ä¸‹é™ä¹‹å table[x][y]ä¸Šæœ‰æ–¹å—äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">&gt;=</span> width <span class="token operator">||</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;=</span> height <span class="token operator">||</span> y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">clr_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">clr_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;=</span> height<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> height<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> width<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">if_full</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">get_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"clear"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
            <span class="token keyword">else</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"#"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
            <span class="token comment">//â–£</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  ç­‰çº§ï¼š"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  å¾—åˆ†ï¼š"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  Press 'q' to quit!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">move_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> y<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">set_count</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    count <span class="token operator">+</span><span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Table<span class="token operator">::</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Table.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_TABLE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_TABLE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> TABLE_SIZE 20</span>
<span class="token keyword">class</span> <span class="token class-name">Block</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>

    <span class="token function">Table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">height</span><span class="token punctuation">(</span>TABLE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>             <span class="token comment">//æ„é€ æ£‹ç›˜</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">height</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">width</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">set_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//å®‰è®¾æ–¹å—</span>
    <span class="token keyword">void</span> <span class="token function">clr_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//æ¸…é™¤æ–¹å—</span>
    <span class="token keyword">int</span> <span class="token function">clr_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//æ¶ˆè¡Œ</span>

    <span class="token keyword">int</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">//è·å–æ£‹ç›˜å®½åº¦</span>
    <span class="token keyword">int</span> <span class="token function">if_full</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//åˆ¤å®šæ˜¯å¦æ»¡è¡Œ</span>
    <span class="token keyword">int</span> <span class="token function">get_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//è·å–æ£‹ç›˜ä¸Šç‚¹ä¿¡æ¯</span>
    <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//ç»˜åˆ¶æ£‹ç›˜</span>
    <span class="token keyword">void</span> <span class="token function">move_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//æ•´è¡Œä¸‹ç§»</span>
    <span class="token keyword">void</span> <span class="token function">set_count</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//è®°å½•å¾—åˆ†</span>
    <span class="token keyword">int</span> <span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    <span class="token comment">//è·å–å¾—åˆ†</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> table<span class="token punctuation">[</span>TABLE_SIZE<span class="token punctuation">]</span><span class="token punctuation">[</span>TABLE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//æ£‹ç›˜</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span> width<span class="token punctuation">;</span>        <span class="token comment">//æ£‹ç›˜çš„é«˜å’Œå®½</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>            <span class="token comment">//å¾—åˆ†</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_TABLE_H</span>

</code></pre>
<p>hierarchical_mutex.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/18.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_HIERARCHICAL_MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_HIERARCHICAL_MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;climits&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">hierarchical_mutex</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token operator">::</span>mutex internal_mutex<span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> <span class="token keyword">const</span> hierarchical_value<span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> previous_value<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">thread_local</span> <span class="token keyword">uint64_t</span> this_thread_hierarchical_value<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>this_thread_hierarchical_value <span class="token operator">&lt;=</span> hierarchical_value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"mutex hierarchical violated."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        previous_value <span class="token operator">=</span> this_thread_hierarchical_value<span class="token punctuation">;</span>
        this_thread_hierarchical_value <span class="token operator">=</span> hierarchical_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">explicit</span> <span class="token function">hierarchical_mutex</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> value<span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token function">hierarchical_value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">previous_value</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        internal_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        this_thread_hierarchical_value <span class="token operator">=</span> previous_value<span class="token punctuation">;</span>
        internal_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>internal_mutex<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_HIERARCHICAL_MUTEX_H</span>

</code></pre>
<ul><li>ç§¯ç´¯çš„ç»éªŒï¼š</li></ul>
<ol><li> <p>ç”Ÿæˆéšæœºæ•°çš„uniform_int_distributionï¼Œdefualt_random_engine(time(0))ä½¿ç”¨æ—¶å¿…é¡»ç”¨static,ç¼ºç‚¹æ˜¯å¤šæ¬¡æ‰§è¡Œç¨‹åºçš„ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„æ•°å­—æ˜¯ä¸€æ ·çš„</p> </li><li> <p>ä¸c++primer p743ç±»ä¼¼ï¼Œä½¿ç”¨æˆå‘˜æŒ‡é’ˆå‡½æ•°è¡¨å¯ä»¥ä½¿ç”¨æˆ·è°ƒç”¨çš„å‡½æ•°æ›´åŠ æ˜äº†ã€‚</p> </li><li> <p>ç»™äº’æ–¥é”åŠ æƒå€¼ï¼Œå¹¶ä»¥æƒå€¼å¤§å°é¡ºåºåŠ é”ï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹åŠ é”é¡ºåºä¸€è‡´ï¼Œé¿å…æ­»é”ï¼ˆå‡ºç°åˆ™æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼ˆè¿™ä¸ªçº¯ç²¹æ´»å­¦æ´»ç”¨ï¼Œå› ä¸ºc++é”å’Œçº¿ç¨‹æ¥è§¦ä¸å¤šï¼‰</p> </li><li> <p><code>thread xxx([&amp;](){})</code>æ˜¯å¯ä»¥æ”¾åœ¨å‡½æ•°å†…éƒ¨çš„çº¿ç¨‹</p> </li><li> <p>åˆ©ç”¨selectç›‘æ§æ ‡å‡†è¾“å…¥</p> </li><li> <p>åˆ©ç”¨tcgetattr,tcsetaddrï¼Œtermiosiç»“æ„ä½“<br/> <code>nt.c_lflag &amp;= ~ECHO; nt.c_lflag &amp;= ~ISIG; nt.c_lflag &amp;= ~ICANON;</code><br/> å¯ä»¥åœ¨linuxå…³é—­å›æ˜¾ï¼Œå®ç°getch</p> </li><li> <p><code>this_thread::sleep_for(std::chrono::milliseconds(400 / tab.getLevel()));</code>å¯ä»¥å’‹çº¿ç¨‹ä¸­å®ç°æ¯«ç§’çº§åˆ«ç¡çœ </p> </li><li> <p>ç±»ä¸­é™æ€å¯¹è±¡åˆå§‹åŒ–å¯ä»¥å†™åœ¨å…¶å¯¹åº”.cppæ–‡ä»¶ä¸­</p> </li></ol>
<ul><li>åæ€ï¼š</li></ul>
<ol><li>æœªä½¿ç”¨ç±»çš„ç»§æ‰¿ï¼Œå„ç§æ–¹å—ç†è®ºå¯ä»¥å†™æˆå­ç±»ï¼Œå› ä¸ºä¸»çº¿ç¨‹ä¸€å¼€å§‹ç›´æ¥ä½¿ç”¨äº†Blockå¯¹è±¡ï¼ŒåæœŸä¸å®¹æ˜“ä¿®æ”¹.</li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p><a href="https://blog.csdn.net/qingfengleerge/article/details/85261316">MySQL C API ä½¿ç”¨ï¼ˆåŸºæœ¬å‡½æ•°ï¼‰</a><br/> <a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611432985088">liaoxuefeng SQL</a><br/> äº†è§£äº†ä»¥ä¸ŠåŸºç¡€çŸ¥è¯†ï¼Œå»åŒ…è£…ä¸€äº›å‡½æ•°ç”¨æ¥ç»™cä½¿ç”¨</p>
<p>accept_mysql ç”¨æ¥è¿æ¥æ•°æ®åº“</p>
<pre><code class="prism language-c">MYSQL   <span class="token function">accept_mysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    MYSQL   mysql<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span><span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_init err"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mysql_library_init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_init err"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">,</span><span class="token string">"sss"</span><span class="token punctuation">,</span><span class="token string">"chatroom"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_real_connect"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mysql_set_character_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_set_character_set"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"è¿æ¥æ•°æ®åº“æˆåŠŸ\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  mysql<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>close_mysql(å…³é—­æ•°æ®åº“)</p>
<pre><code class="prism language-c">
<span class="token keyword">int</span> <span class="token function">close_mysql</span><span class="token punctuation">(</span>MYSQL   mysql<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_library_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>use_mysql<br/> return 1 ä»£è¡¨æ²¡æ•°æ®<br/> return -1 ä»£è¡¨mysqlè¯­å¥å‡ºé”™<br/> (ç”¨äºæŸ¥è¯¢æ•°æ®åº“æˆ–è€…ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œä½†è¿™ä¸ªå‡½æ•°çš„ç¼ºç‚¹selectæ˜¯åªèƒ½æ‰“å°ï¼Œä¸èƒ½ä¼ å‡ºå•ä¸ªæ•°æ®)</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">use_mysql</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>string<span class="token punctuation">,</span>MYSQL mysql<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span>    <span class="token keyword">int</span> num_fields<span class="token punctuation">,</span>num_rows<span class="token punctuation">;</span>
    MYSQL mysql_temp<span class="token operator">=</span>mysql<span class="token punctuation">;</span>
    MYSQL_RES  <span class="token operator">*</span>result<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    MYSQL_ROW       row<span class="token punctuation">;</span>
    MYSQL_FIELD <span class="token operator">*</span>field<span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        result  <span class="token operator">=</span>   <span class="token function">mysql_store_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            num_rows<span class="token operator">=</span><span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num_rows<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>        
            num_fields  <span class="token operator">=</span><span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>field<span class="token operator">=</span><span class="token function">mysql_fetch_field</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-20s"</span><span class="token punctuation">,</span>field<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_fields<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-20s"</span><span class="token punctuation">,</span>row<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"query err\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>è€Œå¦‚æœæƒ³è¦å¾—åˆ°select çš„æ¯ä¸€ä¸ªæ•°æ®ï¼Œæˆ‘é‡‡å–çš„æ–¹æ³•æ˜¯å¼€è¾ŸåŠ¨æ€å†…å­˜ï¼Œä½†åå¤„æ˜¯è°ƒç”¨æ­¤å‡½æ•°ä¹‹åè¦æ‰‹åŠ¨freeï¼Œä¼šå¾ˆç¹ç,è€Œä¸”å†…å­˜å¼€è¾Ÿçš„ä½ç½®å¾—åœ¨å‡½æ•°é‡Œé¢ï¼Œå› ä¸ºæ— æ³•ç¡®å®šæœ‰å¤šå°‘è¡Œç»“æœï¼ŒåŒæ—¶åªæœ‰å‡½æ•°è¿”å›0æˆ–è€…è¿”å›-2çš„æ—¶å€™è¦freeã€‚è°ƒç”¨å‡½æ•°çš„æ—¶å€™éœ€è¦ifåˆ¤æ–­ã€‚<br/> è°ƒç”¨æ–¹å¼</p>
<pre><code class="prism language-c">mysqlMsg<span class="token operator">*</span>mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">&amp;</span>mmsglist<span class="token punctuation">,</span>mMum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mmsglist<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">free</span><span class="token punctuation">(</span>mmsglist<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mmsglist<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">free</span><span class="token punctuation">(</span>mmsglist<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ï¼ˆå¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆæ›´å¥½çš„æ–¹æ³•å¯ä»¥æ•™æ•™æˆ‘ï¼‰</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>MYSQL mysql<span class="token punctuation">,</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span>mysqlMsg<span class="token operator">*</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span>    <span class="token keyword">int</span> num_fields<span class="token punctuation">,</span>num_rows<span class="token punctuation">;</span>
    MYSQL mysql_temp<span class="token operator">=</span>mysql<span class="token punctuation">;</span>
    MYSQL_RES  <span class="token operator">*</span>result<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    MYSQL_ROW       row<span class="token punctuation">;</span>
    MYSQL_FIELD <span class="token operator">*</span>field<span class="token punctuation">;</span>
    <span class="token keyword">char</span> table<span class="token punctuation">[</span>MYSQL_TABLE_LEN<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"message"</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> mysql_order<span class="token punctuation">[</span>MYSQL_ORDER_MAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>mNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token function">snprintf</span><span class="token punctuation">(</span>mysql_order<span class="token punctuation">,</span>MYSQL_ORDER_MAXLEN<span class="token punctuation">,</span><span class="token string">" select id,uid,type,sid,msg,status,flag from %s \
        where uid ='%d' \
        "</span><span class="token punctuation">,</span>table<span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">,</span>mysql_order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        result  <span class="token operator">=</span>   <span class="token function">mysql_store_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// num_fields  =mysql_num_fields(result);        </span>
            num_rows<span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num_rows<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>        
            <span class="token operator">*</span>mNum<span class="token operator">=</span>num_rows<span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"å‡ºç° NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    
                    <span class="token keyword">return</span>  <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// (*(mMsgList)+i)-&gt;recv_id=uid;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
             <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"???query   fail\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<hr/>
<p>èŠå¤©å®¤é‡Œç»å¸¸ç”¨åˆ°çš„mysqlè¯­å¥<br/> å¢åˆ æ”¹æŸ¥<br/> <code>insert into xxx(name,xxxx,xx)values(xx,xxx,xxxx);</code><br/> <code>delete from xxx where x=y;</code><br/> <code>update xxx set x1=y1,x2=y2</code><br/> <code>select xxx from xx where x= y;</code></p>
<p>create table<br/> AUTO_INCREMENT è‡ªå¢<br/> ENGINE=InnoDB å¼•æ“<br/> PRIMARY KEY (<code>id</code>) ä¸»é”®</p>
<p>NOT NULL çš„æ„ä¹‰ï¼ˆã€Šmysqlå¿…çŸ¥å¿…ä¼šã€‹ï¼‰</p>
<blockquote>
<p>ä¸å…è®¸ NULL å€¼çš„åˆ—ä¸æ¥å—è¯¥åˆ—æ²¡æœ‰å€¼çš„è¡Œ,<br/> æ¢å¥è¯è¯´,åœ¨æ’å…¥æˆ–æ›´æ–°è¡Œæ—¶,è¯¥åˆ—å¿…é¡»æœ‰å€¼ã€‚</p>
</blockquote>
<pre><code class="prism language-c"><span class="token function">use_mysql</span><span class="token punctuation">(</span>"create table <span class="token function">account</span><span class="token punctuation">(</span>\
    id BIGINT NOT <span class="token constant">NULL</span> AUTO_INCREMENT<span class="token punctuation">,</span>\
    å§“å <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT <span class="token constant">NULL</span> <span class="token punctuation">,</span>\
    å¸å· <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT <span class="token constant">NULL</span> UNIQUE<span class="token punctuation">,</span>\
    PRIMARY KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>\
    <span class="token punctuation">)</span>ENGINE<span class="token operator">=</span>InnoDB 
          AUTO_INCREMENT<span class="token operator">=</span><span class="token number">1</span>
           DEFAULT CHARSET<span class="token operator">=</span>utf8"<span class="token punctuation">,</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr/>
<hr/>
<p>åœ¨c++ä¸­mysqlå°è£…æˆç±»çš„ç¡®ä¼šæ–¹ä¾¿å¾ˆå¤š,åŒæ—¶å®ƒåˆ†æˆäº† mysql_noResult_query<br/> ï¼Œmysql_select_queryï¼Œmysql_select_SingleLine_queryï¼ˆè¿™ä¸ªå¹¶ä¸å¿…è¦ï¼‰ä¸‰ç§æ–¹å¼ï¼Œå› ä¸ºvector,mapå®¹å™¨åŠ¨æ€æ‰©å®¹çš„ç‰¹ç‚¹ï¼Œä¹Ÿå°±ä¸éœ€è¦ä¸Šè¿°cç‰ˆæœ¬éº»çƒ¦çš„åŠ¨æ€å†…å­˜ã€‚</p>
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">mysql_db</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/*
        mysql_open()
        return : 1 OK
                -1 å¤±è´¥
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> user<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> password<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> database<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_noResult_query();
        éselectè¯­å¥æŸ¥è¯¢
        return &gt;0 æˆåŠŸ, ä¸ºå—å½±å“çš„è¡Œæ•°
               -1 å¤±è´¥
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_noResult_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_select_query();
        æœ‰ç»“æœé›†çš„æŸ¥è¯¢
        return &gt;0 ok è¿”å›ç»“æœé›†æ¡æ•°
               -1 å¤±è´¥
        map_results first = è¡Œ second = values
        */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_select_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql<span class="token punctuation">,</span> map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span> map_results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_select_SingleLine_query();
        åªæœ‰ä¸€æ¡æ•°æ® , æˆ–è€…åªæœ‰ä¸€ä¸ªå­—æ®µ N æ¡çš„æŸ¥è¯¢. ç›´æ¥è°ƒç”¨vectorå³å¯
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_select_SingleLine_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> v_results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_lasterror();
        è¿”å›æœ€è¿‘ä¸€æ¬¡é”™è¯¯ä¿¡æ¯
     */</span>
    string <span class="token function">mysql_lasterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    MYSQL sqlCon<span class="token punctuation">;</span>
    MYSQL_RES <span class="token operator">*</span>m_pResult<span class="token punctuation">;</span>
    MYSQL_ROW  m_Row<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre>
<pre><code class="prism language-cpp">
mysql_db<span class="token operator">::</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// mysql åˆå§‹åŒ–</span>
<span class="token punctuation">}</span>

mysql_db<span class="token operator">::</span><span class="token operator">~</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å…³é—­è¿æ¥</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>password<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>database<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> nvalue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">mysql_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> MYSQL_OPT_RECONNECT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nvalue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ–­çº¿è‡ªåŠ¨é‡è¿</span>
    <span class="token function">mysql_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> MYSQL_SET_CHARSET_NAME<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_noResult_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">mysql_affected_rows</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_select_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span>map_results<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_pResult <span class="token operator">=</span> <span class="token function">mysql_use_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>m_Row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>vVal<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                vVal<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                vVal<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        map_results<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>vVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_select_SingleLine_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>v_results<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_pResult <span class="token operator">=</span> <span class="token function">mysql_use_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>m_Row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            v_results<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

string mysql_db<span class="token operator">::</span><span class="token function">mysql_lasterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>å…³äºè¡¨æ€ä¹ˆè®¾è®¡ï¼Œæˆ‘è®¤ä¸ºèŠå¤©å®¤ä¸­çš„æˆ‘è®¾è®¡çš„å¾ˆä¸å¥½ï¼Œ9å¼ è¡¨ï¼Œç”±äºæˆ‘çš„å§“åæ”¾åœ¨accountè¡¨ï¼Œæˆ‘å°±æ²¡å»è®¾è®¡å¦‚ä½•æ¢å§“åã€‚ç”±äºå¯†ä¿æ”¾åœ¨äº†accountè¡¨å¯¼è‡´ç¾¤å¸å·å¿…é¡»é‡æ–°å»ºè¡¨ï¼Œè€Œä¸æ˜¯å’Œäººå¸å·æ”¾ä¸€èµ·ï¼Œè¿˜å¾—åˆ†å‡ºæ–‡ä»¶è¡¨å’Œç¾¤æ–‡ä»¶è¡¨è¿™å¯¼è‡´äº†ç¨‹åºæ›´åŠ ç¹çã€‚<br/> fri_maskè¡¨ä½¿ç”¨æ¥å±è”½å¥½å‹æ¶ˆæ¯çš„ä¸çŸ¥é“æ˜¯ä¸æœ‰ç‚¹é¸¡è‚‹ã€‚ã€‚ã€‚</p>
<p>è™½è¯´ç¬¬ä¸€æ¬¡è®¾è®¡çš„ä¸å¥½ï¼Œä½†è‡³å°‘ç¨‹åºèƒ½è·‘ï¼Œè€Œä¸”æœ‰äº†ç»éªŒï¼Œä¸‹æ¬¡å°±æ²¡è¿™ä¹ˆéš¾äº†ã€‚</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501414.png"><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501416.png"><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501412.png"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501373.png"/><br/> <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/20200711151501372.png"/></img></img></img></img></img></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>AVLæ ‘å‘¢ï¼Œæ˜¯å¹³è¡¡æ ‘ä¸­ä¸€ä¸ªéå¸¸ç»å…¸çš„ä¾‹å­ã€‚å› ä¸ºæ™®é€šçš„æŸ¥æ‰¾æ ‘åœ¨æ’å…¥å’Œåˆ é™¤çš„è¿‡ç¨‹æœ‰å¯èƒ½ä¼šäº§ç”Ÿæ ‘çš„ä¸€ç«¯å­æ ‘é«˜åº¦æ¯”å¦ä¸€è¾¹å¤§å¾ˆå¤šçš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„é€€åŒ–ä¸ºé“¾è¡¨ï¼ˆæŸ¥æ‰¾æ˜¯ä¸€ä¸ªä¸€ä¸ªèŠ‚ç‚¹å»æ‰¾ï¼‰ï¼Œé™ä½äº†æŸ¥æ‰¾çš„æ•ˆç‡ã€‚</p>
<p>AVLå¹³è¡¡æ ‘é€šè¿‡ä¸€ç³»åˆ—æ—‹è½¬çš„æ–¹å¼è®©å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦ç›¸å·®ä¸å¤§ï¼ˆ&lt;=1ï¼‰ï¼Œè¿™æ ·æœç´¢çš„æ•ˆç‡å°†ä¼šç»´æŒåœ¨è¾ƒå¥½çš„æ°´å¹³ã€‚</p>
<p>æ–¹æ³•å°±æ˜¯å½“æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œ<br/> æ›´æ–°çˆ¶èŠ‚ç‚¹çš„é«˜åº¦ï¼Œåˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„å·¦å³å­æ ‘é«˜åº¦å·®æ˜¯å¦ä¸º2,è‹¥æ˜¯ï¼Œè¿›è¡Œç›¸åº”æ—‹è½¬æ“ä½œï¼ˆ4ç§ï¼‰æ¥é™ä½å·¦å³å­æ ‘é«˜åº¦å·®ã€‚è‹¥ä¸æ˜¯ï¼Œåˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„çˆ¶çš„å·¦å³å­æ ‘é«˜åº¦å·®æ˜¯å¦ä¸º2ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ ¹èŠ‚ç‚¹ï¼ˆå½“ç„¶æ˜¯é€’å½’ä¸­å®Œæˆï¼‰ã€‚</p>
<p>å•å·¦æ—‹ï¼Œå•å³æ—‹ï¼Œå·¦å³æ—‹ï¼Œå³å·¦æ—‹å°±æ˜¯å°†3ä¸ªèŠ‚ç‚¹é—´è°ƒæ•´æ¬¡åºæ¥ï¼Œä»£ç å¦‚ä¸‹ï¼Œå…·ä½“æ ·å­å°±ä¸ç”»å›¾äº†ï¼Œåœ¨è¿™äº›ç‚¹è°ƒèŠ‚æ¬¡åºçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœç´¢æ ‘èŠ‚ç‚¹å¤§å°é¡ºåºè¿˜æ˜¯æ­£å¸¸æ’åˆ—çš„ã€‚<br/> ä¹Ÿå°±æ˜¯ä¸­åºéå†çš„ç»“æœè¿˜æ˜¯1234567è¿™æ ·ä»å°åˆ°å¤§æ’åˆ—ã€‚<br/> avl_tree.h</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _Avltree_h</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _Avltree_h</span>
<span class="token macro property">#<span class="token directive keyword">define</span> Max(a,b) ((a)&gt;(b)?(a):(b))</span>

<span class="token keyword">struct</span> AvlNode<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> AvlNode<span class="token operator">*</span>Position<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> AvlNode<span class="token operator">*</span>AvlTree<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> ElementType <span class="token punctuation">;</span>
Position    <span class="token function">Find</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
Position    <span class="token function">FindMin</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
Position    <span class="token function">FindMax</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvlTree <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvlTree <span class="token function">Insert</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">InOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">PostOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PreOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">InOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PostOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> AvlNode
<span class="token punctuation">{<!-- --></span>
    ElementType Element<span class="token punctuation">;</span>
    AvlTree Left<span class="token punctuation">;</span>
    AvlTree Right<span class="token punctuation">;</span>
    <span class="token keyword">int</span> Height<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


</code></pre>
<p>avl_tree.c</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"avl_tree.h"</span></span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> Height <span class="token punctuation">(</span>Position P<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// puts("å³æ—‹");</span>

    Position    K1<span class="token punctuation">;</span>
    K1<span class="token operator">=</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>K1<span class="token operator">-&gt;</span>Right<span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Right<span class="token operator">=</span>K2<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span>K2<span class="token operator">-&gt;</span>Height<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  K1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//puts("å·¦å³");</span>

    K3<span class="token operator">-&gt;</span>Left<span class="token operator">=</span><span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>K3<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 
        1
    0       2   k2
                4   k1 
                    5
        1
    0       4  k1
            2   5
     */</span>
    <span class="token comment">// puts("å•å·¦æ—‹");</span>
    Position    K1<span class="token punctuation">;</span>
    K1<span class="token operator">=</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Right<span class="token operator">=</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>K2<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span>K2<span class="token operator">-&gt;</span>Height<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  K1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// puts("å³å·¦");</span>
<span class="token comment">/*     
    //120534
    1                                                       1                                   1               
0        2       k3       --ã€‹                   0       2       --ã€‹       0           3
            5      k3-&gt;right                                3                           2       5   
        3                                                                 5     
                
 */</span>     
  K3<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>K3<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">InOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PostOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">InOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">PostOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> retSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> retSize2<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        retSize<span class="token operator">=</span><span class="token function">PostOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        retSize2<span class="token operator">=</span><span class="token function">PostOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d(%d)\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token operator">+</span>retSize<span class="token operator">+</span>retSize2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  retSize2<span class="token operator">+</span>retSize<span class="token operator">+</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PreOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

AvlTree  <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//ååº</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> Height <span class="token punctuation">(</span>Position P<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>P<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> 
        <span class="token keyword">return</span>  P<span class="token operator">-&gt;</span>Height<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Position    <span class="token function">Find</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token function">Find</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token function">Find</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>    
        <span class="token keyword">return</span>  T<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

AvlTree <span class="token function">Insert</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        T<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> AvlNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Out of space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            T<span class="token operator">-&gt;</span>Element<span class="token operator">=</span>X<span class="token punctuation">;</span>
            T<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            T<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>T<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æ”¾åœ¨å·¦ï¼ˆé€’å½’ï¼‰</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// printf("%d&lt;%d\n",X,T-&gt;Element);</span>
        T<span class="token operator">-&gt;</span>Left<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment">//å·¦å·¦-&gt;å•å³æ—‹</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Left<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
                T<span class="token operator">=</span><span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å·¦å³-&gt;åŒå³å·¦æ—‹</span>
            <span class="token keyword">else</span> 
                T<span class="token operator">=</span><span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        T<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Right<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                T<span class="token operator">=</span><span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    T<span class="token operator">=</span><span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    T<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  T<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è‡ªå·±å†™çš„æ–°éå†å‡½æ•°ï¼Œå¯ä»¥æ‰“å°å‡ºå…ˆåºéå†( PreOrder_2)ï¼Œä¸­åºéå†(INOrder_2)ï¼Œååºéå†( PostOrder_2)çš„æ•ˆæœ</p>
<ul><li>å…ˆåºéå†:ä¸­å·¦å³ ï¼ˆç»´æŠ¤æ·±åº¦ï¼Œå­èŠ‚ç‚¹ä»çˆ¶èŠ‚ç‚¹ç»§æ‰¿ï¼‰</li><li>ä¸­åºéå†:å·¦ä¸­å³ ä»å°åˆ°å¤§</li><li>ååºéå†:å·¦å³ä¸­ï¼ˆç»´æŠ¤é«˜åº¦ï¼Œçˆ¶èŠ‚ç‚¹ä»å­èŠ‚ç‚¹è·å–ï¼‰ ï¼ˆå¯ç”¨äºç»Ÿè®¡ç›®å½•çš„å¤§å°ï¼Œå­æ–‡ä»¶çš„å¤§å°ç›¸åŠ å†åŠ åˆ°ç›®å½•ä¸­ï¼‰è¿™é‡Œæˆ‘å°±ç›´æ¥ç”¨æ•°å­—ä»£è¡¨èŠ‚ç‚¹çš„æƒå€¼æ¥ä»£æ›¿æ–‡ä»¶å¤§å°ï¼Œå¹¶åˆå¹¶åˆ°çˆ¶èŠ‚ç‚¹ä¸­ã€‚</li></ul>
<p>(æˆ‘è§‰å¾—ä¸­åºæ‰“å°å‡ºæ¥çš„æœ€åƒæ ‘)</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"avl_tree.h"</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AvlTree T<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// int X=1;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=0;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=2;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=5;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=3;</span>
    <span class="token comment">// T=Insert(X,T);</span>

    <span class="token comment">/* 
    
        1                      1                                1
    0   2               0       2                   0           3
            5                           3                       2       5
          3                                   5
    
     */</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        T<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// if(Find(3,T)-&gt;Right){<!-- --></span>
    <span class="token comment">//     printf("r%d\n",Find(3,T)-&gt;Right-&gt;Element);</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if(Find(3,T)-&gt;Left){<!-- --></span>
    <span class="token comment">//     printf("l%d\n",Find(3,T)-&gt;Left-&gt;Element);</span>
    <span class="token comment">// }</span>
    
     <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"å…ˆ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ä¸­"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"å"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// puts("å2");</span>
    <span class="token comment">// PostOrder_2(T,0);</span>
    <span class="token comment">// PreOrder_2(T,0);</span>
    <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-shell">å…ˆ
4
2
1
3
8
6
5
7
9
10
--------------------------
ä¸­
1
2
3
4
5
6
7
8
9
10
--------------------------
å
1
3
2
5
7
6
10
9
8
4
--------------------------
å…ˆ
4
        2
                1
                3
        8
                6
                        5
                        7
                9
                        10
--------------------------
ä¸­
                1
        2
                3
4
                        5
                6
                        7
        8
                9
                        10
--------------------------
å
                1<span class="token punctuation">(</span>1<span class="token punctuation">)</span>
                3<span class="token punctuation">(</span>3<span class="token punctuation">)</span>
        2<span class="token punctuation">(</span>6<span class="token punctuation">)</span>
                        5<span class="token punctuation">(</span>5<span class="token punctuation">)</span>
                        7<span class="token punctuation">(</span>7<span class="token punctuation">)</span>
                6<span class="token punctuation">(</span>18<span class="token punctuation">)</span>
                        10<span class="token punctuation">(</span>10<span class="token punctuation">)</span>
                9<span class="token punctuation">(</span>19<span class="token punctuation">)</span>
        8<span class="token punctuation">(</span>45<span class="token punctuation">)</span>
4<span class="token punctuation">(</span>55<span class="token punctuation">)</span>
--------------------------
</code></pre>
<p>æœ¬æ–‡å¹¶æ²¡æœ‰åšè¿‡å¤šçš„è®²è§£ï¼Œä¹Ÿå°±æ˜¯å¸¦å¤§å®¶çœ‹ä¸€ä¸‹AVLçš„æ•ˆæœã€‚<br/> æœ¬æ¥å¦‚æœæ’å…¥123456789 10å¯ä»¥æƒ³è±¡æ ‘ä¼šä¸€è·¯é•¿åˆ°ä»€ä¹ˆåœ°æ­¥ã€‚<br/> è‡³äºæ—‹è½¬çš„å››ç§å‡½æ•°ï¼Œè¿˜æ˜¯è‡ªå·±æ…¢æ…¢æ‚Ÿï¼Œè‡ªå·±æ‚Ÿå‡ºæ¥æ°¸è¿œæ¯”çœ‹åˆ«äººåšå®¢æœ‰ç”¨ã€‚</p>
<p>åæ§½ä¸€å¥å½“å¹´å‘æ˜è¿™äº›ç®—æ³•çš„äººçœŸæ¯”æˆ‘ä»¬å¼ºäº†å¤ªå¤šã€‚</p>
<p>å‚è€ƒã€Šæ•°æ®ç»“æ„ä¸ç®—æ³• Cè¯­è¨€æè¿°ã€‹</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>å±•ç¤ºä¸€ä¸‹äºŒè¿›åˆ¶æ–‡ä»¶å†…éƒ¨æ˜¯ä»€ä¹ˆï¼š<br/> æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªä¸ªå­—ç¬¦ã€‚é€šè¿‡ä¸€å®šçš„æ–‡ä»¶æ ¼å¼ï¼Œæ ‡å‡†ï¼ˆæˆ‘è§‰å¾—å°±åƒä¸€äº›ç¨‹åºï¼‰å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿè½¯ä»¶å»è§£è¯»å®ƒï¼ˆå°±åƒåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼‰</p>
<ul><li>å¯æ‰§è¡Œæ–‡ä»¶ELFæ ¼å¼ï¼ˆè‡³äºELFç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œå»ç¿»ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹å§ï¼Œä¹¦ä¸Šæå…¶è¯¦ç»†ï¼Œè€Œæˆ‘è§‰å¾—æˆ‘è¿™éƒ¨åˆ†çœ‹è¿‡æ¥å´åªæ˜¯ä¸€çŸ¥åŠè§£ï¼‰<br/> <img alt="a.out" src="https://img-blog.csdnimg.cn/20200522233155978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> å›¾ç‰‡ï¼špdf<br/> <img alt="pdf" src="https://img-blog.csdnimg.cn/20200522233228480.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/></img></li></ul>
<p>è§†é¢‘ï¼šmp4</p>
<p><img alt="mp4" src="https://img-blog.csdnimg.cn/20200522233417210.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <code>int fd=open("a.txt",O_RDONLY);</code><br/> <code>int fd2=open("b.txt",O_WRONLY|O_APPEND);</code><br/> <code>read(fd,buf,BUFSIZE);</code><br/> <code>strcpy(buf2,buf);</code><br/> <code>write(fd2,buf2,BUFSIZE);</code><br/> å¦‚æœæˆ‘ä»¬ç”¨è¿™æ ·ä¸€æ®µä»£ç å»å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¾—åˆ°çš„æ–‡ä»¶æ˜¯é”™è¯¯çš„ã€‚<br/> ä½†åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</img></p>
<p>æˆ‘æ”¶è·åˆ°çš„ç»éªŒæ˜¯å¦‚æœæƒ³è¦ç”¨bufå»å¤åˆ¶æ•´ä¸ªæ–‡ä»¶ï¼Œåœ¨å¤åˆ¶çš„è¿‡ç¨‹ä¸­ä¸‡ä¸‡è¦å°å¿ƒã€‚<br/> è¿™äº›ä¹±ç å•Šæ˜¯å¯èƒ½åŒ…å«â€™\0â€™è¿™ä¸ªç©ºå­—ç¬¦çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¦‚æœä½¿ç”¨strcpyè¿™ç§é€šè¿‡åˆ¤æ–­æ˜¯å¦åˆ°â€™\0â€™å»å¤åˆ¶å­—ç¬¦ä¸²çš„å‡½æ•°,æ˜¯æœ‰å¯èƒ½ï¼ˆåŸºæœ¬ä¸Šå°±ä¼šï¼‰ä¸¢å¤±æ‰æ–‡ä»¶ä¸€éƒ¨åˆ†çš„ä¿¡æ¯ã€‚ä½¿ç”¨memcpyï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å¤åˆ¶ã€‚å°±å¯ä»¥é¿å…ä¿¡æ¯ä¸¢å¤±ã€‚</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä»Šå¤©è¢«å‡ ä¸ªæ®µé”™è¯¯ï¼Œæ ˆæº¢å‡ºï¼Œfreeä¸æ­£ç¡®çš„æŒ‡é’ˆçš„é”™è¯¯æå¾—ç²¾åŠ›æ†”æ‚´ã€‚</p>
<p>ä¹‹å‰å¯¹äºå¤šçº§æŒ‡é’ˆ+å‡½æ•°å‚æ•°è¿ç”¨å§‹ç»ˆæœ‰ç‚¹è¿·ç³Šï¼Œä»Šå¤©æœçœŸæ ½è¿™å¥½å‡ ä¸ªè·Ÿå¤´ã€‚</p>
<p>è¿™é‡Œå‘¢å°±æ˜¯æƒ³ä»mysqlä¸­æå–å‡ºå‡ ä¸ªå…·æœ‰ç›¸åŒæ¡ä»¶çš„æ•°æ®ï¼Œä¸€è¡Œä¸€è¡Œå¡«è¿›å»å°±è¡Œäº†â€¦<br/> å®šä¹‰ä¸€ä¸ªmysqlMsg*cur=NULL;å†ç”¨&amp;curä¼ å…¥åˆ°ä¸‹é¢çš„å‡½æ•°ä¸­ä¸ºcuråŠ¨æ€åˆ†é…å†…å­˜ç©ºé—´ã€‚</p>
<p>ä½†æ˜¯æˆ‘å¼€å§‹ä½¿ç”¨è¿™å—å†…å­˜æ˜¯å¾ˆç†æ‰€å½“ç„¶è¿™æ ·ç”¨çš„ã€‚</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>MYSQL mysql<span class="token punctuation">,</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span>mysqlMsg<span class="token operator">*</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
â€¦â€¦
     <span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span>â€¦â€¦<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span>uid<span class="token punctuation">;</span>
              i<span class="token operator">++</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>  
â€¦â€¦
<span class="token punctuation">}</span>
</code></pre>
<p>äº‹å®ä¸ŠmMsgList[i]è¿™æ ·ç›¸å½“äº*(mMsgList+i),ä¹Ÿå°±æ˜¯è¶Šè¿‡äº†<code>iÃ—num_rows*sizeof(mysqlMsg)</code>è¿™ä¹ˆå¤§çš„åŒºé—´,i&gt;1æ—¶è¶…è¿‡äº†æˆ‘ä»¬åˆ†é…çš„åŒºé—´å¤§å°ã€‚<br/> äºæ˜¯å‡ºç°äº†å¦‚ä¸‹çš„</p>
<pre><code class="prism language-shell">free<span class="token punctuation">(</span><span class="token punctuation">)</span>: invalid pointer
å·²æ”¾å¼ƒ <span class="token punctuation">(</span>æ ¸å¿ƒå·²è½¬å‚¨<span class="token punctuation">)</span>
</code></pre>
<p>é‚£æ­£ç¡®æ“ä½œæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿï¼Ÿ<br/> äºŒé‡æŒ‡é’ˆå…ˆè§£å¼•ç”¨ï¼Œå†åç§»iä¸ªsizeof(mysqlMsg)å†å»èµ‹å€¼å°±æ²¡é—®é¢˜äº†ã€‚</p>
<pre><code class="prism language-c">     <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span>uid<span class="token punctuation">;</span>
</code></pre>
<p>å½“ç„¶è¿™æ˜¯å› ä¸ºæˆ‘æ˜¯æ˜¯ä¸º<code>*mMsgList</code>åˆ†é…äº†å†…å­˜ç©ºé—´ï¼Œè€Œä¸æ˜¯mMsgList,ä¸ç„¶ä¹‹å‰é‚£ä¸ªå†™æ³•æ˜¯æ­£ç¡®çš„</p>
<p>åˆå¦‚æœæ˜¯ä»¥æ ˆåŒºå­˜å‚¨çš„å¦‚<code>char arglist[10][20]</code>è¿™æ ·ä½œä¸ºå‡½æ•°å‚æ•°çš„è¯ï¼Œç”±äºæ­¤å‚æ•°çœŸæ­£æ„ä¹‰ä¸Šæ˜¯char(*arglist)[20]çš„æ•°ç»„æŒ‡é’ˆã€‚é‚£ä¹ˆarglist[i]ä¹Ÿå°±ä»£è¡¨ç€ä¸€ä¸ªæ•°ç»„ï¼Œå‘è¿™å—å†…å­˜å¡«æ•°æ®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå®ƒå¹¶ä¸ä¼šç›´æ¥è·¨è¿‡ä¸€ä¸ªäºŒé‡æ•°ç»„ã€‚</p>
<p>å•Šï¼ŒåŸºç¡€æ‰å®å¾ˆé‡è¦å•Šï¼</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>ä¸Šä¸ªæœˆåˆçš„myshellå®ç°è®©äººå¤§è´¹è„‘ç­‹ï¼Œåœ¨å­—ç¬¦ä¸²å¤„ç†å’Œå¤šé‡ç®¡é“ä¸Šå‡ºäº†ä¸å°‘å·®é”™ï¼Œä½†å¥½åœ¨æœ€åè¿˜æ˜¯å®ç°äº†è¦æ±‚çš„åŠŸèƒ½ã€‚çœŸçš„å¤ªæ‡’äº†ï¼ŒæŠŠåšå®¢æ‹–åˆ°ç°åœ¨ï½<br/> (ä¹‹åè¿˜å¾—è¡¥myls)</p>
<p>éœ€æ±‚ä¸€ä¸ªä¸€ä¸ªåˆ†æå§</p>
<h4><a id="%09_5"></a>å®ç°ç®¡é“ |</h4>
<p>è¿™ä¸ªçš„æ„æ€å°±æ˜¯æƒ³è¦ä½ æŠŠä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºå½“ä½œè¾“å…¥äº¤ç»™åé¢ä¸€ä¸ªå‘½ä»¤ã€‚å¦‚ls -l | grep â€œaâ€ |wc -cå°±æ˜¯æŠŠls -lçš„è¾“å‡ºç»“æœäº¤ç»™grep å¤„ç†,grepçš„å¤„ç†ç»“æœäº¤ç»™wcå¤„ç†ã€‚<br/> <strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šfork+dup2(fd,0)+execé‡å®šå‘è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶/tmp/file1ä¸­ï¼Œfork+dup(fd,1)+execå†å°†è¿™ä¸ªæ–‡ä»¶temp/file1ä¸­å½“ä½œè¾“å…¥ã€‚(å…¶å®åº”è¯¥ç”¨ç®¡é“æ›´å¥½ï¼Œä½†è¿™é‡Œå°±ç…§ç€ä¹¦ä¸Šçš„æ–¹å¼å†™äº†)</p>
<h4><a id="_____8"></a>å®ç°è¾“å…¥è¾“å‡ºé‡å®šå‘ &lt; &gt; &gt;&gt;</h4>
<ul><li>cat&lt;a.txt å°±æ˜¯å°† &lt;åé¢çš„æ–‡ä»¶çš„å†…å®¹ç»™cat å½“ä½œæ ‡å‡†è¾“å…¥ã€‚</li><li>ls &gt;a.txt å°±æ˜¯å°† lsçš„è¾“å‡ºè¦†ç›–å†™å…¥a.txtä¸­ï¼Œä¹Ÿå°±æ˜¯lsçš„æ ‡å‡†è¾“å‡ºç»™a.txtå½“æ ‡å‡†è¾“å…¥</li><li>ls&gt;&gt;a.txt å°±æ˜¯å°†lsçš„è¾“å…¥ç»“æœåŠ åœ¨a.txtç»“å°¾ï¼Œä¹Ÿå°±æ˜¯lsçš„æ ‡å‡†è¾“å‡ºç»™a.txtï¼ˆAPPENDæ¨¡å¼æ‰“å¼€ï¼‰å½“æ ‡å‡†è¾“å…¥ã€‚</li></ul>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä¾æ—§æ˜¯dup2</p>
<h4><a id="__15"></a>å®ç°åå° &amp;</h4>
<ul><li>è¿™é‡Œæ˜¯ä¹¦ä¸Šæ‰€å†™çš„çˆ¶è¿›ç¨‹wait(-1ï¼ŒNULLï¼ŒWHOHANG)çš„éé˜»å¡æ¨¡å¼ä¸‹çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸€èµ·è¿è¡Œå°±"çœ‹ä¸Šå»"å­è¿›ç¨‹åœ¨åå°è¾“å‡ºï¼Œå…¶å®è¿™æ ·ç®—æ˜¯çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ç»§ç»­è¿è¡Œï¼Œç„¶è€Œçš„çœŸæ­£æ¦‚å¿µæ˜¯åå°ç¨‹åºä¼šå¯èƒ½æš‚åœã€‚å› ä¸ºå‰å°çš„ç¨‹åºè‚¯å®šéœ€è¦æŠŠæ¡ä½ç»ˆç«¯çš„è¾“å…¥å’Œè¾“å‡ºï¼Œæ‰€ä»¥å¦‚æœåƒlsè¿™ç§å†™åˆ°ç»ˆç«¯çš„è¿›ç¨‹æ”¾åœ¨åå°ï¼Œå®ƒä¸åº”è¯¥åŒæ—¶è¾“å‡ºåœ¨å±å¹•ä¸Šï¼Œä½†æ˜¯å‘¢ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¼šå†™å‡ºæ¥ï¼ˆå¯ä»¥ä½¿ç”¨sttytostopå‘½ä»¤ç¦æ­¢ï¼‰ï¼Œæ¥ç€å°±æ˜¯ç»ˆç«¯å‘é€SIGTTOUä¿¡å·,è®©ä¼šæ‰“å°çš„ç¨‹åºæš‚åœä¸å»æ‰§è¡Œã€‚åŒç†éœ€è¦æ ‡å‡†è¾“å…¥çš„ç¨‹åºï¼Œåˆ™ç»ˆç«¯å‘é€SIGTTINä¿¡å·,è®©éœ€è¦å†™å…¥çš„ç¨‹åºæš‚åœä¸å»æ‰§è¡Œã€‚ä¹‹åå‘¢å¦‚æœéœ€è¦è¿è¡Œåˆ™æ˜¯åˆ©ç”¨fg å‘½ä»¤ï¼Œç»ˆç«¯å‘ç¨‹åºå‘é€sigcont,ç¨‹åºåœ¨å‰å°ç»§ç»­è¿è¡Œã€‚</li></ul>
<p>ä½†æˆ‘å†™åœ¨è¿™çš„å°±æ˜¯ä¹¦ä¸Šé‚£ä¸ªéé˜»å¡çš„waitå•¦</p>
<h4><a id="cd_19"></a>å®ç°å†…ç½®cd</h4>
<p>å—¯ï¼Œå°±æ˜¯chdiré…ä¸Šä¸€äº›å­—ç¬¦ä¸²æ“ä½œã€‚è¿˜æˆ–è€…éœ€è¦ä¸‹getcwdè·å–å½“å‰è·¯å¾„ï¼Œç›®çš„æ˜¯ä¿å­˜ä¸Šæ¬¡çš„è·¯å¾„ç”¨äº"cd -","cd ~"åˆ™ç”¨ä¸‹<code>pwd=getpwuid(getuid())å†pwd-&gt;pw_name</code>è·å–ç”¨æˆ·åã€‚è¿™æ ·å°±å¯cdåˆ°homeä¸‹çš„ç”¨æˆ·å®¶ç›®å½•äº†ã€‚<br/> è‡³äºä»€ä¹ˆcdéœ€è¦å†…ç½®ï¼Œæ˜¯å› ä¸ºå¦‚æœä¹Ÿæ˜¯fork+exec(cd)çš„è¯cdè¿™ä¸ªç¨‹åºå®ç°é‡Œé¢çš„chdiråªå¯¹cdå‘½ä»¤çš„å·¥ä½œç›®å½•æœ‰æ•ˆï¼Œå´æ— æ³•æ”¹å˜åŸç¨‹åºçš„å·¥ä½œç›®å½•ã€‚</p>
<h3><a id="_22"></a>å®ç°ä¿¡å·å±è”½</h3>
<p>å°±æš‚æ—¶signal(SIGINT,SIG_IGN);<br/> æˆ‘è§‰å¾—æ˜¯ä¸æ˜¯å¿˜äº†è€ƒè™‘SIGPIPE</p>
<h3><a id="_25"></a>å®ç°å¤šé‡ç®¡é“</h3>
<p>å› ä¸ºä¸å¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶åŒæ—¶å½“ä½œè¾“å…¥ç«¯å’Œè¾“å‡ºç«¯ï¼ˆä¼šå‡ºé”™ï¼‰ï¼Œæ­¤å¤„ä½¿ç”¨äº†ä¿©æ–‡ä»¶/tmp/file1,/tmp/file2è½®æµæ¥è¯»å†™ã€‚å¦‚ls|grep a|wcè¿›ç¨‹ å°±æ˜¯åœ¨å­è¿›ç¨‹æ‰§è¡Œlså‰ï¼Œå°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°file1,çˆ¶è¿›ç¨‹å†åœ¨æ–°å­è¿›ç¨‹æ‰§è¡Œgrepå‰æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°file2,æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°file1,æ¥ç€çˆ¶è¿›ç¨‹å†åœ¨æ‰§è¡Œæ–°å­è¿›ç¨‹æ‰§è¡Œwcå‰æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°file1ï¼Œæ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°file1ã€‚é™¤äº†ç¬¬ä¸€ä¸ªå­è¿›ç¨‹æ˜¯è¾“å…¥ç«¯ä»ç„¶æ˜¯æ ‡å‡†è¾“å…¥å’Œæœ€åä¸€ä¸ªå­è¿›ç¨‹è¾“å‡ºç«¯ä»æ˜¯æ ‡å‡†è¾“å‡ºï¼Œå…¶ä½™å‡ä½¿ç”¨æ–‡ä»¶çš„é‡å®šå‘ï¼Œè¯´å®è¯è¿™æ ·äº¤æ›¿ç€æ˜¯æœ‰ç‚¹å‘†æ»ï¼Œå…¶å®FIFOï¼Œpipeå®ç°çˆ¶å­è¿›ç¨‹é—´é€šä¿¡ä¼šå¥½ä¸€äº›(ä¹‹åæˆ‘è¯•è¯•å»ä¿®æ­£)</p>
<h3><a id="_27"></a>å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ</h3>
<p>å°±è·Ÿmylsé‚£é‡Œä¸€æ ·<br/> <a href="https://blog.csdn.net/adlatereturn/article/details/104864130">ä»»ä½•ä½ç½®è¿è¡Œmyls</a></p>
<h3><a id="tabhistory_30"></a>å®ç°tabè¡¥å…¨å’Œå†…ç½®historyå’Œå…‰æ ‡ç§»åŠ¨</h3>
<p>ä½¿ç”¨readlineåº“ï¼ˆéœ€ä¸‹è½½ï¼‰<br/> <code>#include&lt;readline/readline.h&gt;</code><br/> <code>#include&lt;readline/history.h&gt;</code><br/> å‚è€ƒåšæ–‡ï¼š<a href="https://blog.csdn.net/xuancbm/article/details/81436681">readline1</a></p>
<p>ï¼ˆæ³¨ï¼šåœ¨è¯»å†™historyä¸­æœ‰å‘æ²¡å¤„ç†å¥½ä¼šæ­»å¾ªç¯ï¼‰<br/> read_history(NULL)è¿™æ¡å‡½æ•°åªç”¨æ‰§è¡Œä¸€æ¬¡ï¼Œæ”¾åœ¨ç¨‹åºå¼€å¤´å³å¯ã€‚<br/> ç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Šã€€-lreadline<br/> æˆæœï¼š<br/> <img alt="" src="https://img-blog.csdnimg.cn/20200510232724239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> æºç shell_head.hæ–‡ä»¶</img></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SHELL_HEAD_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SHELL_HEAD_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;readline/readline.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;readline/history.h&gt;</span></span>

<span class="token comment">// #include&lt;history.h&gt;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BAGIN  "\001\033[1m\002"</span><span class="token comment">//å¼ºè°ƒï¼ŒåŠ ç²—ï¼Œé«˜äº®</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_END "\001\033[0m\002"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BKG_SEF(x,y) "\001\033["#x";"#y"m\002"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BKG(x) "\001\033["#x"m\002"</span><span class="token comment">//x&lt;40-49&gt;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_SEF(x) "\001\033["#x"m\002"</span><span class="token comment">//x&lt;30-39&gt;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> DIRNAMESIZE 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ARGMAXLEN 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PIPE 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INPUT 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OUTPUT 4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> APPPUT 8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BACKGROUND 16</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EXIT 32</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ARGMAXNUM 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILENAMESIZE 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SHOWPATH 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILE1 "/tmp/file1"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILE2 "/tmp/file2"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> HISTORYFILE "historyfile"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> HISTORYMAXSIZE 1000</span>
<span class="token keyword">struct</span> history
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">get_prefix</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">find_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span>mode<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">back_check</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">s_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>s<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">search_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">execute_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">print_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">analysisArg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arg<span class="token punctuation">,</span><span class="token keyword">int</span> argcount<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>subExpression<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arglist<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span>argcnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">split_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> ch<span class="token punctuation">,</span><span class="token keyword">char</span> arglist<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">do_arg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">showdir</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>dirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">changdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>newDir<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>oldDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">format_blank</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">getHostname</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">printHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history <span class="token operator">*</span>htylist<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>historylen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setHistory</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setHistory_2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>myshell.cæ–‡ä»¶</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"shell_head.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">read_history</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> oldDir<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>oldDir<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// char input_str[ARGMAXLEN];</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// print_shell();</span>
        <span class="token keyword">char</span> prefix_str<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> input_str<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">get_prefix</span><span class="token punctuation">(</span>prefix_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">readline</span><span class="token punctuation">(</span>prefix_str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//COLOR_BAGIN COLOR_BKG_SEF(49,34)" " COLOR_END</span>
        <span class="token comment">// get_input(input_str);</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setHistory_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"exit"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"cd"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span><span class="token operator">*</span>s<span class="token operator">=</span><span class="token function">format_blank</span><span class="token punctuation">(</span>input_str<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">changdir</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>oldDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"history"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> mode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mode<span class="token punctuation">,</span>input_str<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> ret2<span class="token operator">=</span><span class="token function">do_arg</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret2<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>        
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<pre><code class="prism language-c">
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"shell_head.h"</span></span>
<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// exit(0);</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">s_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>s<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">char</span><span class="token operator">*</span>find<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>ret_val<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">&gt;</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    ret_val<span class="token operator">=</span><span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret_val<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        find<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>find<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">print_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> hname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dirname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getHostname</span><span class="token punctuation">(</span>hname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">if</span><span class="token punctuation">(</span>SHOWPATH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">":"</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s$ "</span>COLOR_END<span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">,</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//40 ,34</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">"$ "</span><span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">get_prefix</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> hname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dirname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getHostname</span><span class="token punctuation">(</span>hname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span>SHOWPATH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">":"</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s$ "</span>COLOR_END<span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">,</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">"$ "</span><span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

bool <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>argline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">s_gets</span><span class="token punctuation">(</span>argline<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"get_arg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>subExpression<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arglist<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span>argcnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>cur<span class="token operator">=</span>subExpression<span class="token punctuation">;</span><span class="token comment">//ls -l\0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
        cur<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>begin<span class="token operator">=</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>cur<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>ARGMAXLEN<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                cur<span class="token operator">++</span><span class="token punctuation">;</span>
            begin<span class="token operator">=</span>cur<span class="token punctuation">;</span>
            argNum<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
            cur<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>ARGMAXLEN<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
    arglist<span class="token punctuation">[</span><span class="token operator">++</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>argcnt<span class="token operator">=</span>argNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">back_check</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>f<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>f<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">' '</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">&amp;</span><span class="token operator">=</span><span class="token operator">~</span>BACKGROUND<span class="token punctuation">;</span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"&amp; err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span>f<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>BACKGROUND<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
bool <span class="token function">search_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    DIR<span class="token operator">*</span>dp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dirent<span class="token operator">*</span>dirp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> newcmd<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>path<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"./"</span><span class="token punctuation">,</span><span class="token string">"/bin"</span><span class="token punctuation">,</span><span class="token string">"/usr/bin"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>find<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> newpath<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>newpath<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>find<span class="token operator">-</span>cmd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>newpath<span class="token punctuation">;</span>  
        <span class="token function">strcpy</span><span class="token punctuation">(</span>newcmd<span class="token punctuation">,</span>find<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">"./"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
            cmd<span class="token operator">+</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>newcmd<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// printf("n=%s\n",newcmd);</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dp<span class="token operator">=</span><span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"cant open \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dirp<span class="token operator">=</span><span class="token function">readdir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("d=%s\n",dirp-&gt;d_name);</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span>newcmd<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">closedir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">closedir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">split_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> ch<span class="token punctuation">,</span><span class="token keyword">char</span> arglist<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>argNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>begin<span class="token operator">=</span>p<span class="token punctuation">;</span>
    <span class="token operator">*</span>argNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span>ch<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token operator">==</span>ARGMAXNUM<span class="token punctuation">)</span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"too many arg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
            begin<span class="token operator">=</span>p<span class="token punctuation">;</span>
            len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span>c<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 p<span class="token operator">++</span><span class="token punctuation">;</span>
                len<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                p<span class="token operator">++</span><span class="token punctuation">;</span>
                len<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
        len<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">find_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// llllllllll&lt;&lt; &lt;&lt;\0</span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">int</span> StrLen<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> strLen<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>str<span class="token punctuation">,</span>strLen<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">do_arg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// printf("%d\n",mode);</span>
    <span class="token keyword">char</span> arglist2<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> argNum2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">char</span> fileName<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>INPUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">==</span>argNum2<span class="token operator">-</span><span class="token number">2</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>arglist2<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>FILENAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        
        <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// sys_err("open");</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰¾ä¸åˆ°æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œå¤±è´¥ï¼ï¼ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]æ­£åœ¨åå°è¿è¡Œ\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token operator">||</span>mode<span class="token operator">&amp;</span>APPPUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">==</span>argNum2<span class="token operator">-</span><span class="token number">2</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>arglist2<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>FILENAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token punctuation">)</span>
                fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_TRUNC<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>APPPUT<span class="token punctuation">)</span>
                fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// sys_err("open");</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰¾ä¸åˆ°æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œå¤±è´¥ï¼ï¼ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]æ­£åœ¨åå°è¿è¡Œ\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>PIPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>INPUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰¾ä¸åˆ°æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œå¤±è´¥ï¼ï¼ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]æ­£åœ¨åå°è¿è¡Œ\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>PIPE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> arglist3<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span>  infile<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span>  outfile<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> argNum3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>FILE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>FILE2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>FILE2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>FILE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">split_2</span><span class="token punctuation">(</span>arglist2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist3<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum3<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum3<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist3<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            arg<span class="token punctuation">[</span>argNum3<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰¾ä¸åˆ°æ–‡ä»¶"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// printf("i=%d\tinfile:%s:",i,infile);</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// sys_err("open");</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// rmdir("/tmp/mystery love");</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// printf("%d--argNUM3:\n",argNum2);</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span>argNum2<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// printf("i=%d,outfile:%s:",i,outfile);</span>
                    <span class="token keyword">int</span> fd2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_TRUNC<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>fd2<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">dup2</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"æ‰§è¡Œå¤±è´¥ï¼ï¼ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// dup2(fd,1);</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]æ­£åœ¨åå°è¿è¡Œ\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> 
                        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// return 0;</span>
                    <span class="token function">remove</span><span class="token punctuation">(</span>infile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span>mode<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">back_check</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">find_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"   |  ä¸‹ä¸æ”¯æŒ&gt;,&lt;,&gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span>            
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>PIPE<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> ocnt<span class="token operator">=</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> icnt<span class="token operator">=</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> acnt<span class="token operator">=</span><span class="token function">find_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// printf("%d%d%d\n",ocnt,icnt,acnt);</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ocnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"åªæ”¯æŒ1ä¸ª&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>icnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"åªæ”¯æŒ1ä¸ª&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>acnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"åªæ”¯æŒ1ä¸ª&lt;&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span>icnt<span class="token operator">&amp;&amp;</span>icnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span>acnt<span class="token operator">&amp;&amp;</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>icnt<span class="token operator">==</span>acnt<span class="token operator">&amp;&amp;</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"ä¸å¯åŒæ—¶æ”¯æŒ&lt; &gt; &gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>OUTPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>icnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>INPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>APPPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">changdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>newDirName<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>oldDirName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> newDir<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span>newDirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>oldDirName<span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"è¿™æ˜¯ç¬¬ä¸€æ¬¡è·³è½¬ç›®å½•,å› æ­¤æ— æ³•è·³è½¬åˆ°ä¸Šä¸€æ¬¡çš„ç›®å½•"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span>oldDirName<span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"~"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"/home/%s"</span><span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>oldDirName<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">chdir</span><span class="token punctuation">(</span>newDir<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"é”™è¯¯çš„ç›®å½•åç§°:%s\n"</span><span class="token punctuation">,</span>newDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">showdir</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>dirName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">getcwd</span><span class="token punctuation">(</span>dirName<span class="token punctuation">,</span>DIRNAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span>dirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">format_blank</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>str<span class="token punctuation">,</span><span class="token operator">*</span>e<span class="token operator">=</span>str<span class="token operator">+</span>len<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>p<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>e<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>e<span class="token operator">!=</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>e<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>e<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>e<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            e<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>username<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> passwd<span class="token operator">*</span> pwd <span class="token operator">=</span> <span class="token function">getpwuid</span><span class="token punctuation">(</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> pwd<span class="token operator">-&gt;</span>pw_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">getHostname</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>hostname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">gethostname</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">setHistory</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>input_str<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">||</span><span class="token operator">*</span>input_str<span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> historylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> history htylist<span class="token punctuation">[</span>HISTORYMAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> history<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>HISTORYMAXSIZE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>htylist<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getHistory</span><span class="token punctuation">(</span>htylist<span class="token punctuation">,</span><span class="token operator">&amp;</span>historylen<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>historylen<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">=</span>htylist<span class="token punctuation">[</span>historylen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span>history<span class="token punctuation">,</span>HISTORYMAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>HISTORYFILE<span class="token punctuation">,</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> wlen<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>htylist<span class="token operator">+</span>historylen<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wlen<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history <span class="token operator">*</span>htylist<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>historylen<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>HISTORYFILE<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_RDONLY<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>ret<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>htylist<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"read err %s"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>historylen<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>HISTORYMAXSIZE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>HISTORYMAXSIZE<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token function">memset</span><span class="token punctuation">(</span>htylist<span class="token operator">+</span>j<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>historylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">printHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> history htylist<span class="token punctuation">[</span>HISTORYMAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> htylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getHistory</span><span class="token punctuation">(</span>htylist<span class="token punctuation">,</span><span class="token operator">&amp;</span>htylen<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>htylen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %s\n"</span><span class="token punctuation">,</span>htylist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>htylist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">setHistory_2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>input_str<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>input_str<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">add_history</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_history</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    HIST_ENTRY <span class="token operator">*</span><span class="token operator">*</span> his<span class="token punctuation">;</span>
    his <span class="token operator">=</span> <span class="token function">history_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>his<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %s\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> his<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>æœ¬æ–‡å…¶å®æœ‰å¾ˆå¤šæ¼æ´å’Œä¸è¶³ä¹‹å¤„ä¹Ÿæ¯”è¾ƒå†—é•¿ï¼ˆæ€»è®©æˆ‘æ„Ÿè§‰å¾ˆå¤šåœ°æ–¹å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•å¤ç”¨ï¼‰ã€‚æœ¬æ–‡ä¹Ÿæœªå®ç°å¤šé‡ç®¡é“å’Œè¾“å…¥è¾“å‡ºé‡å®šå‘çš„æ··æ­ï¼Œå› ä¸ºä¸€å¼€å§‹åœ¨æ­¤å¤„çš„å­—ç¬¦ä¸²å¤„ç†ä¸Šå¡å£³å¤ªä¹…ï¼ˆå¿ƒç´¯ï¼‰ã€‚<br/> æœ‰äº›å‡½æ•°æ˜¯å¼€å§‹çš„ç‰ˆæœ¬çš„å°±æ¯”å¦‚mainä¸­æœ‰ä½¿ç”¨xxxx_2çš„å‡½æ•°ï¼Œæœ¬æ¥åœ¨ç”¨xxxx,æˆ‘æ²¡æœ‰åˆ å»ã€‚ä¿ç•™ä¸‹æ¥åº·åº·æŒºå¿ƒé…¸çš„ã€‚</p>
<p>é‚£äº›å†™çš„ä¸ä¼˜é›…çš„åœ°æ–¹ä¹‹åä¼šæ…¢æ…¢çŸ«æ­£å§ï¼Œæˆ‘æƒ³ã€‚</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>çº¿ç¨‹æ± ï¼Œåœ¨æˆ‘çœ‹æ¥å°±æ˜¯ä¸€ä¸ª çº¿ç¨‹é“¾è¡¨ï¼Œæ¥ç€æˆ‘ä»¬é€šè¿‡ä»»åŠ¡é“¾è¡¨ï¼ˆå…¶å®åº”è¯¥æ˜¯é˜Ÿåˆ—ï¼‰åœ¨ä¸Šé¢åˆ†é…ä¸€äº›ä»»åŠ¡å‡½æ•°ã€‚<br/> åœ¨å®é™…åº”ç”¨ä¸­ï¼Œçº¿ç¨‹æ± å¯ä»¥å’Œç½‘ç»œæœåŠ¡å™¨ç­‰é«˜å¹¶å‘çš„ç¨‹åºç»“åˆèµ·æ¥å®ç°å¼‚æ­¥æ“ä½œã€‚</p>
<h2><a id="_4"></a>çº¿ç¨‹æ± æ ¸å¿ƒç»“æ„</h2>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> my_pthread_t
<span class="token punctuation">{<!-- --></span>
    pthread_t <span class="token operator">*</span>_pthread<span class="token punctuation">;</span>		<span class="token comment">//çº¿ç¨‹å·</span>
    bool state<span class="token punctuation">;</span>					<span class="token comment">//æ˜¯å¦å·²ç»è¿›å…¥ç­‰å¾…çŠ¶æ€</span>
<span class="token punctuation">}</span>my_pthread_t<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> trdpool_t<span class="token punctuation">{<!-- --></span>
my_pthread_t <span class="token operator">*</span>phead<span class="token punctuation">;</span>	<span class="token comment">/*å…¶å®è¿™é‡Œå¯ä»¥ç›´æ¥ç”¨ä¸‹é¢çš„pthread_t*å–ä»£ï¼ˆä¸»æµåšæ³•ï¼‰ï¼Œä½†æ˜¯å› ä¸ºåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­,é‡è§äº†ç‚¹å°é—®é¢˜ï¼Œè¿™é‡Œåšäº†ä¿®æ”¹ï¼Œç”¨é€”åè§*/</span>
<span class="token comment">// pthread_t *phead;</span>

work_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>						<span class="token comment">//ä»»åŠ¡é“¾è¡¨çš„å¤´</span>
pthread_cond_t cond<span class="token punctuation">;</span>			<span class="token comment">//ç”¨äºç»´æŠ¤ä»»åŠ¡é“¾è¡¨çš„æ¡ä»¶å˜é‡</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>	<span class="token comment">//ç”¨äºé”å®šæ¡ä»¶å˜é‡çš„äº’æ–¥é”</span>
bool status<span class="token punctuation">;</span>                                <span class="token comment">//çº¿ç¨‹æ± çŠ¶æ€ï¼š	0 çº¿ç¨‹æ± ä¸é”€æ¯      1 é”€æ¯</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>										<span class="token comment">//çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡</span>
<span class="token punctuation">}</span>trdpool_t<span class="token punctuation">;</span>
</code></pre>
<h2><a id="_23"></a>ä»»åŠ¡é“¾è¡¨ç»“æ„</h2>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token function">Fun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> work_t<span class="token punctuation">{<!-- --></span>
    Fun<span class="token operator">*</span> fun<span class="token punctuation">;</span>						<span class="token comment">//ä»»åŠ¡å‡½æ•°</span>
    <span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">;</span> 					<span class="token comment">//ä»»åŠ¡å‡½æ•°çš„å‚æ•°</span>
    <span class="token keyword">struct</span> work_t<span class="token operator">*</span>next<span class="token punctuation">;</span>	<span class="token comment">//ä»»åŠ¡é“¾è¡¨çš„ä¸‹ä¸€ä¸ªä»»åŠ¡çš„æŒ‡é’ˆ</span>
<span class="token punctuation">}</span>work_t<span class="token punctuation">;</span>
</code></pre>
<h2><a id="main%09_33"></a>main æµç¨‹</h2>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//åœ¨çº¿ç¨‹æ± åˆ›å»º5ä¸ªçº¿ç¨‹</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//æ·»åŠ 10ä¸ªä»»åŠ¡</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//è¿™é‡Œæ˜¯ä¸ºäº†çœ‹æ•ˆæœï¼Œå»¶ç¼“ä¸‹é”€æ¯</span>
    <span class="token comment">// while(1);</span>
    <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//é”€æ¯çº¿ç¨‹æ± </span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="prdpool_initint_46"></a>prdpool_init(int)</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    trdpool<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>trdpool_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//åŠ¨æ€å†…å­˜è®°å¾—free</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//åˆå§‹åŒ–é”</span>
    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//åˆå§‹åŒ–æ¡ä»¶å˜é‡</span>
    
    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//åˆå§‹åŒ–çŠ¶æ€ä¸ºæœªé”€æ¯</span>
    trdpool<span class="token operator">-&gt;</span>phead<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//è¦æ±‚åˆ†é…numä¸ªçº¿ç¨‹</span>
    trdpool<span class="token operator">-&gt;</span>num<span class="token operator">=</span>num<span class="token punctuation">;</span>			
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    ï¼Ÿï¼Ÿï¼Ÿ    trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pthread_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//åŠ¨æ€åˆ†é…çº¿ç¨‹çš„å†…å­˜ç©ºé—´</span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">//è¿™ä¸ªæ˜¯ä»£è¡¨çº¿ç¨‹å°šæœªè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå¹¶ä¸å¿…è¦</span>
        bool<span class="token operator">*</span>pthread_arg<span class="token operator">=</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//è¿™ä¸ªæ˜¯ä¼ ç»™çº¿ç¨‹çš„å‚æ•°</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>start_routine<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pthread_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">//åˆ›å»ºçº¿ç¨‹ </span>
        lblready<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		
                <span class="token comment">//å¦‚æœè¿™ä¸ªæ—¶å€™çº¿ç¨‹åœ¨çº¿ç¨‹å‡½æ•°ä¸­</span>
                <span class="token comment">//å°šæœªè¿›å…¥ç­‰å¾…çŠ¶æ€å°±å†ç¡ä¸€ä¼šå„¿</span>
                        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> lblready<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="voidstart_routinevoidarg%09_74"></a>void<em>start_routine(void</em>arg) çº¿ç¨‹æ‰§è¡Œå‡½æ•°</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span><span class="token operator">*</span><span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bool<span class="token operator">*</span>state<span class="token operator">=</span>arg<span class="token punctuation">;</span>		<span class="token comment">//æå–å‡ºå‚æ•°ï¼Œè¿™é‡Œæˆ‘å°±åªç”¨äº†å‰é¢æåˆ°çš„trdpool-&gt;phead[i].stateï¼Œä¹Ÿå°±æ˜¯</span>
    <span class="token comment">//çº¿ç¨‹æ˜¯å¦è¿›å…¥ç­‰å¾…çŠ¶æ€çš„æ ‡å¿—</span>
    work_t<span class="token operator">*</span>work<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//ç»™æ¡ä»¶å˜é‡åŠ é”ï¼ŒåŒæ—¶ä¹Ÿç®—æ˜¯ç»™ä»»åŠ¡é“¾è¡¨åŠ é”</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>      <span class="token comment">//ä½¿ç”¨whileçš„åŸå› ï¼Œä¹‹åæ¡ä»¶å˜é‡æ”¹å˜ä¹‹åä¼šæœ‰æŠ¢é”ï¼ŒæŠ¢åˆ°é”çš„çº¿ç¨‹ä»ä»»åŠ¡é˜Ÿå¤´æ‹¿èµ°ä»»åŠ¡ï¼Œåˆ™ä»»åŠ¡é“¾è¡¨å¯èƒ½å˜ç©ºï¼Œè€Œæ­¤æ—¶æŠ¢åˆ°é”çš„çº¿ç¨‹é‡Šæ”¾é”åˆ™è®©å”¤é†’çš„çº¿ç¨‹ç»§ç»­ç¡çœ ã€‚		åé¢é‚£ä¸ªstatusæ¡ä»¶è¡¨æ˜çº¿ç¨‹æ± å°šæœªè¢«æ‘§æ¯</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is ready \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//è¡¨ç¤ºçº¿ç¨‹è¦å»ç¡çœ äº†</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//å”¤é†’ä¿©æ¡ä»¶1.æœ‰ä»»åŠ¡2.çº¿ç¨‹æ± é‡Šæ”¾æ‘§æ¯ä¿¡å·</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is weak up  \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		<span class="token comment">//å¦‚æœä¸æ˜¯è¦æ‘§æ¯çº¿ç¨‹æ± </span>
            work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>	<span class="token comment">//		å–å‡ºä»»åŠ¡</span>
             trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>		<span class="token comment">//ä»»åŠ¡é“¾è¡¨å»é™¤ä»»åŠ¡</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//è§£é”</span>
            <span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//æ‰§è¡Œä»»åŠ¡å‡½æ•°</span>
            <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//é‡Šæ”¾åŠ¨æ€åˆ†é…çš„ä»»åŠ¡</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//å¦‚æœæ˜¯æƒ³æ‘§æ¯çº¿ç¨‹æ±             </span>
            <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//è¿™é‡Œå°±çº¿ç¨‹é€€å‡ºå°±å¥½äº†</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<h2><a id="void_add_work%09_104"></a>void add_work() æ·»åŠ ä»»åŠ¡</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    work_t<span class="token operator">*</span> new_work<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>work_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    work_t<span class="token operator">*</span> old_work<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>arg<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>fun<span class="token operator">=</span>print_pthread_self<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token comment">//è®¾ç½®ä»»åŠ¡çš„æœ‰å…³ä¿¡æ¯</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é”ä½ä»»åŠ¡é“¾è¡¨</span>
    <span class="token comment">//æ·»åŠ ä»»åŠ¡</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        old_work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
        new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span>old_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//é€šçŸ¥å”¤é†’ç­‰å¾…é˜»å¡çš„çº¿ç¨‹</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//è§£é”</span>
<span class="token punctuation">}</span>

</code></pre>
<h2><a id="void_prdpool_destory_129"></a>void prdpool_destory()</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool begin to  destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    work_t <span class="token operator">*</span>work<span class="token punctuation">;</span>

    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//æ ‡è®°çº¿ç¨‹æ± éœ€è¦æ‘§æ¯</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//åŠ é”</span>
    <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//å¹¿æ’­å”¤é†’ç­‰å¾…ä¸­çš„æ‰€æœ‰çº¿ç¨‹</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//è§£é”</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> trdpool<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œå…¶å®æ˜¯é˜»å¡ç­‰å¾…æ¯ä¸ªçº¿ç¨‹</span>
        <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			<span class="token comment">//é‡Šæ”¾æ¯ä¸€ä¸ªä»»åŠ¡</span>
        trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//é‡Šæ”¾æ¡ä»¶å˜é‡</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//ä¿è¯æ²¡äººç”¨é”</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//é‡Šæ”¾é”</span>
    <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>ä¸‹é¢æ˜¯æˆ‘å†™çš„æºç --------&gt;</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token function">Fun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> work_t<span class="token punctuation">{<!-- --></span>
    Fun<span class="token operator">*</span> fun<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> work_t<span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>work_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> my_pthread_t
<span class="token punctuation">{<!-- --></span>
    pthread_t <span class="token operator">*</span>_pthread<span class="token punctuation">;</span>
    bool state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>my_pthread_t<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> trdpool_t<span class="token punctuation">{<!-- --></span>
my_pthread_t <span class="token operator">*</span>phead<span class="token punctuation">;</span>
<span class="token comment">// pthread_t *phead;</span>
work_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>
pthread_cond_t cond<span class="token punctuation">;</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>
bool status<span class="token punctuation">;</span>                                <span class="token comment">//0 çº¿ç¨‹æ± ä¸é”€æ¯      1 é”€æ¯</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span>trdpool_t<span class="token punctuation">;</span>

trdpool_t <span class="token operator">*</span>trdpool<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> 

<span class="token keyword">void</span> <span class="token function">print_pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread id = %ld\n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span><span class="token operator">*</span><span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bool<span class="token operator">*</span>state<span class="token operator">=</span>arg<span class="token punctuation">;</span>
    work_t<span class="token operator">*</span>work<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>      <span class="token comment">//ä¸€ä¸ªå°æœ‹å‹æŠŠè›‹ç³•æŠ¢èµ°äº†ï¼Œé‚£ä¹ˆå…¶ä»–å°æœ‹å‹é†’æ¥å†ç»§ç»­ç¡ã€‚</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is ready \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is weak up  \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
             trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    work_t<span class="token operator">*</span> new_work<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>work_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    work_t<span class="token operator">*</span> old_work<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>arg<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>fun<span class="token operator">=</span>print_pthread_self<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        old_work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
        new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span>old_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    trdpool<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>trdpool_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    trdpool<span class="token operator">-&gt;</span>phead<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    trdpool<span class="token operator">-&gt;</span>num<span class="token operator">=</span>num<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        bool<span class="token operator">*</span>pthread_arg<span class="token operator">=</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>start_routine<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pthread_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        lblready<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> lblready<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool begin to  destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    work_t <span class="token operator">*</span>work<span class="token punctuation">;</span>

    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> trdpool<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// puts("!");</span>
        trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sleep(1);</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// while(1);</span>
    <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<pre><code class="prism language-bash">adl@adl:~/æ¡Œé¢/linux$ ./a.out 
thread  140704759068416 is ready 
thread  140704750675712 is ready 
thread  140704672118528 is ready 
thread  140704663725824 is ready 
thread  140704655333120 is ready 
thread  140704759068416 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704759068416
thread  140704655333120 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704655333120
thread  140704663725824 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704663725824
thread  140704750675712 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704750675712
thread  140704672118528 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704672118528
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704759068416
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704655333120
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704663725824
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704750675712
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704672118528
thread  140704759068416 is ready 
thread  140704655333120 is ready 
thread  140704663725824 is ready 
thread  140704750675712 is ready 
thread  140704672118528 is ready 
the trdpool begin to  destory <span class="token operator">!</span>
thread  140704750675712 is weak up  
thread  140704655333120 is weak up  
thread  140704663725824 is weak up  
thread  140704672118528 is weak up  
thread  140704759068416 is weak up  
the trdpool destory <span class="token operator">!</span>
</code></pre>
<p>ä»¥ä¸Šæ˜¯æˆ‘å†™çš„ç®€å•çº¿ç¨‹æ± ï¼Œå…¶å®åœ¨å†™çš„è¿‡ç¨‹ä¸­é‡åˆ°è¿‡äº›é—®é¢˜ï¼Œä½†æœ‰åœ¨å­¦é•¿å’Œçƒ­å¿ƒç½‘å‹çš„å¸®åŠ©ä¸‹å­¦åˆ°äº†è®¸å¤šã€‚<br/> <a href="https://bbs.csdn.net/topics/396472423">æŒ‚è®ºå›ä¸Šçš„é“¾æ¥</a></p>
<p>å‚è€ƒäº†ï¼š<br/> <a href="https://blog.csdn.net/yangbodong22011/article/details/47301975">å­¦é•¿åšå®¢</a></p>
<p>å¤§å®¶å¯ä»¥å»çœ‹è¿™ä¸ªæ˜¯æ¯”è¾ƒå¥½çš„ï¼š<br/> <a href="https://blog.csdn.net/qq_36359022/article/details/78796784">è¯¦ç»†çš„çº¿ç¨‹æ± å®ç°</a></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>åœ¨é˜…è¯»ã€ŠUNIX é«˜çº§ç¯å¢ƒç¼–ç¨‹ã€‹è¿›ç¨‹æ§åˆ¶é‚£å—ï¼Œæœ‰ä¸ªä¾‹å­æ˜¯å·®ä¸å¤šè¿™æ ·çš„ï¼š<br/> åœ¨å­è¿›ç¨‹ä¸­æ”¹å˜å˜é‡ï¼Œè§‚å¯Ÿçˆ¶è¿›ç¨‹ä¹‹åå˜é‡çš„å˜åŒ–</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token keyword">int</span> glob<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"write to stdout\n"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> var<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    var <span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before fork\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// fflush(stdout);</span>
    <span class="token comment">// setbuf(stdout,NULL);</span>
    <span class="token comment">// setvbuf(stdout,(char*)NULL,_IONBF,0);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        glob<span class="token operator">++</span><span class="token punctuation">;</span>
        var<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid =%d ,glob =%d ,var=%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>glob<span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¼€å§‹æˆ‘ä¹Ÿè§‰å¾—å°±è¿™æ ·ï¼Œå› ä¸ºå­è¿›ç¨‹å†™æ—¶å¤åˆ¶çˆ¶è¿›ç¨‹çš„å †æ ˆå’Œæ•°æ®ç©ºé—´ï¼Œå­è¿›ç¨‹æ”¹å˜å˜é‡çˆ¶è¿›ç¨‹çš„å˜é‡æ²¡å•¥å¯å˜åŒ–çš„ã€‚<br/> ä½†ä¹¦ä¸Šå¿½ç„¶è¯å³°ä¸€è½¬ï¼Œæåˆ°äº†æ ‡å‡†IOå‡½æ•°å†™ç¼“å†²åŒºçš„å¤åˆ¶é—®é¢˜ã€‚</p>
<p>é—®é¢˜æ˜¯è¿™æ ·çš„ï¼šæˆ‘ä»¬çš„write(STDOUT_FILENO)åœ¨ç»ˆç«¯æ‰“å°ä¸€æ¬¡æ²¡é”™ï¼Œæˆ‘ä»¬çš„printf(â€œbefore fork\nâ€)åœ¨ç»ˆç«¯ä¹Ÿæ‰“å°ä¸€æ¬¡æ²¡é”™ã€‚ä½†å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªç»“æœä»¥<code>a.out &gt;a.txt</code>çš„å½¢å¼<br/> é‡å®šå‘å¯¼å…¥åˆ°æ–‡ä»¶ä¸­ä¼šå°†è¿™äº›è¯­å¥æ‰“å°å‡ æ¬¡å‘¢???<br/> ç­”æ¡ˆï¼šwrite(STDOUT_FILENO)æ‰“å°ä¸€æ¬¡ï¼Œ<strong>printf(â€œbefore fork\nâ€)æ‰“å°ä¸¤æ¬¡</strong><br/> å“‡è¿™è¯´æ˜äº†ä»€ä¹ˆå‘¢ï¼Ÿï¼Ÿï¼Ÿä¹¦ä¸ŠæŒ‡å‡ºwriteæ˜¯ä¸å¸¦ç¼“å­˜çš„ï¼Œprintfæ˜¯å¸¦æœ‰ä¸€ä¸ª8192å­—èŠ‚çš„ç¼“å­˜çš„ã€‚ä»¤äººæ„å¤–ä¸”å®¹æ˜“è¢«æˆ‘ä»¬å¿½è§†çš„æ˜¯ï¼š<strong>å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹å†™ç¼“å†²åŒºçš„å†…å®¹çš„</strong>ã€‚é‚£ä¸ºä»€ä¹ˆå†™åˆ°ç»ˆç«¯å°±æ‰“å°æ²¡æœ‰è¿™å¥è¯å‘¢ï¼Œå†™åˆ°æ–‡ä»¶å´å‡ºç°äº†å‘¢?<br/> è¿™æ˜¯å› ä¸ºæ ‡å‡†è¾“å‡ºæ˜¯è¡Œç¼“å†²çš„æˆ‘ä»¬å†™çš„å†…å®¹ä¸­æœ‰ä¸ªâ€™\nâ€™çš„æ¢è¡Œç¬¦åˆ·æ–°äº†è¡Œç¼“å†²,å­è¿›ç¨‹å› æ­¤å¾—ä¸åˆ°æ­¤å†…å®¹;ç„¶è€Œé‡å®šå‘æ˜¯è®©è¾“å‡ºæŒ‡å‘æ–‡ä»¶ï¼Œå¹¶ä¸”æ­¤æ—¶å®ƒçš„ç¼“å†²æ¨¡å¼æˆäº†å†™å…¥æ™®é€šæ–‡ä»¶çš„ç¼“å†²æ¨¡å¼:å…¨ç¼“å†²ï¼ˆä¸æ‡‚è§ã€ŠUNIX é«˜çº§ç¯å¢ƒç¼–ç¨‹ã€‹ç¬¬äº”ç« ï¼‰è¿™å¯¼è‡´äº†æˆ‘ä»¬çˆ¶è¿›ç¨‹printfæ‰“å°å®Œäº†ä¹‹åç¼“å†²åŒºä¸­çš„å†…å®¹è¿˜åœ¨ï¼Œå¹¶ä¸”å…¶ä¸­çš„å†…å®¹å¤åˆ¶ç»™äº†å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¹Ÿå› æ­¤ä¼šæ‰“å°å‡ºè¿™å¥è¯ã€‚</p>
<p>å¥½å¥‡å®å®ä»¬ä¼šé—®ï¼Œé‚£æ€ä¹ˆæ‰å¯è®©å­è¿›ç¨‹ä¸æ‰“å°è¿™å¥è¯å‘¢ï¼Ÿï¼Ÿï¼Ÿ<br/> ç­”æ¡ˆæ˜¯åœ¨çˆ¶è¿›ç¨‹printfä¹‹åç”¨è¿™ä¸‰ä¸ªå‡½æ•°å…¶ä¸­ä¹‹ä¸€åˆ·æ–°ç¼“å†²åŒºå³å¯ã€‚</p>
<pre><code class="prism language-c">     <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span>_IONBF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>å¤§å®¶è¿˜å¯ä»¥æ³¨æ„åˆ°å†™ç¼“å†²æ˜¯8192å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬å†™è¶…è¿‡8192å­—èŠ‚çš„å†…å®¹é‚£è¿™ä¸ªç¼“å†²åŒºæ˜¯å¦å·²ç»è¢«åˆ·æ–°äº†å‘¢ï¼Ÿ<br/> ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p>
<p>å¦‚ä¸‹çš„å®éªŒï¼šæˆ‘åœ¨printf(â€œbefore fork\nâ€)æ·»åŠ å¾ˆå¤šç©ºæ ¼ï¼Œåˆ°è¿™ä¸ªå­—ç¬¦ä¸²æœ‰300ä¸ªå­—èŠ‚ä¸ºæ­¢ã€‚æ¥ç€æˆ‘ä»¬å†æ‰“å°å®ƒä¸ª30æ¬¡ï¼Œ3000Ã—30=9000=8192;è¿™æ„å‘³è¿™å…¨ç¼“å†²ä¸‹æˆ‘ä»¬åœ¨æ‰“å°äº†300Ã—28=8400å­—èŠ‚ä¹‹åç¼“å†²åŒºçš„å†…å®¹å…¨éƒ¨è¢«åˆ·æ–°å‡ºå»äº†ã€‚é‚£æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥æ‰“å°å¥å­—ç¬¦ä¸²å‘¢ï¼Ÿï¼Ÿï¼Ÿçˆ¶è¿›ç¨‹çš„30+è¿˜åœ¨ç¼“å†²åŒºç»§æ‰¿ç»™å­è¿›ç¨‹çš„ï¼ˆ30-28ï¼‰=32ã€‚ ç­”æ¡ˆçš„ç¡®å¦‚æ­¤ã€‚</p>
<p>æ­¤æ—¶æˆ‘ä»¬ç”¨è¿™æ¡å‘½ä»¤<code>a.out |grep before | wc</code><br/> çŒœçŒœçœ‹å¾—åˆ°çš„è¡Œæ•°çš„æ˜¯å¤šå°‘ï¼Ÿå¯¹æ˜¯32ï¼è¿™é‡Œçš„ <code>|</code>åŒæ ·é‡å®šå‘äº†æ ‡å‡†è¾“å‡ºåˆ°å¯æ‰§è¡Œæ–‡ä»¶grepä¸­ã€‚å¦‚æœå¤§å®¶ä¹‹å‰æ²¡çœ‹è¿™ç¯‡æ–‡ç« è‚¯å®šä»¥ä¸ºä¼šæ˜¯30å§ï¼ï¼ï¼æƒŠä¸æƒŠå–œï¼Ÿ</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token keyword">int</span> glob<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"write to stdout\n"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> var<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    var <span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">30</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before fork                                                                                                                                                                                                                                                                                               \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// fflush(stdout);</span>
    <span class="token comment">// setbuf(stdout,NULL);</span>
    <span class="token comment">// setvbuf(stdout,(char*)NULL,_IONBF,0);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        glob<span class="token operator">++</span><span class="token punctuation">;</span>
        var<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid =%d ,glob =%d ,var=%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>glob<span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å‘ç°äº†å§ï¼Œè‡ªå·±åšå†™å°å®éªŒæ˜¯å¯ä»¥æœ‰å¾ˆå¤§æ”¶è·çš„ã€‚</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>åº”è¯¥ä¹‹åå¼€å§‹æ¯å¤©è®°å½•ä¸€ç‚¹ï¼Œä¸ç„¶è¿™äº›ç¬”è®°è¿‡æ®µæ—¶é—´éƒ½ä¸çŸ¥é“æ”¾å“ªäº†ã€‚</p>
<ol><li> <p>fork å’Œvfork çš„åŒºåˆ«åœ¨äºvforkå­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œå­è¿›ç¨‹å…ˆæ‰§è¡Œï¼Œè¿™æ„å‘³ç€å˜é‡æ˜¯å…±äº«çš„ï¼Œå­è¿›ç¨‹ä¸€è¾¹æ”¹å˜ï¼Œçˆ¶è¿›ç¨‹çš„å˜é‡çš„å€¼ä¹Ÿä¼šå—åˆ°å½±å“ã€‚</p> </li><li> <p>ä¿©è¿›ç¨‹åœ¨å†™åŒä¸€ä¸ªæ–‡ä»¶å¦‚æœä½¿ç”¨open(O_APPEND),writeçš„ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„è°ƒç”¨æ¬¡åºä¸ä¸€å®šï¼Œå†™å…¥æ–‡ä»¶ä¸­æ˜¯äº¤æ›¿çš„ï¼ˆä½†ä¸ä¼šè¦†ç›–ï¼‰ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯fopen(â€œabâ€),fwriteçš„cåº“å‡½æ•°çš„æ—¶å€™ï¼Œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¾æ—§è°ƒç”¨æ¬¡åºä¸ä¸€å®š,ä½†å†™å…¥æ–‡ä»¶ä¸­å¦‚æœæ•°æ®è¾ƒå°ï¼Œæœªå‡ºç°äº¤æ›¿ç°è±¡ï¼Œæ•°æ®å¤§èµ·æ¥åˆ°4096å­—èŠ‚çš„æ—¶å€™äº¤æ›¿ç»™å¦ä¸€ä¸ªè¿›ç¨‹å†™å…¥ã€‚<br/> ä½†å¦‚æœæ˜¯open()+lseek(END)åˆ™ä¼šäº§ç”Ÿè¦†ç›–ç°è±¡</p> </li><li> <p>ã€strtok_rå‡½æ•°<br/> strtok_rå‡½æ•°æ˜¯linuxä¸‹åˆ†å‰²å­—ç¬¦ä¸²çš„å®‰å…¨å‡½æ•°ï¼Œå‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š<br/> char *strtok_r(char *str, const char *delim, char **saveptr);<br/> è¯¥å‡½æ•°ä¹Ÿä¼šç ´åå¸¦åˆ†è§£å­—ç¬¦ä¸²çš„å®Œæ•´æ€§ï¼Œä½†æ˜¯å…¶å°†å‰©ä½™çš„å­—ç¬¦ä¸²ä¿å­˜åœ¨saveptrå˜é‡ä¸­ï¼Œä¿è¯äº†å®‰å…¨æ€§ã€‚</p> </li><li> <p>å½“æè¿°ç¬¦0å’Œf då…±äº«åŒä¸€æ–‡ä»¶è¡¨é¡¹ ã€‚ä¾‹å¦‚,è‹¥æè¿°ç¬¦ 0è¢«åªè¯»æ‰“å¼€,é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿåªå¯¹ f dè¿›<br/> è¡Œè¯»æ“ä½œã€‚å³ä½¿ç³»ç»Ÿå¿½ç•¥æ‰“å¼€æ–¹å¼,å¹¶ä¸”ä¸‹åˆ—è°ƒç”¨æˆåŠŸ:<br/> fd = open("/dev/fd/0", O_RDWR);<br/> æˆ‘ä»¬ä»ç„¶ä¸èƒ½å¯¹f dè¿›è¡Œå†™æ“ä½œã€‚</p> </li><li> <p>æŒ‡å®šäº†O_APPENDæ‰“å¼€æ–‡ä»¶ï¼Œä½¿ç”¨lseekåˆ°æ–‡ä»¶ä»»æ„ä¸€ä¸ªä½ç½®å†™éƒ½æ²¡æœ‰ç”¨,å…¨ä¼šå†™åˆ°æ–‡ä»¶æœ«å°¾ã€‚open(O_APPEND )=open()+lseek(fd,0,SEK_END)çš„åŸå­æ“ä½œã€‚open(O_APPEND)éœ€è¦æŒ‡å®šO_WRONLYæˆ–è€…O_RDWR</p> </li><li> <p>dup(1,0)è¿™äº›ä¹‹é—´å§‹ç»ˆæœ‰ç€äº›ç–‘é—®,<br/> è€Œä¸”å¯¹äºwrite(stdout,)å’Œread(stdin,)å’Œ<br/> write(stdin,)å’Œread(stdout,)ä¹Ÿæ˜¯æ„Ÿè§‰å¾ˆå¥‡æ€ª</p> </li><li> <p>#ifdef _SIZE_T<br/> typedef _SIZE_T size_t ;<br/> #undef _SIZE_T<br/> è¿™ç§å½¢å¼çš„å®å®šä¹‰ç»“åˆtypedefå¯ä»¥è®©size_tåœ¨å¤šä¸ªå¤´æ–‡ä»¶ä¸­å®å®šä¹‰å¤šæ¬¡_SIZE_Téƒ½æ²¡å…³ç³»</p> </li><li> <p>ä¹¦ä¸Šè¯´O_TRUNCåªä¼šæˆªæ–­åªè¯»æˆ–è€…åªå†™æ–‡ä»¶ã€‚å®éªŒè¯æ˜O_TRUNCå³ä½¿æ˜¯å¯è¯»å¯å†™æ–‡ä»¶ä¹Ÿæ˜¯ä¼šæˆªæ–­ä¸º0çš„</p> </li><li> <p>å¿…é¡»æ˜¯æœ¬ç”¨æˆ·çš„ç¨‹åºè®¾ç½®u+sæ‰å¯ä»¥è®©å…¶ä»–ç”¨æˆ·æ¥é€šè¿‡è¿™ä¸ªç¨‹åºè¶Šçº§è®¿é—®æœ¬ç”¨æˆ·æ–‡ä»¶</p> </li><li> <p>å¯ç”¨é€šè¿‡access æ¥è¯•éªŒæ–‡ä»¶æƒé™ã€‚</p> </li><li> <p>ièŠ‚ç‚¹åŒ…å«äº†æ‰€æœ‰ä¸æ–‡ä»¶æœ‰å…³çš„ä¿¡æ¯:æ–‡ä»¶ç±»å‹ã€æ–‡ä»¶å­˜å–è®¸å¯æƒä½ã€æ–‡ä»¶é•¿åº¦å’ŒæŒ‡å‘è¯¥<br/> æ–‡ä»¶æ‰€å ç”¨çš„æ•°æ®å—çš„æŒ‡é’ˆç­‰ç­‰ã€‚ s t a tç»“æ„ä¸­çš„å¤§å¤šæ•°ä¿¡æ¯éƒ½å–è‡ª ièŠ‚ç‚¹ã€‚åªæœ‰ä¸¤é¡¹æ•°æ®å­˜æ”¾åœ¨<br/> ç›®å½•é¡¹ä¸­:æ–‡ä»¶åå’ŒièŠ‚ç‚¹ç¼–å·æ•°ã€‚ièŠ‚ç‚¹ç¼–å·æ•°çš„æ•°æ®ç±»å‹æ˜¯i n o _ tã€‚</p> </li><li> <p>ç›®å½•ä¸å¯ä»¥ç¡¬é“¾æ¥çš„åŸå› :,ç›®å½•éç©ºæ— æ³•åˆ é™¤(çœ‹rmdir,renameå¯çŸ¥)è€Œè½¯é“¾æ¥unlinkæ˜¯ä¸ç©¿é€çš„,å› æ­¤unlinkä¸€ä¸ªè½¯é“¾æ¥ç›®å½•å¯ä»¥æŠŠè¿™ä¸ªç›®å½•â€œå‰¯æœ¬â€åˆ é™¤ã€‚ï¼ˆæ³¨ï¼šunix(æˆ‘ä¸ç¡®å®šlinuxå¯ä¸å¯ä»¥ï¼Œä¹Ÿä¸æ•¢è¯•)rootå¯ä»¥ç¡¬é“¾æ¥ç›®å½•ï¼Œä½œè€…è¯´æ–‡ä»¶ç³»ç»Ÿä¼šå‡ºé—®é¢˜ï¼‰13. åˆ©ç”¨å®å‡½æ•°ä¼šæ¯”æ™®é€šå‡½æ•°è°ƒç”¨å¿«å¦‚getc,fgetc</p> </li><li> <p>fgets()ç”¨memcpy()å®ç°ï¼Œmemcpyç”¨æ±‡ç¼–ã€‚</p> </li><li> <p>dup2(fd,1)é‡å®šå‘çš„æ·±å…¥ç†è§£ï¼šå°†fdçš„æ–‡ä»¶è¡¨é¡¹ä¸1å…±äº«ï¼ŒåŸæœ¬write(fd)çš„å†…å®¹å…ˆæ‰¾åˆ°fdçš„æ–‡ä»¶è¡¨é¡¹ï¼Œå†æ ¹æ®å½“ä¸‹çš„vèŠ‚ç‚¹æŒ‡é’ˆï¼ˆfdçš„ï¼‰æ‰¾åˆ°vèŠ‚ç‚¹è¡¨ï¼Œå†™å…¥ä¿¡æ¯ã€‚</p> </li><li> <p>statå¤§éƒ¨åˆ†å†…å®¹åœ¨vèŠ‚ç‚¹è¡¨ï¼Œå°‘æ•°åœ¨æ–‡ä»¶è¡¨é¡¹ï¼Œå¦‚æ–‡ä»¶åï¼Œæ–‡ä»¶çš„è¯»å†™çŠ¶æ€ï¼Œ</p> </li><li> <p>æ ‡å‡†å‡ºé”™å¦‚å®ƒæ‰€åº”è¯¥çš„é‚£æ ·æ˜¯éç¼“å­˜çš„,è€Œæ™®é€šæ–‡ä»¶æŒ‰ç³»<br/> ç»Ÿé»˜è®¤æ˜¯å…¨ç¼“å­˜çš„ã€‚</p> </li><li> <p>syncå¯ç”¨äºæ•°æ®åº“è¿™æ ·çš„åº”ç”¨ç¨‹åº,å®ƒç¡®ä¿ä¿®æ”¹è¿‡çš„å—ç«‹å³å†™åˆ°ç£ç›˜ä¸Š</p> </li><li> <p>å¯¹äºO_sync ,O_directè¾ƒå¥½çš„ç†è§£<br/> https://www.cnblogs.com/suzhou/p/5381738.html<br/> è¿™å¼ å›¾çˆ±äº†<img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/2020042015080612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/></p> </li><li> <p>caltime=time(NULL);<br/> tm=localtime(&amp;caltime);<br/> (strftime(line,MAXLINE,"%a %b %d %X %Z %Y\n",tm)</p> </li><li> <p><code>atexit(void(*func)(void))</code>ç±»ä¼¼äºææ„å‡½æ•°</p> </li><li> <p>å…±äº«åº“å¯ä»¥è®©å¯æ‰§è¡Œæ–‡ä»¶å¤§å°æ˜¾è‘—å‡å°‘ï¼šå…±äº«åº“ä½¿å¾—å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸å†éœ€è¦åŒ…å«å¸¸ç”¨çš„åº“å‡½æ•°,è€Œåªéœ€åœ¨æ‰€æœ‰è¿›ç¨‹éƒ½å¯å­˜å–çš„å­˜å‚¨åŒºä¸­ä¿å­˜è¿™ç§åº“ä¾‹ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬ã€‚ç¨‹åºç¬¬ä¸€æ¬¡æ‰§è¡Œæˆ–è€…ç¬¬ä¸€æ¬¡è°ƒç”¨æŸä¸ªåº“å‡½æ•°æ—¶,ç”¨åŠ¨æ€è¿æ¥æ–¹æ³•å°†ç¨‹åºä¸å…±äº«åº“å‡½æ•°ç›¸è¿æ¥ã€‚è¿™å‡å°‘äº†æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„é•¿åº¦,ä½†å¢åŠ äº†ä¸€äº›è¿è¡Œæ—¶é—´å¼€é”€ã€‚å…±äº«åº“çš„å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥ç”¨åº“å‡½æ•°çš„æ–°ç‰ˆæœ¬ä»£æ›¿è€ç‰ˆæœ¬è€Œæ— éœ€å¯¹ä½¿ç”¨è¯¥åº“çš„ç¨‹åºé‡æ–°è¿æ¥ç¼–è¾‘ã€‚(å‡å®šå‚æ•°çš„æ•°ç›®å’Œç±»å‹éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚)----&gt;(æœ¬éœ€è¦å†™åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œï¼Œç°åœ¨æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ‹¿è¿‡æ¥é“¾æ¥å°±å¥½äº†)ç¼ºç‚¹ï¼šå˜æ…¢</p> </li><li> <p>setjmp,setlongjmpä½¿ç”¨çš„è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„æƒ³åƒæ­£å¸¸gotoä¸€æ ·çš„æ•°æ®ä¸å›æ»šçš„åŠŸèƒ½ï¼Œéœ€è¦è®©é‚£äº›åœ¨è¿‡ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡æ–½åŠ volatile</p> </li><li> <p>å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œ f o r kä¹‹åçš„æŒ‡ä»¤ã€‚å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å¤åˆ¶å“ã€‚ä¾‹å¦‚,å­è¿›ç¨‹è·å¾—<br/> çˆ¶è¿›ç¨‹æ•°æ®ç©ºé—´ã€å †å’Œæ ˆçš„å¤åˆ¶å“ã€‚æ³¨æ„,è¿™æ˜¯å­è¿›ç¨‹æ‰€æ‹¥æœ‰çš„æ‹·è´ã€‚çˆ¶ã€å­è¿›ç¨‹å¹¶ä¸å…±äº«è¿™<br/> äº›å­˜å‚¨ç©ºé—´éƒ¨åˆ†ã€‚å¦‚æœæ­£æ–‡æ®µæ˜¯åªè¯»çš„,åˆ™çˆ¶ã€å­è¿›ç¨‹å…±äº«æ­£æ–‡æ®µ (è§7 . 6èŠ‚)ã€‚<br/> ç°åœ¨å¾ˆå¤šçš„å®ç°å¹¶ä¸åšä¸€ä¸ªçˆ¶è¿›ç¨‹æ•°æ®æ®µå’Œå †çš„å®Œå…¨æ‹·è´,å› ä¸ºåœ¨ f o r kä¹‹åç»å¸¸è·Ÿéšç€<br/> e x e cã€‚ä½œä¸ºæ›¿ä»£,ä½¿ç”¨äº†åœ¨å†™æ—¶å¤åˆ¶ ( C o p y - O n - Write, COW)çš„æŠ€æœ¯ã€‚è¿™äº›åŒºåŸŸç”±çˆ¶ã€å­è¿›ç¨‹å…±<br/> äº«,è€Œä¸”å†…æ ¸å°†å®ƒä»¬çš„å­˜å–è®¸å¯æƒæ”¹å˜ä¸ºåªè¯»çš„ã€‚</p> </li><li> <p>f o r kçš„ä¸€ä¸ªç‰¹æ€§æ˜¯æ‰€æœ‰ç”±çˆ¶è¿›ç¨‹æ‰“å¼€çš„æè¿°ç¬¦éƒ½è¢«å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ã€‚<br/> çˆ¶ã€å­è¿›ç¨‹æ¯ä¸ªç›¸åŒçš„æ‰“å¼€æè¿°ç¬¦å…±äº«ä¸€ä¸ªæ–‡ä»¶è¡¨é¡¹ ã€‚</p> </li><li> <p>forkç”šè‡³ä¼šæŠŠforkå‰çˆ¶è¿›ç¨‹ä¸­æ ‡å‡†IOå¦‚printfå†™ç¼“å†²åŒº(é‚£äº›æ˜¯å…¨ç¼“å­˜çš„)(å¦‚æœæ²¡æœ‰fflush)çš„å†…å®¹å¤åˆ¶åˆ°å­è¿›ç¨‹çš„ç¼“å­˜ä¸­ã€‚</p> </li><li> <p>fork ä¸¤æ¬¡å¯ä»¥é¿å…åƒµå°¸,å‰ææ˜¯å­å…ˆäºå­™æ­»ï¼Œå­™åˆ™æ¥ç»™initè€Œä¸æ˜¯çˆ¶ã€‚</p> </li><li> <p>setuid(500)åœ¨æœ¬ç¨‹åºä¸æ˜¯rootçš„æƒ…å†µä¸‹åªå¯ä»¥500å»è¿è¡Œçš„æ—¶å€™æŠŠæœ‰æ•ˆuidæ”¹æˆ500ã€‚</p> </li><li> <p>[å¯¹äºsetuidç­‰å‡½æ•°çš„è¾ƒå¥½çš„å®éªŒ] https://www.cnblogs.com/robbychan/archive/2013/06/05/3786945.html</p> </li><li> <p>å­è¿›ç¨‹exitä¼šåˆ·æ–°çˆ¶è¿›ç¨‹çš„æ ‡å‡†IOç¼“å†²åŒºï¼Œæ‰€ä»¥ç”¨_exit</p> </li><li> <p>åœ¨å†™myshellçš„è¿‡ç¨‹ä¸­æœ‰ä¸ªé—®é¢˜å°±æ˜¯ç”¨wait(WHOHANG)å®ç°çš„&amp;ç©¶ç«Ÿæ˜¯ä¸æ˜¯çœŸæ­£çš„æ”¾åˆ°åå°ã€‚<br/> ä¸æ˜¯!<br/> ç»ˆç«¯å¦‚æœçŸ¥é“å­è¿›ç¨‹åœ¨åå°è¿è¡Œ1.å­è¿›ç¨‹éœ€è¦å‘ç»ˆç«¯å†™æ•°æ®ï¼ˆå¯ä»¥ä½¿ç”¨stty tostopç¦æ­¢ï¼‰ï¼Œå¯ä»¥ä¼šå†™å‡ºæ¥ä¹Ÿå¯èƒ½å»å‘é€SIGTTOUä¿¡å·ã€‚åœ¨ç¦æ­¢ä¹‹åå‘¢ï¼Œå†™æ•°æ®çš„å­è¿›ç¨‹å°±å’Œä»ç»ˆç«¯è¯»æ•°æ®çš„è¿›ç¨‹ä¸€æ ·çš„ä¼šè¢«æš‚åœã€‚è¯»æ•°æ®ç»ˆç«¯åˆ™å‘é€sigsttinä¿¡å·ã€‚ä¹‹åå‘¢å¦‚æœéœ€è¦è¿è¡Œåˆ™æ˜¯åˆ©ç”¨fg å‘½ä»¤ï¼Œç»ˆç«¯å‘ç¨‹åºå‘é€sigcont,ç¨‹åºåœ¨å‰å°ç»§ç»­è¿è¡Œã€‚å¯ä»¥è¯´çœŸæ­£çš„åå°å°±æ˜¯æš‚åœå’Œå¯ä»¥æ‹¿å‡ºæ¥ç»§ç»­ã€‚ç„¶è€Œmyshellå®éªŒåªæ˜¯è®©å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹åŒæ—¶è¿è¡Œäº†ã€‚</p> </li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article>
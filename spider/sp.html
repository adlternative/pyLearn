<article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>最近刚好学py,刚好小组的群博好久没更新了<br/> 便想拿py来试试水</p>
<p>通过右上角打开rss订阅　<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2020101221364549.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> 其中有很多是你之前的博客，但不是全部，这里我大概40篇博客它仅仅更新了<br/> 10多篇<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2020101221364546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"/></img></p>
<p>接下来将这个rss的url 通过py脚本获取其中带<br/> <code>&lt;a&gt;&lt;href="https://blog.csdn.net/adlatereturn/article/details/108889759"&gt;&lt;/a&gt;</code><br/> 的标签，这并不难,需要注意的是需要 BeautifulSoup(html, ‘lxml’),它这传下来的是xml，但网页上看其源代码其实是html，这的确很坑。</p>
<pre><code class="prism language-python"><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>request <span class="token keyword">import</span> urlopen
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">import</span> re
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> HTTPError
<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>error <span class="token keyword">import</span> URLError
<span class="token keyword">import</span> random


<span class="token keyword">def</span> <span class="token function">getAritcles</span><span class="token punctuation">(</span>articleUrl<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        html <span class="token operator">=</span> urlopen<span class="token punctuation">(</span>articleUrl<span class="token punctuation">)</span>
    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">except</span> URLError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        bs <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">'lxml'</span><span class="token punctuation">)</span>
        <span class="token comment"># with open('rss.xml', 'w+')as fd:</span>
        <span class="token comment">#     fd.write(str(bs))</span>
        <span class="token comment"># print(bs.title)</span>
        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token string">'原文链接'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'href'</span> <span class="token keyword">in</span> article<span class="token punctuation">.</span>attrs<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

getAritcles<span class="token punctuation">(</span><span class="token string">'https://blog.csdn.net/adlatereturn/rss/list'</span><span class="token punctuation">)</span>

</code></pre>
<p>接着如果用如下方式</p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> i <span class="token keyword">in</span> bs<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span> i
</code></pre>
<p>可见find_all可以直接定位到标签</p>
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108889759<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108732422<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108502385<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108356380<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/108046579<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107753159<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107335130<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107335130#comments<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>查看评论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107286812<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107585630<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107586703<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107445014<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/107281562<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106845518<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106293203<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/106167280<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105897403<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105780480<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105691795<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105586921<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://blog.csdn.net/adlatereturn/article/details/105452737<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>原文链接<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>而通过　　<code>article['href']</code>可获得正确的url<br/> 注意　使用<code>article.get_text()只能得到后面的“原文链接”</code></p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
           <span class="token keyword">if</span> <span class="token string">'href'</span> <span class="token keyword">in</span> article<span class="token punctuation">.</span>attrs<span class="token punctuation">:</span>
              <span class="token keyword">print</span><span class="token punctuation">(</span>article<span class="token punctuation">[</span><span class="token string">'href'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-bash">https://blog.csdn.net/adlatereturn/article/details/108889759
https://blog.csdn.net/adlatereturn/article/details/108732422
https://blog.csdn.net/adlatereturn/article/details/108502385
https://blog.csdn.net/adlatereturn/article/details/108356380
https://blog.csdn.net/adlatereturn/article/details/108046579
https://blog.csdn.net/adlatereturn/article/details/107753159
https://blog.csdn.net/adlatereturn/article/details/107335130
https://blog.csdn.net/adlatereturn/article/details/107335130<span class="token comment">#comments</span>
https://blog.csdn.net/adlatereturn/article/details/107286812
https://blog.csdn.net/adlatereturn/article/details/107585630
https://blog.csdn.net/adlatereturn/article/details/107586703
https://blog.csdn.net/adlatereturn/article/details/107445014
https://blog.csdn.net/adlatereturn/article/details/107281562
https://blog.csdn.net/adlatereturn/article/details/106845518
https://blog.csdn.net/adlatereturn/article/details/106293203
https://blog.csdn.net/adlatereturn/article/details/106167280
https://blog.csdn.net/adlatereturn/article/details/105897403
https://blog.csdn.net/adlatereturn/article/details/105780480
https://blog.csdn.net/adlatereturn/article/details/105691795
https://blog.csdn.net/adlatereturn/article/details/105586921
https://blog.csdn.net/adlatereturn/article/details/105452737
</code></pre>
<p>中间有个很唐突的查看评论</p>
<p>因此我们使用</p>
<pre><code class="prism language-python">        <span class="token keyword">for</span> article <span class="token keyword">in</span> bs<span class="token punctuation">.</span>findAll<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span>text<span class="token operator">=</span><span class="token string">'原文链接'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre>
<p>排除掉查看评论</p>
<p>获得正确的url</p>
<pre><code class="prism language-bash">https://blog.csdn.net/adlatereturn/article/details/108889759
https://blog.csdn.net/adlatereturn/article/details/108732422
https://blog.csdn.net/adlatereturn/article/details/108502385
https://blog.csdn.net/adlatereturn/article/details/108356380
https://blog.csdn.net/adlatereturn/article/details/108046579
https://blog.csdn.net/adlatereturn/article/details/107753159
https://blog.csdn.net/adlatereturn/article/details/107335130
https://blog.csdn.net/adlatereturn/article/details/107286812
https://blog.csdn.net/adlatereturn/article/details/107585630
https://blog.csdn.net/adlatereturn/article/details/107586703
https://blog.csdn.net/adlatereturn/article/details/107445014
https://blog.csdn.net/adlatereturn/article/details/107281562
https://blog.csdn.net/adlatereturn/article/details/106845518
https://blog.csdn.net/adlatereturn/article/details/106293203
https://blog.csdn.net/adlatereturn/article/details/106167280
https://blog.csdn.net/adlatereturn/article/details/105897403
https://blog.csdn.net/adlatereturn/article/details/105780480
https://blog.csdn.net/adlatereturn/article/details/105691795
https://blog.csdn.net/adlatereturn/article/details/105586921
https://blog.csdn.net/adlatereturn/article/details/105452737
</code></pre>
<p>这样我们就明确了我们需要爬去的目标了</p>
<p>之后只需要对每个url进行单独爬去即可</p>
<p>csdn爸爸求过审</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>之前一直用免密码登录 😢😢 😢，今天再次找方法去修改密码，但网上方法一直失效，直到找到这篇，<br/> <a href="https://www.cnblogs.com/cpl9412290130/p/9583868.html">blog</a></p>
<pre><code class="prism language-bash">mysql<span class="token operator">&gt;</span> update mysql.user <span class="token keyword">set</span> authentication_string<span class="token operator">=</span>password<span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span>,plugin<span class="token operator">=</span><span class="token string">'mysql_native_password'</span> where user<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span>
</code></pre>
<p>其实就比网上多一步操作,update mysql.user中 修改<code>plugin='mysql_native_password'</code>就完事了，否则将仍然登录失败．</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>小伙伴们,在初步学习了c++的移动操作后你肯定会接触到std::move,std::forward了吧，但你真的懂了std::move和std::forward的具体意义吗？</p>
<p>本文仅涉及std::forward的部分知识讲解</p>
<p>std::forward的使用需求：模板转发参数（完美转发）</p>
<p>所谓转发，即在模板函数中调用另一个函数,外部函数传递的参数并可以保持其左右值属性传递给内部的函数<br/> 大致是下面这样的形式：</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>以下是几种不好或者不正确的转发方式：<br/> ##原始拷贝转发</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>下图1的exec模板函数传入a,b类型对象的拷贝（比如传入一个string,虽说此处传入int）,效率低．</p>
<p><strong>图1</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a tmpa<span class="token punctuation">,</span> b tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##外部函数左值转发</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>下图2的exec模板函数传入a,b类型对象的左值引用,main函数中exec不可以直接传入数字6这种右值.</p>
<p><strong>图2</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b<span class="token operator">&amp;</span> tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##外部函数左值转发，内部函数含有右值参数</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>下图3当 tmp的参数是右值引用时，由于exec中的tmpb是左值，不能给tmp作为参数</p>
<p><strong>图3</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a<span class="token operator">&amp;</span> tmpa<span class="token punctuation">,</span> b<span class="token operator">&amp;</span> tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&amp;&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>##外部函数右值引用转发</p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>下图4已经解决了exec传右值问题，但传给tmp 的tmpb依旧是个左值（右值引用为左值）,我们若直接使用<br/> std::move(tmpb)来给tmp函数传右值,此时的确是可行的,但我们并不确定外界给exec传入的tmpa,tmpb是左值还是右值,而我们需要的转发需要保持参数的左右值属性，此时我们并没有什么好的方法去处理模板函数调用内部函数的方式.</p>
<p><strong>图4</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> ＆a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>作为一种统一的做法，我们需要让传给exec的左值保持左值发给tmp，让保存exec的右值的左值形参如tmpb转换成右值发给tmp,但这个自己并不好实现，但标准库聪明地实现了这个过程<code>std::forward&lt;T&gt;()</code>,下图5模板函数内部仅需统一的调用函数<code>f(std::forward&lt;a&gt;(tmpa), std::forward&lt;b&gt;(tmpb));</code></p>
<p><strong>图5</strong></p>
<pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> fun<span class="token punctuation">,</span> <span class="token keyword">typename</span> a<span class="token punctuation">,</span> <span class="token keyword">typename</span> b<span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">exec</span><span class="token punctuation">(</span>fun f<span class="token punctuation">,</span> a <span class="token operator">&amp;&amp;</span>tmpa<span class="token punctuation">,</span> b <span class="token operator">&amp;&amp;</span>tmpb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>a<span class="token operator">&gt;</span><span class="token punctuation">(</span>tmpa<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>b<span class="token operator">&gt;</span><span class="token punctuation">(</span>tmpb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tmp</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> a <span class="token operator">*</span> b <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token function">exec</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>大家肯定会很好奇forward的实现原理．<br/> 如下图6<br/> std::forward源码</p>
<pre><code class="prism language-cpp">  <span class="token comment">/**
   *  @brief  Forward an lvalue.
   *  @return The parameter cast to the specified type.
   *
   *  This function is used to implement "perfect forwarding".
   */</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token operator">&gt;</span>
    <span class="token keyword">constexpr</span> _Tp<span class="token operator">&amp;&amp;</span>
    <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">typename</span> std<span class="token operator">::</span>remove_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type<span class="token operator">&amp;</span> __t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Tp<span class="token operator">&amp;&amp;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>__t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">/**
   *  @brief  Forward an rvalue.
   *  @return The parameter cast to the specified type.
   *
   *  This function is used to implement "perfect forwarding".
   */</span>
  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token operator">&gt;</span>
    <span class="token keyword">constexpr</span> _Tp<span class="token operator">&amp;&amp;</span>
    <span class="token function">forward</span><span class="token punctuation">(</span><span class="token keyword">typename</span> std<span class="token operator">::</span>remove_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type<span class="token operator">&amp;&amp;</span> __t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token operator">!</span>std<span class="token operator">::</span>is_lvalue_reference<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>value<span class="token punctuation">,</span> <span class="token string">"template argument"</span>
		    <span class="token string">" substituting _Tp is an lvalue reference type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>_Tp<span class="token operator">&amp;&amp;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>__t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<p>无论传入的_Tp是int还是int&amp;还是int&amp;&amp;<br/> <code>std::remove_reference&lt;_Tp&gt;::type</code>会是int<br/> <code>std::remove_reference&lt;_Tp&gt;::type&amp;</code>会是int&amp;,<br/> <code>std::remove_reference&lt;_Tp&gt;::type&amp;&amp;</code>会是int&amp;&amp;</p>
<p>而exec 的参数tmpa,tmpb都是左值（右值引用是左值），此时使用forward其实都只会调用左值版本的forward函数，tempa传入int&amp;,tempb传入int&amp;&amp;,通过引用折叠,a类型推导为int&amp;,b推导为int，<br/> 所以<br/> forward(tmpa)即forward&lt;int&amp;&gt;(int&amp;)<br/> forward函数内_Tp=int&amp;,_Tp&amp;&amp;=int&amp;,<br/> 因此<code>return static_cast&lt;_Tp&amp;&amp;&gt;(__t)</code>返回 int&amp;,也就是左值</p>
<p><code>forward&lt;b&gt;(tmpb)</code>即<code>forward&lt;int&gt;(int&amp;) forward函数内_Tp=int&amp;,_Tp&amp;&amp;=int&amp;, 因此</code>return static_cast&lt;_Tp&amp;&amp;&gt;(__t)`返回 int&amp;&amp;,也就是右值</p>
<p>当然当forward传实参是右值时会调用另一个重载函数，最后会返回右值．</p>
<p>所以可以说forward这里是必须配合模板＋&amp;&amp;参数来实现完美转发</p>
<p>如生成智能指针函数std::make_shared就运用了完美转发的模型，c++中源码的奥妙真是无穷无尽．</p>
<pre><code class="prism language-cpp">  <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Tp<span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> _Args<span class="token operator">&gt;</span>
    <span class="token keyword">inline</span> shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span>
    <span class="token function">make_shared</span><span class="token punctuation">(</span>_Args<span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> __args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">typedef</span> <span class="token keyword">typename</span> std<span class="token operator">::</span>remove_const<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">::</span>type _Tp_nc<span class="token punctuation">;</span>
      <span class="token keyword">return</span> std<span class="token operator">::</span>allocate_shared<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>allocator<span class="token operator">&lt;</span>_Tp_nc<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				       std<span class="token operator">::</span>forward<span class="token operator">&lt;</span>_Args<span class="token operator">&gt;</span><span class="token punctuation">(</span>__args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p><a href="https://github.com/linyacool/WebServer">linyacool/WebServer</a></p>
<p>怎么说呢,又看了一个模仿moduo的server,不过之前那个mini-muduo是echo服务器,这个是http服务器,思想都差不多,在并发模型上这个服务器使用的是Reactor +线程池 ,每个连接子线程也是一个Reactor,这也是我第一次看到这种模型的实现,它相对mini-muduo的优点还有它使用了智能指针来避免内存泄漏,这的确增大了编程的难度,但其保证内存不泄漏的确是程序员格外需要去注意的地方.</p>
<p>大致有这些类<br/> Server(入口类,其中包含了Accptor 用来处理连接事件)</p>
<p>Channel (对于文件描述符的封装)</p>
<p>Epoll (对于epoll的封装,在其中添删Channel)</p>
<p>EventLoop(while循环的封装,其中有个Epoll在那收集事件)</p>
<p>EventLoopThread(EventLoop线程类,是子线程来使用EventLoop来监控连接套接字的)</p>
<p>EventLoopThreadPool(包含指定数量的EventLoopThread来分担所有连接套接字)</p>
<p>HTTPData(连接类,在其中读取数据,处理数据,分发数据)</p>
<p>Logging(异步日志)</p>
<p>流程:(符号不完全一样)</p>
<p>mainLoop()<br/> myHttpServer()-&gt;eventLoopThreadPool_(),accpetChannel()-&gt;myHttpServer.start()-&gt;eventLoopThreadPool_.start()-&gt; eventLoopThread(),eventLoopThread.startLoop()-&gt;thread.start()-&gt; subEventLoop()-&gt;subEventLoop.loop()-&gt;mainloop.addToPoller(acceptChannel)<br/> mainLoop.loop()</p>
<p>对应的说明:</p>
<ul><li>初始化化主循环mainloop</li><li>初始化Server</li><li>其中先初始化eventLoopThreadPool,再初始化监听套接字并放入accpetChannel</li><li>接着启动Server.start</li><li>其中eventLoopThreadPool中初始化4个eventLoopThread</li><li>并开启线程调用它们注册的线程函数,也就是启动 一个线程独有的EventLoop subReactor</li><li>每个subEventLoop 调用loop也就是Epoll类调用的poll(epoll_wait)此时这些epoll上都没有客户套接字</li><li>此时子线程的工作完成,回到父线程中的Server::start,让mainLoop监听acceptChannel</li><li>再调用mainloop.loop来等待客户连接,此时万事具备,只欠东风.</li></ul>
<p>流程:<br/> mainLoop.loop返回-&gt;accpetChannel.handleEvents-&gt;myHttpServer.handNewConn-&gt;accept得到conn_fd-&gt;HttpData req_info(conn_fd)-&gt;Channel connChannel(conn_fd)-&gt;subloop.queueInLoop异步执行req_info.newEvent,subloop.addToPoller(connChannel,2000)</p>
<p>对应的说明:</p>
<ul><li>此时来了客户连接,会在mainLoop.loop中返回,</li><li>通过回调handNewConn来accept,将得到的conn_fd绑定到HttpData和Channel上</li><li>通过EventLoopThreadPool来轮转获取subEventLoop,在subEventLoop中用queueInLoop来将任务函数HttpData::newEvent添加到到subEventLoop中</li><li>其中会将conn_Channel加入到subLoop监听的红黑树中</li><li>还会在conn_Channel绑定一个2秒的计时器,这个计时器由全局的timerManage管理,2s内客户没发送消息,过时会删去计时器(不过会在EventLoop中延迟执行),在计时器类的析构函数中让conn_Channel的智能指针的计数-1,起到"清除"超时客户的作用.</li></ul>
<p>当客户消息来了<br/> 流程:<br/> subLoop.loop返回-&gt; EPOLLIN?-&gt;req_info.handleRead() EPOLLOUT?-&gt;req_info.handleWrite()<br/> req_info.handleRead()-&gt;read,parseURI,parseHeaders,analysisRequest ,req_info.handleWrite()-&gt;write</p>
<p>req_info.handleConn -&gt;查看并修改连接类的Epoll状态-&gt;subEventloop.updatePoller(connChennel)/subEventloop.runInLoop(HttpData::handleClose)异步执行req_info.handleClose-&gt;subLoop.removeFromPoller(connChennel)</p>
<p>对应的说明:</p>
<ul><li>当客户消息来了,subLoop.loop返回,Channel会根据返回的事件来执行读写,handleRead中读取输入,并处理http请求, handleWrite中将需要回发的数据发出去,接着在handleConn中会查看并修改连接类的Epoll状态,根据现在的状态选择更新connChennel 的Epoll事件或者异步关闭连接.</li></ul>
<p>一次的请求完毕</p>
<p>Log类的设计也比较巧妙,专门用一个线程来发送需要写入日志的信息,用户接口非常容易<code>Log&lt;&lt;"xxx"</code>,详见源码</p>
<p>经验:</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Functor<span class="token operator">&amp;&amp;</span> cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">{<!-- --></span>
    MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingFunctors_<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> callingPendingFunctors_<span class="token punctuation">)</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ol><li>(纠正下我上一篇博客讲mini-muduo里面 queueInLoop的错误)``queueInLoop 异步执行任务,queueInLoop中的判断callingPendingFunctors_的作用:在EventLoop::loop中callingPendingFunctors_=true的区间取出所有任务并执行,在queueInLoop中先判断如果发送的任务所在线程不是EventLoop所创建的线程那么如果EventLoop的所在线程已经从pendingFunctors_以vector.swap的方式中取出任务（避免迭代器失效），这个时候 callingPendingFunctors_为真,则EventLoop.weakup可以让epoll的下一轮执行任务，如果此时queueInLoop调用的线程是EventLoop所创建的线程的话，那同样!isInLoopThread()为假,callingPendingFunctors_也为假,不调用wakeup异步唤醒，之后等到eventloop下一轮苏醒了或者说执行到doPendingFunctors了，就能保证此次添加的任务在任务vector中.</li><li>runInLoop也是异步执行任务，queueInLoop功能更像是异步将任务添加到任务Vector</li><li>线程局部存储_thread的用法</li><li>通过linux新api eventfd实现唤醒epoll的功能</li><li>将面向过程代码通过包装成类改造成面向对象代码</li><li>http中head中的每个<code>域名:域值</code>选项以map的key,value存储，方便解析</li><li>使用应用层的缓冲区，读取到的数据append到buffer的末尾，以string动态扩容的方式，解决了原本一个定长数组的不足之处．</li><li>,了解了mainReactor+subReactor+threadpool的模式的功能，（这个threadpool不是用来计算，而是给subReactor来loop）</li><li>利用函数getopt来方便解析命令行参数，这简直是写ls，cp等各种命令的福音</li><li>通过setReadHandler(bind(&amp;Server::handNewConn, this))的方式设置回调函数，可以执行对象的函数，还可以保证setReadHandler的接口统一，需要注意的是传入对象的this指针会让绑定这个函数不安全（这在muduo前几章有所提及）</li><li>ET模式下每次读取或者输出需要一直read或write直到EAGAIN</li><li></li></ol>
<p>bug:服务器bind的80端口已被占用,需要绑定别的.在网页上有回车显示不出来的问题</p>
<p>缺点:未支持utf-8,POST的省略,计时器的设计不佳</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>之前想学muduo 但因为一些原因，暂时编译不过，碰巧看到一个博主是模仿着muduo写的mini-muduo，看了看觉得挺好，仅仅实现Echo服务器，从最简单的epoll模型开始到反应堆+多线程,为了简洁没有使用智能指针（它也提示了会内存泄漏），部分有bug,但依旧是一个很好的学习对象。本文就最后的　反应堆+多线程模型作一下分析。(原文分成了13小节)</p>
<h2><a id="maincpp_2"></a>main.cpp</h2>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EchoServer.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> args<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    EventLoop loop<span class="token punctuation">;</span>
    EchoServer <span class="token function">echoserver</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    echoserver<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接口都是一样的，一个服务器，一个loop,分别使用start loop方法就可以让程序跑起来，</p>
<h2><a id="EchoServerh_20"></a>EchoServer.h</h2>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">ifndef</span> ECHOSERVER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ECHOSERVER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IMuduoUser.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ThreadPool.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">EchoServer</span> <span class="token operator">:</span> <span class="token keyword">public</span> IMuduoUser
                   <span class="token punctuation">,</span> <span class="token keyword">public</span> IRun2
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">EchoServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">EchoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onConnection</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onWriteComplate</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
    TcpServer _pServer<span class="token punctuation">;</span>
    ThreadPool _threadpool<span class="token punctuation">;</span>
    <span class="token keyword">long</span> _timer<span class="token punctuation">;</span>
    <span class="token keyword">int</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>这个EchoServer 是应用层面的服务器，继承于IMuduoUser和IRun2。IMuduoUser类包含onConnection，onMessage，onWriteComplate三个虚函数，要求子类EchoServer实现，分别对应着连接时，收到消息时，发送消息完成时需要的部分处理，<br/> IRun2类虚函数是run2，这个函数运用于回调。<br/> EventLoop* _pLoop是事件轮讯对象指针，TcpServer _pServer是服务器对象,ThreadPool _threadpool是线程池，_timer是计时器的地址(原博主的意思是用计时器的id,但他直接使用了计时器的指针存放在long类型的_timer里,可以说是有点古怪，后面需要多次的转型)<br/> _index暂无使用</p>
<h2><a id="EchoServercc_59"></a>EchoServer.cc</h2>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EchoServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpConnection.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"CurrentThread.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MESSAGE_LENGTH 8</span>

EchoServer<span class="token operator">::</span><span class="token function">EchoServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pServer</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_timer</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_index</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

EchoServer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">EchoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _threadpool<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onConnection</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"onConnection"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MESSAGE_LENGTH<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAsString</span><span class="token punctuation">(</span>MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAllAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onWriteComplate</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"onWriteComplate"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//run in different therad</span>
<span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//IO blocking task or CPU busy task</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fib(30) = "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" tid = "</span> <span class="token operator">&lt;&lt;</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span><span class="token punctuation">)</span>tcp<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fib is short for Fibonacci, fib is a CPU busy method</span>
<span class="token keyword">int</span> EchoServer<span class="token operator">::</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>可以看到　onConnection，onWriteComplate类仅仅是打印一下函数名称， <code>printf("%s\n",__func__);</code>是我为了打印函数执行流程而打印的，使用时可去除。<br/> 先不看run2 ,fib,onMessage,而是看main里面的echoserver.start</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _threadpool<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>转到TcpServer</p>
<h2><a id="TcpServerh_147"></a>TcpServer.h</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> TCPSERVER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCPSERVER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IAcceptorCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IMuduoUser.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TcpServer</span> <span class="token operator">:</span> <span class="token keyword">public</span> IAcceptorCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">TcpServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IMuduoUser<span class="token operator">*</span> pUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">struct</span> epoll_event _events<span class="token punctuation">[</span>MAX_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
        map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> TcpConnection<span class="token operator">*</span><span class="token operator">&gt;</span> _connections<span class="token punctuation">;</span>
        Acceptor<span class="token operator">*</span> _pAcceptor<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
        IMuduoUser<span class="token operator">*</span> _pUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<h2><a id="TcpServercc_181"></a>TcpServer.cc</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpServer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Acceptor.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TcpConnection.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

TcpServer<span class="token operator">::</span><span class="token function">TcpServer</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_pAcceptor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pUser</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

TcpServer<span class="token operator">::</span><span class="token operator">~</span><span class="token function">TcpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Acceptor</span><span class="token punctuation">(</span>_pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pAcceptor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pAcceptor<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    TcpConnection<span class="token operator">*</span> tcp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TcpConnection</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> _pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _connections<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span> <span class="token operator">=</span> tcp<span class="token punctuation">;</span>
    tcp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setUser</span><span class="token punctuation">(</span>_pUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tcp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectEstablished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> TcpServer<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IMuduoUser<span class="token operator">*</span> user<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pUser <span class="token operator">=</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>直接看TcpServer.start里面new了一个Accpetor</p>
<h2><a id="Accpetorh_228"></a>Accpetor.h</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> ACCEPTOR_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ACCEPTOR_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Acceptor</span> <span class="token operator">:</span> <span class="token keyword">public</span> IChannelCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Acceptor</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">Acceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IAcceptorCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> <span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> _listenfd<span class="token punctuation">;</span>
        Channel<span class="token operator">*</span> _pSocketAChannel<span class="token punctuation">;</span>
        IAcceptorCallback<span class="token operator">*</span> _pCallback<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>跳到Acceptor.cc内<br/> 直接看start,</p>
<h2><a id="Acceptorcc_263"></a>Acceptor.cc</h2>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Acceptor.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IAcceptorCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

Acceptor<span class="token operator">::</span><span class="token function">Acceptor</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_listenfd</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pSocketAChannel</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pCallback</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

Acceptor<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Acceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _listenfd <span class="token operator">=</span> <span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pSocketAChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span>_pLoop<span class="token punctuation">,</span> _listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pSocketAChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pSocketAChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Acceptor<span class="token operator">::</span><span class="token function">createAndListen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    _listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in servaddr<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no-block io</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">11111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"bind error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">listen</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> MAX_LISTENFD<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"listen error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _listenfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> connfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in cliaddr<span class="token punctuation">;</span>
    socklen_t clilen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>_listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>cliaddr<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clilen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>connfd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"new connection from "</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>cliaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span> 
            <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>cliaddr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"]"</span>
            <span class="token operator">&lt;&lt;</span> <span class="token string">" new socket fd:"</span> <span class="token operator">&lt;&lt;</span> connfd
            <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"accept error, connfd:"</span> <span class="token operator">&lt;&lt;</span> connfd
            <span class="token operator">&lt;&lt;</span> <span class="token string">" errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>connfd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//no-block io</span>

    _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">newConnection</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> Acceptor<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IAcceptorCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pCallback <span class="token operator">=</span> pCallback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>可以知道这个Acceptor类是生成了一个监听套接字，再new 了一个Channel，在其构造函数传入listenfd,那这个Channel是什么类呢？<br/> Channel的原意是频道，波段，我觉得这个Channel更像是文件描述符对于epoll的一层封装。</p>
<h2><a id="Channelh_356"></a>Channel.h</h2>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CHANNEL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CHANNEL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Channel</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Channel</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>IChannelCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setRevents</span><span class="token punctuation">(</span><span class="token keyword">int</span> revent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">disableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> <span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> _sockfd<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _events<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _revents<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _index<span class="token punctuation">;</span>
        IChannelCallback<span class="token operator">*</span> _pCallback<span class="token punctuation">;</span>
        EventLoop<span class="token operator">*</span> _pLoop<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<h2><a id="Channelcpp_393"></a>Channel.cpp</h2>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

Channel<span class="token operator">::</span><span class="token function">Channel</span><span class="token punctuation">(</span>EventLoop<span class="token operator">*</span> pLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> sockfd<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_sockfd</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_events</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_revents</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_index</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pCallback</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_pLoop</span><span class="token punctuation">(</span>pLoop<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setCallback</span><span class="token punctuation">(</span>IChannelCallback<span class="token operator">*</span> pCallback<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pCallback <span class="token operator">=</span> pCallback<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setRevents</span><span class="token punctuation">(</span><span class="token keyword">int</span> revents<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _revents <span class="token operator">=</span> revents<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _index <span class="token operator">=</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_revents <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>_revents <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
      _pCallback<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">|</span><span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">|</span><span class="token operator">=</span> EPOLLOUT<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">disableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _events <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>EPOLLOUT<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> Channel<span class="token operator">::</span><span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Channel<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _pLoop<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _sockfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Channel<span class="token operator">::</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>可以看出对这个类的操作仅仅是对文件描述符的events属性做了修改，再在_pLoop中update了这个对象，在Acceptor::start的enableReading也就是将这个修改了的文件描述符让其epoll的属性设置为EPOLLIN，enableWriting调用的EventLoop::update</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel <span class="token operator">*</span>pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>会在其Epoll *_pPoller内update这个Channel,也就是调用了 ::epoll_ctl　EPOLL_CTL_ADD或者EPOLL_CTL_MOD</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kNew<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setIndex</span><span class="token punctuation">(</span>kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可见在这个TcpServer中的Acceptor成员会通过Channel在EventLoop的Epoll对象中将listenfd监听套接字让epoll去监听。<br/> 一步步回到EchoServer.start 它接着调用了threadpoll.start(3)也就是让线程池开启了３个线程</p>
<p>它的线程池实现：<br/> ThreadPool.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> THREADPOOL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> THREADPOOL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"BlockingQueue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadPool</span> <span class="token operator">:</span> <span class="token keyword">public</span> IRun0
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">addTask</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BlockingQueue<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> _tasks<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Thread<span class="token operator">*</span><span class="token operator">&gt;</span> _threads<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>ThreadPool.cc</p>
<pre><code class="prism language-cpp">
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ThreadPool.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Thread.h"</span></span>

ThreadPool<span class="token operator">::</span><span class="token function">ThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _threads<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//runInThread  while 1</span>
        Thread<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//virtual for Thread</span>
<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">addTask</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _tasks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//virtual for Thread class</span>
<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从跨线程的阻塞队列取出任务执行</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>利用的阻塞队列<br/> BlockingQueue.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> BLOCKINGQUEUE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BLOCKINGQUEUE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;deque&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Condition.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">BlockingQueue</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">BlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_cond</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> one<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _queue<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _cond<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        T <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            MutexLockGuard <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _cond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token punctuation">}</span>
            T <span class="token function">front</span><span class="token punctuation">(</span>_queue<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _queue<span class="token punctuation">.</span><span class="token function">pop_front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> front<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        deque<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _queue<span class="token punctuation">;</span>
        MutexLock _mutex<span class="token punctuation">;</span>
        Condition _cond<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>其中的锁和条件变量</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MUTEX_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">MutexLock</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">MutexLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_mutexid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pthread_mutex_t<span class="token operator">*</span> <span class="token function">getPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>_mutexid<span class="token punctuation">;</span>       
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        pthread_mutex_t _mutexid<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MutexLockGuard</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">MutexLockGuard</span><span class="token punctuation">(</span>MutexLock<span class="token operator">&amp;</span> mutex<span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">MutexLockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        MutexLock<span class="token operator">&amp;</span> _mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>Conition.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CONDITION_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CONDITION_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token keyword">class</span> <span class="token class-name">Condition</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Condition</span><span class="token punctuation">(</span>MutexLock<span class="token operator">&amp;</span> mutex<span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Condition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">,</span> _mutex<span class="token punctuation">.</span><span class="token function">getPthreadMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_condid<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        MutexLock<span class="token operator">&amp;</span> _mutex<span class="token punctuation">;</span>
        pthread_cond_t _condid<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>这里不说什么，直接看ThreadPool::start</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> numThreads<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _threads<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>numThreads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//runInThread  while 1</span>
        Thread<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threads<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在一个线程的指针vector中逐渐加入new的Thread指针。肯定疑惑的是这个task任务是什么</p>
<p>task.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> TASK_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TASK_H </span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Task</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Task</span><span class="token punctuation">(</span>IRun0<span class="token operator">*</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Task</span><span class="token punctuation">(</span>IRun2<span class="token operator">*</span> func<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        IRun0<span class="token operator">*</span> _func0<span class="token punctuation">;</span>
        IRun2<span class="token operator">*</span> _func2<span class="token punctuation">;</span>
        std<span class="token operator">::</span>string _str<span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token operator">*</span> _param<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>task.cc</p>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IRun.h"</span></span>

Task<span class="token operator">::</span><span class="token function">Task</span><span class="token punctuation">(</span>IRun0<span class="token operator">*</span> func<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_func0</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_func2</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_param</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

Task<span class="token operator">::</span><span class="token function">Task</span><span class="token punctuation">(</span>IRun2<span class="token operator">*</span> func<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> param<span class="token punctuation">)</span>
    <span class="token operator">:</span><span class="token function">_func0</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_func2</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_str</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token function">_param</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> Task<span class="token operator">::</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>_func0<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        _func0<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        _func2<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">run2</span><span class="token punctuation">(</span>_str<span class="token punctuation">,</span> _param<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>看出来task只是根据它传入的参数个数分别调用相应的run0或者run2。<br/> 而ThreadPool实现的run0由绕圈子的调用了runInThread也就是</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> ThreadPool<span class="token operator">::</span><span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _tasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 从跨线程的阻塞队列取出任务执行</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到这个函数是从_tasks阻塞队列中取出任务执行。<br/> 所以每个线程的任务也就是循环着取出任务执行。当然此时任务队列是空的。</p>
<p>此时echoserver.start已经好了<br/> 接着看loop.loop();</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> EVENTLOOP_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EVENTLOOP_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"IChannelCallback.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Mutex.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventLoop</span> <span class="token operator">:</span> <span class="token keyword">public</span> IChannelCallback
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">runInLoop</span><span class="token punctuation">(</span>Task<span class="token operator">&amp;</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp when<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> IRun0<span class="token operator">*</span> pRun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">cancelTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timerfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> <span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> _quit<span class="token punctuation">;</span>
        <span class="token keyword">bool</span> _callingPendingFunctors<span class="token punctuation">;</span>
        Epoll<span class="token operator">*</span> _pPoller<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _eventfd<span class="token punctuation">;</span>
        <span class="token keyword">const</span> pid_t _threadId<span class="token punctuation">;</span>
        Channel<span class="token operator">*</span> _pEventfdChannel<span class="token punctuation">;</span>
        MutexLock _mutex<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> _pendingFunctors<span class="token punctuation">;</span>
        TimerQueue<span class="token operator">*</span> _pTimerQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/eventfd.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"EventLoop.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Epoll.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"TimerQueue.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Timestamp.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Task.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"CurrentThread.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

EventLoop<span class="token operator">::</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">_quit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_callingPendingFunctors</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_pPoller</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Memory Leak !!!</span>
      <span class="token punctuation">,</span>
      <span class="token function">_threadId</span><span class="token punctuation">(</span>CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_pTimerQueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">TimerQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Memory Leak!!!</span>
<span class="token punctuation">{<!-- --></span>
    _eventfd <span class="token operator">=</span> <span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pEventfdChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Channel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> _eventfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Memory Leak !!!</span>
    _pEventfdChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pEventfdChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableReading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

EventLoop<span class="token operator">::</span><span class="token operator">~</span><span class="token function">EventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>_quit<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"loop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid : %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span>Channel <span class="token operator">*</span><span class="token operator">&gt;</span> channels<span class="token punctuation">;</span>
        _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        vector<span class="token operator">&lt;</span>Channel <span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> channels<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> channels<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"for"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel <span class="token operator">*</span>pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _pPoller<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pendingFunctors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _callingPendingFunctors<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">runInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        task<span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::wakeup() writes "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> EventLoop<span class="token operator">::</span><span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> evtfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK <span class="token operator">|</span> EFD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evtfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed in eventfd"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> evtfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">read</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventEventLoop::handleRead() reads "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid -  %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tempRuns<span class="token punctuation">;</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tempRuns<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pendingFunctors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> tempRuns<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> tempRuns<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        it<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runAt</span><span class="token punctuation">(</span>Timestamp when<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> when<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runAfter</span><span class="token punctuation">(</span><span class="token keyword">double</span> delay<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> Timestamp<span class="token operator">::</span><span class="token function">nowAfter</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">long</span> EventLoop<span class="token operator">::</span><span class="token function">runEvery</span><span class="token punctuation">(</span><span class="token keyword">double</span> interval<span class="token punctuation">,</span> IRun0 <span class="token operator">*</span>pRun<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addTimer</span><span class="token punctuation">(</span>pRun<span class="token punctuation">,</span> Timestamp<span class="token operator">::</span><span class="token function">nowAfter</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">cancelTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timerId<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _pTimerQueue<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">cancelTimer</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> EventLoop<span class="token operator">::</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _threadId <span class="token operator">==</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>在loop中调用<code>_pPoller-&gt;poll</code> 也就是使用epoll_wait监听事件。</p>
<p>Epoll.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> EPOLL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EPOLL_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Declear.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Epoll</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span> pChannels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _epollfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> epoll_event _events<span class="token punctuation">[</span>MAX_EVENTS<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

</code></pre>
<p>Epoll.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//author voidccc</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Epoll.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Channel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Define.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> kNew <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> kAdded <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

Epoll<span class="token operator">::</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    _epollfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_epollfd <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_create error, errno:"</span> <span class="token operator">&lt;&lt;</span> _epollfd <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Epoll<span class="token operator">::</span><span class="token operator">~</span><span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">poll</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token operator">*</span> pChannels<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fds <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">epoll_wait</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> _events<span class="token punctuation">,</span> MAX_EVENTS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fds <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"epoll_wait error, errno:"</span> <span class="token operator">&lt;&lt;</span> errno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Channel<span class="token operator">*</span> pChannel <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>Channel<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setRevents</span><span class="token punctuation">(</span>_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannels<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>pChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Epoll<span class="token operator">::</span><span class="token function">update</span><span class="token punctuation">(</span>Channel<span class="token operator">*</span> pChannel<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index <span class="token operator">==</span> kNew<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setIndex</span><span class="token punctuation">(</span>kAdded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> epoll_event ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> pChannel<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd <span class="token operator">=</span> pChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">::</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>_epollfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>从poll可见通过<code>_events[i].data.ptr</code>取出Channel指针，并返回一个Channel指针vector，紧接着EventLoop::loop遍历vector,如果事件是EPOLLIN调用读操作 ,或者是EPOLLOUT调用写操作</p>
<p>如果有客户端连接事件来临，会调用Acceptor::handleRead接受连接并回调TcpServer::newConnection其中会new一个 TcpConnection并在构造函数中new出一个有连接套接字的 Channel，并调用　enableReading将其让epoll监听。接着在TcpConnection::connectEstablished中回调EchoServer::onConnection打印了下函数名，当然可以用来　打印日志</p>
<p>此刻连接的全部工作结束。</p>
<p>当客户端发送消息　epoll_wait返回，loop中调用TcpConnection::handleRead 读取输入，</p>
<pre><code class="prism language-cpp">        string <span class="token function">linestr</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> readlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _inBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>linestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pUser<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>_inBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>在应用层输入缓冲区_inbuf中写入读取的内容。<br/> 调用EchoServer::onMessage</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">onMessage</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span> pCon<span class="token punctuation">,</span> Buffer<span class="token operator">*</span> pBuf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> MESSAGE_LENGTH<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAsString</span><span class="token punctuation">(</span>MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MESSAGE_LENGTH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        string message <span class="token operator">=</span> pBuf<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">retrieveAllAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> pCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _threadpool<span class="token punctuation">.</span><span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>(原博主的这个函数写的有问题，我修改了下)<br/> 大致意思是从缓冲区中每次取出定长发送　这里定长是MESSAGE_LENGTH，当然最后小于MESSAGE_LENGTH的也发，这里的Buffer类不难，可以直接看源码。接着它这里是定义一个含有message的Task,并放入线程池中，threadpool的三个线程会有线程来执行，由于是三参数的任务会调用EchoServer::run2，为模拟计算密集型的线程，它在run2中调用了递归的Fibonacci函数，接着再调用TcpConnection::send。</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EchoServer<span class="token operator">::</span><span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> str<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> tcp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//IO blocking task or CPU busy task</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"fib(30) = "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">fib</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" tid = "</span> <span class="token operator">&lt;&lt;</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>TcpConnection<span class="token operator">*</span><span class="token punctuation">)</span>tcp<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//fib is short for Fibonacci, fib is a CPU busy method</span>
<span class="token keyword">int</span> EchoServer<span class="token operator">::</span><span class="token function">fib</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fib</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着send函数会判断当前线程是不是Eventloop(用来io)的线程，如果是直接调用sendInLoop，否则将调用runInLoop。因为send是线程池中其中一个线程执行的，而io是主线程做的，所以会调用_pLoop-&gt;runInLoop</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">runInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        task<span class="token punctuation">.</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>其中还会检验一次是不是io线程,是则执行任务，此时不是，则将执行queueInLoop</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>Task <span class="token operator">&amp;</span>task<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pendingFunctors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInLoopThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _callingPendingFunctors<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>其中会将任务加入到一个vector中，再一次判断是不是io线程，此时不是，执行wakeup();姑且先不管_callingPendingFunctors。</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventLoop::wakeup() writes "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可见wakeup是写向一个_eventfd,而这个_eventfd是什么呢？</p>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> EventLoop<span class="token operator">::</span><span class="token function">createEventfd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> evtfd <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">eventfd</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> EFD_NONBLOCK <span class="token operator">|</span> EFD_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>evtfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed in eventfd"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> evtfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看到linux的新api eventfd生成一个事件文件描述符，我们姑且不管这个描述符在其他领域的作用，此时它也是epoll可以选择去监听的(在EventLoop的构造函数中就调用了new Channel +enableReading )</p>
<p>而当我们执行write(_eventfd)的时候，如果epoll_wait没有返回，　epoll_wait会唤醒并通知，并且调用相应的处理函数，这里是EventLoop::handleRead,其中仅仅是读取了刚刚wakeup发送的内容，其作用也就是让沉睡的loop唤醒而已。</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">uint64_t</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ssize_t n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">read</span><span class="token punctuation">(</span>_eventfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">sizeof</span> one<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"EventEventLoop::handleRead() reads "</span> <span class="token operator">&lt;&lt;</span> n <span class="token operator">&lt;&lt;</span> <span class="token string">" bytes instead of 8"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在loop内的for轮讯结束后，会调用一个函数doPendingFunctors。在这个函数里面会去执行刚刚我们放入任务vector内的任务，执行TcpConnection::run2其中调用sendInLoop，将消息发送给相应的客户端。在其中看到了刚才所见的_callingPendingFunctors，它的用意可能是希望在loop执行doPendingFunctors的时候调用weakup让下一轮的epoll_wait监听.</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> EventLoop<span class="token operator">::</span><span class="token function">doPendingFunctors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tid -  %d\n"</span><span class="token punctuation">,</span> CurrentThread<span class="token operator">::</span><span class="token function">tid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> tempRuns<span class="token punctuation">;</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">{<!-- --></span>
        MutexLockGuard <span class="token function">guard</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tempRuns<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pendingFunctors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    vector<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span><span class="token operator">::</span>iterator it<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> tempRuns<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> tempRuns<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        it<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">doTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _callingPendingFunctors <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着我们看sendInLoop这个发送给客户消息的函数</p>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> TcpConnection<span class="token operator">::</span><span class="token function">sendInLoop</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> message<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_outBuf<span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        n <span class="token operator">=</span> <span class="token operator">::</span><span class="token function">write</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"write error"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Task <span class="token function">task</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _pLoop<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">queueInLoop</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//invoke onWriteComplate</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> n <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _outBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_pSocketChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">isWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _pSocketChannel<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">enableWriting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//add EPOLLOUT</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>这里是需要发送_outBuf＋message</p>
<p>如果没发完将message放入_outBuf中，如果发完了再去Eventloop放一个任务，这个任务最终会执行TcpConnection::run0，再执行EchoServer::onWriteComplate，这里仅仅打印了函数名称。</p>
<p>历经千辛万苦，整次Echo完毕。</p>
<p>我积累到的经验：<br/> １. 多线程异步执行任务的方法。<br/> ２.网络模型的解耦<br/> ３.阻塞队列BlockingQueue的使用方法。</p>
<p>计时器这里没讲，它这个版本的程序忽略了计时器。在前几个版本中有写，但我觉得它用的也不好，感兴趣可以去看原博主的源码。<br/> <a href="https://github.com/voidccc/mini-muduo">voidccc/mini-muduo<br/> </a></p>
<p>我稍微修改过一点点的<br/> <a href="https://github.com/adlternative/LinuxLearn/tree/master/mini-muduo-learn">adlternative/mini-muduo-learn</a></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>这次写的是一个网络版五子棋</p>
<p>怎么说的，这次的cpp文件文件比较多，我就贴个github代码吧</p>
<p><a href="https://github.com/adlternative/c-2/tree/master/games">github</a><br/> 编译主要看 makefile里那几个文件<br/> 实现了　登录　匹配下棋。</p>
<p>服务器用了　epoll+线程池（模仿《linux高性能编程写的》）但这次的教训就是这个棋局的主体业务逻辑应该放在服务器（我写在客户端由客户端判断棋局是否结束），而且线程池处理也是计算密集型任务，在这种俩个用户并非同时下棋的程序中可以不用。更何况放在客户端的业务逻辑可以伪造的，这样服务器就可能收到伪造的数据。</p>
<p>给大家看下效果：<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200817004521356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"/></p>
<p>经验：</p>
<ol><li>由于用的是PACK的buffer缓存给线程池的process函数执行（同样还有写缓冲）, 每次EPOLLIN 读入后需要切换 EPOLLOUT,写出后再切换EPOLLIN,这样就不会多次读入到同一缓冲区了。</li><li>c++线程中想要使用类的函数，得需要 <code>thread(clientUser::UI, this).detach();</code>在参数中传入对象的指针，同时这个调用的函数必须得是类内的静态函数，且这个静态函数也只能调用类的静态成员，想要使用对象只能使用传进来的arg 通过<code>clientUser *cu = (clientUser *) arg;</code>再使用<code>cu-&gt;xxx</code>来使用cu内的成员<br/> 3.输入出错重新输入的c++方式</li></ol>
<pre><code class="prism language-cpp"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cin <span class="token operator">&gt;&gt;</span> ch<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cin<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"输入有误"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
                cin<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cin<span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
<p>4.condition_variable中要传锁得是unique_lock ，而不是mutex。<br/> 同时从源码可知调用条件变量的wait中可以传入的条件是while(!p)而不是if,也就是条件不满足会重新wait休眠。</p>
<pre><code class="prism language-cpp">
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> _Predicate<span class="token operator">&gt;</span>
      <span class="token keyword">void</span>
      <span class="token function">wait</span><span class="token punctuation">(</span>unique_lock<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __lock<span class="token punctuation">,</span> _Predicate __p<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__p</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token function">wait</span><span class="token punctuation">(</span>__lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre>
<p>5.类的静态成员的初始化在类外不能在.h,放其中一个.cpp即可（最好放在类的.cpp内）<br/> 6.网络发包的pack中不能出现容器,本来很想用string!<br/> 7.make_shared_ptr 的参数是对象而不是对象指针，如果在类中有shared_ptr可以通过构造函数传入的new指针初始化，<br/> 8.ET模式下 read是一次读完后出现EAGAIN ，EWOULDBLOCK说明客户发的全部读了（是对的），而我使用包装成Readn恰好读PACK的大小可能不会执行到这一步。<br/> 9.匹配可以使用对象指针队列，匹配成功放在一个pair集合,比赛结束或者用户退出则需要在队列和集合等容器中清除对象指针</p>
<ol start="10"><li><code>str = "SELECT * FROM information_schema.SCHEMATA where SCHEMA_NAME='chess'";</code>判断是有chess这个数据库，<code>str = "select TABLE_NAME from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA='chess' and TABLE_NAME='account'";</code>判断chess库是否有account表。</li><li>刚看了点设计模式，觉得这个是客户端的客户类是需要设置为单例模式的。并且这次的程序代码复用性不强，本想同时给五子棋类设计的判断胜出规则放在了Table类，而五子棋类的父类ChessBase就显的很累赘rule()没用上，之后再想方法完善，可能是因为不知道围棋的规则，没法实践c++继承体系。</li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<ul><li>编译器不检查虚函数的各类属性:pub,pro,pri。统一放于虚函数表</li><li>继承属性只能改变子类继承下来的元素在子类中的属性，而即使是pri继承子类同样可以访问基类继承下来的prompub属性成员</li><li>析构的异常处理1：try catch record abort ,2：close +flag + try catch</li><li>基类析构,构造别用子类的虚函数（会被解释为基类的虚函数），可以通过子类静态非虚类函数构造基类</li><li>operator= 自赋值 return *this,new temp/copy-and-swap</li><li>copy copy-assign 可用第三个init(pri)来代替</li><li>用non_member函数调用pub成员函数以提供较大封装性，若使用member函数则可访问私有，破坏分装，加大后期维护（越少访问pri越好封装性）</li><li>class +swap(member)(using std::swap)+swap(non_member)+std::swap, template +swap(member)(using std::swap)+swap(non_member)</li><li>临时对象的成员指针传出可造成空悬</li><li>copy+swap 来实现强烈保证（异常安全）（可能无法全美）。</li><li>Handle classes(impl with obj,handle with shared_ptr impl and 可能会在构造函数使用的class的声明) ,Interface classes(static create derive class with shared_ptr)</li><li>使用纯虚函数，这样子类必须重写接口（避免遗忘而导致使用默认的父类虚函数），父类纯虚函数可以有实现体（可用于默认，子类必须：：使用）</li><li>NVI 父类接口pub调虚函数pri,子类可修改虚函数定义。pri虚函数子类只能重写，不能使用。若要使用 pro,pub</li><li>带有默认参数的虚函数会使用静态的默认参数，解决方案NVI，默认实参给</li><li>用list实现set (impl通过pri list+pub 接口)而非public继承，和stack deque类似，将deque 作为 模板+pro</li><li>将不希望让子类修改父类继承父类的父类的vitual函数可以修改结构让父类的私有成员(内部类)pub继承父类的父类。如果仅仅让父类pri继承父类的父类是不行的，子类还是可以修改虚函数，尽管他不能使用</li><li>需要类型转换时请为模板定义非成员函数+友元（为了生成函数，之后才能推导类型转换）</li><li>通过模板的友元类内定义可以让该函数自动具现化，这样就可以利用参数的类型转换（模板方可推导）<br/> <code>friend ostream &amp;operator&lt;&lt;&lt;&gt;(ostream &amp;os, A&lt;T&gt; a)</code>;需要前置声明，<br/> 或者这样</li></ul>
<pre><code class="prism language-c">  template<span class="token operator">&lt;</span>typename U<span class="token operator">&gt;</span>
  friend
  ostream <span class="token operator">&amp;</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>ostream <span class="token operator">&amp;</span>os<span class="token punctuation">,</span> A<span class="token operator">&lt;</span>U<span class="token operator">&gt;</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//类内声明，之后类外定义</span>
</code></pre>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>以后知道一个写一个</p>
<p><strong>valgrind</strong><br/> 可用来检验内存泄漏出处<br/> valgrind --tool=memcheck --leak-check=full ./test</p>
<pre><code class="prism language-shell">adl@adl:~/桌面/json-tutorial/tutorial03/images$ valgrind  ./leptjson_test --leak-check<span class="token operator">=</span>full
<span class="token operator">==</span>7458<span class="token operator">==</span> Memcheck, a memory error detector
<span class="token operator">==</span>7458<span class="token operator">==</span> Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> 2002-2017, and GNU GPL<span class="token string">'d, by Julian Seward et al.
==7458== Using Valgrind-3.13.0 and LibVEX; rerun with -h for copyright info
==7458== Command: ./leptjson_test --leak-check=full
==7458== 
160/160 (100.00%) passed
==7458== 
==7458== HEAP SUMMARY:
==7458==     in use at exit: 6 bytes in 1 blocks
==7458==   total heap usage: 12 allocs, 11 frees, 2,092 bytes allocated
==7458== 
==7458== LEAK SUMMARY:
==7458==    definitely lost: 6 bytes in 1 blocks
==7458==    indirectly lost: 0 bytes in 0 blocks
==7458==      possibly lost: 0 bytes in 0 blocks
==7458==    still reachable: 0 bytes in 0 blocks
==7458==         suppressed: 0 bytes in 0 blocks
==7458== Rerun with --leak-check=full to see details of leaked memory
==7458== 
==7458== For counts of detected and suppressed errors, rerun with: -v
==7458== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
adl@adl:~/桌面/json-tutorial/tutorial03/images$ valgrind --tool=memcheck --leak-check=full ./
CMakeFiles/    leptjson_test  
adl@adl:~/桌面/json-tutorial/tutorial03/images$ valgrind --tool=memcheck --leak-check=full ./leptjson_test 
==7516== Memcheck, a memory error detector
==7516== Copyright (C) 2002-2017, and GNU GPL'</span>d, by Julian Seward et al.
<span class="token operator">==</span>7516<span class="token operator">==</span> Using Valgrind-3.13.0 and LibVEX<span class="token punctuation">;</span> rerun with -h <span class="token keyword">for</span> copyright info
<span class="token operator">==</span>7516<span class="token operator">==</span> Command: ./leptjson_test
<span class="token operator">==</span>7516<span class="token operator">==</span> 
160/160 <span class="token punctuation">(</span>100.00%<span class="token punctuation">)</span> passed
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> HEAP SUMMARY:
<span class="token operator">==</span>7516<span class="token operator">==</span>     <span class="token keyword">in</span> use at exit: 6 bytes <span class="token keyword">in</span> 1 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>   total heap usage: 12 allocs, 11 frees, 2,092 bytes allocated
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> 6 bytes <span class="token keyword">in</span> 1 blocks are definitely lost <span class="token keyword">in</span> loss record 1 of 1
<span class="token operator">==</span>7516<span class="token operator">==</span>    at 0x4C2FB0F: malloc <span class="token punctuation">(</span>in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10F532: lept_set_string <span class="token punctuation">(</span>in /home/adl/桌面/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E83F: test_access_string <span class="token punctuation">(</span>in /home/adl/桌面/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E9AC: test_parse <span class="token punctuation">(</span>in /home/adl/桌面/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span>    by 0x10E9BD: main <span class="token punctuation">(</span>in /home/adl/桌面/json-tutorial/tutorial03/images/leptjson_test<span class="token punctuation">)</span>
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> LEAK SUMMARY:
<span class="token operator">==</span>7516<span class="token operator">==</span>    definitely lost: 6 bytes <span class="token keyword">in</span> 1 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>    indirectly lost: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>      possibly lost: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>    still reachable: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span>         suppressed: 0 bytes <span class="token keyword">in</span> 0 blocks
<span class="token operator">==</span>7516<span class="token operator">==</span> 
<span class="token operator">==</span>7516<span class="token operator">==</span> For counts of detected and suppressed errors, rerun with: -v
<span class="token operator">==</span>7516<span class="token operator">==</span> ERROR SUMMARY: 1 errors from 1 contexts <span class="token punctuation">(</span>suppressed: 0 from 0<span class="token punctuation">)</span>
</code></pre>
<p><strong>telnet</strong></p>
<p>可当客户端<br/> telnet 127.0.0.1 12345<br/> （会有\r\n）<br/> <strong>nc</strong><br/> nc可以当成客户或者服务器</p>
<p><strong>tcpdump</strong><br/> 抓包<br/> sudo tcpdump -i lo tcp port 12345 and host 127.0.0.1<br/> [.]ACK, [R]RST,[F]FIN,[S]SYN [S.]SYN+ACK</p>
<p><strong>top -d</strong> 查看cpu占用情况！</p>
<p><strong>find</strong>（这个记下是因为老是忘）<br/> find . -maxdepth 5 -name “cJSON.*” 指定查找的深度为5</p>
<p><strong>ranger</strong><br/> 一个可以通过上下左右就可以快速访问各级目录的命令<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200802224008409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> awk 配合 ps grep 杀死你想结束的进程<br/> ps -ef | grep vim | awk ‘{print $2}’| xargs kill -9</img></p>
<p>rm 想含有’-'文件名的文件<br/> 解决方法：在文件名之前加”–“来删除文件</p>
<p>g++ 指定编译版本<br/> <code>g++ -std=c++17 stdAnyTest.cpp</code></p>
<p>将一个文件下所有的后缀为<code>.cgi ---&gt;.py</code><br/> <code>rename 's/.py/.cgi/' *</code></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>之前写聊天室的时候，因为构思不够严谨，连续重构了好几次，也算是踩了好多次的坑。这次就给大家讲下我写聊天室的一点点经验和建议。</p>
<ol><li>采用的策略：迭代服务器还是并发服务器<br/> <em>迭代服务器</em><br/> 服务器进程是一个一个处理各个客户端发来的连接的，比如一个客户端发来一个连接，那么只要它还没有完成自己的任务，那么它就一直会占用服务器的进程直到处理完毕后服务器关闭掉这个socket。<br/> <em>并发服务器</em><br/> 有很多种模型。服务器对于客户端到来的请求在线程中并发处理。这样可以“同时”处理耗时操作。<br/> 我当时因为线程池不知道如何部署，包括我的业务逻辑函数的接口不一致，就采用了迭代服务器</li></ol>
<p>我的服务器大致思路：</p>
<div class="mermaid">
<svg height="187.1875" id="mermaid-svg-4RkGOVkWob97JqEZ" viewbox="0 0 1062.8125 207.1875" width="1042.8125" xmlns="http://www.w3.org/2000/svg">
<g>
<g class="output">
<g class="clusters"></g>
<g class="edgePaths">
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M81.359375,83.34553252382213L198.2578125,44.296875L315.15625,44.296875" marker-end="url(#arrowhead98)" style="fill:none"></path>
<defs>
<marker id="arrowhead98" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M81.359375,103.84196747617787L198.2578125,142.890625L359.7734375,142.890625" marker-end="url(#arrowhead99)" style="fill:none"></path>
<defs>
<marker id="arrowhead99" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M485.3828125,142.890625L713.6015625,142.890625L897.203125,142.890625" marker-end="url(#arrowhead100)" style="fill:none"></path>
<defs>
<marker id="arrowhead100" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
</g>
<g class="edgeLabels">
<g class="edgeLabel" style="opacity: 1;" transform="translate(198.2578125,44.296875)">
<g class="label" transform="translate(-72.328125,-14.296875)">
<foreignobject height="28.600000381469727" width="144.66717529296875">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">监听到lfd连接事件</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(198.2578125,142.890625)">
<g class="label" transform="translate(-91.8984375,-14.296875)">
<foreignobject height="28.600000381469727" width="183.8031005859375">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">监听到cfd发送消息事件</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(713.6015625,142.890625)">
<g class="label" transform="translate(-158.6015625,-14.296875)">
<foreignobject height="28.600000381469727" width="317.2125244140625">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">根据发送的结构体中相应的字段来switch</span>
</div>
</foreignobject>
</g>
</g>
</g>
<g class="nodes">
<g class="node" id="A" style="opacity: 1;" transform="translate(50.6796875,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="61.359375" x="-30.6796875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-20.6796875,-14.296875)">
<foreignobject height="28.600000381469727" width="41.370361328125">
<div style="display: inline-block; white-space: nowrap;">
          epoll
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="B" style="opacity: 1;" transform="translate(422.578125,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="214.84375" x="-107.421875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-97.421875,-14.296875)">
<foreignobject height="28.600000381469727" width="194.85467529296875">
<div style="display: inline-block; white-space: nowrap;">
          建立连接,epoll监听新cfd
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="C" style="opacity: 1;" transform="translate(422.578125,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          丢给处理函数
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="D" style="opacity: 1;" transform="translate(960.0078125,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          业务处理函数
         </div>
</foreignobject>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>我的客户端大致思路：</p>
<div class="mermaid">
<svg height="187.1875" id="mermaid-svg-8wC1qD0R8dglmnAn" viewbox="0 0 1240.84375 207.1875" width="1220.84375" xmlns="http://www.w3.org/2000/svg">
<g>
<g class="output">
<g class="clusters"></g>
<g class="edgePaths">
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M110.40625,93.59375L135.40625,93.59375L160.40625,93.59375" marker-end="url(#arrowhead120)" style="fill:none"></path>
<defs>
<marker id="arrowhead120" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M283.83760895404123,69.296875L346.21875,44.296875L406.421875,44.296875" marker-end="url(#arrowhead121)" style="fill:none"></path>
<defs>
<marker id="arrowhead121" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M708.03125,44.296875L891.6328125,44.296875L1075.234375,44.296875" marker-end="url(#arrowhead122)" style="fill:none"></path>
<defs>
<marker id="arrowhead122" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
<g class="edgePath" style="opacity: 1;">
<path class="path" d="M283.83760895404123,117.890625L346.21875,142.890625L468.0234375,142.890625" marker-end="url(#arrowhead123)" style="fill:none"></path>
<defs>
<marker id="arrowhead123" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
<path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path>
</marker>
</defs>
</g>
</g>
<g class="edgeLabels">
<g class="edgeLabel" style="opacity: 1;" transform="">
<g class="label" transform="translate(0,0)">
<foreignobject height="0" width="0">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel"></span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(346.21875,44.296875)">
<g class="label" transform="translate(-35.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="70.417236328125">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">登录成功</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="translate(891.6328125,44.296875)">
<g class="label" transform="translate(-158.6015625,-14.296875)">
<foreignobject height="28.600000381469727" width="317.2125244140625">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel">根据发送的结构体中相应的字段来switch</span>
</div>
</foreignobject>
</g>
</g>
<g class="edgeLabel" style="opacity: 1;" transform="">
<g class="label" transform="translate(0,0)">
<foreignobject height="0" width="0">
<div style="display: inline-block; white-space: nowrap;">
<span class="edgeLabel"></span>
</div>
</foreignobject>
</g>
</g>
</g>
<g class="nodes">
<g class="node" id="I" style="opacity: 1;" transform="translate(65.203125,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="90.40625" x="-45.203125" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-35.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="70.417236328125">
<div style="display: inline-block; white-space: nowrap;">
          建立连接
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="J" style="opacity: 1;" transform="translate(223.2109375,93.59375)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          登录界面目录
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="K" style="opacity: 1;" transform="translate(557.2265625,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="301.609375" x="-150.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-140.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="281.6171875">
<div style="display: inline-block; white-space: nowrap;">
          开启线程监听连接服务器发来的消息
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="Q" style="opacity: 1;" transform="translate(1138.0390625,44.296875)">
<rect height="48.59375" rx="0" ry="0" width="125.609375" x="-62.8046875" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-52.8046875,-14.296875)">
<foreignobject height="28.600000381469727" width="105.6171875">
<div style="display: inline-block; white-space: nowrap;">
          处理业务逻辑
         </div>
</foreignobject>
</g>
</g>
</g>
<g class="node" id="L" style="opacity: 1;" transform="translate(557.2265625,142.890625)">
<rect height="48.59375" rx="0" ry="0" width="178.40625" x="-89.203125" y="-24.296875"></rect>
<g class="label" transform="translate(0,0)">
<g transform="translate(-79.203125,-14.296875)">
<foreignobject height="28.600000381469727" width="158.41717529296875">
<div style="display: inline-block; white-space: nowrap;">
          主线程读取键盘输入
         </div>
</foreignobject>
</g>
</g>
</g>
</g>
</g>
</g>
</svg>
</div>
<p>注意：其实客户端同样是可以用epoll监听stdin和服务器套接字。<br/> (另外需要提到的一点就是只能一个线程读同一个套接字，你发送给服务器文件，如果让服务器开接受文件的线程，这个想法很自然，但是事实上会有点问题：我们在发送给服务器文件的同时，发送了一条消息，服务器的这个线程难道不会接受你发送的消息吗？如果想要通过recv 的MSG_PEEK以获取文件的flag位来表示消息类型而不去接收，这同样会出现问题，一个线程可能一直拿到这个包，另一个线程一直拿不到，而我当时的设计里服务器是没用epoll+线程池的，这会导致我整个服务器阻塞在这！因此recv让一个线程来做，而send包的时候其实可以开多线程因为不存在这种冲突)</p>
<ol start="2"><li> <p>信号怎么处理<br/> SIGPIPE<br/> <em>服务器</em> Server 向已经关闭的 Client 继续发送数据（其实是发送两次才会触发），大部分信号都是默认结束整个程序。而服务器是需要永久挂着的，如果触发了SIGPIPE，程序是会停止的，我们得使用SIG_IGN。<br/> <em>客户端</em> 使用信号处理函数通知服务器提前退出，紧接着客户端就可以退出了。<br/> SIGINT，SIGTERM 都可以选择性SIG_IGN</p> </li><li> <p>EPOLLRDHUP是什么？这是EPOLL中可以监听到的事件种类之一，代表对端的关闭。epoll_wait得到的结果集中，你可以通过这个标志位来监测客户端退出，关闭客户端连接。</p> </li><li> <p>应该设计哪些类？mysql设计哪些表？<br/> 好友表，消息表，账号表…并没有什么标准答案，最好想好先逻辑了再去写，不然很容易重构的。</p> </li></ol>
<p>传的PACK包最好带有个mysql中id字段（不过你发送给服务器不一定要填写这个字段），因为我当初没有加id字段（因为总感觉这对客户没有用）结果在服务器上处理业务逻辑每次都得根据账号去查询mysql下的id，再根据id去做更多操作，比如查询另一张含有这个id的表。直接代码量大了很多很多，也让程序的结构显得十分丑陋，可读性也会很差。</p>
<ol start="5"><li> <p>cjson / 自己写的结构体 /还是在msg中用分割符号得到更多的字段？<br/> 我觉得json可能会更好，因为我当初用的是分割符号，也就是在myshell中用来分割每一个小段，比如<code>id:1\nname:adl\nclass:计科1904\n</code>通过一个自己写的函数去将这个片段根据分隔符’\n’分成三份，从而解析出我们需要的字段内容，然而我写的函数需要在函数外开辟大量的数组空间避免内容过长而导致的溢出，而且使用起来难以精确free。至于真要使用这种方法，分隔符请不要使用\n,因为这个过于常见，推荐使用"\r\n"。而如果使用结构体添加字段，你要知道，你发送的包一般是固定的，但你如果需要发送一些文件的大小，名称，你忽然发现你的结构体的字段不够用，添加结构体字段其实是一种下策（我就加了文件的字段），因为服务器和客户端都会需要因此多维护很多相应的信息。cjson呢你就可以比如想将一个</p> </li><li> <p>发文件如何让对方知道我发完了呢？<br/> 发送含END标志位的包，END包的处理在聊天室中用到挺多的，显示一个好友列表，群列表。。。</p> </li><li> <p>重复加好友，加群该怎么处理？？？群主和管理员该怎么同时处理这个请求？？？<br/> 这些重复需求大需要验证该消息已存在的操作。而群主和管理员只能让一个生效。</p> </li><li> <p>同时填写一个结构体的字段最好写成函数</p> </li><li> <p>聊天记录和其他类型的消息需要在mysql中存放多久？（消息的状态flag）</p> </li><li> <p>断点传输应该注意哪些事项？<br/> 服务器存客户端的文件的总大小和已发送大小，断开连接后，下一次客户连接，服务器可通知该客户，再可以选择性重发<br/> （sys/sendfile.h sendfile函数大家可以试试）<br/> 上传给服务器的文件应该放在哪里，是直接发给对方吗？<br/> 目录 等到对端在线PUSH</p> </li><li> <p>时间戳<br/> 这个其实挺重要的，这样每次你发送的消息都可显示时间，看上去炫酷多了！</p> </li><li> <p>超时处理<br/> 仅仅提供我的想法：之前说服务器可以用一个全局链表来记录客户的在线状态，那么可以添加一个字段登录时间（或者超时时间），服务器当客户连接时记录下客户的登录时间，每循环一轮（或者更长一段就将超时的客户删去）<br/> 事实上可以采用时间升序链表的方式，也就是插入的时候将这个节点放在那些超时时间在它之前的节点的后面。那么你在链表节点的插入就有O（n）的复杂度，也是每隔一段时间比较链表上节点超时时间和当前时间，超时则删除客户。如果客户发送了请求，说明客户在线，那么就去更新超时时间。<br/> 大致就这个思路，当初没有实现，感兴趣的小伙伴可以试试。</p> </li></ol>
<p>写聊天室的思路 先构思整体逻辑 再登录注册入手 再实现私聊 再群聊（其实很多地方和私聊本质相同）<br/> 心态很容易爆炸的，一次次痛苦的重构 ，唉，打不死你的只会让你更强大！</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>节点类<br/> 相比较时间升序链表中的绝对时间expire</p>
<p>tw_timer采用的是相对时间的概念也就多出<br/> rotation ，time_slot俩属性，rotation是转的“圈数”，time_slot是转到时间轮的哪一块区域。好比现在在1：05，过了65分钟时针走了闹钟的1rotation并走到10 time_slot;</p>
<p>tw_timer.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_TW_TIMER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_TW_TIMER_H</span>

<span class="token keyword">class</span> <span class="token class-name">client_data</span> <span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">tw_timer</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">tw_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> rot<span class="token punctuation">,</span><span class="token keyword">int</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">int</span> rotation<span class="token punctuation">;</span>
    <span class="token keyword">int</span> time_slot<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span>user_data<span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span>next<span class="token punctuation">;</span>
    tw_timer<span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_TW_TIMER_H</span>

</code></pre>
<p>tw_timer.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>

tw_timer<span class="token operator">::</span><span class="token function">tw_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> rot<span class="token punctuation">,</span> <span class="token keyword">int</span> ts<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">rotation</span><span class="token punctuation">(</span>rot<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">time_slot</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

</code></pre>
<p>client_data.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_CLIENT_DATA_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_CLIENT_DATA_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE 64</span>

<span class="token comment">//class util_timer;</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>
<span class="token comment">//class heap_timer;</span>
<span class="token keyword">struct</span> client_data <span class="token punctuation">{<!-- --></span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
        tw_timer <span class="token operator">*</span>timer<span class="token punctuation">;</span>
<span class="token comment">//        util_timer *timer;</span>
<span class="token comment">//        heap_timer*timer3;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_CLIENT_DATA_H</span>

</code></pre>
<p>time_wheel.cpp<br/> 可以注意到这个时间轮类的接口和时间升序链表的接口基本一致</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_TIME_WHEEL_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_TIME_WHEEL_H</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">time_wheel</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tw_timer <span class="token operator">*</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tw_timer <span class="token operator">*</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> N<span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span><span class="token comment">//一圈60块区域</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> SI <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//SI可以想象成时针或者分钟每次转动的幅度</span>
    tw_timer<span class="token operator">*</span>slots<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cur_slot<span class="token punctuation">;</span><span class="token comment">//当前所在区域</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_TIME_WHEEL_H</span>
</code></pre>
<p>time_wheel.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"time_wheel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>

time_wheel<span class="token operator">::</span><span class="token operator">~</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tw_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
            <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

time_wheel<span class="token operator">::</span><span class="token function">time_wheel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">cur_slot</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

tw_timer <span class="token operator">*</span>time_wheel<span class="token operator">::</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> SI<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//这个水表一次只能跳5小格，那当然定时3小格至少要时针跳一次</span>
        ticks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> timeout <span class="token operator">/</span> SI<span class="token punctuation">;</span><span class="token comment">//跳的次数</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> rotation <span class="token operator">=</span> ticks <span class="token operator">/</span> N<span class="token punctuation">;</span><span class="token comment">//跳的圈数</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>cur_slot <span class="token operator">+</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span><span class="token comment">//跳的最终位置（时间）</span>
	<span class="token comment">//这里它将timer在timer_wheel内部动态分配了，这也就导致了使用接口和时间升序链表有所区别，见后文</span>
    tw_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">tw_timer</span><span class="token punctuation">(</span>rotation<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ticks =%d ,timeout=%d\n"</span><span class="token punctuation">,</span>ticks<span class="token punctuation">,</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add timer,rotation is %d,ts is %d,cur_slot is %d\n"</span><span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//这个adjust_timer函数其实书上没有，因为和时间升序链表的接口比较相似，我就把节点摘下来，再重新放到时间轮上=del_timer+add_timer，也就是用于客户在发送消息之后我们重新设置超时的需求</span>
tw_timer <span class="token operator">*</span>time_wheel<span class="token operator">::</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ots <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>ots<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> ticks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> SI<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ticks <span class="token operator">=</span> timeout <span class="token operator">/</span> SI<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> rotation <span class="token operator">=</span> ticks <span class="token operator">/</span> N<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> <span class="token punctuation">(</span>cur_slot <span class="token operator">+</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> N<span class="token punctuation">;</span>
    timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot <span class="token operator">=</span> ts<span class="token punctuation">;</span>
    timer<span class="token operator">-</span><span class="token operator">&gt;</span>rotation <span class="token operator">=</span> rotation<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"add timer,rotation is %d,ts is %d,cur_slot is %d\n"</span><span class="token punctuation">,</span> rotation<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> time_wheel<span class="token operator">::</span><span class="token function">del_timer</span><span class="token punctuation">(</span>tw_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ts <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>time_slot<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            slots<span class="token punctuation">[</span>ts<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timer<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">delete</span> timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> time_wheel<span class="token operator">::</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    tw_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"current slot is %d\n"</span><span class="token punctuation">,</span> cur_slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tick the timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//因为时针转过一圈才会回到相同的cur_slot,所以每调用tick且轮到相同的cur_slot时，将rotation--直到0为止</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>rotation <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            tmp<span class="token operator">-</span><span class="token operator">&gt;</span>rotation<span class="token operator">--</span><span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span><span class="token comment">//换到这个区域内链表的下一个节点，查看他它是否超时</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//超时则调用函数，删除节点</span>
            tmp<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"delete header in cur_slot\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tmp <span class="token operator">=</span> slots<span class="token punctuation">[</span>cur_slot<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                tmp<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token operator">-</span><span class="token operator">&gt;</span>next <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token operator">-</span><span class="token operator">&gt;</span>prev <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>prev<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tw_timer <span class="token operator">*</span>tmp2 <span class="token operator">=</span> tmp<span class="token operator">-</span><span class="token operator">&gt;</span>next<span class="token punctuation">;</span>
                <span class="token keyword">delete</span> tmp<span class="token punctuation">;</span>
                tmp <span class="token operator">=</span> tmp2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//时针转1格</span>
    cur_slot <span class="token operator">=</span> <span class="token operator">++</span>cur_slot <span class="token operator">%</span> N<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Handleinactiveconnections.cpp<br/> 书上说让我们自己实现一下这个，但是时间升序链表中操作略有不同（没在用户空间动态分配节点类，并且直接使用相对时间在时间轮上添加新定时器，更为清晰方便）</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token comment">//#include "sort_timer_lst.h"</span>
<span class="token comment">//#include "util_timer.h"</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"client_data.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tw_timer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"time_wheel.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> FD_LIMIT 65535</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENT_NUMBER 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TIMESLOT 1</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> time_wheel timeWheel<span class="token punctuation">;</span>
<span class="token comment">//static sort_timer_lst timerLst;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|</span><span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span>user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    timeWheel<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    timerLst.tick();</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage: %s ip_address port_number \n"</span><span class="token punctuation">,</span> <span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>listenfd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> op<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_REUSEADDR<span class="token punctuation">,</span><span class="token operator">&amp;</span>op<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    client_data <span class="token operator">*</span>users <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token comment">//        std::cout&lt;&lt;number&lt;&lt;std::endl;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">struct</span> sockaddr_in client_address<span class="token punctuation">;</span>
                    socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
<span class="token comment">//                    util_timer *timer = new util_timer;</span>
<span class="token comment">//                    tw_timer*timer =new tw_timer;</span>
<span class="token comment">//我们无需在接口外分配节点类</span>
            <span class="token comment">//        time_t cur = time(nullptr);</span>
    <span class="token comment">//此时超时时间也变成了相对时间</span>
                    <span class="token keyword">auto</span> timer <span class="token operator">=</span> timeWheel<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token comment">/*cur+*/</span><span class="token number">3</span><span class="token operator">*</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    timer<span class="token operator">-</span><span class="token operator">&gt;</span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    timer<span class="token operator">-</span><span class="token operator">&gt;</span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
<span class="token comment">//                      timer-&gt;expire = cur + 3 * TIMESLOT;</span>
                    users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
<span class="token comment">//                    timerLst.add_timer(timer);</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                    <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                    stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tw_timer<span class="token comment">/*util_timer*/</span> <span class="token operator">*</span>timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                                timerLst.del_timer(timer);</span>
                                timeWheel<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            timeWheel<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timerLst.del_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                            time_t cur = time(nullptr);</span>
<span class="token comment">//                            timer-&gt;expire = cur + 3 * TIMESLOT;</span>
                            timeWheel<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span><span class="token comment">/*cur +*/</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"adjust timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timer-&gt;time_slot;</span>
<span class="token comment">//                            timerLst.adjust_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>实现效果和时间升序链表类似</p>
<p>思考：为什么用了时间轮就可以使用相对时间了而升序链表不行呢？<br/> 因为时间轮中将时间节点“哈希”到每一块时间区域，并将相对时间100转换成了rotation（1）+slot（40）也就是时钟上的小时和分钟，从而使用者可以根据时钟上位置的rotation,slot的变化来判断真实时间的变化，而升序链表无法得知过去的相对时间，便只能使用绝对时间比较了。当然时间升序链表也可以存储绝对时间，但并没这个必要。</p>
<p>注意的是无论时间升序链表还是时间轮，他们如果调用的超时回调函数会占用一段时间，那么如果有多个节点超时并需要删除，他们的真实删除时间其实不是定时器所定的时间，而是稍微晚一些。</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>刚好前两天学长给我们讲座中提到服务器客户的超时处理，刚好又在看《高性能linux服务器编程》有发现这方面的知识，就拿出来总结一下。</p>
<p>第一,我们为什么需要自制计时器，c++ /c 的alarm不是可以实现定时操作吗，还有sleep…???</p>
<p>linux下一个进程共享一个alarm闹钟定时器，然而服务器肯定是多用户的，我们肯定得想方法给每个客户整一个定时器</p>
<p>也就是接下来要介绍的升序时间链表，除此之外还有时间轮，时间最小堆等更好的方法。</p>
<p>util_timer类代表着每一个节点，利用time()存储绝对时间,client_data是用户的数据<br/> util_timer.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_UTIL_TIMER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_UTIL_TIMER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token keyword">class</span> <span class="token class-name">client_data</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    time_t expire<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>cb_func<span class="token punctuation">)</span><span class="token punctuation">(</span>client_data<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client_data<span class="token operator">*</span>user_data<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>prev<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_UTIL_TIMER_H</span>

</code></pre>
<p>util_timer.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

```cpp
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>

util_timer<span class="token operator">::</span><span class="token function">util_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">prev</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre>
<p>这个客户类中也会有一个util_timer指针可以说是客户信息类和时间节点类相互捆绑了<br/> client_data.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_CLIENT_DATA_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_CLIENT_DATA_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE 64</span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">tw_timer</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">heap_timer</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> client_data <span class="token punctuation">{<!-- --></span>
    sockaddr_in address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//        tw_timer *timer;</span>
        util_timer <span class="token operator">*</span>timer<span class="token punctuation">;</span>
<span class="token comment">//        heap_timer*timer3;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_CLIENT_DATA_H</span>
</code></pre>
<p>链表类<br/> sort_timer_lst.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> TEST2_SORT_TIMER_LST_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TEST2_SORT_TIMER_LST_H</span>

<span class="token keyword">class</span> <span class="token class-name">util_timer</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">sort_timer_lst</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer<span class="token operator">*</span>timer<span class="token punctuation">,</span>util_timer<span class="token operator">*</span>lst_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>head<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tail<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//TEST2_SORT_TIMER_LST_H</span>

</code></pre>
<p>sort_timer_lst.cpp</p>
<pre><code class="prism language-c"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sort_timer_lst.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>

sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">head</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tail</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">sort_timer_lst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        delete tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * 如果没头节点，则将这个节点作为头节点*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> tail <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * 如果该节点的时间大小比头节点时间小那么修改这个节点为新的头节点*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> head<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
     * 否则用重载函数添加到链表中地一个比它大的节点的前面查找的范围
     * 第二个参数是可以缩小
     * */</span>

    <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 修改某个节点时间
 * 需要调整这个节点到相应的位置*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    util_timer <span class="token operator">*</span>tmp <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token comment">//如果时间小于下一个节点那没事此节点不用换位置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp <span class="token operator">||</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire <span class="token operator">&lt;</span> tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//否则如果若这个节点是头节点则更改头节点为下一个节点并插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//删并插入</span>
        timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        <span class="token comment">//插</span>
        <span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">del_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        delete timer<span class="token punctuation">;</span>
        head <span class="token operator">=</span> tail <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        head <span class="token operator">=</span> head<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        delete timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">==</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tail <span class="token operator">=</span> tail<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
        tail<span class="token operator">-&gt;</span>next <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        delete timer<span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    timer<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    timer<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> timer<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
    delete timer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * 这个升序时间链表的关键就是这个tick 比较是比当前时间(使用绝对时间比较)早的所有节点并执行他们的回调函数cb_func
 * 比如可以让客户超时退出*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timer tick\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    time_t cur <span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tmp <span class="token operator">=</span>head<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token operator">&lt;</span>tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tmp<span class="token operator">-&gt;</span><span class="token function">cb_func</span><span class="token punctuation">(</span>tmp<span class="token operator">-&gt;</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        head <span class="token operator">=</span> tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            head<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        delete tmp<span class="token punctuation">;</span>
        tmp <span class="token operator">=</span>head <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * 调整新位置
*/</span>
<span class="token keyword">void</span> sort_timer_lst<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add_timer</span><span class="token punctuation">(</span>util_timer <span class="token operator">*</span>timer<span class="token punctuation">,</span> util_timer <span class="token operator">*</span>lst_head<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    util_timer<span class="token operator">*</span>prev<span class="token operator">=</span>lst_head<span class="token punctuation">;</span>
    util_timer<span class="token operator">*</span>tmp<span class="token operator">=</span>prev<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token operator">-&gt;</span>expire<span class="token operator">&lt;</span>tmp<span class="token operator">-&gt;</span>expire<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            prev<span class="token operator">-&gt;</span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>next<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
            tmp<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>timer<span class="token punctuation">;</span>
            timer<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        prev<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
        tmp<span class="token operator">=</span>tmp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tmp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        prev<span class="token operator">-&gt;</span>next<span class="token operator">=</span>timer<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>prev<span class="token operator">=</span>prev<span class="token punctuation">;</span>
        timer<span class="token operator">-&gt;</span>next<span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
        tail<span class="token operator">=</span>timer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>用升序链表实现的关闭非活跃客户连接</p>
<p>Handleinactiveconnections.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/25.</span>
<span class="token comment">//</span>

<span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/22.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;assert.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;libgen.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token comment">//#include "MyHeadFile.h"</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sort_timer_lst.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util_timer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"client_data.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> FD_LIMIT 65535</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENT_NUMBER 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TIMESLOT 5</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> pipefd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> sort_timer_lst timerLst<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/*
*设置文件描述符非阻塞
*/</span>
<span class="token keyword">int</span> <span class="token function">setnonblocking</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> old_option <span class="token operator">=</span> <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_GETFL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> new_option <span class="token operator">=</span> old_option <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>
    <span class="token function">fcntl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> F_SETFL<span class="token punctuation">,</span> new_option<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> old_option<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
epoll ET监听
*/</span>
<span class="token keyword">void</span> <span class="token function">addfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> epollfd<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    epoll_event event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN <span class="token operator">|</span> EPOLLET<span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
信号处理函数，通过管道发生给主函数处理（epoll_wait），统一事件源，也就是将信号的处理和普通套接字或者别的文件描述符统一用epoll_wait来同步，
*/</span>
<span class="token keyword">void</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> save_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> msg <span class="token operator">=</span> sig<span class="token punctuation">;</span>
    <span class="token function">send</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errno <span class="token operator">=</span> save_errno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
添加信号
*/</span>
<span class="token keyword">void</span> <span class="token function">addsig</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> sigaction sa<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> sig_handler<span class="token punctuation">;</span>
    sa<span class="token punctuation">.</span>sa_flags <span class="token operator">|</span><span class="token operator">=</span> SA_RESTART<span class="token punctuation">;</span>
    <span class="token function">sigfillset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">.</span>sa_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">sigaction</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sa<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
回调函数：关闭连接
*/</span>
<span class="token keyword">void</span> <span class="token function">cb_func</span><span class="token punctuation">(</span>client_data <span class="token operator">*</span>user_data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">assert</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close fd %d\n"</span><span class="token punctuation">,</span> user_data<span class="token operator">-</span><span class="token operator">&gt;</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*这个函数每次epoll_wait轮完一轮就用一次，调用tick将超时的用户清理，并重新定时*/</span>
<span class="token keyword">void</span> <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    timerLst<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    timerLst.tick();</span>
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usage: %s ip_address port_number \n"</span><span class="token punctuation">,</span> <span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>ip <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_in address<span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    address<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>listenfd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> op <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>op<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    epoll_event events<span class="token punctuation">[</span>MAX_EVENT_NUMBER<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> epollfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>epollfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">socketpair</span><span class="token punctuation">(</span>PF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setnonblocking</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
前面的都不说，就是基本的建立连接，从这里开始添加SIGALRM信号
*/</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGALRM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addsig</span><span class="token punctuation">(</span>SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> stop_server <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*动态分配用户数组*/</span>
    client_data <span class="token operator">*</span>users <span class="token operator">=</span> <span class="token keyword">new</span> client_data<span class="token punctuation">[</span>FD_LIMIT<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*启动闹钟 ，5秒后会响
	如果epoll_wait上没有客户发来消息或者其他事件以结束epoll_wait的阻塞，这个alarm会唤醒epoll_wait
	可以试着打印下面epoll_wait的返回值，如果客户端不发数据，你可以看到-1，1交替出现的现象，而这个现象出现的原因是
	第一次alarm将epoll_wait打断，并触发信号函数，epoll会接受到管道来的数据，在下一轮epoll_wait反映出来。
*/</span>
    
    <span class="token function">alarm</span><span class="token punctuation">(</span>TIMESLOT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop_server<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> MAX_EVENT_NUMBER<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"epoll failure\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> number<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> sockfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">struct</span> sockaddr_in client_address<span class="token punctuation">;</span>
                socklen_t client_addrlength <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>client_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addrlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">addfd</span><span class="token punctuation">(</span>epollfd<span class="token punctuation">,</span> connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>address <span class="token operator">=</span> client_address<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>sockfd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
            
              	<span class="token comment">/*
              	连接上来的套接字绑定一个时间节点，这个时间按节点的超时时间在当前时间按+3*TIMEOUT之后*/</span>
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> util_timer<span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>user_data <span class="token operator">=</span> <span class="token operator">&amp;</span>users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>cb_func <span class="token operator">=</span> cb_func<span class="token punctuation">;</span>
                time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                timer<span class="token operator">-</span><span class="token operator">&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
                users<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
                timerLst<span class="token punctuation">.</span><span class="token function">add_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">==</span> pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">/*
        	若接受到是信号函数触发而从管道发送过来的信息*/</span>
                <span class="token keyword">int</span> sig<span class="token punctuation">;</span>
                <span class="token keyword">char</span> signals<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> signals<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>signals<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ret<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">case</span> SIGALRM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                           	<span class="token comment">/*将timeout设置成true,之后会tick检查链表上全部的超时事件
                           	*/</span>
                                timeout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">case</span> SIGTERM<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                stop_server <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">memset</span><span class="token punctuation">(</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token string">'\0'</span><span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> BUFFER_SIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get %d bytes of client data %s from %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">,</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span> sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                util_timer <span class="token operator">*</span>timer <span class="token operator">=</span> users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>timer<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> EAGAIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                timerLst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                            timeWheel.del_timer(timer);</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">cb_func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>users<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//                        timeWheel.del_timer(timer);</span>
                            timerLst<span class="token punctuation">.</span><span class="token function">del_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*如果客户发来信息了，那么修改超时时间，并修改链表上时间节点的位置*/</span>
                        time_t cur <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            timer<span class="token operator">-</span><span class="token operator">&gt;</span>expire <span class="token operator">=</span> cur <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> TIMESLOT<span class="token punctuation">;</span>
<span class="token comment">//                        timeWheel.adjust_timer(timer,/*cur +*/ 3 * TIMESLOT);</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"adjust timer once\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            timerLst<span class="token punctuation">.</span><span class="token function">adjust_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*调用tick，重新设置闹钟时间*/</span>
        
            <span class="token function">timer_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>pipefd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span>users<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>g++和用telnet模拟客户端一下可以看到：每5秒一次的tick在发送4次以后服务器关闭了连接（虽然设置了超时时间是3×5秒，但是与客户建立连接的时候都会是调用alarm中前或之后一段时间，因此会多触发一次）<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200725220641909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> 而客户端发送了一条sad消息之后socket的关闭时间重置，过一段时间不发消息也被关了</img></p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200725220609511.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> 时间升序链表缺点：添加时间节点的效率低，遍历查找复杂度 O（n）<br/> 但说实话，书上的这个c++代码太c了一点，之后用到了再改进吧！</img></p>
<p>定时器之时间轮，下回分解…</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>主程序<br/> RussiaBlock.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/18.</span>
<span class="token comment">//</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Table.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hierarchical_mutex.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"fstream"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">thread_local</span> <span class="token keyword">uint64_t</span>
        hierarchical_mutex<span class="token operator">::</span>this_thread_hierarchical_value <span class="token operator">=</span> ULONG_MAX<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>level <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"./a.out number "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//全局变量</span>
    <span class="token keyword">static</span> Table <span class="token function">tab</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//构造一个15,20的棋盘</span>
    <span class="token keyword">static</span> Block bl<span class="token punctuation">;</span>      <span class="token comment">//构造一个落下方块</span>
    hierarchical_mutex <span class="token function">table_mtx</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hierarchical_mutex <span class="token function">mtx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    thread <span class="token function">getkey</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> termios saveterm<span class="token punctuation">,</span> nt<span class="token punctuation">;</span>
        fd_set rfds<span class="token punctuation">,</span> rs<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> timeval tv<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> q<span class="token punctuation">,</span> r<span class="token punctuation">,</span> fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//标准输入</span>
        <span class="token function">tcgetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nt <span class="token operator">=</span> saveterm<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ECHO<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ISIG<span class="token punctuation">;</span>
        nt<span class="token punctuation">.</span>c_lflag <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>ICANON<span class="token punctuation">;</span>
        <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">FD_SET</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
            r <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rfds<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">write</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"select error.\n"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token string">"select error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            rfds <span class="token operator">=</span> rs<span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//上下左右</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token string">'A'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//旋转</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bl<span class="token punctuation">.</span><span class="token function">get_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">rotate_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'B'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//向下（加速）</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'C'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">/*向右*/</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">case</span> <span class="token string">'D'</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//左</span>
                    tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>RIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">113</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">tcsetattr</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"game over"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token function">tcsetattr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> TCSANOW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>saveterm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread <span class="token function">printloop</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"clear"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this_thread<span class="token operator">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">::</span>chrono<span class="token operator">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">200</span> <span class="token operator">/</span> tab<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"任意键退出"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    getkey<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    printloop<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dir<span class="token punctuation">,</span> i<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//生成方块</span>
        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">table_lock</span><span class="token punctuation">(</span>table_mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        std::unique_lock&lt;std::mutex&gt;table_lock(table_mtx);</span>

        bl<span class="token punctuation">.</span><span class="token function">create_block</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tab<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断游戏是否结束</span>
        table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>hierarchical_mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">///行动按键判定</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            this_thread<span class="token operator">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>std<span class="token operator">::</span>chrono<span class="token operator">::</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">400</span> <span class="token operator">/</span> tab<span class="token punctuation">.</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/向下移动一格</span>
            table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">.</span><span class="token function">clr_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//清空上一次方块位置</span>
            bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//向下移动一步</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//是否触底</span>
                bl<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>Block<span class="token operator">::</span>UP<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//如果触底，还原触底前位置</span>
                tab<span class="token punctuation">.</span><span class="token function">set_block</span><span class="token punctuation">(</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果满行则消行</span>
        table_lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tab<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span><span class="token function">if_full</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//是否满行</span>
                tab<span class="token punctuation">.</span><span class="token function">clr_line</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//如果是，消行</span>
                tab<span class="token punctuation">.</span><span class="token function">move_line</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将所消行的上面的棋盘信息下移</span>
                i<span class="token operator">--</span><span class="token punctuation">;</span>      <span class="token comment">//下移后，重新检查这一行是否满（可能出现几行同时消去）</span>
                tab<span class="token punctuation">.</span><span class="token function">set_count</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//记录得分</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        table_lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>grid.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_GRID_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_GRID_H</span>

<span class="token keyword">struct</span> grid <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span>

    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span>grid<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token keyword">noexcept</span> <span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    grid<span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    grid<span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span> grid<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">//坐标</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_GRID_H</span>

</code></pre>
<p>grid.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"grid.h"</span></span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span>grid <span class="token operator">&amp;&amp;</span>rhs<span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token operator">~</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

grid<span class="token operator">::</span><span class="token function">grid</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">x</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

grid <span class="token operator">&amp;</span>grid<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> grid <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> rhs<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> rhs<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

grid <span class="token operator">&amp;</span>grid<span class="token operator">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>grid <span class="token operator">&amp;&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> rhs<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> rhs<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Block.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_BLOCK_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_BLOCK_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;termios.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;zconf.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"grid.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> BLOCK_SIZE 4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SLEEP_TIME 500</span>

<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;random&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Block</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">using</span> Action <span class="token operator">=</span>Block<span class="token operator">&amp;</span><span class="token punctuation">(</span>Block<span class="token operator">::</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> direct <span class="token punctuation">{<!-- --></span>
        UP<span class="token punctuation">,</span> DOWN<span class="token punctuation">,</span> LEFT<span class="token punctuation">,</span> RIGHT
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    grid g<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">Block</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">center</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">def_block</span><span class="token punctuation">(</span>grid g1<span class="token punctuation">,</span> grid g2<span class="token punctuation">,</span> grid g3<span class="token punctuation">,</span> grid g4<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> g1<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> g2<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> g3<span class="token punctuation">;</span>
        g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> g4<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//顺时针旋</span>
        <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> center<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            y <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> center<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> center<span class="token punctuation">.</span>x <span class="token operator">+</span> y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> center<span class="token punctuation">.</span>y <span class="token operator">-</span> x<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>y<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>y<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">left</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>x<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Block <span class="token operator">&amp;</span><span class="token function">right</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        center<span class="token punctuation">.</span>x<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">move</span><span class="token punctuation">(</span>direct dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token operator">*</span>Menu<span class="token punctuation">[</span>dir<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">void</span> <span class="token function">set_cen</span><span class="token punctuation">(</span>grid g<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        center <span class="token operator">=</span> g<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    grid <span class="token function">get_cen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token keyword">int</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        type <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">get_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">rotate_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//rotate的逆向</span>
        <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            x <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> center<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            y <span class="token operator">=</span> g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> center<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> center<span class="token punctuation">.</span>x <span class="token operator">+</span> y<span class="token punctuation">;</span>
            g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> center<span class="token punctuation">.</span>y <span class="token operator">-</span> x<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">create_block</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> ran<span class="token punctuation">;</span>
        grid g<span class="token punctuation">[</span>BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> std<span class="token operator">::</span>uniform_int_distribution<span class="token operator">&lt;</span><span class="token keyword">unsigned</span><span class="token operator">&gt;</span> <span class="token function">u</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> std<span class="token operator">::</span>default_random_engine <span class="token function">e</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ran <span class="token operator">=</span> <span class="token function">u</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>ran<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//反L</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//Z</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//反Z</span>
            <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//田</span>
            <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//1</span>
            <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
                <span class="token comment">//山</span>
            <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token function">set_cen</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">set_type</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"someThing err!"</span> <span class="token operator">&lt;&lt;</span> ran <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">def_block</span><span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> g<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">static</span> Action Menu<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    grid center<span class="token punctuation">;</span>
    <span class="token keyword">int</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_BLOCK_H</span>

</code></pre>
<p>Block.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>
Block<span class="token operator">::</span>Action Block<span class="token operator">::</span>Menu<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>up<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>down<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>left<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>Block<span class="token operator">::</span>right
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Table.cpp</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Table.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Block.h"</span></span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">set_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token comment">//比如下降之后 table[x][y]上有方块了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> x <span class="token operator">&gt;=</span> width <span class="token operator">||</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;=</span> height <span class="token operator">||</span> y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">clr_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        x <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        y <span class="token operator">=</span> bl<span class="token punctuation">.</span>g<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">clr_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> y <span class="token operator">&gt;=</span> height<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> height<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> width<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">if_full</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">get_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> table<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"clear"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
            <span class="token keyword">else</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"#"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
            <span class="token comment">//▣</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">13</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  等级："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  得分："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|  Press 'q' to quit!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"|"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> width <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"-"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>flush<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">move_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> y<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> table<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">set_count</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    count <span class="token operator">+</span><span class="token operator">=</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> Table<span class="token operator">::</span><span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Table<span class="token operator">::</span><span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Table<span class="token operator">::</span>level <span class="token operator">=</span> level<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>Table.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/17.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_TABLE_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_TABLE_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> TABLE_SIZE 20</span>
<span class="token keyword">class</span> <span class="token class-name">Block</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>

    <span class="token function">Table</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">height</span><span class="token punctuation">(</span>TABLE_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">level</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>             <span class="token comment">//构造棋盘</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">setLevel</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">Table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span><span class="token keyword">int</span> level<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">height</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">width</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> width<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">set_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//安设方块</span>
    <span class="token keyword">void</span> <span class="token function">clr_block</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block <span class="token operator">&amp;</span>bl<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//清除方块</span>
    <span class="token keyword">int</span> <span class="token function">clr_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//消行</span>

    <span class="token keyword">int</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

    <span class="token comment">//获取棋盘宽度</span>
    <span class="token keyword">int</span> <span class="token function">if_full</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//判定是否满行</span>
    <span class="token keyword">int</span> <span class="token function">get_table</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//获取棋盘上点信息</span>
    <span class="token keyword">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//绘制棋盘</span>
    <span class="token keyword">void</span> <span class="token function">move_line</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//整行下移</span>
    <span class="token keyword">void</span> <span class="token function">set_count</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//记录得分</span>
    <span class="token keyword">int</span> <span class="token function">get_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    <span class="token comment">//获取得分</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> table<span class="token punctuation">[</span>TABLE_SIZE<span class="token punctuation">]</span><span class="token punctuation">[</span>TABLE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//棋盘</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span> width<span class="token punctuation">;</span>        <span class="token comment">//棋盘的高和宽</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>            <span class="token comment">//得分</span>
    <span class="token keyword">int</span> level<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_TABLE_H</span>

</code></pre>
<p>hierarchical_mutex.h</p>
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by adl on 2020/7/18.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> UNTITLED_HIERARCHICAL_MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> UNTITLED_HIERARCHICAL_MUTEX_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;algorithm&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;exception&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;climits&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">hierarchical_mutex</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token operator">::</span>mutex internal_mutex<span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> <span class="token keyword">const</span> hierarchical_value<span class="token punctuation">;</span>
    <span class="token keyword">uint64_t</span> previous_value<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">thread_local</span> <span class="token keyword">uint64_t</span> this_thread_hierarchical_value<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>this_thread_hierarchical_value <span class="token operator">&lt;=</span> hierarchical_value<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">logic_error</span><span class="token punctuation">(</span><span class="token string">"mutex hierarchical violated."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        previous_value <span class="token operator">=</span> this_thread_hierarchical_value<span class="token punctuation">;</span>
        this_thread_hierarchical_value <span class="token operator">=</span> hierarchical_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">explicit</span> <span class="token function">hierarchical_mutex</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> value<span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token function">hierarchical_value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">previous_value</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        internal_mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        this_thread_hierarchical_value <span class="token operator">=</span> previous_value<span class="token punctuation">;</span>
        internal_mutex<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> <span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">check_for_hierarchy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>internal_mutex<span class="token punctuation">.</span><span class="token function">try_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">update_hierarchy_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">//UNTITLED_HIERARCHICAL_MUTEX_H</span>

</code></pre>
<ul><li>积累的经验：</li></ul>
<ol><li> <p>生成随机数的uniform_int_distribution，defualt_random_engine(time(0))使用时必须用static,缺点是多次执行程序的第一次生成的数字是一样的</p> </li><li> <p>与c++primer p743类似，使用成员指针函数表可以使用户调用的函数更加明了。</p> </li><li> <p>给互斥锁加权值，并以权值大小顺序加锁，可以保证线程加锁顺序一致，避免死锁（出现则抛出异常）（这个纯粹活学活用，因为c++锁和线程接触不多）</p> </li><li> <p><code>thread xxx([&amp;](){})</code>是可以放在函数内部的线程</p> </li><li> <p>利用select监控标准输入</p> </li><li> <p>利用tcgetattr,tcsetaddr，termiosi结构体<br/> <code>nt.c_lflag &amp;= ~ECHO; nt.c_lflag &amp;= ~ISIG; nt.c_lflag &amp;= ~ICANON;</code><br/> 可以在linux关闭回显，实现getch</p> </li><li> <p><code>this_thread::sleep_for(std::chrono::milliseconds(400 / tab.getLevel()));</code>可以咋线程中实现毫秒级别睡眠</p> </li><li> <p>类中静态对象初始化可以写在其对应.cpp文件中</p> </li></ol>
<ul><li>反思：</li></ul>
<ol><li>未使用类的继承，各种方块理论可以写成子类，因为主线程一开始直接使用了Block对象，后期不容易修改.</li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p><a href="https://blog.csdn.net/qingfengleerge/article/details/85261316">MySQL C API 使用（基本函数）</a><br/> <a href="https://www.liaoxuefeng.com/wiki/1177760294764384/1179611432985088">liaoxuefeng SQL</a><br/> 了解了以上基础知识，去包装一些函数用来给c使用</p>
<p>accept_mysql 用来连接数据库</p>
<pre><code class="prism language-c">MYSQL   <span class="token function">accept_mysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    MYSQL   mysql<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span><span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_init err"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mysql_library_init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_init err"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token string">"root"</span><span class="token punctuation">,</span><span class="token string">"sss"</span><span class="token punctuation">,</span><span class="token string">"chatroom"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_real_connect"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mysql_set_character_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">,</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">err_sys</span><span class="token punctuation">(</span><span class="token string">"mysql_set_character_set"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"连接数据库成功\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  mysql<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>close_mysql(关闭数据库)</p>
<pre><code class="prism language-c">
<span class="token keyword">int</span> <span class="token function">close_mysql</span><span class="token punctuation">(</span>MYSQL   mysql<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mysql_library_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>use_mysql<br/> return 1 代表没数据<br/> return -1 代表mysql语句出错<br/> (用于查询数据库或者修改数据库中的数据，但这个函数的缺点select是只能打印，不能传出单个数据)</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">use_mysql</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>string<span class="token punctuation">,</span>MYSQL mysql<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span>    <span class="token keyword">int</span> num_fields<span class="token punctuation">,</span>num_rows<span class="token punctuation">;</span>
    MYSQL mysql_temp<span class="token operator">=</span>mysql<span class="token punctuation">;</span>
    MYSQL_RES  <span class="token operator">*</span>result<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    MYSQL_ROW       row<span class="token punctuation">;</span>
    MYSQL_FIELD <span class="token operator">*</span>field<span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        result  <span class="token operator">=</span>   <span class="token function">mysql_store_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            num_rows<span class="token operator">=</span><span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num_rows<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>        
            num_fields  <span class="token operator">=</span><span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>field<span class="token operator">=</span><span class="token function">mysql_fetch_field</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-20s"</span><span class="token punctuation">,</span>field<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_fields<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-20s"</span><span class="token punctuation">,</span>row<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"query err\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>而如果想要得到select 的每一个数据，我采取的方法是开辟动态内存，但坏处是调用此函数之后要手动free，会很繁琐,而且内存开辟的位置得在函数里面，因为无法确定有多少行结果，同时只有函数返回0或者返回-2的时候要free。调用函数的时候需要if判断。<br/> 调用方式</p>
<pre><code class="prism language-c">mysqlMsg<span class="token operator">*</span>mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span>x<span class="token punctuation">,</span><span class="token operator">&amp;</span>mmsglist<span class="token punctuation">,</span>mMum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mmsglist<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">free</span><span class="token punctuation">(</span>mmsglist<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mmsglist<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">free</span><span class="token punctuation">(</span>mmsglist<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mmsglist<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
<p>（如果大家有什么更好的方法可以教教我）</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>MYSQL mysql<span class="token punctuation">,</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span>mysqlMsg<span class="token operator">*</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span>    <span class="token keyword">int</span> num_fields<span class="token punctuation">,</span>num_rows<span class="token punctuation">;</span>
    MYSQL mysql_temp<span class="token operator">=</span>mysql<span class="token punctuation">;</span>
    MYSQL_RES  <span class="token operator">*</span>result<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    MYSQL_ROW       row<span class="token punctuation">;</span>
    MYSQL_FIELD <span class="token operator">*</span>field<span class="token punctuation">;</span>
    <span class="token keyword">char</span> table<span class="token punctuation">[</span>MYSQL_TABLE_LEN<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"message"</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> mysql_order<span class="token punctuation">[</span>MYSQL_ORDER_MAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>mNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token function">snprintf</span><span class="token punctuation">(</span>mysql_order<span class="token punctuation">,</span>MYSQL_ORDER_MAXLEN<span class="token punctuation">,</span><span class="token string">" select id,uid,type,sid,msg,status,flag from %s \
        where uid ='%d' \
        "</span><span class="token punctuation">,</span>table<span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret<span class="token operator">=</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">,</span>mysql_order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        result  <span class="token operator">=</span>   <span class="token function">mysql_store_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysql_temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// num_fields  =mysql_num_fields(result);        </span>
            num_rows<span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num_rows<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>        
            <span class="token operator">*</span>mNum<span class="token operator">=</span>num_rows<span class="token punctuation">;</span>
            <span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token operator">!</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"出现 NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    
                    <span class="token keyword">return</span>  <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// (*(mMsgList)+i)-&gt;recv_id=uid;</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
             <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"???query   fail\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<hr/>
<p>聊天室里经常用到的mysql语句<br/> 增删改查<br/> <code>insert into xxx(name,xxxx,xx)values(xx,xxx,xxxx);</code><br/> <code>delete from xxx where x=y;</code><br/> <code>update xxx set x1=y1,x2=y2</code><br/> <code>select xxx from xx where x= y;</code></p>
<p>create table<br/> AUTO_INCREMENT 自增<br/> ENGINE=InnoDB 引擎<br/> PRIMARY KEY (<code>id</code>) 主键</p>
<p>NOT NULL 的意义（《mysql必知必会》）</p>
<blockquote>
<p>不允许 NULL 值的列不接受该列没有值的行,<br/> 换句话说,在插入或更新行时,该列必须有值。</p>
</blockquote>
<pre><code class="prism language-c"><span class="token function">use_mysql</span><span class="token punctuation">(</span>"create table <span class="token function">account</span><span class="token punctuation">(</span>\
    id BIGINT NOT <span class="token constant">NULL</span> AUTO_INCREMENT<span class="token punctuation">,</span>\
    姓名 <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT <span class="token constant">NULL</span> <span class="token punctuation">,</span>\
    帐号 <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> NOT <span class="token constant">NULL</span> UNIQUE<span class="token punctuation">,</span>\
    PRIMARY KEY <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span>\
    <span class="token punctuation">)</span>ENGINE<span class="token operator">=</span>InnoDB 
          AUTO_INCREMENT<span class="token operator">=</span><span class="token number">1</span>
           DEFAULT CHARSET<span class="token operator">=</span>utf8"<span class="token punctuation">,</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr/>
<hr/>
<p>在c++中mysql封装成类的确会方便很多,同时它分成了 mysql_noResult_query<br/> ，mysql_select_query，mysql_select_SingleLine_query（这个并不必要）三种方式，因为vector,map容器动态扩容的特点，也就不需要上述c版本麻烦的动态内存。</p>
<pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">mysql_db</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">/*
        mysql_open()
        return : 1 OK
                -1 失败
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> user<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> password<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> database<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_noResult_query();
        非select语句查询
        return &gt;0 成功, 为受影响的行数
               -1 失败
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_noResult_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_select_query();
        有结果集的查询
        return &gt;0 ok 返回结果集条数
               -1 失败
        map_results first = 行 second = values
        */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_select_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql<span class="token punctuation">,</span> map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span> map_results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_select_SingleLine_query();
        只有一条数据 , 或者只有一个字段 N 条的查询. 直接调用vector即可
     */</span>
    <span class="token keyword">int</span> <span class="token function">mysql_select_SingleLine_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> v_results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        mysql_lasterror();
        返回最近一次错误信息
     */</span>
    string <span class="token function">mysql_lasterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    MYSQL sqlCon<span class="token punctuation">;</span>
    MYSQL_RES <span class="token operator">*</span>m_pResult<span class="token punctuation">;</span>
    MYSQL_ROW  m_Row<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre>
<pre><code class="prism language-cpp">
mysql_db<span class="token operator">::</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// mysql 初始化</span>
<span class="token punctuation">}</span>

mysql_db<span class="token operator">::</span><span class="token operator">~</span><span class="token function">mysql_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">mysql_close</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭连接</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>user<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>password<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>database<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> nvalue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">mysql_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> MYSQL_OPT_RECONNECT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>nvalue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 断线自动重连</span>
    <span class="token function">mysql_options</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> MYSQL_SET_CHARSET_NAME<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">mysql_real_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> host<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> database<span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_noResult_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">mysql_affected_rows</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_select_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> map<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;&gt;</span> <span class="token operator">&amp;</span>map_results<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_pResult <span class="token operator">=</span> <span class="token function">mysql_use_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>m_Row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>vVal<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                vVal<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                vVal<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        map_results<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>vVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> mysql_db<span class="token operator">::</span><span class="token function">mysql_select_SingleLine_query</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>v_results<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">,</span> sql<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>m_pResult <span class="token operator">=</span> <span class="token function">mysql_use_result</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>m_Row<span class="token operator">=</span><span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            v_results<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m_Row<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mysql_free_result</span><span class="token punctuation">(</span>m_pResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

string mysql_db<span class="token operator">::</span><span class="token function">mysql_lasterror</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">mysql_error</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sqlCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>关于表怎么设计，我认为聊天室中的我设计的很不好，9张表，由于我的姓名放在account表，我就没去设计如何换姓名。由于密保放在了account表导致群帐号必须重新建表，而不是和人帐号放一起，还得分出文件表和群文件表这导致了程序更加繁琐。<br/> fri_mask表使用来屏蔽好友消息的不知道是不有点鸡肋。。。</p>
<p>虽说第一次设计的不好，但至少程序能跑，而且有了经验，下次就没这么难了。</p>
<p><img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501414.png"><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501416.png"><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501412.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501373.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20200711151501372.png"/></img></img></img></img></img></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>AVL树呢，是平衡树中一个非常经典的例子。因为普通的查找树在插入和删除的过程有可能会产生树的一端子树高度比另一边大很多的情况，也就是所谓的退化为链表（查找是一个一个节点去找），降低了查找的效率。</p>
<p>AVL平衡树通过一系列旋转的方式让左子树和右子树的高度相差不大（&lt;=1），这样搜索的效率将会维持在较好的水平。</p>
<p>方法就是当插入一个节点之后，<br/> 更新父节点的高度，判断父节点的左右子树高度差是否为2,若是，进行相应旋转操作（4种）来降低左右子树高度差。若不是，判断父节点的父的左右子树高度差是否为2，以此类推，直到根节点（当然是递归中完成）。</p>
<p>单左旋，单右旋，左右旋，右左旋就是将3个节点间调整次序来，代码如下，具体样子就不画图了，在这些点调节次序的过程中，我们可以发现搜索树节点大小顺序还是正常排列的。<br/> 也就是中序遍历的结果还是1234567这样从小到大排列。<br/> avl_tree.h</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _Avltree_h</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _Avltree_h</span>
<span class="token macro property">#<span class="token directive keyword">define</span> Max(a,b) ((a)&gt;(b)?(a):(b))</span>

<span class="token keyword">struct</span> AvlNode<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> AvlNode<span class="token operator">*</span>Position<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> AvlNode<span class="token operator">*</span>AvlTree<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> ElementType <span class="token punctuation">;</span>
Position    <span class="token function">Find</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
Position    <span class="token function">FindMin</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
Position    <span class="token function">FindMax</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvlTree <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
AvlTree <span class="token function">Insert</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">InOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">PostOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PreOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">InOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">PostOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> AvlNode
<span class="token punctuation">{<!-- --></span>
    ElementType Element<span class="token punctuation">;</span>
    AvlTree Left<span class="token punctuation">;</span>
    AvlTree Right<span class="token punctuation">;</span>
    <span class="token keyword">int</span> Height<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


</code></pre>
<p>avl_tree.c</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"avl_tree.h"</span></span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> Height <span class="token punctuation">(</span>Position P<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// puts("右旋");</span>

    Position    K1<span class="token punctuation">;</span>
    K1<span class="token operator">=</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>K1<span class="token operator">-&gt;</span>Right<span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Right<span class="token operator">=</span>K2<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span>K2<span class="token operator">-&gt;</span>Height<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  K1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//puts("左右");</span>

    K3<span class="token operator">-&gt;</span>Left<span class="token operator">=</span><span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>K3<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>Position K2<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 
        1
    0       2   k2
                4   k1 
                    5
        1
    0       4  k1
            2   5
     */</span>
    <span class="token comment">// puts("单左旋");</span>
    Position    K1<span class="token punctuation">;</span>
    K1<span class="token operator">=</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Right<span class="token operator">=</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>K2<span class="token punctuation">;</span>
    K2<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>K2<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    K1<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>K1<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span>K2<span class="token operator">-&gt;</span>Height<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  K1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span>  Position    <span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>Position   K3<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// puts("右左");</span>
<span class="token comment">/*     
    //120534
    1                                                       1                                   1               
0        2       k3       --》                   0       2       --》       0           3
            5      k3-&gt;right                                3                           2       5   
        3                                                                 5     
                
 */</span>     
  K3<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>K3<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  <span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>K3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">InOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PostOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">InOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">PostOrder_2</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> retSize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> retSize2<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        retSize<span class="token operator">=</span><span class="token function">PostOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        retSize2<span class="token operator">=</span><span class="token function">PostOrder_2</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">,</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> depth<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d(%d)\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token operator">+</span>retSize<span class="token operator">+</span>retSize2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>  retSize2<span class="token operator">+</span>retSize<span class="token operator">+</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">PreOrder</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

AvlTree  <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//后序</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> Height <span class="token punctuation">(</span>Position P<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>P<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> 
        <span class="token keyword">return</span>  P<span class="token operator">-&gt;</span>Height<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Position    <span class="token function">Find</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token function">Find</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
        <span class="token keyword">return</span>  <span class="token function">Find</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>    
        <span class="token keyword">return</span>  T<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

AvlTree <span class="token function">Insert</span><span class="token punctuation">(</span>ElementType X<span class="token punctuation">,</span>AvlTree T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        T<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> AvlNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Out of space"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            T<span class="token operator">-&gt;</span>Element<span class="token operator">=</span>X<span class="token punctuation">;</span>
            T<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            T<span class="token operator">-&gt;</span>Left<span class="token operator">=</span>T<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//放在左（递归）</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// printf("%d&lt;%d\n",X,T-&gt;Element);</span>
        T<span class="token operator">-&gt;</span>Left<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment">//左左-&gt;单右旋</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&lt;</span>T<span class="token operator">-&gt;</span>Left<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span>
                T<span class="token operator">=</span><span class="token function">SingleRotateWithLeft</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//左右-&gt;双右左旋</span>
            <span class="token keyword">else</span> 
                T<span class="token operator">=</span><span class="token function">DoubleRotateWithLeft</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        T<span class="token operator">-&gt;</span>Right<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>X<span class="token operator">&gt;</span>T<span class="token operator">-&gt;</span>Right<span class="token operator">-&gt;</span>Element<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                T<span class="token operator">=</span><span class="token function">SingleRotateWithRight</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    T<span class="token operator">=</span><span class="token function">DoubleRotateWithRight</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    T<span class="token operator">-&gt;</span>Height<span class="token operator">=</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Left<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">Height</span><span class="token punctuation">(</span>T<span class="token operator">-&gt;</span>Right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>  T<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>自己写的新遍历函数，可以打印出先序遍历( PreOrder_2)，中序遍历(INOrder_2)，后序遍历( PostOrder_2)的效果</p>
<ul><li>先序遍历:中左右 （维护深度，子节点从父节点继承）</li><li>中序遍历:左中右 从小到大</li><li>后序遍历:左右中（维护高度，父节点从子节点获取） （可用于统计目录的大小，子文件的大小相加再加到目录中）这里我就直接用数字代表节点的权值来代替文件大小，并合并到父节点中。</li></ul>
<p>(我觉得中序打印出来的最像树)</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"avl_tree.h"</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AvlTree T<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// int X=1;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=0;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=2;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=5;</span>
    <span class="token comment">// T=Insert(X,T);</span>
    <span class="token comment">// X=3;</span>
    <span class="token comment">// T=Insert(X,T);</span>

    <span class="token comment">/* 
    
        1                      1                                1
    0   2               0       2                   0           3
            5                           3                       2       5
          3                                   5
    
     */</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        T<span class="token operator">=</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// if(Find(3,T)-&gt;Right){<!-- --></span>
    <span class="token comment">//     printf("r%d\n",Find(3,T)-&gt;Right-&gt;Element);</span>
    <span class="token comment">// }</span>
    <span class="token comment">// if(Find(3,T)-&gt;Left){<!-- --></span>
    <span class="token comment">//     printf("l%d\n",Find(3,T)-&gt;Left-&gt;Element);</span>
    <span class="token comment">// }</span>
    
     <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"先"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PreOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"中"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PostOrder</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// puts("后2");</span>
    <span class="token comment">// PostOrder_2(T,0);</span>
    <span class="token comment">// PreOrder_2(T,0);</span>
    <span class="token function">InOrder_2</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MakeEmpty</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-shell">先
4
2
1
3
8
6
5
7
9
10
--------------------------
中
1
2
3
4
5
6
7
8
9
10
--------------------------
后
1
3
2
5
7
6
10
9
8
4
--------------------------
先
4
        2
                1
                3
        8
                6
                        5
                        7
                9
                        10
--------------------------
中
                1
        2
                3
4
                        5
                6
                        7
        8
                9
                        10
--------------------------
后
                1<span class="token punctuation">(</span>1<span class="token punctuation">)</span>
                3<span class="token punctuation">(</span>3<span class="token punctuation">)</span>
        2<span class="token punctuation">(</span>6<span class="token punctuation">)</span>
                        5<span class="token punctuation">(</span>5<span class="token punctuation">)</span>
                        7<span class="token punctuation">(</span>7<span class="token punctuation">)</span>
                6<span class="token punctuation">(</span>18<span class="token punctuation">)</span>
                        10<span class="token punctuation">(</span>10<span class="token punctuation">)</span>
                9<span class="token punctuation">(</span>19<span class="token punctuation">)</span>
        8<span class="token punctuation">(</span>45<span class="token punctuation">)</span>
4<span class="token punctuation">(</span>55<span class="token punctuation">)</span>
--------------------------
</code></pre>
<p>本文并没有做过多的讲解，也就是带大家看一下AVL的效果。<br/> 本来如果插入123456789 10可以想象树会一路长到什么地步。<br/> 至于旋转的四种函数，还是自己慢慢悟，自己悟出来永远比看别人博客有用。</p>
<p>吐槽一句当年发明这些算法的人真比我们强了太多。</p>
<p>参考《数据结构与算法 C语言描述》</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>展示一下二进制文件内部是什么：<br/> 本质上就是一个个字符。通过一定的文件格式，标准（我觉得就像一些程序）写入到文件中，我们可以通过系统软件去解读它（就像序列化和反序列化）</p>
<ul><li>可执行文件ELF格式（至于ELF究竟是什么，去翻《程序员的自我修养》吧，书上极其详细，而我觉得我这部分看过来却只是一知半解）<br/> <img alt="a.out" src="https://img-blog.csdnimg.cn/20200522233155978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> 图片：pdf<br/> <img alt="pdf" src="https://img-blog.csdnimg.cn/20200522233228480.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/></img></li></ul>
<p>视频：mp4</p>
<p><img alt="mp4" src="https://img-blog.csdnimg.cn/20200522233417210.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"><br/> <code>int fd=open("a.txt",O_RDONLY);</code><br/> <code>int fd2=open("b.txt",O_WRONLY|O_APPEND);</code><br/> <code>read(fd,buf,BUFSIZE);</code><br/> <code>strcpy(buf2,buf);</code><br/> <code>write(fd2,buf2,BUFSIZE);</code><br/> 如果我们用这样一段代码去复制二进制文件，得到的文件是错误的。<br/> 但原因是什么呢？</img></p>
<p>我收获到的经验是如果想要用buf去复制整个文件，在复制的过程中万万要小心。<br/> 这些乱码啊是可能包含’\0’这个空字符的，这意味着我们如果使用strcpy这种通过判断是否到’\0’去复制字符串的函数,是有可能（基本上就会）丢失掉文件一部分的信息。使用memcpy，它是一个字节一个字节复制。就可以避免信息丢失。</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>今天被几个段错误，栈溢出，free不正确的指针的错误搞得精力憔悴。</p>
<p>之前对于多级指针+函数参数运用始终有点迷糊，今天果真栽这好几个跟头。</p>
<p>这里呢就是想从mysql中提取出几个具有相同条件的数据，一行一行填进去就行了…<br/> 定义一个mysqlMsg*cur=NULL;再用&amp;cur传入到下面的函数中为cur动态分配内存空间。</p>
<p>但是我开始使用这块内存是很理所当然这样用的。</p>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">mysqlGetMsgByUid</span><span class="token punctuation">(</span>MYSQL mysql<span class="token punctuation">,</span><span class="token keyword">int</span> uid<span class="token punctuation">,</span>mysqlMsg<span class="token operator">*</span><span class="token operator">*</span>mMsgList<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
……
     <span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span>num_rows<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>mysqlMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">while</span><span class="token punctuation">(</span>……<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span>mMsgList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span>uid<span class="token punctuation">;</span>
              i<span class="token operator">++</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>  
……
<span class="token punctuation">}</span>
</code></pre>
<p>事实上mMsgList[i]这样相当于*(mMsgList+i),也就是越过了<code>i×num_rows*sizeof(mysqlMsg)</code>这么大的区间,i&gt;1时超过了我们分配的区间大小。<br/> 于是出现了如下的</p>
<pre><code class="prism language-shell">free<span class="token punctuation">(</span><span class="token punctuation">)</span>: invalid pointer
已放弃 <span class="token punctuation">(</span>核心已转储<span class="token punctuation">)</span>
</code></pre>
<p>那正确操作是什么呢？？？<br/> 二重指针先解引用，再偏移i个sizeof(mysqlMsg)再去赋值就没问题了。</p>
<pre><code class="prism language-c">     <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>type<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>send_id<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>message<span class="token punctuation">,</span>row<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>MYSQL_MSG_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>flag<span class="token operator">=</span><span class="token function">atoi</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>mMsgList<span class="token punctuation">)</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">-&gt;</span>recv_id<span class="token operator">=</span>uid<span class="token punctuation">;</span>
</code></pre>
<p>当然这是因为我是是为<code>*mMsgList</code>分配了内存空间，而不是mMsgList,不然之前那个写法是正确的</p>
<p>又如果是以栈区存储的如<code>char arglist[10][20]</code>这样作为函数参数的话，由于此参数真正意义上是char(*arglist)[20]的数组指针。那么arglist[i]也就代表着一个数组，向这块内存填数据是没有问题的，它并不会直接跨过一个二重数组。</p>
<p>啊，基础扎实很重要啊！</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>上个月初的myshell实现让人大费脑筋，在字符串处理和多重管道上出了不少差错，但好在最后还是实现了要求的功能。真的太懒了，把博客拖到现在～<br/> (之后还得补myls)</p>
<p>需求一个一个分析吧</p>
<h4><a id="%09_5"></a>实现管道 |</h4>
<p>这个的意思就是想要你把一个命令的输出当作输入交给后面一个命令。如ls -l | grep “a” |wc -c就是把ls -l的输出结果交给grep 处理,grep的处理结果交给wc处理。<br/> <strong>解决方案</strong>：fork+dup2(fd,0)+exec重定向输出到一个文件/tmp/file1中，fork+dup(fd,1)+exec再将这个文件temp/file1中当作输入。(其实应该用管道更好，但这里就照着书上的方式写了)</p>
<h4><a id="_____8"></a>实现输入输出重定向 &lt; &gt; &gt;&gt;</h4>
<ul><li>cat&lt;a.txt 就是将 &lt;后面的文件的内容给cat 当作标准输入。</li><li>ls &gt;a.txt 就是将 ls的输出覆盖写入a.txt中，也就是ls的标准输出给a.txt当标准输入</li><li>ls&gt;&gt;a.txt 就是将ls的输入结果加在a.txt结尾，也就是ls的标准输出给a.txt（APPEND模式打开）当标准输入。</li></ul>
<p><strong>解决方案</strong>：依旧是dup2</p>
<h4><a id="__15"></a>实现后台 &amp;</h4>
<ul><li>这里是书上所写的父进程wait(-1，NULL，WHOHANG)的非阻塞模式下父进程和子进程一起运行就"看上去"子进程在后台输出，其实这样算是父进程和子进程继续运行，然而的真正概念是后台程序会可能暂停。因为前台的程序肯定需要把握住终端的输入和输出，所以如果像ls这种写到终端的进程放在后台，它不应该同时输出在屏幕上，但是呢，还是有可能会写出来（可以使用sttytostop命令禁止），接着就是终端发送SIGTTOU信号,让会打印的程序暂停不去执行。同理需要标准输入的程序，则终端发送SIGTTIN信号,让需要写入的程序暂停不去执行。之后呢如果需要运行则是利用fg 命令，终端向程序发送sigcont,程序在前台继续运行。</li></ul>
<p>但我写在这的就是书上那个非阻塞的wait啦</p>
<h4><a id="cd_19"></a>实现内置cd</h4>
<p>嗯，就是chdir配上一些字符串操作。还或者需要下getcwd获取当前路径，目的是保存上次的路径用于"cd -","cd ~"则用下<code>pwd=getpwuid(getuid())再pwd-&gt;pw_name</code>获取用户名。这样就可cd到home下的用户家目录了。<br/> 至于什么cd需要内置，是因为如果也是fork+exec(cd)的话cd这个程序实现里面的chdir只对cd命令的工作目录有效，却无法改变原程序的工作目录。</p>
<h3><a id="_22"></a>实现信号屏蔽</h3>
<p>就暂时signal(SIGINT,SIG_IGN);<br/> 我觉得是不是忘了考虑SIGPIPE</p>
<h3><a id="_25"></a>实现多重管道</h3>
<p>因为不可以把一个文件同时当作输入端和输出端（会出错），此处使用了俩文件/tmp/file1,/tmp/file2轮流来读写。如ls|grep a|wc进程 就是在子进程执行ls前，将标准输出重定向到file1,父进程再在新子进程执行grep前标准输出重定向到file2,标准输入重定向到file1,接着父进程再在执行新子进程执行wc前标准输出重定向到file1，标准输入重定向到file1。除了第一个子进程是输入端仍然是标准输入和最后一个子进程输出端仍是标准输出，其余均使用文件的重定向，说实话这样交替着是有点呆滞，其实FIFO，pipe实现父子进程间通信会好一些(之后我试试去修正)</p>
<h3><a id="_27"></a>可以在任何地方运行</h3>
<p>就跟myls那里一样<br/> <a href="https://blog.csdn.net/adlatereturn/article/details/104864130">任何位置运行myls</a></p>
<h3><a id="tabhistory_30"></a>实现tab补全和内置history和光标移动</h3>
<p>使用readline库（需下载）<br/> <code>#include&lt;readline/readline.h&gt;</code><br/> <code>#include&lt;readline/history.h&gt;</code><br/> 参考博文：<a href="https://blog.csdn.net/xuancbm/article/details/81436681">readline1</a></p>
<p>（注：在读写history中有坑没处理好会死循环）<br/> read_history(NULL)这条函数只用执行一次，放在程序开头即可。<br/> 编译的时候需要加上　-lreadline<br/> 成果：<br/> <img alt="" src="https://img-blog.csdnimg.cn/20200510232724239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70#pic_center"><br/> 源码shell_head.h文件</img></p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> SHELL_HEAD_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SHELL_HEAD_H</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;readline/readline.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;readline/history.h&gt;</span></span>

<span class="token comment">// #include&lt;history.h&gt;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BAGIN  "\001\033[1m\002"</span><span class="token comment">//强调，加粗，高亮</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_END "\001\033[0m\002"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BKG_SEF(x,y) "\001\033["#x";"#y"m\002"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_BKG(x) "\001\033["#x"m\002"</span><span class="token comment">//x&lt;40-49&gt;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COLOR_SEF(x) "\001\033["#x"m\002"</span><span class="token comment">//x&lt;30-39&gt;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> DIRNAMESIZE 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ARGMAXLEN 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PIPE 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> INPUT 2</span>
<span class="token macro property">#<span class="token directive keyword">define</span> OUTPUT 4</span>
<span class="token macro property">#<span class="token directive keyword">define</span> APPPUT 8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BACKGROUND 16</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EXIT 32</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ARGMAXNUM 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILENAMESIZE 255</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SHOWPATH 1</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILE1 "/tmp/file1"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FILE2 "/tmp/file2"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> HISTORYFILE "historyfile"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> HISTORYMAXSIZE 1000</span>
<span class="token keyword">struct</span> history
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">get_prefix</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">find_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>  <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span>mode<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">back_check</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">s_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>s<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bool <span class="token function">search_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">execute_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">print_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">analysisArg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arg<span class="token punctuation">,</span><span class="token keyword">int</span> argcount<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>subExpression<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arglist<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span>argcnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">split_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> ch<span class="token punctuation">,</span><span class="token keyword">char</span> arglist<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">do_arg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">showdir</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>dirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">changdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>newDir<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>oldDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">format_blank</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">getHostname</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">printHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history <span class="token operator">*</span>htylist<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>historylen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setHistory</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">setHistory_2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre>
<p>myshell.c文件</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"shell_head.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">read_history</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signal</span><span class="token punctuation">(</span>SIGINT<span class="token punctuation">,</span>SIG_IGN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> oldDir<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>oldDir<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// char input_str[ARGMAXLEN];</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// print_shell();</span>
        <span class="token keyword">char</span> prefix_str<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> input_str<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">get_prefix</span><span class="token punctuation">(</span>prefix_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>buf<span class="token operator">=</span><span class="token function">readline</span><span class="token punctuation">(</span>prefix_str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//COLOR_BAGIN COLOR_BKG_SEF(49,34)" " COLOR_END</span>
        <span class="token comment">// get_input(input_str);</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setHistory_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"exit"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span><span class="token function">strcmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"logout"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"cd"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span><span class="token operator">*</span>s<span class="token operator">=</span><span class="token function">format_blank</span><span class="token punctuation">(</span>input_str<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">changdir</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>oldDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"history"</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>input_str<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> mode<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mode<span class="token punctuation">,</span>input_str<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> ret2<span class="token operator">=</span><span class="token function">do_arg</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret2<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>        
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<pre><code class="prism language-c">
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">"shell_head.h"</span></span>
<span class="token keyword">void</span> <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>err<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// exit(0);</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">s_gets</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>s<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token keyword">char</span><span class="token operator">*</span>find<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>ret_val<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">&gt;</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    ret_val<span class="token operator">=</span><span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>n<span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret_val<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        find<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>find<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">print_shell</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> hname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dirname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getHostname</span><span class="token punctuation">(</span>hname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">if</span><span class="token punctuation">(</span>SHOWPATH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">":"</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s$ "</span>COLOR_END<span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">,</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//40 ,34</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">"$ "</span><span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">get_prefix</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> hname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> dirname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">getHostname</span><span class="token punctuation">(</span>hname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span>BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span>SHOWPATH<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">":"</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s$ "</span>COLOR_END<span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">,</span>dirname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span>COLOR_BAGIN <span class="token function">COLOR_BKG_SEF</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span><span class="token number">33</span><span class="token punctuation">)</span> <span class="token string">"%s@%s"</span>COLOR_END<span class="token string">"$ "</span><span class="token punctuation">,</span>hname<span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

bool <span class="token function">get_input</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>argline<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">s_gets</span><span class="token punctuation">(</span>argline<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"get_arg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>subExpression<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>arglist<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span>argcnt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>cur<span class="token operator">=</span>subExpression<span class="token punctuation">;</span><span class="token comment">//ls -l\0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
        cur<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>begin<span class="token operator">=</span>cur<span class="token punctuation">;</span>
    <span class="token keyword">int</span> argNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cur<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>cur<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>ARGMAXLEN<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>cur<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                cur<span class="token operator">++</span><span class="token punctuation">;</span>
            begin<span class="token operator">=</span>cur<span class="token punctuation">;</span>
            argNum<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
            cur<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>ARGMAXLEN<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    arglist<span class="token punctuation">[</span>argNum<span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
    arglist<span class="token punctuation">[</span><span class="token operator">++</span>argNum<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>argcnt<span class="token operator">=</span>argNum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">back_check</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>f<span class="token operator">=</span><span class="token function">strchr</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>f<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">' '</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">&amp;</span><span class="token operator">=</span><span class="token operator">~</span>BACKGROUND<span class="token punctuation">;</span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"&amp; err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span>f<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>BACKGROUND<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
bool <span class="token function">search_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>cmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    DIR<span class="token operator">*</span>dp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dirent<span class="token operator">*</span>dirp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> newcmd<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>path<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"./"</span><span class="token punctuation">,</span><span class="token string">"/bin"</span><span class="token punctuation">,</span><span class="token string">"/usr/bin"</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>find<span class="token operator">=</span><span class="token function">strrchr</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>find<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> newpath<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>newpath<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>find<span class="token operator">-</span>cmd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>newpath<span class="token punctuation">;</span>  
        <span class="token function">strcpy</span><span class="token punctuation">(</span>newcmd<span class="token punctuation">,</span>find<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">"./"</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
            cmd<span class="token operator">+</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token function">strcpy</span><span class="token punctuation">(</span>newcmd<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// printf("n=%s\n",newcmd);</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dp<span class="token operator">=</span><span class="token function">opendir</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"cant open \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dirp<span class="token operator">=</span><span class="token function">readdir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("d=%s\n",dirp-&gt;d_name);</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>dirp<span class="token operator">-&gt;</span>d_name<span class="token punctuation">,</span>newcmd<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">closedir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">closedir</span><span class="token punctuation">(</span>dp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">split_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> ch<span class="token punctuation">,</span><span class="token keyword">char</span> arglist<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>argNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>begin<span class="token operator">=</span>p<span class="token punctuation">;</span>
    <span class="token operator">*</span>argNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span>ch<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token operator">==</span>ARGMAXNUM<span class="token punctuation">)</span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"too many arg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
            begin<span class="token operator">=</span>p<span class="token punctuation">;</span>
            len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            len<span class="token operator">++</span><span class="token punctuation">;</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>begin<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        arglist<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>argNum<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span>c<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>len<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>c<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 p<span class="token operator">++</span><span class="token punctuation">;</span>
                len<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                p<span class="token operator">++</span><span class="token punctuation">;</span>
                len<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
        len<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">find_2</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>String<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// llllllllll&lt;&lt; &lt;&lt;\0</span>
    <span class="token keyword">int</span> cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>String<span class="token punctuation">;</span>
    <span class="token keyword">int</span> StrLen<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> strLen<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>str<span class="token punctuation">,</span>strLen<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        p<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">do_arg</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">,</span><span class="token keyword">int</span> mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// printf("%d\n",mode);</span>
    <span class="token keyword">char</span> arglist2<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> argNum2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">char</span> fileName<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>INPUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">==</span>argNum2<span class="token operator">-</span><span class="token number">2</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>arglist2<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>FILENAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        
        <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// sys_err("open");</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"找不到文件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"执行失败！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]正在后台运行\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
            
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token operator">||</span>mode<span class="token operator">&amp;</span>APPPUT<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">==</span>argNum2<span class="token operator">-</span><span class="token number">2</span><span class="token operator">&amp;&amp;</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strncpy</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>arglist2<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>FILENAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token punctuation">)</span>
                fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_TRUNC<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>APPPUT<span class="token punctuation">)</span>
                fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// sys_err("open");</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"找不到文件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"执行失败！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]正在后台运行\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>PIPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>OUTPUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>INPUT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        arg<span class="token punctuation">[</span>argNum2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"找不到文件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"执行失败！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]正在后台运行\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>PIPE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">split_2</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span>arglist2<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> arglist3<span class="token punctuation">[</span>ARGMAXNUM<span class="token punctuation">]</span><span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span>  infile<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span>  outfile<span class="token punctuation">[</span>FILENAMESIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>argNum2<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> argNum3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>FILE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>FILE2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>FILE2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">strcpy</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>FILE1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">split_2</span><span class="token punctuation">(</span>arglist2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">' '</span><span class="token punctuation">,</span>arglist3<span class="token punctuation">,</span><span class="token operator">&amp;</span>argNum3<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span><span class="token operator">*</span>arg<span class="token punctuation">[</span>argNum3<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>argNum3<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                arg<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>arglist3<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            arg<span class="token punctuation">[</span>argNum3<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">search_cmd</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">==</span>false<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"找不到文件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>infile<span class="token punctuation">,</span>O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// printf("i=%d\tinfile:%s:",i,infile);</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// sys_err("open");</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// rmdir("/tmp/mystery love");</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// printf("%d--argNUM3:\n",argNum2);</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span>argNum2<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// printf("i=%d,outfile:%s:",i,outfile);</span>
                    <span class="token keyword">int</span> fd2<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>outfile<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_TRUNC<span class="token operator">|</span>O_RDWR<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>fd2<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">dup2</span><span class="token punctuation">(</span>fd2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">execvp</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"执行失败！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// dup2(fd,1);</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token operator">&amp;</span>BACKGROUND<span class="token punctuation">)</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid[%d]正在后台运行\n"</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> 
                        <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// return 0;</span>
                    <span class="token function">remove</span><span class="token punctuation">(</span>infile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
<span class="token keyword">int</span>  <span class="token function">get_mode</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span>mode<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">back_check</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">find_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"   |  下不支持&gt;,&lt;,&gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span>            
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>PIPE<span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> ocnt<span class="token operator">=</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> icnt<span class="token operator">=</span><span class="token function">find</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> acnt<span class="token operator">=</span><span class="token function">find_2</span><span class="token punctuation">(</span>input_str<span class="token punctuation">,</span><span class="token string">"&gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// printf("%d%d%d\n",ocnt,icnt,acnt);</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ocnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"只支持1个&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>icnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"只支持1个&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>acnt<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"只支持1个&lt;&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span>icnt<span class="token operator">&amp;&amp;</span>icnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span>acnt<span class="token operator">&amp;&amp;</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>icnt<span class="token operator">==</span>acnt<span class="token operator">&amp;&amp;</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                 <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"不可同时支持&lt; &gt; &gt;&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ocnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>OUTPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>icnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>INPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>acnt<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>mode<span class="token operator">|</span><span class="token operator">=</span>APPPUT<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">changdir</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>newDirName<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span>oldDirName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> newDir<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span>newDirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"-"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>oldDirName<span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
           <span class="token function">sys_err</span><span class="token punctuation">(</span><span class="token string">"这是第一次跳转目录,因此无法跳转到上一次的目录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">strcpy</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span>oldDirName<span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"~"</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> uname<span class="token punctuation">[</span>BUFSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">getUsername</span><span class="token punctuation">(</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>newDir<span class="token punctuation">,</span><span class="token string">"/home/%s"</span><span class="token punctuation">,</span>uname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getcwd</span><span class="token punctuation">(</span>oldDirName<span class="token punctuation">,</span>ARGMAXLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>            
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">chdir</span><span class="token punctuation">(</span>newDir<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"错误的目录名称:%s\n"</span><span class="token punctuation">,</span>newDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">showdir</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>dirName<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">getcwd</span><span class="token punctuation">(</span>dirName<span class="token punctuation">,</span>DIRNAMESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span>dirName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">char</span><span class="token operator">*</span><span class="token function">format_blank</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span>p<span class="token operator">=</span>str<span class="token punctuation">,</span><span class="token operator">*</span>e<span class="token operator">=</span>str<span class="token operator">+</span>len<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>p<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>e<span class="token operator">&amp;&amp;</span><span class="token operator">*</span>e<span class="token operator">!=</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>e<span class="token operator">==</span><span class="token string">' '</span><span class="token operator">||</span><span class="token operator">*</span>e<span class="token operator">==</span><span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>e<span class="token operator">=</span><span class="token string">'\0'</span><span class="token punctuation">;</span>
            e<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>username<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> passwd<span class="token operator">*</span> pwd <span class="token operator">=</span> <span class="token function">getpwuid</span><span class="token punctuation">(</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> pwd<span class="token operator">-&gt;</span>pw_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">getHostname</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span>hostname<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">gethostname</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> BUFSIZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">setHistory</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>input_str<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">||</span><span class="token operator">*</span>input_str<span class="token operator">==</span><span class="token string">'\0'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> historylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> history htylist<span class="token punctuation">[</span>HISTORYMAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> history<span class="token punctuation">[</span>ARGMAXLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>HISTORYMAXSIZE<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>htylist<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getHistory</span><span class="token punctuation">(</span>htylist<span class="token punctuation">,</span><span class="token operator">&amp;</span>historylen<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>historylen<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">=</span>htylist<span class="token punctuation">[</span>historylen<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>htylist<span class="token punctuation">[</span>historylen<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">,</span>history<span class="token punctuation">,</span>HISTORYMAXSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>HISTORYFILE<span class="token punctuation">,</span>O_APPEND<span class="token operator">|</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> wlen<span class="token operator">=</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>htylist<span class="token operator">+</span>historylen<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>wlen<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history <span class="token operator">*</span>htylist<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>historylen<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd<span class="token operator">=</span><span class="token function">open</span><span class="token punctuation">(</span>HISTORYFILE<span class="token punctuation">,</span>O_CREAT<span class="token operator">|</span>O_RDONLY<span class="token punctuation">,</span><span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>ret<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>htylist<span class="token operator">+</span>i<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"read err %s"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>historylen<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span>HISTORYMAXSIZE<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>HISTORYMAXSIZE<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token function">memset</span><span class="token punctuation">(</span>htylist<span class="token operator">+</span>j<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> history<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>historylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">printHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> history htylist<span class="token punctuation">[</span>HISTORYMAXSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> htylen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getHistory</span><span class="token punctuation">(</span>htylist<span class="token punctuation">,</span><span class="token operator">&amp;</span>htylen<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>htylen<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %s\n"</span><span class="token punctuation">,</span>htylist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>htylist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">setHistory_2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>input_str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>input_str<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span><span class="token operator">*</span>input_str<span class="token operator">!=</span><span class="token string">'\0'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">add_history</span><span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write_history</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">printHistory_2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    HIST_ENTRY <span class="token operator">*</span><span class="token operator">*</span> his<span class="token punctuation">;</span>
    his <span class="token operator">=</span> <span class="token function">history_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>his<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %s\n"</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> his<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-&gt;</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<p>本文其实有很多漏洞和不足之处也比较冗长（总让我感觉很多地方可以用什么方法复用）。本文也未实现多重管道和输入输出重定向的混搭，因为一开始在此处的字符串处理上卡壳太久（心累）。<br/> 有些函数是开始的版本的就比如main中有使用xxxx_2的函数，本来在用xxxx,我没有删去。保留下来康康挺心酸的。</p>
<p>那些写的不优雅的地方之后会慢慢矫正吧，我想。</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>线程池，在我看来就是一个 线程链表，接着我们通过任务链表（其实应该是队列）在上面分配一些任务函数。<br/> 在实际应用中，线程池可以和网络服务器等高并发的程序结合起来实现异步操作。</p>
<h2><a id="_4"></a>线程池核心结构</h2>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> my_pthread_t
<span class="token punctuation">{<!-- --></span>
    pthread_t <span class="token operator">*</span>_pthread<span class="token punctuation">;</span>		<span class="token comment">//线程号</span>
    bool state<span class="token punctuation">;</span>					<span class="token comment">//是否已经进入等待状态</span>
<span class="token punctuation">}</span>my_pthread_t<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> trdpool_t<span class="token punctuation">{<!-- --></span>
my_pthread_t <span class="token operator">*</span>phead<span class="token punctuation">;</span>	<span class="token comment">/*其实这里可以直接用下面的pthread_t*取代（主流做法），但是因为在学习的过程中,遇见了点小问题，这里做了修改，用途后见*/</span>
<span class="token comment">// pthread_t *phead;</span>

work_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>						<span class="token comment">//任务链表的头</span>
pthread_cond_t cond<span class="token punctuation">;</span>			<span class="token comment">//用于维护任务链表的条件变量</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>	<span class="token comment">//用于锁定条件变量的互斥锁</span>
bool status<span class="token punctuation">;</span>                                <span class="token comment">//线程池状态：	0 线程池不销毁      1 销毁</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>										<span class="token comment">//线程池中的线程数量</span>
<span class="token punctuation">}</span>trdpool_t<span class="token punctuation">;</span>
</code></pre>
<h2><a id="_23"></a>任务链表结构</h2>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token function">Fun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> work_t<span class="token punctuation">{<!-- --></span>
    Fun<span class="token operator">*</span> fun<span class="token punctuation">;</span>						<span class="token comment">//任务函数</span>
    <span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">;</span> 					<span class="token comment">//任务函数的参数</span>
    <span class="token keyword">struct</span> work_t<span class="token operator">*</span>next<span class="token punctuation">;</span>	<span class="token comment">//任务链表的下一个任务的指针</span>
<span class="token punctuation">}</span>work_t<span class="token punctuation">;</span>
</code></pre>
<h2><a id="main%09_33"></a>main 流程</h2>
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//在线程池创建5个线程</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//添加10个任务</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//这里是为了看效果，延缓下销毁</span>
    <span class="token comment">// while(1);</span>
    <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//销毁线程池</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="prdpool_initint_46"></a>prdpool_init(int)</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    trdpool<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>trdpool_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//动态内存记得free</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//初始化锁</span>
    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//初始化条件变量</span>
    
    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//初始化状态为未销毁</span>
    trdpool<span class="token operator">-&gt;</span>phead<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//要求分配num个线程</span>
    trdpool<span class="token operator">-&gt;</span>num<span class="token operator">=</span>num<span class="token punctuation">;</span>			
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    ？？？    trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pthread_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//动态分配线程的内存空间</span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">//这个是代表线程尚未进入休眠状态，并不必要</span>
        bool<span class="token operator">*</span>pthread_arg<span class="token operator">=</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//这个是传给线程的参数</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>start_routine<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pthread_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">//创建线程 </span>
        lblready<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		
                <span class="token comment">//如果这个时候线程在线程函数中</span>
                <span class="token comment">//尚未进入等待状态就再睡一会儿</span>
                        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> lblready<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a id="voidstart_routinevoidarg%09_74"></a>void<em>start_routine(void</em>arg) 线程执行函数</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span><span class="token operator">*</span><span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bool<span class="token operator">*</span>state<span class="token operator">=</span>arg<span class="token punctuation">;</span>		<span class="token comment">//提取出参数，这里我就只用了前面提到的trdpool-&gt;phead[i].state，也就是</span>
    <span class="token comment">//线程是否进入等待状态的标志</span>
    work_t<span class="token operator">*</span>work<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//给条件变量加锁，同时也算是给任务链表加锁</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>      <span class="token comment">//使用while的原因，之后条件变量改变之后会有抢锁，抢到锁的线程从任务队头拿走任务，则任务链表可能变空，而此时抢到锁的线程释放锁则让唤醒的线程继续睡眠。		后面那个status条件表明线程池尚未被摧毁</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is ready \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//表示线程要去睡眠了</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//唤醒俩条件1.有任务2.线程池释放摧毁信号</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is weak up  \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>		<span class="token comment">//如果不是要摧毁线程池</span>
            work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>	<span class="token comment">//		取出任务</span>
             trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>		<span class="token comment">//任务链表去除任务</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//解锁</span>
            <span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//执行任务函数</span>
            <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//释放动态分配的任务</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//如果是想摧毁线程池            </span>
            <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//这里就线程退出就好了</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
<h2><a id="void_add_work%09_104"></a>void add_work() 添加任务</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    work_t<span class="token operator">*</span> new_work<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>work_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    work_t<span class="token operator">*</span> old_work<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>arg<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>fun<span class="token operator">=</span>print_pthread_self<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token comment">//设置任务的有关信息</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁住任务链表</span>
    <span class="token comment">//添加任务</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        old_work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
        new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span>old_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//通知唤醒等待阻塞的线程</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解锁</span>
<span class="token punctuation">}</span>

</code></pre>
<h2><a id="void_prdpool_destory_129"></a>void prdpool_destory()</h2>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool begin to  destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    work_t <span class="token operator">*</span>work<span class="token punctuation">;</span>

    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//标记线程池需要摧毁</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//加锁</span>
    <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//广播唤醒等待中的所有线程</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//解锁</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> trdpool<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这里其实是阻塞等待每个线程</span>
        <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>			<span class="token comment">//释放每一个任务</span>
        trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//释放条件变量</span>
	<span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//保证没人用锁</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//释放锁</span>
    <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>下面是我写的源码--------&gt;</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token function">Fun</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> work_t<span class="token punctuation">{<!-- --></span>
    Fun<span class="token operator">*</span> fun<span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">;</span> 
    <span class="token keyword">struct</span> work_t<span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span>work_t<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> my_pthread_t
<span class="token punctuation">{<!-- --></span>
    pthread_t <span class="token operator">*</span>_pthread<span class="token punctuation">;</span>
    bool state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>my_pthread_t<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> trdpool_t<span class="token punctuation">{<!-- --></span>
my_pthread_t <span class="token operator">*</span>phead<span class="token punctuation">;</span>
<span class="token comment">// pthread_t *phead;</span>
work_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>
pthread_cond_t cond<span class="token punctuation">;</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>
bool status<span class="token punctuation">;</span>                                <span class="token comment">//0 线程池不销毁      1 销毁</span>
<span class="token keyword">int</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span>trdpool_t<span class="token punctuation">;</span>

trdpool_t <span class="token operator">*</span>trdpool<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span> 

<span class="token keyword">void</span> <span class="token function">print_pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread id = %ld\n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span><span class="token operator">*</span><span class="token function">start_routine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bool<span class="token operator">*</span>state<span class="token operator">=</span>arg<span class="token punctuation">;</span>
    work_t<span class="token operator">*</span>work<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">==</span><span class="token constant">NULL</span><span class="token operator">&amp;&amp;</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>      <span class="token comment">//一个小朋友把蛋糕抢走了，那么其他小朋友醒来再继续睡。</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is ready \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>state<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token string">"thread  %ld is weak up  \n"</span><span class="token punctuation">,</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
             trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>fun<span class="token punctuation">)</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    work_t<span class="token operator">*</span> new_work<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>work_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    work_t<span class="token operator">*</span> old_work<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>arg<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>fun<span class="token operator">=</span>print_pthread_self<span class="token punctuation">;</span>
    new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        old_work<span class="token operator">=</span> trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
        new_work<span class="token operator">-&gt;</span>next<span class="token operator">=</span>old_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
         trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>new_work<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    trdpool<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>trdpool_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    trdpool<span class="token operator">-&gt;</span>phead<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>my_pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    trdpool<span class="token operator">-&gt;</span>num<span class="token operator">=</span>num<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>pthread_t<span class="token punctuation">)</span><span class="token operator">*</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        bool<span class="token operator">*</span>pthread_arg<span class="token operator">=</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span>start_routine<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pthread_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        lblready<span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>state<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">goto</span> lblready<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool begin to  destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    work_t <span class="token operator">*</span>work<span class="token punctuation">;</span>

    trdpool<span class="token operator">-&gt;</span>status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_cond_broadcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> trdpool<span class="token operator">-&gt;</span>num<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_pthread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span> trdpool<span class="token operator">-&gt;</span>phead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// puts("!");</span>
        trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>work<span class="token punctuation">)</span><span class="token punctuation">;</span>
        work<span class="token operator">=</span>trdpool<span class="token operator">-&gt;</span>whead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_cond_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span> trdpool<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>trdpool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"the trdpool destory !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">prdpool_init</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// sleep(1);</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// while(1);</span>
    <span class="token function">prdpool_destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<pre><code class="prism language-bash">adl@adl:~/桌面/linux$ ./a.out 
thread  140704759068416 is ready 
thread  140704750675712 is ready 
thread  140704672118528 is ready 
thread  140704663725824 is ready 
thread  140704655333120 is ready 
thread  140704759068416 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704759068416
thread  140704655333120 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704655333120
thread  140704663725824 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704663725824
thread  140704750675712 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704750675712
thread  140704672118528 is weak up  
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704672118528
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704759068416
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704655333120
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704663725824
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704750675712
pthread <span class="token function">id</span> <span class="token operator">=</span> 140704672118528
thread  140704759068416 is ready 
thread  140704655333120 is ready 
thread  140704663725824 is ready 
thread  140704750675712 is ready 
thread  140704672118528 is ready 
the trdpool begin to  destory <span class="token operator">!</span>
thread  140704750675712 is weak up  
thread  140704655333120 is weak up  
thread  140704663725824 is weak up  
thread  140704672118528 is weak up  
thread  140704759068416 is weak up  
the trdpool destory <span class="token operator">!</span>
</code></pre>
<p>以上是我写的简单线程池，其实在写的过程中遇到过些问题，但有在学长和热心网友的帮助下学到了许多。<br/> <a href="https://bbs.csdn.net/topics/396472423">挂论坛上的链接</a></p>
<p>参考了：<br/> <a href="https://blog.csdn.net/yangbodong22011/article/details/47301975">学长博客</a></p>
<p>大家可以去看这个是比较好的：<br/> <a href="https://blog.csdn.net/qq_36359022/article/details/78796784">详细的线程池实现</a></p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>在阅读《UNIX 高级环境编程》进程控制那块，有个例子是差不多这样的：<br/> 在子进程中改变变量，观察父进程之后变量的变化</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token keyword">int</span> glob<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"write to stdout\n"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> var<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    var <span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before fork\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// fflush(stdout);</span>
    <span class="token comment">// setbuf(stdout,NULL);</span>
    <span class="token comment">// setvbuf(stdout,(char*)NULL,_IONBF,0);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        glob<span class="token operator">++</span><span class="token punctuation">;</span>
        var<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid =%d ,glob =%d ,var=%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>glob<span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>开始我也觉得就这样，因为子进程写时复制父进程的堆栈和数据空间，子进程改变变量父进程的变量没啥可变化的。<br/> 但书上忽然话峰一转，提到了标准IO函数写缓冲区的复制问题。</p>
<p>问题是这样的：我们的write(STDOUT_FILENO)在终端打印一次没错，我们的printf(“before fork\n”)在终端也打印一次没错。但如果我们把这个结果以<code>a.out &gt;a.txt</code>的形式<br/> 重定向导入到文件中会将这些语句打印几次呢???<br/> 答案：write(STDOUT_FILENO)打印一次，<strong>printf(“before fork\n”)打印两次</strong><br/> 哇这说明了什么呢？？？书上指出write是不带缓存的，printf是带有一个8192字节的缓存的。令人意外且容易被我们忽视的是：<strong>子进程会继承父进程写缓冲区的内容的</strong>。那为什么写到终端就打印没有这句话呢，写到文件却出现了呢?<br/> 这是因为标准输出是行缓冲的我们写的内容中有个’\n’的换行符刷新了行缓冲,子进程因此得不到此内容;然而重定向是让输出指向文件，并且此时它的缓冲模式成了写入普通文件的缓冲模式:全缓冲（不懂见《UNIX 高级环境编程》第五章）这导致了我们父进程printf打印完了之后缓冲区中的内容还在，并且其中的内容复制给了子进程，子进程也因此会打印出这句话。</p>
<p>好奇宝宝们会问，那怎么才可让子进程不打印这句话呢？？？<br/> 答案是在父进程printf之后用这三个函数其中之一刷新缓冲区即可。</p>
<pre><code class="prism language-c">     <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span>_IONBF<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>大家还可以注意到写缓冲是8192字节，如果我们写超过8192字节的内容那这个缓冲区是否已经被刷新了呢？<br/> 答案是肯定的。</p>
<p>如下的实验：我在printf(“before fork\n”)添加很多空格，到这个字符串有300个字节为止。接着我们再打印它个30次，3000×30=9000=8192;这意味这全缓冲下我们在打印了300×28=8400字节之后缓冲区的内容全部被刷新出去了。那文件中我们可以打印句字符串呢？？？父进程的30+还在缓冲区继承给子进程的（30-28）=32。 答案的确如此。</p>
<p>此时我们用这条命令<code>a.out |grep before | wc</code><br/> 猜猜看得到的行数的是多少？对是32！这里的 <code>|</code>同样重定向了标准输出到可执行文件grep中。如果大家之前没看这篇文章肯定以为会是30吧！！！惊不惊喜？</p>
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;semaphore.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/select.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;dirent.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;pwd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;grp.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;signal.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token keyword">int</span> glob<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"write to stdout\n"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> var<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    var <span class="token operator">=</span><span class="token number">88</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>STDOUT_FILENO<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"write error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">30</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"before fork                                                                                                                                                                                                                                                                                               \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// fflush(stdout);</span>
    <span class="token comment">// setbuf(stdout,NULL);</span>
    <span class="token comment">// setvbuf(stdout,(char*)NULL,_IONBF,0);</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"fork error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pid<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        glob<span class="token operator">++</span><span class="token punctuation">;</span>
        var<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pid =%d ,glob =%d ,var=%d\n"</span><span class="token punctuation">,</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>glob<span class="token punctuation">,</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>发现了吧，自己做写小实验是可以有很大收获的。</p>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article><article class="baidu_pl">
<div class="article_content clearfix" id="article_content">
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-a405391f94.css" rel="stylesheet"/>
<div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
<svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
<path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
</svg>
<p>应该之后开始每天记录一点，不然这些笔记过段时间都不知道放哪了。</p>
<ol><li> <p>fork 和vfork 的区别在于vfork子进程共享父进程地址空间，子进程先执行，这意味着变量是共享的，子进程一边改变，父进程的变量的值也会受到影响。</p> </li><li> <p>俩进程在写同一个文件如果使用open(O_APPEND),write的系统调用的时候，父进程和子进程的调用次序不一定，写入文件中是交替的（但不会覆盖），如果使用的是fopen(“ab”),fwrite的c库函数的时候，父进程和子进程依旧调用次序不一定,但写入文件中如果数据较小，未出现交替现象，数据大起来到4096字节的时候交替给另一个进程写入。<br/> 但如果是open()+lseek(END)则会产生覆盖现象</p> </li><li> <p>、strtok_r函数<br/> strtok_r函数是linux下分割字符串的安全函数，函数声明如下：<br/> char *strtok_r(char *str, const char *delim, char **saveptr);<br/> 该函数也会破坏带分解字符串的完整性，但是其将剩余的字符串保存在saveptr变量中，保证了安全性。</p> </li><li> <p>当描述符0和f d共享同一文件表项 。例如,若描述符 0被只读打开,那么我们也只对 f d进<br/> 行读操作。即使系统忽略打开方式,并且下列调用成功:<br/> fd = open("/dev/fd/0", O_RDWR);<br/> 我们仍然不能对f d进行写操作。</p> </li><li> <p>指定了O_APPEND打开文件，使用lseek到文件任意一个位置写都没有用,全会写到文件末尾。open(O_APPEND )=open()+lseek(fd,0,SEK_END)的原子操作。open(O_APPEND)需要指定O_WRONLY或者O_RDWR</p> </li><li> <p>dup(1,0)这些之间始终有着些疑问,<br/> 而且对于write(stdout,)和read(stdin,)和<br/> write(stdin,)和read(stdout,)也是感觉很奇怪</p> </li><li> <p>#ifdef _SIZE_T<br/> typedef _SIZE_T size_t ;<br/> #undef _SIZE_T<br/> 这种形式的宏定义结合typedef可以让size_t在多个头文件中宏定义多次_SIZE_T都没关系</p> </li><li> <p>书上说O_TRUNC只会截断只读或者只写文件。实验证明O_TRUNC即使是可读可写文件也是会截断为0的</p> </li><li> <p>必须是本用户的程序设置u+s才可以让其他用户来通过这个程序越级访问本用户文件</p> </li><li> <p>可用通过access 来试验文件权限。</p> </li><li> <p>i节点包含了所有与文件有关的信息:文件类型、文件存取许可权位、文件长度和指向该<br/> 文件所占用的数据块的指针等等。 s t a t结构中的大多数信息都取自 i节点。只有两项数据存放在<br/> 目录项中:文件名和i节点编号数。i节点编号数的数据类型是i n o _ t。</p> </li><li> <p>目录不可以硬链接的原因:,目录非空无法删除(看rmdir,rename可知)而软链接unlink是不穿透的,因此unlink一个软链接目录可以把这个目录“副本”删除。（注：unix(我不确定linux可不可以，也不敢试)root可以硬链接目录，作者说文件系统会出问题）13. 利用宏函数会比普通函数调用快如getc,fgetc</p> </li><li> <p>fgets()用memcpy()实现，memcpy用汇编。</p> </li><li> <p>dup2(fd,1)重定向的深入理解：将fd的文件表项与1共享，原本write(fd)的内容先找到fd的文件表项，再根据当下的v节点指针（fd的）找到v节点表，写入信息。</p> </li><li> <p>stat大部分内容在v节点表，少数在文件表项，如文件名，文件的读写状态，</p> </li><li> <p>标准出错如它所应该的那样是非缓存的,而普通文件按系<br/> 统默认是全缓存的。</p> </li><li> <p>sync可用于数据库这样的应用程序,它确保修改过的块立即写到磁盘上</p> </li><li> <p>对于O_sync ,O_direct较好的理解<br/> https://www.cnblogs.com/suzhou/p/5381738.html<br/> 这张图爱了<img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2020042015080612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FkbGF0ZXJldHVybg==,size_16,color_FFFFFF,t_70"/></p> </li><li> <p>caltime=time(NULL);<br/> tm=localtime(&amp;caltime);<br/> (strftime(line,MAXLINE,"%a %b %d %X %Z %Y\n",tm)</p> </li><li> <p><code>atexit(void(*func)(void))</code>类似于析构函数</p> </li><li> <p>共享库可以让可执行文件大小显著减少：共享库使得可执行文件中不再需要包含常用的库函数,而只需在所有进程都可存取的存储区中保存这种库例程的一个副本。程序第一次执行或者第一次调用某个库函数时,用动态连接方法将程序与共享库函数相连接。这减少了每个可执行文件的长度,但增加了一些运行时间开销。共享库的另一个优点是可以用库函数的新版本代替老版本而无需对使用该库的程序重新连接编辑。(假定参数的数目和类型都没有发生改变。)----&gt;(本需要写在可执行文件里，现在放在内存中，拿过来链接就好了)缺点：变慢</p> </li><li> <p>setjmp,setlongjmp使用的过程中需要注意想像正常goto一样的数据不回滚的功能，需要让那些在过程中使用的变量施加volatile</p> </li><li> <p>子进程和父进程继续执行 f o r k之后的指令。子进程是父进程的复制品。例如,子进程获得<br/> 父进程数据空间、堆和栈的复制品。注意,这是子进程所拥有的拷贝。父、子进程并不共享这<br/> 些存储空间部分。如果正文段是只读的,则父、子进程共享正文段 (见7 . 6节)。<br/> 现在很多的实现并不做一个父进程数据段和堆的完全拷贝,因为在 f o r k之后经常跟随着<br/> e x e c。作为替代,使用了在写时复制 ( C o p y - O n - Write, COW)的技术。这些区域由父、子进程共<br/> 享,而且内核将它们的存取许可权改变为只读的。</p> </li><li> <p>f o r k的一个特性是所有由父进程打开的描述符都被复制到子进程中。<br/> 父、子进程每个相同的打开描述符共享一个文件表项 。</p> </li><li> <p>fork甚至会把fork前父进程中标准IO如printf写缓冲区(那些是全缓存的)(如果没有fflush)的内容复制到子进程的缓存中。</p> </li><li> <p>fork 两次可以避免僵尸,前提是子先于孙死，孙则接给init而不是父。</p> </li><li> <p>setuid(500)在本程序不是root的情况下只可以500去运行的时候把有效uid改成500。</p> </li><li> <p>[对于setuid等函数的较好的实验] https://www.cnblogs.com/robbychan/archive/2013/06/05/3786945.html</p> </li><li> <p>子进程exit会刷新父进程的标准IO缓冲区，所以用_exit</p> </li><li> <p>在写myshell的过程中有个问题就是用wait(WHOHANG)实现的&amp;究竟是不是真正的放到后台。<br/> 不是!<br/> 终端如果知道子进程在后台运行1.子进程需要向终端写数据（可以使用stty tostop禁止），可以会写出来也可能去发送SIGTTOU信号。在禁止之后呢，写数据的子进程就和从终端读数据的进程一样的会被暂停。读数据终端则发送sigsttin信号。之后呢如果需要运行则是利用fg 命令，终端向程序发送sigcont,程序在前台继续运行。可以说真正的后台就是暂停和可以拿出来继续。然而myshell实验只是让子进程和父进程同时运行了。</p> </li></ol>
</div>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-10218d227c.css" rel="stylesheet"/>
<link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-57471a2b6e.css" rel="stylesheet"/>
</div>
</article>